<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GURPS –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #333; padding: 20px; min-height: 100vh; }
        .container { max-width: 800px; margin: 0 auto; background: white; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); overflow: hidden; }
        .header { background: linear-gradient(135deg, #2c3e50, #34495e); color: white; padding: 20px; text-align: center; }
        .character-info { display: flex; gap: 15px; margin-bottom: 15px; flex-wrap: wrap; justify-content: center; }
        .input-group { flex: 1; min-width: 200px; }
        .input-group label { display: block; margin-bottom: 5px; font-weight: bold; color: #ecf0f1; }
        .input-group input { width: 100%; padding: 10px; border: none; border-radius: 8px; font-size: 16px; background: rgba(255,255,255,0.9); }
        
        .level-system { background: #f8f9fa; padding: 15px; border-bottom: 2px solid #dee2e6; }
        .level-display { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .level-info { font-size: 1.2em; font-weight: bold; color: #2c3e50; display: flex; align-items: center; gap: 10px; }
        .exp-display { display: flex; align-items: center; gap: 10px; }
        .exp-input { width: 120px; padding: 8px; border: 2px solid #3498db; border-radius: 6px; font-size: 16px; text-align: center; }
        
        .stats-panel { padding: 15px; background: #fff; border-bottom: 2px solid #ecf0f1; }
        .stat-row { display: flex; align-items: center; padding: 8px 0; gap: 10px; }
        .stat-label { flex: 1; font-weight: bold; display: flex; align-items: center; gap: 8px; }
        .stat-input { width: 100px; padding: 8px; border: 2px solid #3498db; border-radius: 6px; text-align: center; font-size: 16px; }
        
        .points-panel { padding: 15px; background: #e8f4f8; border-bottom: 2px solid #3498db; }
        .points-display { display: flex; align-items: center; justify-content: center; gap: 10px; }
        
        .skills-section { padding: 20px; border-bottom: 2px solid #ecf0f1; }
        .section-title { font-size: 1.4em; color: #2c3e50; margin-bottom: 15px; padding-bottom: 8px; border-bottom: 2px solid #3498db; display: flex; align-items: center; gap: 10px; }
        .skill-row { display: flex; align-items: center; padding: 12px 0; border-bottom: 1px solid #ecf0f1; }
        .skill-name { flex: 2; font-weight: 500; display: flex; align-items: center; gap: 8px; }
        .skill-controls { flex: 1; display: flex; align-items: center; justify-content: flex-end; gap: 10px; }
        .skill-value { font-size: 1.2em; font-weight: bold; color: #2c3e50; min-width: 30px; text-align: center; }
        
        .btn { padding: 8px 12px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: bold; transition: all 0.3s; }
        .btn-plus { background: #27ae60; color: white; }
        .btn-minus { background: #e74c3c; color: white; }
        .btn-roll { background: #3498db; color: white; padding: 8px 15px; }
        .btn-convert { background: #9b59b6; color: white; }
        .btn-levels { background: #f39c12; color: white; }
        .btn-edit { background: #95a5a6; color: white; }
        .btn-undo { background: #e67e22; color: white; }
        .btn-redo { background: #d35400; color: white; }
        .btn:disabled { background: #bdc3c7; cursor: not-allowed; }
        
        .result-popup, .levels-popup { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .result-content, .levels-content { background: white; padding: 30px; border-radius: 15px; text-align: center; max-width: 90%; width: 400px; max-height: 80vh; overflow-y: auto; }
        .dice-rolls { display: flex; justify-content: center; gap: 15px; margin: 15px 0; }
        .dice { width: 50px; height: 50px; background: #3498db; border-radius: 8px; display: flex; justify-content: center; align-items: center; font-size: 1.5em; font-weight: bold; color: white; }
        
        .success { color: #27ae60; font-weight: bold; }
        .failure { color: #e74c3c; font-weight: bold; }
        .critical-success { color: #f39c12; font-weight: bold; }
        .critical-failure { color: #c0392b; font-weight: bold; }
        
        .free-points-warning { color: #e74c3c; font-weight: bold; text-align: center; margin: 10px; padding: 10px; background: #ffeaa7; border-radius: 5px; }
        
        .levels-table { width: 100%; border-collapse: collapse; margin: 15px 0; }
        .levels-table th, .levels-table td { padding: 8px; text-align: center; border: 1px solid #ddd; }
        .levels-table th { background: #34495e; color: white; }
        .current-level { background: #ffeaa7 !important; font-weight: bold; }
        
        @media (max-width: 600px) {
            .character-info, .stat-row, .skill-row { flex-direction: column; align-items: flex-start; gap: 10px; }
            .skill-controls { width: 100%; justify-content: space-between; }
            .exp-display, .level-display { flex-direction: column; gap: 10px; }
            .points-display { flex-direction: column; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üé≤ GURPS –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</h1>
            <div class="character-info">
                <div class="input-group">
                    <label for="characterName">–ò–º—è:</label>
                    <input type="text" id="characterName" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è">
                </div>
                <div class="input-group">
                    <label for="characterSurname">–§–∞–º–∏–ª–∏—è:</label>
                    <input type="text" id="characterSurname" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ñ–∞–º–∏–ª–∏—é">
                </div>
                <div class="input-group">
                    <label for="characterTitle">–¢–∏—Ç—É–ª:</label>
                    <input type="text" id="characterTitle" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–∏—Ç—É–ª">
                </div>
            </div>
        </div>

        <div class="level-system">
            <div class="level-display">
                <div class="level-info">
                    –£—Ä–æ–≤–µ–Ω—å: <span id="currentLevel">1</span>
                    <button class="btn btn-edit" onclick="editLevel()">‚úèÔ∏è</button>
                    <button class="btn btn-levels" onclick="showLevelsTable()">üìä</button>
                    <button class="btn btn-undo" onclick="undo()" id="undoBtn" disabled>‚Ü∂</button>
                    <button class="btn btn-redo" onclick="redo()" id="redoBtn" disabled>‚Ü∑</button>
                </div>
                <div class="exp-display">
                    <input type="number" id="currentExp" class="exp-input" value="0" min="0">
                    <span>/ <span id="requiredExp">1000</span></span>
                    <button class="btn btn-plus" onclick="addExperience()">‚ûï –û–ø—ã—Ç</button>
                    <button class="btn btn-convert" id="convertBtn" onclick="convertExpToPoints()" style="display: none;">üíé –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                </div>
            </div>
            <div id="convertInfo" style="display: none; text-align: center; margin-top: 10px; font-size: 0.9em; color: #9b59b6;">
                üíé 1000 –æ–ø—ã—Ç–∞ = 1 –æ—á–∫–æ –Ω–∞–≤—ã–∫–æ–≤
            </div>
        </div>

        <div class="stats-panel">
            <div class="stat-row">
                <div class="stat-label">‚ù§Ô∏è –ó–î–û–†–û–í–¨–ï:</div>
                <input type="number" class="stat-input" id="health" value="100">
                <button class="btn btn-minus" onclick="changeStat('health', -10)">-10</button>
                <button class="btn btn-plus" onclick="changeStat('health', 10)">+10</button>
            </div>
            <div class="stat-row">
                <div class="stat-label">üíß –ú–ê–ù–ê:</div>
                <input type="number" class="stat-input" id="mana" value="100">
                <button class="btn btn-minus" onclick="changeStat('mana', -5)">-5</button>
                <button class="btn btn-plus" onclick="changeStat('mana', 5)">+5</button>
            </div>
            <div class="stat-row">
                <div class="stat-label">‚ö° –°–¢–ê–ú–ò–ù–ê:</div>
                <input type="number" class="stat-input" id="stamina" value="100">
                <button class="btn btn-minus" onclick="changeStat('stamina', -5)">-5</button>
                <button class="btn btn-plus" onclick="changeStat('stamina', 5)">+5</button>
            </div>
        </div>

        <div class="points-panel">
            <div class="points-display">
                <span style="font-size: 1.2em; font-weight: bold; color: #2c3e50;">–°–≤–æ–±–æ–¥–Ω—ã–µ –æ—á–∫–∏:</span>
                <input type="number" id="freePoints" class="stat-input" value="20" style="width: 80px;">
                <button class="btn btn-edit" onclick="editFreePoints()">‚úèÔ∏è</button>
            </div>
        </div>

        <div id="skillsContainer"></div>
        
        <div class="free-points-warning" id="pointsWarning" style="display: none;">
            ‚ö†Ô∏è –°–≤–æ–±–æ–¥–Ω—ã–µ –æ—á–∫–∏ –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å!
        </div>
    </div>

    <script>
        // –¢–∞–±–ª–∏—Ü–∞ —É—Ä–æ–≤–Ω–µ–π (–æ–±–Ω–æ–≤–ª—ë–Ω–Ω–∞—è)
        const levelTable = {
            1: { expRequired: 1000, hp: 100, mana: 100, stamina: 100, points: 20 },
            2: { expRequired: 3000, hp: 200, mana: 200, stamina: 200, points: 30 },
            3: { expRequired: 5000, hp: 300, mana: 300, stamina: 300, points: 40 },
            4: { expRequired: 8000, hp: 400, mana: 400, stamina: 400, points: 50 },
            5: { expRequired: 12000, hp: 500, mana: 500, stamina: 500, points: 60 },
            6: { expRequired: 16000, hp: 600, mana: 600, stamina: 600, points: 70 },
            7: { expRequired: 20000, hp: 700, mana: 700, stamina: 700, points: 80 },
            8: { expRequired: 25000, hp: 800, mana: 800, stamina: 800, points: 90 },
            9: { expRequired: 30000, hp: 900, mana: 900, stamina: 900, points: 100 },
            10: { expRequired: 100000, hp: 1000, mana: 1000, stamina: 1000, points: 200 }
        };

        // –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –Ω–∞–≤—ã–∫–æ–≤
        const skillsStructure = {
            "‚öîÔ∏è –ë–û–ï–í–´–ï –ù–ê–í–´–ö–ò": [
                "–¢—è–∂—ë–ª–∞—è –±—Ä–æ–Ω—è", "–õ—ë–≥–∫–∞—è –±—Ä–æ–Ω—è", "–î–≤—É—Ä—É—á–Ω–æ–µ –æ—Ä—É–∂–∏–µ", 
                "–û–¥–Ω–æ—Ä—É—á–Ω–æ–µ –æ—Ä—É–∂–∏–µ", "–°—Ç—Ä–µ–ª—å–±–∞", "–ë–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∏–µ", 
                "–î—Ä–µ–≤–∫–æ–≤–æ–µ", "–†—É–∫–æ–ø–∞—à–Ω—ã–π –±–æ–π", "–ú–µ—Ç–∞–Ω–∏–µ"
            ],
            "üé≠ –û–ë–©–ò–ï –ù–ê–í–´–ö–ò": [
                "–°–∫—Ä—ã—Ç–Ω–æ—Å—Ç—å", "–ö—Ä–∞—Å–Ω–æ—Ä–µ—á–∏–µ", "–õ–æ–≤–∫–æ—Å—Ç—å", "–í—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å",
                "–í–∑–ª–æ–º", "–í–æ—Å–ø—Ä–∏—è—Ç–∏–µ", "–£–¥–∞—á–∞", "–ö–∞—Ä–º–∞–Ω–Ω—ã–µ –∫—Ä–∞–∂–∏"
            ],
            "‚öóÔ∏è –†–ï–ú–ï–°–õ–ê": [
                "–ê–ª—Ö–∏–º–∏—è", "–ö—É–∑–Ω–µ—á–Ω–æ–µ –¥–µ–ª–æ", "–ó–∞—á–∞—Ä–æ–≤–∞–Ω–∏–µ", "–†–µ–º–µ—Å–ª–æ"
            ],
            "üîÆ –ú–ê–ì–ò–Ø": [
                "–ú–∞–≥–∏—è –≤–æ–¥—ã", "–ú–∞–≥–∏—è –∑–µ–º–ª–∏", "–ú–∞–≥–∏—è –≤–æ–∑–¥—É—Ö–∞", "–ú–∞–≥–∏—è –∫—Ä–æ–≤–∏",
                "–ú–∞–≥–∏—è –æ–≥–Ω—è", "–ú–∞–≥–∏—è –º–µ—Ç–∞–ª–ª–∞", "–ú–∞–≥–∏—è –ø—Ä–∏—Ä–æ–¥—ã", "–ú–∞–≥–∏—è —Å–≤–µ—Ç–∞",
                "–ú–∞–≥–∏—è —Ç—å–º—ã", "–ú–∞–≥–∏—è –∏–Ω—Ñ–µ—Ä–Ω–æ", "–ú–∞–≥–∏—è —Ö–∞–æ—Å–∞", "–ú–∞–≥–∏—è —Ä–∞–∑—É–º–∞",
                "–ú–∞–≥–∏—è –ñ–∏–∑–Ω–∏", "–ú–∞–≥–∏—è —Å–º–µ—Ä—Ç–∏", "–ú–∞–≥–∏—è –ø—É—Å—Ç–æ—Ç—ã", "–ú–∞–≥–∏—è –≠–Ω–µ—Ä–≥–∏–∏"
            ]
        };

        // –°–∏—Å—Ç–µ–º–∞ –∏—Å—Ç–æ—Ä–∏–∏
        let actionHistory = [];
        let currentHistoryIndex = -1;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', function() {
            loadCharacterData();
            renderSkills();
            updateUI();
            updateLevelDisplay();
            updateHistoryButtons();
        });

        // –†–µ–Ω–¥–µ—Ä –Ω–∞–≤—ã–∫–æ–≤
        function renderSkills() {
            const container = document.getElementById('skillsContainer');
            container.innerHTML = '';

            for (const [groupName, skills] of Object.entries(skillsStructure)) {
                const section = document.createElement('div');
                section.className = 'skills-section';
                
                const title = document.createElement('div');
                title.className = 'section-title';
                title.innerHTML = groupName;
                section.appendChild(title);

                skills.forEach(skill => {
                    const skillRow = document.createElement('div');
                    skillRow.className = 'skill-row';
                    skillRow.innerHTML = `
                        <div class="skill-name"><span>üéØ</span><span>${skill}</span></div>
                        <div class="skill-controls">
                            <button class="btn btn-minus" onclick="decreaseSkill('${skill}')" disabled>-</button>
                            <span class="skill-value" id="skill-${skill}">5</span>
                            <button class="btn btn-plus" onclick="increaseSkill('${skill}')">+</button>
                            <button class="btn btn-roll" onclick="rollSkill('${skill}')">–ë—Ä–æ—Å–æ–∫</button>
                        </div>
                    `;
                    section.appendChild(skillRow);
                });
                container.appendChild(section);
            }
        }

        // –°–∏—Å—Ç–µ–º–∞ –∏—Å—Ç–æ—Ä–∏–∏ –¥–µ–π—Å—Ç–≤–∏–π
        function saveStateToHistory() {
            const state = {
                level: getCurrentLevel(),
                exp: getCurrentExp(),
                health: getHealth(),
                mana: getMana(),
                stamina: getStamina(),
                freePoints: getFreePoints(),
                skills: {}
            };

            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Å–µ –Ω–∞–≤—ã–∫–∏
            for (const group of Object.values(skillsStructure)) {
                for (const skill of group) {
                    state.skills[skill] = getSkillValue(skill);
                }
            }

            actionHistory = actionHistory.slice(0, currentHistoryIndex + 1);
            actionHistory.push(state);
            currentHistoryIndex = actionHistory.length - 1;
            updateHistoryButtons();
        }

        function undo() {
            if (currentHistoryIndex > 0) {
                currentHistoryIndex--;
                loadStateFromHistory();
            }
        }

        function redo() {
            if (currentHistoryIndex < actionHistory.length - 1) {
                currentHistoryIndex++;
                loadStateFromHistory();
            }
        }

        function loadStateFromHistory() {
            const state = actionHistory[currentHistoryIndex];
            
            setCurrentLevel(state.level);
            setCurrentExp(state.exp);
            setHealth(state.health);
            setMana(state.mana);
            setStamina(state.stamina);
            setFreePoints(state.freePoints);
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞–≤—ã–∫–∏
            for (const [skill, value] of Object.entries(state.skills)) {
                setSkillValue(skill, value);
            }
            
            updateLevelDisplay();
            updateUI();
            updateHistoryButtons();
        }

        function updateHistoryButtons() {
            document.getElementById('undoBtn').disabled = currentHistoryIndex <= 0;
            document.getElementById('redoBtn').disabled = currentHistoryIndex >= actionHistory.length - 1;
        }

        // –°–∏—Å—Ç–µ–º–∞ –Ω–∞–≤—ã–∫–æ–≤
        function increaseSkill(skillName) {
            saveStateToHistory();
            const freePoints = getFreePoints();
            if (freePoints > 0) {
                const skillValue = getSkillValue(skillName);
                setSkillValue(skillName, skillValue + 1);
                setFreePoints(freePoints - 1);
                updateUI();
                saveCharacterData();
            }
        }

        function decreaseSkill(skillName) {
            saveStateToHistory();
            const skillValue = getSkillValue(skillName);
            if (skillValue > 5) {
                const freePoints = getFreePoints();
                setSkillValue(skillName, skillValue - 1);
                setFreePoints(freePoints + 1);
                updateUI();
                saveCharacterData();
            }
        }

        // –°–∏—Å—Ç–µ–º–∞ —É—Ä–æ–≤–Ω–µ–π
        function addExperience() {
            saveStateToHistory();
            const expToAdd = prompt('–°–∫–æ–ª—å–∫–æ –æ–ø—ã—Ç–∞ –¥–æ–±–∞–≤–∏—Ç—å?');
            if (expToAdd && !isNaN(expToAdd)) {
                let currentExp = getCurrentExp();
                const currentLevel = getCurrentLevel();
                
                currentExp += parseInt(expToAdd);
                setCurrentExp(currentExp);
                
                checkLevelUp();
                updateLevelDisplay();
                saveCharacterData();
            }
        }

        function checkLevelUp() {
            let currentLevel = getCurrentLevel();
            let currentExp = getCurrentExp();
            
            if (currentLevel >= 10) return;
            
            while (currentLevel < 10 && currentExp >= levelTable[currentLevel].expRequired) {
                currentLevel++;
                
                const health = getHealth() + levelTable[currentLevel].hp;
                const mana = getMana() + levelTable[currentLevel].mana;
                const stamina = getStamina() + levelTable[currentLevel].stamina;
                const freePoints = getFreePoints() + levelTable[currentLevel].points;
                
                setHealth(health);
                setMana(mana);
                setStamina(stamina);
                setFreePoints(freePoints);
                
                currentExp = currentExp - levelTable[currentLevel-1].expRequired;
                setCurrentExp(currentExp);
                
                setCurrentLevel(currentLevel);
                
                showMessage(`üéâ –£—Ä–æ–≤–µ–Ω—å –ø–æ–≤—ã—à–µ–Ω –¥–æ ${currentLevel}!`);
            }
        }

        function editLevel() {
            saveStateToHistory();
            const newLevel = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π —É—Ä–æ–≤–µ–Ω—å (1-10):', getCurrentLevel());
            if (newLevel && !isNaN(newLevel) && newLevel >= 1 && newLevel <= 10) {
                setCurrentLevel(parseInt(newLevel));
                updateStatsForLevel();
                updateLevelDisplay();
                saveCharacterData();
            }
        }

        function updateStatsForLevel() {
            const currentLevel = getCurrentLevel();
            let totalHP = 100, totalMana = 100, totalStamina = 100;
            
            for (let i = 1; i <= currentLevel; i++) {
                totalHP += levelTable[i].hp;
                totalMana += levelTable[i].mana;
                totalStamina += levelTable[i].stamina;
            }
            
            setHealth(totalHP);
            setMana(totalMana);
            setStamina(totalStamina);
        }

        function convertExpToPoints() {
            saveStateToHistory();
            const currentExp = getCurrentExp();
            const availablePoints = Math.floor(currentExp / 1000);
            
            if (availablePoints > 0) {
                const expToConvert = availablePoints * 1000;
                setCurrentExp(currentExp - expToConvert);
                setFreePoints(getFreePoints() + availablePoints);
                
                showMessage(`üíé –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ ${availablePoints} –æ—á–∫–æ–≤ –Ω–∞–≤—ã–∫–æ–≤!`);
                updateLevelDisplay();
                updateUI();
                saveCharacterData();
            }
        }

        function updateLevelDisplay() {
            const currentLevel = getCurrentLevel();
            const currentExp = getCurrentExp();
            const convertBtn = document.getElementById('convertBtn');
            const convertInfo = document.getElementById('convertInfo');
            
            document.getElementById('currentLevel').textContent = currentLevel;
            document.getElementById('currentExp').value = currentExp;
            
            if (currentLevel < 10) {
                document.getElementById('requiredExp').textContent = levelTable[currentLevel].expRequired;
                convertBtn.style.display = 'none';
                convertInfo.style.display = 'none';
            } else {
                document.getElementById('requiredExp').textContent = 'MAX';
                convertBtn.style.display = 'block';
                convertInfo.style.display = 'block';
            }
        }

        function showLevelsTable() {
            const currentLevel = getCurrentLevel();
            const popup = document.createElement('div');
            popup.className = 'levels-popup';
            popup.innerHTML = `
                <div class="levels-content">
                    <h2>üìä –¢–∞–±–ª–∏—Ü–∞ —É—Ä–æ–≤–Ω–µ–π</h2>
                    <table class="levels-table">
                        <tr><th>–£—Ä.</th><th>–û–ø—ã—Ç</th><th>–•–ü</th><th>–ú–∞–Ω–∞</th><th>–°—Ç–∞–º–∏–Ω–∞</th><th>–û—á–∫–∏</th></tr>
                        ${Object.entries(levelTable).map(([level, data]) => `
                            <tr class="${level == currentLevel ? 'current-level' : ''}">
                                <td>${level}</td>
                                <td>${data.expRequired || 'MAX'}</td>
                                <td>${data.hp}</td>
                                <td>${data.mana}</td>
                                <td>${data.stamina}</td>
                                <td>${data.points}</td>
                            </tr>
                        `).join('')}
                    </table>
                    <button class="btn close-btn" onclick="this.closest('.levels-popup').remove()" style="background: #34495e; color: white; padding: 10px 25px; margin-top: 15px;">–ó–∞–∫—Ä—ã—Ç—å</button>
                </div>
            `;
            document.body.appendChild(popup);
        }

        // –°–∏—Å—Ç–µ–º–∞ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫
        function changeStat(stat, value) {
            saveStateToHistory();
            const input = document.getElementById(stat);
            let currentValue = parseInt(input.value) || 0;
            let newValue = currentValue + value;
            
            if (newValue < 0) newValue = 0;
            
            input.value = newValue;
            saveCharacterData();
        }

        function editFreePoints() {
            saveStateToHistory();
            const newPoints = prompt('–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–≤–æ–±–æ–¥–Ω—ã—Ö –æ—á–∫–æ–≤:', getFreePoints());
            if (newPoints && !isNaN(newPoints)) {
                setFreePoints(parseInt(newPoints));
                updateUI();
                saveCharacterData();
            }
        }

        // –ë—Ä–æ—Å–∫–∏ –Ω–∞–≤—ã–∫–æ–≤
        function rollSkill(skillName) {
            const skillValue = getSkillValue(skillName);
            const roll1 = Math.floor(Math.random() * 6) + 1;
            const roll2 = Math.floor(Math.random() * 6) + 1;
            const roll3 = Math.floor(Math.random() * 6) + 1;
            const totalRoll = roll1 + roll2 + roll3;

            let resultType, resultText, resultClass;
            if (totalRoll === 3 || totalRoll === 4) {
                resultText = "üí´ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –£–°–ü–ï–•!";
                resultClass = "critical-success";
            } else if (totalRoll === 17 || totalRoll === 18) {
                resultText = "üí• –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –ü–†–û–í–ê–õ!";
                resultClass = "critical-failure";
            } else if (totalRoll <= skillValue) {
                resultText = "‚úÖ –£–°–ü–ï–•!";
                resultClass = "success";
            } else {
                resultText = "‚ùå –ù–ï–£–î–ê–ß–ê!";
                resultClass = "failure";
            }

            showRollResult(skillName, skillValue, [roll1, roll2, roll3], totalRoll, resultText, resultClass);
        }

        function showRollResult(skillName, skillValue, dice, total, resultText, resultClass) {
            const popup = document.createElement('div');
            popup.className = 'result-popup';
            popup.innerHTML = `
                <div class="result-content">
                    <h2>–ë—Ä–æ—Å–æ–∫ –Ω–∞ "${skillName}" (${skillValue})</h2>
                    <div class="dice-rolls">
                        <div class="dice">${dice[0]}</div>
                        <div class="dice">${dice[1]}</div>
                        <div class="dice">${dice[2]}</div>
                    </div>
                    <div style="font-size: 1.5em; margin: 15px 0;">${dice.join(' + ')} = ${total}</div>
                    <div class="${resultClass}">${resultText}</div>
                    <button class="btn close-btn" onclick="this.closest('.result-popup').remove()" style="background: #34495e; color: white; padding: 10px 25px; margin-top: 15px;">–ó–∞–∫—Ä—ã—Ç—å</button>
                </div>
            `;
            document.body.appendChild(popup);
        }

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        function updateUI() {
            const freePoints = getFreePoints();
            const warning = document.getElementById('pointsWarning');
            warning.style.display = freePoints === 0 ? 'block' : 'none';
            
            document.querySelectorAll('.skill-row').forEach(row => {
                const skillName = row.querySelector('.skill-name span:nth-child(2)').textContent;
                const skillValue = getSkillValue(skillName);
                const minusBtn = row.querySelector('.btn-minus');
                const plusBtn = row.querySelector('.btn-plus');
                
                row.querySelector('.skill-value').textContent = skillValue;
                minusBtn.disabled = skillValue <= 5;
                plusBtn.disabled = freePoints <= 0;
            });
        }

        function showMessage(text) {
            alert(text);
        }

        // –ì–µ—Ç—Ç–µ—Ä—ã/—Å–µ—Ç—Ç–µ—Ä—ã
        function getFreePoints() { return parseInt(document.getElementById('freePoints').value) || 20; }
        function setFreePoints(value) { document.getElementById('freePoints').value = value; }

        function getCurrentLevel() { return parseInt(localStorage.getItem('currentLevel')) || 1; }
        function setCurrentLevel(value) { localStorage.setItem('currentLevel', value); }

        function getCurrentExp() { return parseInt(localStorage.getItem('currentExp')) || 0; }
        function setCurrentExp(value) { localStorage.setItem('currentExp', value); }

        function getHealth() { return parseInt(document.getElementById('health').value) || 100; }
        function setHealth(value) { document.getElementById('health').value = value; }

        function getMana() { return parseInt(document.getElementById('mana').value) || 100; }
        function setMana(value) { document.getElementById('mana').value = value; }

        function getStamina() { return parseInt(document.getElementById('stamina').value) || 100; }
        function setStamina(value) { document.getElementById('stamina').value = value; }

        function getSkillValue(skillName) { return parseInt(localStorage.getItem(`skill_${skillName}`)) || 5; }
        function setSkillValue(skillName, value) { localStorage.setItem(`skill_${skillName}`, value); }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ/–∑–∞–≥—Ä—É–∑–∫–∞
        function saveCharacterData() {
            localStorage.setItem('characterName', document.getElementById('characterName').value);
            localStorage.setItem('characterSurname', document.getElementById('characterSurname').value);
            localStorage.setItem('characterTitle', document.getElementById('characterTitle').value);
        }

        function loadCharacterData() {
            document.getElementById('characterName').value = localStorage.getItem('characterName') || '';
            document.getElementById('characterSurname').value = localStorage.getItem('characterSurname') || '';
            document.getElementById('characterTitle').value = localStorage.getItem('characterTitle') || '';
        }

        // –°–ª—É—à–∞—Ç–µ–ª–∏
        document.getElementById('characterName').addEventListener('input', saveCharacterData);
        document.getElementById('characterSurname').addEventListener('input', saveCharacterData);
        document.getElementById('characterTitle').addEventListener('input', saveCharacterData);
        document.getElementById('health').addEventListener('input', saveCharacterData);
        document.getElementById('mana').addEventListener('input', saveCharacterData);
        document.getElementById('stamina').addEventListener('input', saveCharacterData);
        document.getElementById('freePoints').addEventListener('input', function() {
            updateUI();
            saveCharacterData();
        });
        document.getElementById('currentExp').addEventListener('input', function() {
            setCurrentExp(parseInt(this.value) || 0);
            checkLevelUp();
            updateLevelDisplay();
            saveCharacterData();
        });

        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤ –∏—Å—Ç–æ—Ä–∏—é
        setTimeout(saveStateToHistory, 1000);
    </script>
</body>
</html>
