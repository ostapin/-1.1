<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D&D Character Sheet</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            font-family: 'Times New Roman', serif; 
            background: #1a0f0b; 
            color: #e0d0c0; 
            padding: 20px; 
            min-height: 100vh; 
        }
        .container { 
            max-width: 900px; 
            margin: 0 auto; 
            background: #2c1810; 
            border: 3px solid #8b4513; 
            border-radius: 8px; 
            overflow: hidden; 
        }

        .tabs { 
            display: flex; 
            background: linear-gradient(to bottom, #5a3928, #3d2418); 
            border-bottom: 2px solid #8b4513; 
        }
        .tab-btn { 
            flex: 1; 
            padding: 15px; 
            border: none; 
            background: transparent; 
            color: #e0d0c0; 
            font-size: 16px; 
            cursor: pointer; 
            transition: all 0.3s; 
            border-right: 1px solid #8b4513;
            font-family: 'Times New Roman', serif;
        }
        .tab-btn:last-child { border-right: none; }
        .tab-btn.active { 
            background: #8b4513; 
            text-shadow: 0 0 5px #ffd700;
        }
        .tab-content { display: none; padding: 20px; }
        .tab-content.active { display: block; }
        
        .header { 
            background: linear-gradient(to bottom, #3d2418, #2c1810); 
            color: #e0d0c0; 
            padding: 25px; 
            text-align: center; 
            border-bottom: 3px solid #8b4513;
        }
        .character-info { 
            display: flex; 
            gap: 15px; 
            margin-bottom: 15px; 
            flex-wrap: wrap; 
            justify-content: center; 
        }
        .input-group { 
            flex: 1; 
            min-width: 200px; 
        }
        .input-group label { 
            display: block; 
            margin-bottom: 8px; 
            font-weight: bold; 
            color: #d4af37; 
            font-size: 0.9em;
        }
        .input-group input, .input-group select { 
            width: 100%; 
            padding: 12px; 
            border: 2px solid #8b4513; 
            border-radius: 4px; 
            font-size: 16px; 
            background: #1a0f0b; 
            color: #e0d0c0;
        }
        .input-row { 
            display: flex; 
            gap: 10px; 
            align-items: center; 
        }
        
        .level-system { 
            background: #3d2418; 
            padding: 20px; 
            border-bottom: 2px solid #8b4513; 
        }
        .level-display { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 15px; 
        }
        .level-info { 
            font-size: 1.3em; 
            font-weight: bold; 
            color: #d4af37; 
            display: flex; 
            align-items: center; 
            gap: 10px; 
        }
        .exp-display { 
            display: flex; 
            align-items: center; 
            gap: 10px; 
        }
        .exp-input { 
            width: 120px; 
            padding: 10px; 
            border: 2px solid #8b4513; 
            border-radius: 4px; 
            font-size: 16px; 
            text-align: center; 
            background: #1a0f0b;
            color: #e0d0c0;
        }
        
        .stats-panel { 
            padding: 20px; 
            background: #2c1810; 
            border-bottom: 2px solid #5a3928; 
        }
        .stat-row { 
            display: flex; 
            align-items: center; 
            padding: 12px 0; 
            gap: 15px; 
            border-bottom: 1px solid #3d2418;
        }
        .stat-row:last-child { border-bottom: none; }
        .stat-label { 
            flex: 1; 
            font-weight: bold; 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            color: #d4af37;
        }
        .stat-input { 
            width: 100px; 
            padding: 10px; 
            border: 2px solid #8b4513; 
            border-radius: 4px; 
            text-align: center; 
            font-size: 16px; 
            background: #1a0f0b;
            color: #e0d0c0;
        }
        
        .points-panel { 
            padding: 20px; 
            background: #3d2418; 
            border-bottom: 2px solid #8b4513; 
        }
        .points-display { 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 15px; 
        }
        
        .skills-section { 
            padding: 25px; 
            border-bottom: 2px solid #5a3928; 
        }
        .section-title { 
            font-size: 1.5em; 
            color: #d4af37; 
            margin-bottom: 20px; 
            padding-bottom: 12px; 
            border-bottom: 2px solid #8b4513; 
            display: flex; 
            align-items: center; 
            gap: 10px; 
        }
        .skill-row { 
            display: flex; 
            align-items: center; 
            padding: 15px 0; 
            border-bottom: 1px solid #3d2418;
        }
        .skill-row:last-child { border-bottom: none; }
        .skill-name { 
            flex: 2; 
            font-weight: 500; 
            display: flex; 
            align-items: center; 
            gap: 12px; 
        }
        .skill-controls { 
            flex: 1; 
            display: flex; 
            align-items: center; 
            justify-content: flex-end; 
            gap: 12px; 
        }
        .skill-value { 
            font-size: 1.3em; 
            font-weight: bold; 
            color: #d4af37; 
            min-width: 40px; 
            text-align: center; 
        }
        
        .btn { 
            padding: 10px 16px; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
            font-size: 14px; 
            font-weight: bold; 
            transition: all 0.3s; 
        }
        .btn-plus { background: #27ae60; color: white; }
        .btn-minus { background: #c44536; color: white; }
        .btn-roll { background: #8b4513; color: white; }
        .btn-dice { background: #3498db; color: white; margin: 5px; }
        .btn-small { padding: 6px 12px; font-size: 12px; }
        .btn:disabled { 
            background: #5a3928; 
            color: #8b7d6b; 
            cursor: not-allowed; 
        }

        .popup { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(26, 15, 11, 0.95); 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            z-index: 1000; 
        }
        .popup-content { 
            background: #2c1810; 
            padding: 35px; 
            border-radius: 8px; 
            max-width: 90%; 
            width: 500px; 
            max-height: 80vh; 
            overflow-y: auto; 
            border: 3px solid #8b4513;
        }
        .spells-content { width: 800px; text-align: left; }

        .dice-rolls { 
            display: flex; 
            justify-content: center; 
            gap: 20px; 
            margin: 20px 0; 
        }
        .dice { 
            width: 60px; 
            height: 60px; 
            background: #8b4513; 
            border-radius: 8px; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            font-size: 1.8em; 
            font-weight: bold; 
            color: #1a0f0b; 
        }
        
        .success { color: #27ae60; font-weight: bold; font-size: 1.3em; }
        .failure { color: #e74c3c; font-weight: bold; font-size: 1.3em; }
        
        .skill-disabled {
            opacity: 0.4;
            color: #8b7d6b !important;
        }
        .skill-disabled .skill-value {
            color: #8b7d6b !important;
        }

        .spell-icon {
            cursor: pointer;
            margin-left: 10px;
            font-size: 1.2em;
        }

        .spell-item {
            background: #3d2418;
            margin: 10px 0;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid #3498db;
        }
        .spell-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .spell-name {
            font-weight: bold;
            color: #d4af37;
            font-size: 1.2em;
        }
        .spell-order {
            background: #8b4513;
            color: #e0d0c0;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.9em;
        }
        .spell-details {
            color: #b8a28a;
            font-size: 0.95em;
            line-height: 1.4;
        }
        .spell-learned {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 10px;
        }

        .dice-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 20px 0;
            justify-content: center;
            align-items: center;
        }

        .dice-controls {
            display: flex;
            gap: 10px;
            align-items: center;
            justify-content: center;
            margin: 20px 0;
        }

        .dice-count {
            width: 80px;
            padding: 10px;
            border: 2px solid #8b4513;
            border-radius: 4px;
            background: #1a0f0b;
            color: #e0d0c0;
            text-align: center;
        }

        .custom-dice-input {
            width: 80px;
            padding: 10px;
            border: 2px solid #8b4513;
            border-radius: 4px;
            background: #1a0f0b;
            color: #e0d0c0;
            text-align: center;
        }

        .notes-container {
            margin: 20px 0;
        }
        .note-item {
            background: #3d2418;
            margin: 10px 0;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid #27ae60;
        }
        .note-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .note-title {
            font-weight: bold;
            color: #d4af37;
            font-size: 1.2em;
        }
        .note-preview {
            color: #b8a28a;
            font-size: 0.95em;
            line-height: 1.4;
        }
        .note-actions {
            display: flex;
            gap: 10px;
        }

        .search-box {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 2px solid #8b4513;
            border-radius: 4px;
            background: #1a0f0b;
            color: #e0d0c0;
        }

        @media (max-width: 768px) {
            .character-info, .stat-row, .skill-row { flex-direction: column; gap: 12px; }
            .skill-controls { width: 100%; justify-content: space-between; }
            .exp-display, .level-display { flex-direction: column; gap: 15px; }
            .points-display { flex-direction: column; }
            .tabs { flex-direction: column; }
            .dice-container { flex-direction: column; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="tabs">
            <button class="tab-btn active" onclick="openTab('character')">üßô –ü–µ—Ä—Å–æ–Ω–∞–∂</button>
            <button class="tab-btn" onclick="openTab('inventory')">üéí –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</button>
            <button class="tab-btn" onclick="openTab('dice')">üé≤ –ö—É–±–∏–∫–∏</button>
            <button class="tab-btn" onclick="openTab('notes')">‚úçÔ∏è –ó–∞–º–µ—Ç–∫–∏</button>
        </div>

        <div id="character-tab" class="tab-content active">
            <div class="header">
                <h1 style="font-size: 2.5em; color: #d4af37; margin-bottom: 20px;">‚öîÔ∏è D&D Character Sheet</h1>
                <div class="character-info">
                    <div class="input-group">
                        <label for="characterName">–ò–º—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞:</label>
                        <input type="text" id="characterName" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è">
                    </div>
                    <div class="input-group">
                        <label for="characterSurname">–§–∞–º–∏–ª–∏—è:</label>
                        <input type="text" id="characterSurname" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ñ–∞–º–∏–ª–∏—é">
                    </div>
                    <div class="input-group">
                        <label for="characterTitle">–¢–∏—Ç—É–ª:</label>
                        <input type="text" id="characterTitle" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–∏—Ç—É–ª">
                    </div>
                </div>

                <div class="character-info">
                    <div class="input-group">
                        <label for="characterRace">–†–∞—Å–∞:</label>
                        <select id="characterRace" onchange="onRaceChange()">
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞—Å—É</option>
                            <option value="atski">üî• –ê—Ü–∫–∏ (–ü–µ—Ä—Å—ã)</option>
                            <option value="knofi">üó£Ô∏è –ö–Ω–æ—Ñ—ã (–†–∏–º–ª—è–Ω–µ)</option>
                            <option value="vorki">‚ùÑÔ∏è –í–æ—Ä–∫–∏ (–í–∏–∫–∏–Ω–≥–∏)</option>
                            <option value="minci">üéØ –ú–∏–Ω—Ü—ã (–ê–∑–∏–∞—Ç—ã)</option>
                            <option value="kaei">‚öíÔ∏è –ö–∞—ç–π—Ü—ã (–ù–µ–≥—Ä—ã)</option>
                            <option value="forest_elf">üåø –õ–µ—Å–Ω—ã–µ —ç–ª—å—Ñ—ã</option>
                            <option value="high_elf">‚ú® –í—ã—Å—à–∏–µ —ç–ª—å—Ñ—ã</option>
                            <option value="dark_elf">üåë –¢–µ–º–Ω—ã–µ —ç–ª—å—Ñ—ã</option>
                            <option value="dwarf">‚õ∞Ô∏è –î–≤–∞—Ä—Ñ—ã</option>
                            <option value="gnome">üîÆ –ì–Ω–æ–º—ã</option>
                            <option value="orc">üíÄ –û—Ä–∫–∏</option>
                            <option value="goblin">üëπ –ì–æ–±–ª–∏–Ω—ã</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="characterHeritage">–ù–∞—Å–ª–µ–¥–∏–µ:</label>
                        <input type="text" id="characterHeritage" placeholder="–û—Å–æ–±–æ–µ –Ω–∞—Å–ª–µ–¥–∏–µ">
                    </div>
                </div>

                <div class="character-info">
                    <div class="input-group">
                        <label for="characterHeight">–†–æ—Å—Ç (—Å–º):</label>
                        <div class="input-row">
                            <input type="number" id="characterHeight" readonly>
                            <button class="btn" id="generateHeightBtn" onclick="generateHeightForSelectedRace()" style="background: #8b4513; color: white;">üé≤ –ê–≤—Ç–æ</button>
                        </div>
                    </div>
                    <div class="input-group">
                        <label for="characterWeight">–í–µ—Å (–∫–≥):</label>
                        <input type="number" id="characterWeight" placeholder="–í–µ—Å">
                    </div>
                    <div class="input-group">
                        <label for="characterAge">–í–æ–∑—Ä–∞—Å—Ç (–ª–µ—Ç):</label>
                        <input type="number" id="characterAge" placeholder="–í–æ–∑—Ä–∞—Å—Ç">
                    </div>
                </div>
            </div>

            <div class="level-system">
                <div class="level-display">
                    <div class="level-info">
                        –£—Ä–æ–≤–µ–Ω—å: <span id="currentLevel">0</span>
                        <button class="btn btn-roll" onclick="editLevel()">‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å</button>
                        <button class="btn btn-roll" onclick="showLevelsTable()">üìä –¢–∞–±–ª–∏—Ü–∞</button>
                    </div>
                    <div class="exp-display">
                        <input type="number" id="currentExp" class="exp-input" value="0" min="0">
                        <span style="color: #d4af37; font-weight: bold;">/ <span id="requiredExp">1000</span> XP</span>
                        <button class="btn btn-plus" onclick="addExperience()">‚ûï –û–ø—ã—Ç</button>
                        <button class="btn btn-roll" id="convertBtn" onclick="convertExpToPoints()" style="display: none;">üíé –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                    </div>
                </div>
            </div>

            <div class="stats-panel">
                <div class="stat-row">
                    <div class="stat-label">‚ù§Ô∏è –ó–¥–æ—Ä–æ–≤—å–µ:</div>
                    <input type="number" class="stat-input" id="health" value="100">
                    <button class="btn btn-minus" onclick="changeStat('health', -5)">-5</button>
                    <button class="btn btn-plus" onclick="changeStat('health', 5)">+5</button>
                </div>
                <div class="stat-row">
                    <div class="stat-label">üîÆ –ú–∞–Ω–∞:</div>
                    <input type="number" class="stat-input" id="mana" value="100">
                    <button class="btn btn-minus" onclick="changeStat('mana', -5)">-5</button>
                    <button class="btn btn-plus" onclick="changeStat('mana', 5)">+5</button>
                </div>
                <div class="stat-row">
                    <div class="stat-label">‚ö° –í—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å:</div>
                    <input type="number" class="stat-input" id="stamina" value="100">
                    <button class="btn btn-minus" onclick="changeStat('stamina', -5)">-5</button>
                    <button class="btn btn-plus" onclick="changeStat('stamina', 5)">+5</button>
                </div>
            </div>

            <div class="points-panel">
                <div class="points-display">
                    <span style="font-size: 1.3em; font-weight: bold; color: #d4af37;">–°–≤–æ–±–æ–¥–Ω—ã–µ –æ—á–∫–∏ –Ω–∞–≤—ã–∫–æ–≤:</span>
                    <input type="number" id="freePoints" class="stat-input" value="0">
                    <button class="btn btn-roll" onclick="editFreePoints()">‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å</button>
                </div>
            </div>

            <div id="skillsContainer"></div>
        </div>

        <div id="inventory-tab" class="tab-content">
            <h2 style="color: #d4af37; text-align: center; margin-bottom: 25px;">üéí –ò–ù–í–ï–ù–¢–ê–†–¨</h2>
            <input type="text" class="search-box" id="inventorySearch" placeholder="üîç –ü–æ–∏—Å–∫ –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–µ...">
            <div id="inventoryContainer"></div>
        </div>

        <div id="dice-tab" class="tab-content">
            <h2 style="color: #d4af37; text-align: center; margin-bottom: 25px;">üé≤ –°–ò–°–¢–ï–ú–ê –ë–†–û–°–ö–û–í</h2>
            
            <div class="dice-controls">
                <span style="color: #d4af37;">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫—É–±–∏–∫–æ–≤:</span>
                <input type="number" id="diceCount" class="dice-count" value="1" min="1" max="10">
            </div>

            <div class="dice-container">
                <button class="btn btn-dice" onclick="rollDice('coin')">ü™ô –ú–æ–Ω–µ—Ç–∫–∞</button>
                <button class="btn btn-dice" onclick="rollDice(4)">D4</button>
                <button class="btn btn-dice" onclick="rollDice(6)">D6</button>
                <button class="btn btn-dice" onclick="rollDice(8)">D8</button>
                <button class="btn btn-dice" onclick="rollDice(10)">D10</button>
                <button class="btn btn-dice" onclick="rollDice(12)">D12</button>
                <button class="btn btn-dice" onclick="rollDice(20)">D20</button>
                <button class="btn btn-dice" onclick="rollDice(100)">D100</button>
                <div style="display: flex; gap: 5px; align-items: center;">
                    <button class="btn btn-dice" onclick="rollCustomDice()">‚ö´ D0</button>
                    <input type="number" id="customDiceSides" class="custom-dice-input" value="6" min="2" max="1000" placeholder="–ì—Ä–∞–Ω–∏">
                </div>
            </div>

            <div id="diceResults" style="margin-top: 30px; text-align: center;"></div>
            <div id="diceHistory" style="margin-top: 20px;"></div>
        </div>

        <div id="notes-tab" class="tab-content">
            <h2 style="color: #d4af37; text-align: center; margin-bottom: 25px;">‚úçÔ∏è –°–ò–°–¢–ï–ú–ê –ó–ê–ú–ï–¢–û–ö</h2>
            
            <div style="text-align: center; margin-bottom: 20px;">
                <button class="btn btn-plus" onclick="showAddNotePopup()">‚ûï –î–æ–±–∞–≤–∏—Ç—å –∑–∞–º–µ—Ç–∫—É</button>
            </div>
            
            <input type="text" class="search-box" id="notesSearch" placeholder="üîç –ü–æ–∏—Å–∫ –≤ –∑–∞–º–µ—Ç–∫–∞—Ö...">
            
            <div class="notes-container" id="notesContainer"></div>
        </div>
    </div>

    <script>
        // –¢–∞–±–ª–∏—Ü–∞ —É—Ä–æ–≤–Ω–µ–π
        const levelTable = {
            0: { expRequired: 1000, hp: 100, mana: 100, stamina: 100, points: 20 },
            1: { expRequired: 3000, hp: 200, mana: 200, stamina: 200, points: 30 },
            2: { expRequired: 5000, hp: 300, mana: 300, stamina: 300, points: 40 },
            3: { expRequired: 8000, hp: 400, mana: 400, stamina: 400, points: 50 },
            4: { expRequired: 12000, hp: 500, mana: 500, stamina: 500, points: 60 },
            5: { expRequired: 16000, hp: 600, mana: 600, stamina: 600, points: 70 },
            6: { expRequired: 20000, hp: 700, mana: 700, stamina: 700, points: 80 },
            7: { expRequired: 25000, hp: 800, mana: 800, stamina: 800, points: 90 },
            8: { expRequired: 30000, hp: 900, mana: 900, stamina: 900, points: 100 },
            9: { expRequired: 100000, hp: 1000, mana: 1000, stamina: 1000, points: 200 }
        };

        // –°–∏—Å—Ç–µ–º–∞ —Ä–∞—Å
        const races = {
            atski: {
                name: "üî• –ê—Ü–∫–∏ (–ü–µ—Ä—Å—ã)",
                description: "50% –∑–∞—â–∏—Ç–∞ –æ—Ç –æ–≥–Ω—è, 100% –Ω–∞ –∞—Ç–∞–∫—É –æ–≥–Ω–µ–º, –ø—É—Å—Ç—ã–Ω—è —ç—Ç–æ –∏—Ö —Å—Ç–∏—Ö–∏—è",
                lifespan: "350 –ª–µ—Ç",
                bonuses: { "–ú–∞–≥–∏—è –æ–≥–Ω—è": 2 },
                limitations: {}
            },
            knofi: {
                name: "üó£Ô∏è –ö–Ω–æ—Ñ—ã (–†–∏–º–ª—è–Ω–µ)", 
                description: "+1 –∫ –∫—Ä–∞—Å–Ω–æ—Ä–µ—á–∏—é, –∑–Ω–∞–Ω–∏–µ 3 —è–∑—ã–∫–æ–≤",
                lifespan: "400 –ª–µ—Ç",
                bonuses: { "–ö—Ä–∞—Å–Ω–æ—Ä–µ—á–∏–µ": 1 },
                limitations: {}
            },
            vorki: {
                name: "‚ùÑÔ∏è –í–æ—Ä–∫–∏ (–í–∏–∫–∏–Ω–≥–∏)",
                description: "50% –∑–∞—â–∏—Ç–∞ –æ—Ç –ª—å–¥—É, +100% –Ω–∞ –∞—Ç–∞–∫—É –ª—å–¥–æ–º",
                lifespan: "250 –ª–µ—Ç",
                bonuses: { "–ú–∞–≥–∏—è –≤–æ–¥—ã": 2 },
                limitations: {}
            },
            minci: {
                name: "üéØ –ú–∏–Ω—Ü—ã (–ê–∑–∏–∞—Ç—ã)",
                description: "+1 –∫ –¥—Ä–µ–≤–∫–æ–≤–æ–º—É, +1 –∫ –ª–æ–≤–∫–æ—Å—Ç–∏, +1 –≤—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç–∏",
                lifespan: "350 –ª–µ—Ç", 
                bonuses: { "–î—Ä–µ–≤–∫–æ–≤–æ–µ": 1, "–õ–æ–≤–∫–æ—Å—Ç—å": 1, "–í—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å": 1 },
                limitations: { "–î—Ä–µ–≤–∫–æ–≤–æ–µ": 19 }
            },
            kaei: {
                name: "‚öíÔ∏è –ö–∞—ç–π—Ü—ã (–ù–µ–≥—Ä—ã)",
                description: "–° —Ä–æ–∂–¥–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–Ω–∞ —Å—Ç–∏—Ö–∏—è –º–µ—Ç–∞–ª–ª–∞",
                lifespan: "300 –ª–µ—Ç",
                bonuses: { "–ú–∞–≥–∏—è –º–µ—Ç–∞–ª–ª–∞": 2 },
                limitations: {}
            },
            forest_elf: {
                name: "üåø –õ–µ—Å–Ω—ã–µ —ç–ª—å—Ñ—ã", 
                description: "–° —Ä–æ–∂–¥–µ–Ω–∏—è –æ–±–ª–∞–¥–∞—é—Ç –º–∞–≥–∏–µ–π –ø—Ä–∏—Ä–æ–¥—ã",
                lifespan: "700 –ª–µ—Ç",
                bonuses: { "–ú–∞–≥–∏—è –ø—Ä–∏—Ä–æ–¥—ã": 2 },
                limitations: {}
            },
            high_elf: {
                name: "‚ú® –í—ã—Å—à–∏–µ —ç–ª—å—Ñ—ã",
                description: "–° —Ä–æ–∂–¥–µ–Ω–∏—è –æ–±–ª–∞–¥–∞—é—Ç –¥–≤—É–º—è —Å—Ç–∏—Ö–∏—è–º–∏",
                lifespan: "2000 –ª–µ—Ç", 
                bonuses: { },
                limitations: { "–í—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å": 19 }
            },
            dark_elf: {
                name: "üåë –¢–µ–º–Ω—ã–µ —ç–ª—å—Ñ—ã",
                description: "–° —Ä–æ–∂–¥–µ–Ω–∏—è –≤–ª–∞–¥–µ—é—Ç –º–∞–≥–∏–µ–π —Ç—å–º—ã", 
                lifespan: "700 –ª–µ—Ç",
                bonuses: { "–ú–∞–≥–∏—è —Ç—å–º—ã": 2 },
                limitations: {}
            },
            dwarf: {
                name: "‚õ∞Ô∏è –î–≤–∞—Ä—Ñ—ã",
                description: "–ü—Ä–∏—Ä–æ–∂–¥–µ–Ω–Ω—ã–µ –∫—É–∑–Ω–µ—Ü—ã, –≤–æ–∏–Ω—Å—Ç–≤–µ–Ω–Ω–∞—è —Ä–∞—Å–∞",
                lifespan: "600 –ª–µ—Ç",
                bonuses: { "–ö—É–∑–Ω–µ—á–Ω–æ–µ –¥–µ–ª–æ": 1 },
                limitations: { "–ö—É–∑–Ω–µ—á–Ω–æ–µ –¥–µ–ª–æ": 19, "–õ–æ–≤–∫–æ—Å—Ç—å": 19 }
            },
            gnome: {
                name: "üîÆ –ì–Ω–æ–º—ã", 
                description: "–ò–∑–æ–±—Ä–µ—Ç–∞—Ç–µ–ª—å–Ω—ã–µ –∏ –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–µ",
                lifespan: "800 –ª–µ—Ç",
                bonuses: { "–†–µ–º–µ—Å–ª–æ": 1 },
                limitations: { "–õ–æ–≤–∫–æ—Å—Ç—å": 19, "–í—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å": 19, "–†–µ–º–µ—Å–ª–æ": 19 }
            },
            orc: {
                name: "üíÄ –û—Ä–∫–∏",
                description: "–õ—É—á—à–∏–µ –±–æ–π—Ü—ã, –ø—Ä–µ–∑–∏—Ä–∞—é—Ç –º–∞–≥–∏—é",
                lifespan: "400 –ª–µ—Ç", 
                bonuses: { "–¢—è–∂—ë–ª–∞—è –±—Ä–æ–Ω—è": 1, "–î–≤—É—Ä—É—á–Ω–æ–µ –æ—Ä—É–∂–∏–µ": 1 },
                limitations: { "–¢—è–∂—ë–ª–∞—è –±—Ä–æ–Ω—è": 20, "–î–≤—É—Ä—É—á–Ω–æ–µ –æ—Ä—É–∂–∏–µ": 20 }
            },
            goblin: {
                name: "üëπ –ì–æ–±–ª–∏–Ω—ã",
                description: "–•–∏—Ç—Ä—ã–µ –∏ –±—ã—Å—Ç—Ä–æ —É—á–∞—Ç—Å—è, –Ω–µ –º–æ–≥—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –º–∞–≥–∏—é",
                lifespan: "25 –ª–µ—Ç", 
                bonuses: {},
                limitations: { 
                    "–ú–∞–≥–∏—è –≤–æ–¥—ã": 0, "–ú–∞–≥–∏—è –∑–µ–º–ª–∏": 0, "–ú–∞–≥–∏—è –≤–æ–∑–¥—É—Ö–∞": 0, "–ú–∞–≥–∏—è –æ–≥–Ω—è": 0, 
                    "–ú–∞–≥–∏—è –∫—Ä–æ–≤–∏": 0, "–ú–∞–≥–∏—è –º–µ—Ç–∞–ª–ª–∞": 0, "–ú–∞–≥–∏—è –ø—Ä–∏—Ä–æ–¥—ã": 0, "–ú–∞–≥–∏—è —Å–≤–µ—Ç–∞": 0, 
                    "–ú–∞–≥–∏—è —Ç—å–º—ã": 0, "–ú–∞–≥–∏—è –∏–Ω—Ñ–µ—Ä–Ω–æ": 0, "–ú–∞–≥–∏—è —Ö–∞–æ—Å–∞": 0, "–ú–∞–≥–∏—è —Ä–∞–∑—É–º–∞": 0, 
                    "–ú–∞–≥–∏—è –ñ–∏–∑–Ω–∏": 0, "–ú–∞–≥–∏—è —Å–º–µ—Ä—Ç–∏": 0, "–ú–∞–≥–∏—è –ø—É—Å—Ç–æ—Ç—ã": 0, "–ú–∞–≥–∏—è –≠–Ω–µ—Ä–≥–∏–∏": 0, 
                    "–ê–ª—Ö–∏–º–∏—è": 0, "–ó–∞—á–∞—Ä–æ–≤–∞–Ω–∏–µ": 0 
                }
            }
        };

        // –î–∏–∞–ø–∞–∑–æ–Ω—ã —Ä–æ—Å—Ç–∞ –¥–ª—è —Ä–∞—Å
        const raceHeightRanges = {
            atski: { min: 140, max: 210 },
            knofi: { min: 135, max: 205 },
            vorki: { min: 150, max: 220 },
            minci: { min: 130, max: 200 },
            kaei: { min: 140, max: 225 },
            forest_elf: { min: 150, max: 210 },
            high_elf: { min: 170, max: 270 },
            dark_elf: { min: 160, max: 230 },
            dwarf: { min: 110, max: 160 },
            gnome: { min: 40, max: 80 },
            orc: { min: 200, max: 350 },
            goblin: { min: 90, max: 150 }
        };

        // –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –Ω–∞–≤—ã–∫–æ–≤
        const skillsStructure = {
            "‚öîÔ∏è –ë–û–ï–í–´–ï –ù–ê–í–´–ö–ò": [
                "–¢—è–∂—ë–ª–∞—è –±—Ä–æ–Ω—è", "–õ—ë–≥–∫–∞—è –±—Ä–æ–Ω—è", "–î–≤—É—Ä—É—á–Ω–æ–µ –æ—Ä—É–∂–∏–µ", 
                "–û–¥–Ω–æ—Ä—É—á–Ω–æ–µ –æ—Ä—É–∂–∏–µ", "–°—Ç—Ä–µ–ª—å–±–∞", "–ë–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∏–µ", 
                "–î—Ä–µ–≤–∫–æ–≤–æ–µ", "–†—É–∫–æ–ø–∞—à–Ω—ã–π –±–æ–π", "–ú–µ—Ç–∞–Ω–∏–µ"
            ],
            "üé≠ –û–ë–©–ò–ï –ù–ê–í–´–ö–ò": [
                "–°–∫—Ä—ã—Ç–Ω–æ—Å—Ç—å", "–ö—Ä–∞—Å–Ω–æ—Ä–µ—á–∏–µ", "–õ–æ–≤–∫–æ—Å—Ç—å", "–í—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å",
                "–í–∑–ª–æ–º", "–í–æ—Å–ø—Ä–∏—è—Ç–∏–µ", "–£–¥–∞—á–∞", "–ö–∞—Ä–º–∞–Ω–Ω—ã–µ –∫—Ä–∞–∂–∏"
            ],
            "‚öóÔ∏è –†–ï–ú–ï–°–õ–ê": [
                "–ê–ª—Ö–∏–º–∏—è", "–ö—É–∑–Ω–µ—á–Ω–æ–µ –¥–µ–ª–æ", "–ó–∞—á–∞—Ä–æ–≤–∞–Ω–∏–µ", "–†–µ–º–µ—Å–ª–æ"
            ],
            "üîÆ –ú–ê–ì–ò–Ø": [
                "–ú–∞–≥–∏—è –≤–æ–¥—ã", "–ú–∞–≥–∏—è –∑–µ–º–ª–∏", "–ú–∞–≥–∏—è –≤–æ–∑–¥—É—Ö–∞", "–ú–∞–≥–∏—è –∫—Ä–æ–≤–∏",
                "–ú–∞–≥–∏—è –æ–≥–Ω—è", "–ú–∞–≥–∏—è –º–µ—Ç–∞–ª–ª–∞", "–ú–∞–≥–∏—è –ø—Ä–∏—Ä–æ–¥—ã", "–ú–∞–≥–∏—è —Å–≤–µ—Ç–∞",
                "–ú–∞–≥–∏—è —Ç—å–º—ã", "–ú–∞–≥–∏—è –∏–Ω—Ñ–µ—Ä–Ω–æ", "–ú–∞–≥–∏—è —Ö–∞–æ—Å–∞", "–ú–∞–≥–∏—è —Ä–∞–∑—É–º–∞",
                "–ú–∞–≥–∏—è –ñ–∏–∑–Ω–∏", "–ú–∞–≥–∏—è —Å–º–µ—Ä—Ç–∏", "–ú–∞–≥–∏—è –ø—É—Å—Ç–æ—Ç—ã", "–ú–∞–≥–∏—è –≠–Ω–µ—Ä–≥–∏–∏"
            ]
        };

        // –ó–∞–∫–ª–∏–Ω–∞–Ω–∏—è –º–∞–≥–∏–∏ –≤–æ–¥—ã (35 –∑–∞–∫–ª–∏–Ω–∞–Ω–∏–π)
        const waterSpells = [
            {
                name: "–†–æ—Å–∞",
                order: 10,
                effect: "–ó–∞–∫–ª–∏–Ω–∞–Ω–∏–µ –ø–æ–∫—Ä—ã–≤–∞–µ—Ç —Ç–µ–ª–æ –∏ –æ–¥–µ–∂–¥—É –º–∞–≥–∞ —Ç–æ–Ω–∫–æ–π –ø—Ä–æ–∑—Ä–∞—á–Ω–æ–π –≤–æ–¥—è–Ω–æ–π –ø–ª—ë–Ω–∫–æ–π, –ø–æ–º–æ–≥–∞—é—â–µ–π –∏–∑–±–µ–∂–∞—Ç—å –∏—Å—Å—É—à–µ–Ω–∏—è –æ—Ä–≥–∞–Ω–∏–∑–º–∞ –≤ –ø—É—Å—Ç—ã–Ω–µ –∏–ª–∏ –æ–∫–µ–∞–Ω–µ. –ò–ª–∏ –∂–µ —Å–æ–∑–¥–∞–µ—Ç –≤ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–µ –Ω–∞ –∫–∞–∫–æ–π-–ª–∏–±–æ –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–∏ - –≤–ª–∞–≥—É –∏–∑ –Ω–∏—á–µ–≥–æ.",
                type: "–ó–∞–∫–ª—è—Ç–∏–µ, –Ω–∞–∫–ª–∞–¥—ã–≤–∞–µ–º–æ–µ –Ω–∞ –æ–±–ª–∞—Å—Ç—å, —Ç–æ—á–µ—á–Ω–æ–µ",
                conditions: "2 —Å–µ–∫—É–Ω–¥—ã –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏–∏, 1 –≤–æ–ª—à–µ–±–Ω—ã–π –∂–µ—Å—Ç",
                duration: "–ú–æ–∂–µ—Ç –¥–µ—Ä–∂–∞—Ç—å—Å—è –æ–∫–æ–ª–æ –æ–¥–Ω–æ–≥–æ-–¥–≤—É—Ö —á–∞—Å–æ–≤, —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ —Ä–∞—Å—Å–µ–∏–≤–∞–Ω–∏—è –≤–æ–∑–º–æ–∂–Ω–æ –ø–æ—Å–ª–µ–¥—É—é—â–µ–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ",
                cost: "30 –º–∞–Ω–Ω—ã",
                learned: false
            },
            {
                name: "–†–∂–∞–≤—á–∏–Ω–∞",
                order: 10,
                effect: "–ú–∞–≥–∏—á–µ—Å–∫–∏ —É—Å–∫–æ—Ä—è–µ—Ç –∫–æ—Ä—Ä–æ–∑–∏—é –º–µ—Ç–∞–ª–ª–∞. –ó–∞–∫–ª–∏–Ω–∞–Ω–∏–µ –ø–æ–∑–≤–æ–ª—è–µ—Ç –æ—Å–ª–∞–±–ª—è—Ç—å –∏–ª–∏ —Ä–∞–∑—Ä—É—à–∞—Ç—å –º–µ—Ç–∞–ª–ª–∏—á–µ—Å–∫–∏–µ –æ–±—ä–µ–∫—Ç—ã, –≤ —Ç–æ–º —á–∏—Å–ª–µ –∏ –æ—Ä—É–∂–∏–µ.",
                type: "–ó–∞–∫–ª—è—Ç–∏–µ, –Ω–∞–∫–ª–∞–¥—ã–≤–∞–µ–º–æ–µ –Ω–∞ –æ–±–ª–∞—Å—Ç—å, —Ç–æ—á–µ—á–Ω–æ–µ",
                conditions: "1 —Å–µ–∫—É–Ω–¥–∞ –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏–∏, –ø—Ä–∏ –ø—Ä—è–º–æ–º –∫–æ–Ω—Ç–∞–∫—Ç–µ —Å –º–µ—Ç–∞–ª–ª–æ–º ‚Äì 1 –≤–æ–ª—à–µ–±–Ω—ã–π –∂–µ—Å—Ç. –ü—Ä–∏ –æ–¥–Ω–æ–º –ª–∏—à—å –∑—Ä–∏—Ç–µ–ª—å–Ω–æ–º –∫–æ–Ω—Ç–∞–∫—Ç–µ ‚Äì 2 —Å–µ–∫—É–Ω–¥—ã –∫–æ–Ω—Ü–µ–Ω—Ç—Ä–∞—Ü–∏–∏, 3 –≤–æ–ª—à–µ–±–Ω—ã—Ö –∂–µ—Å—Ç–∞",
                duration: "–ú–µ—Ç–∞–ª–ª –ø–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∑–∞–∫–ª–∏–Ω–∞–Ω–∏—è –Ω–µ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è, –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –º–∞–∫—Å–∏–º—É–º —Ä–∞–∑ –≤ 2 –º–∏–Ω—É—Ç—ã",
                cost: "30 –º–∞–Ω–Ω—ã",
                learned: false
            },
            // ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∑–∞–∫–ª–∏–Ω–∞–Ω–∏—è
        ];

        const spellsBySchool = {
            "–ú–∞–≥–∏—è –≤–æ–¥—ã": waterSpells
        };

        // –°–∏—Å—Ç–µ–º–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –º–∞–≥–∏—á–µ—Å–∫–∏—Ö —à–∫–æ–ª
        let availableMagicSchools = {};
        const baseMagicSchools = ["–ú–∞–≥–∏—è –≤–æ–¥—ã", "–ú–∞–≥–∏—è –∑–µ–º–ª–∏", "–ú–∞–≥–∏—è –≤–æ–∑–¥—É—Ö–∞", "–ú–∞–≥–∏—è –æ–≥–Ω—è"];

        // –°–∏—Å—Ç–µ–º–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –Ω–∞–≤—ã–∫–æ–≤
        let blockedSkills = {};

        // –°–∏—Å—Ç–µ–º–∞ –∑–∞–º–µ—Ç–æ–∫
        let notes = [];

        // –°–∏—Å—Ç–µ–º–∞ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è
        let inventory = {
            weapons: [],
            armor: [],
            potions: [],
            scrolls: [],
            resources: [],
            valuables: [],
            tools: [],
            other: []
        };

        // –ò—Å—Ç–æ—Ä–∏—è –±—Ä–æ—Å–∫–æ–≤ –∫—É–±–∏–∫–æ–≤
        let diceHistory = [];

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', function() {
            loadCharacterData();
            loadNotes();
            loadInventory();
            loadSpells();
            loadBlockedSkills();
            renderSkills();
            renderInventory();
            renderNotes();
            updateUI();
            updateLevelDisplay();
            
            // –°–ª—É—à–∞—Ç–µ–ª–∏ –ø–æ–∏—Å–∫–∞
            document.getElementById('inventorySearch').addEventListener('input', renderInventory);
            document.getElementById('notesSearch').addEventListener('input', renderNotes);
        });

        // === –û–°–ù–û–í–ù–´–ï –§–£–ù–ö–¶–ò–ò ===
        function openTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(tabName + '-tab').classList.add('active');
            event.currentTarget.classList.add('active');
        }

        // === –°–ò–°–¢–ï–ú–ê –†–ê–° ===
        function generateRandomHeight(raceId) {
            const range = raceHeightRanges[raceId];
            return range ? Math.floor(Math.random() * (range.max - range.min + 1)) + range.min : 170;
        }

        function onRaceChange() {
            const raceId = document.getElementById('characterRace').value;
            if (raceId) {
                showRaceInfo(raceId);
            }
        }

        function showRaceInfo(raceId) {
            const race = races[raceId];
            if (!race) return;

            const popup = document.createElement('div');
            popup.className = 'popup';
            popup.innerHTML = `
                <div class="popup-content">
                    <h2 style="color: #d4af37; margin-bottom: 15px;">${race.name}</h2>
                    <p style="margin-bottom: 10px;"><strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong> ${race.description}</p>
                    <p style="margin-bottom: 10px;"><strong>–ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∂–∏–∑–Ω–∏:</strong> ${race.lifespan}</p>
                    
                    ${Object.keys(race.bonuses).length > 0 ? `
                        <p style="margin-bottom: 5px;"><strong>–ë–æ–Ω—É—Å—ã:</strong></p>
                        <ul style="margin-bottom: 15px; margin-left: 20px;">
                            ${Object.entries(race.bonuses).map(([skill, bonus]) => 
                                `<li>${skill}: +${bonus}</li>`
                            ).join('')}
                        </ul>
                    ` : ''}
                    
                    ${Object.keys(race.limitations).length > 0 ? `
                        <p style="margin-bottom: 5px;"><strong>–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:</strong></p>
                        <ul style="margin-bottom: 15px; margin-left: 20px;">
                            ${Object.entries(race.limitations).map(([skill, limit]) => 
                                `<li>${skill}: –º–∞–∫—Å–∏–º—É–º ${limit === 0 ? '–Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ' : limit}</li>`
                            ).join('')}
                        </ul>
                    ` : ''}
                    
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button class="btn btn-plus" onclick="setRace('${raceId}')">‚úÖ –í—ã–±—Ä–∞—Ç—å —Ä–∞—Å—É</button>
                        <button class="btn btn-roll" onclick="this.closest('.popup').remove()">–û—Ç–º–µ–Ω–∞</button>
                    </div>
                </div>
            `;
            document.body.appendChild(popup);
        }

        function setRace(raceId) {
            const race = races[raceId];
            if (!race) return;
            
            // –°–ë–†–û–° –í–°–ï–ô –°–¢–ê–†–û–ô –ú–ê–ì–ò–ò
            resetAllMagicSkills();
            
            availableMagicSchools = {};
            document.getElementById('characterRace').value = raceId;
            
            const randomHeight = generateRandomHeight(raceId);
            document.getElementById('characterHeight').value = randomHeight;
            
            const lifespan = parseInt(race.lifespan);
            document.getElementById('characterAge').value = Math.max(15, Math.floor(lifespan * 0.1));
            
            document.getElementById('generateHeightBtn').disabled = true;
            
            determineAvailableMagicSchools(raceId);
            applyRaceBonuses(raceId);
            
            saveCharacterData();
            document.querySelector('.popup').remove();
            alert(`‚úÖ –†–∞—Å–∞ "${race.name}" –≤—ã–±—Ä–∞–Ω–∞!\nüìè –†–æ—Å—Ç: ${randomHeight} —Å–º\nüîÆ –°—Ç–∞—Ä–∞—è –º–∞–≥–∏—è —Å–±—Ä–æ—à–µ–Ω–∞, –≤—ã–¥–∞–Ω–∞ –Ω–æ–≤–∞—è –ø–æ —Ä–∞—Å–µ`);
        }

        function resetAllMagicSkills() {
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Å–µ –º–∞–≥–∏—á–µ—Å–∫–∏–µ –Ω–∞–≤—ã–∫–∏ –¥–æ 5
            const magicSkills = skillsStructure["üîÆ –ú–ê–ì–ò–Ø"];
            magicSkills.forEach(skill => {
                setSkillValue(skill, 5);
                // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –Ω–∞–≤—ã–∫ –µ—Å–ª–∏ –æ–Ω –±—ã–ª –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω
                if (blockedSkills[skill]) {
                    blockedSkills[skill] = false;
                }
            });
            saveBlockedSkills();
            updateUI();
        }

        function determineAvailableMagicSchools(raceId) {
            availableMagicSchools = {};
            
            switch(raceId) {
                case 'forest_elf':
                    availableMagicSchools["–ú–∞–≥–∏—è –ø—Ä–∏—Ä–æ–¥—ã"] = true;
                    break;
                case 'dark_elf':
                    availableMagicSchools["–ú–∞–≥–∏—è —Ç—å–º—ã"] = true;
                    break;
                case 'high_elf':
                    const shuffled = [...baseMagicSchools].sort(() => 0.5 - Math.random());
                    availableMagicSchools[shuffled[0]] = true;
                    availableMagicSchools[shuffled[1]] = true;
                    break;
                case 'goblin':
                    break;
                default:
                    const randomSchool = baseMagicSchools[Math.floor(Math.random() * baseMagicSchools.length)];
                    availableMagicSchools[randomSchool] = true;
            }
            
            const race = races[raceId];
            if (race && race.limitations) {
                Object.keys(race.limitations).forEach(school => {
                    if (race.limitations[school] === 0) {
                        availableMagicSchools[school] = false;
                    }
                });
            }
            
            updateMagicSkillsDisplay();
        }

        function updateMagicSkillsDisplay() {
            const magicSkills = skillsStructure["üîÆ –ú–ê–ì–ò–Ø"];
            magicSkills.forEach(skill => {
                const skillElement = document.getElementById(`skill-${skill}`);
                if (skillElement) {
                    const skillRow = skillElement.closest('.skill-row');
                    const isAvailable = availableMagicSchools[skill] || getSkillValue(skill) > 5;
                    skillRow.classList.toggle('skill-disabled', !isAvailable);
                }
            });
        }

        function applyRaceBonuses(raceId) {
            const race = races[raceId];
            if (!race || !race.bonuses) return;
            
            Object.entries(race.bonuses).forEach(([skill, bonus]) => {
                const currentValue = getSkillValue(skill);
                setSkillValue(skill, currentValue + bonus);
            });
            
            updateUI();
        }

        function generateHeightForSelectedRace() {
            const selectedRace = document.getElementById('characterRace').value;
            if (!selectedRace) {
                alert('‚ùå –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Ä–∞—Å—É!');
                return;
            }
            
            const randomHeight = generateRandomHeight(selectedRace);
            document.getElementById('characterHeight').value = randomHeight;
            document.getElementById('generateHeightBtn').disabled = true;
            saveCharacterData();
            alert(`üìè –ù–æ–≤—ã–π —Ä–æ—Å—Ç: ${randomHeight} —Å–º`);
        }

        // === –°–ò–°–¢–ï–ú–ê –ù–ê–í–´–ö–û–í ===
        function loadBlockedSkills() {
            const saved = localStorage.getItem('blockedSkills');
            if (saved) {
                blockedSkills = JSON.parse(saved);
            }
        }

        function saveBlockedSkills() {
            localStorage.setItem('blockedSkills', JSON.stringify(blockedSkills));
        }

        function renderSkills() {
            const container = document.getElementById('skillsContainer');
            if (!container) return;
            
            container.innerHTML = '';

            for (const [groupName, skills] of Object.entries(skillsStructure)) {
                const section = document.createElement('div');
                section.className = 'skills-section';
                
                const title = document.createElement('div');
                title.className = 'section-title';
                title.innerHTML = groupName;
                section.appendChild(title);

                skills.forEach(skill => {
                    const skillRow = document.createElement('div');
                    skillRow.className = 'skill-row';
                    
                    const spellIcon = groupName === "üîÆ –ú–ê–ì–ò–Ø" ? 
                        `<span class="spell-icon" onclick="showSpells('${skill}')" title="–ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∑–∞–∫–ª–∏–Ω–∞–Ω–∏—è">üîÆ</span>` : '';
                    
                    skillRow.innerHTML = `
                        <div class="skill-name">
                            <span>üéØ</span>
                            <span>${skill}</span>
                            ${spellIcon}
                        </div>
                        <div class="skill-controls">
                            <button class="btn btn-minus" onclick="decreaseSkill('${skill}')" disabled>-</button>
                            <span class="skill-value" id="skill-${skill}">5</span>
                            <button class="btn btn-plus" onclick="increaseSkill('${skill}')">+</button>
                            <button class="btn btn-roll" onclick="rollSkill('${skill}')">–ë—Ä–æ—Å–æ–∫</button>
                        </div>
                    `;
                    section.appendChild(skillRow);
                });
                container.appendChild(section);
            }
            updateUI();
        }

        function increaseSkill(skillName) {
            // –ï—Å–ª–∏ –Ω–∞–≤—ã–∫ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω - –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫—É
            if (blockedSkills[skillName]) {
                const masterPermission = confirm(
                    `üîì –†–ê–ó–ë–õ–û–ö–ò–†–û–í–ö–ê –ù–ê–í–´–ö–ê\n\n` +
                    `–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –Ω–∞–≤—ã–∫ "${skillName}"?\n` +
                    `–í—ã –ø–æ–ª—É—á–∏–ª–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –º–∞—Å—Ç–µ—Ä–∞?\n\n` +
                    `–ù–∞–∂–º–∏—Ç–µ "–û–ö" –¥–ª—è —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –∏–ª–∏ "–û—Ç–º–µ–Ω–∞" –¥–ª—è –æ—Ç–º–µ–Ω—ã.`
                );
                
                if (masterPermission) {
                    blockedSkills[skillName] = false;
                    saveBlockedSkills();
                    updateUI();
                }
                return;
            }
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –º–∞–≥–∏–∏ –¥–ª—è –í–°–ï–• —Ä–∞—Å
            const isMagicSkill = skillsStructure["üîÆ –ú–ê–ì–ò–Ø"].includes(skillName);
            if (isMagicSkill && !availableMagicSchools[skillName] && getSkillValue(skillName) <= 5) {
                const masterPermission = confirm(
                    `üîÆ –í—ã –ø—ã—Ç–∞–µ—Ç–µ—Å—å –∏–∑—É—á–∏—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—É—é –º–∞–≥–∏—é!\n\n` +
                    `–ù–∞–≤—ã–∫ "${skillName}" –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è –≤–∞—à–µ–π —Ä–∞—Å—ã.\n` +
                    `–í—ã –ø–æ–ª—É—á–∏–ª–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –ú–∞—Å—Ç–µ—Ä–∞ –Ω–∞ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫—É —ç—Ç–æ–π –º–∞–≥–∏–∏?\n\n` +
                    `–ù–∞–∂–º–∏—Ç–µ "–û–ö" –¥–ª—è —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ (–Ω–∞–≤—ã–∫ —Å—Ç–∞–Ω–µ—Ç 5 —É—Ä–æ–≤–Ω—è) –∏–ª–∏ "–û—Ç–º–µ–Ω–∞" –¥–ª—è –æ—Ç–º–µ–Ω—ã.`
                );
                
                if (masterPermission) {
                    availableMagicSchools[skillName] = true;
                    setSkillValue(skillName, 5);
                    updateMagicSkillsDisplay();
                    updateUI();
                    saveCharacterData();
                }
                return;
            }
            
            const freePoints = getFreePoints();
            if (freePoints > 0) {
                const skillValue = getSkillValue(skillName);
                setSkillValue(skillName, skillValue + 1);
                setFreePoints(freePoints - 1);
                updateUI();
                saveCharacterData();
            }
        }

        function decreaseSkill(skillName) {
            const skillValue = getSkillValue(skillName);
            
            // –ï—Å–ª–∏ –Ω–∞–≤—ã–∫ –Ω–∞ 5 - –±–ª–æ–∫–∏—Ä—É–µ–º –µ–≥–æ
            if (skillValue === 5) {
                const masterPermission = confirm(
                    `üîí –ë–õ–û–ö–ò–†–û–í–ö–ê –ù–ê–í–´–ö–ê\n\n` +
                    `–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –Ω–∞–≤—ã–∫ "${skillName}"?\n` +
                    `–í—ã –ø–æ–ª—É—á–∏–ª–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –º–∞—Å—Ç–µ—Ä–∞?\n\n` +
                    `–ù–∞–∂–º–∏—Ç–µ "–û–ö" –¥–ª—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –∏–ª–∏ "–û—Ç–º–µ–Ω–∞" –¥–ª—è –æ—Ç–º–µ–Ω—ã.`
                );
                
                if (masterPermission) {
                    blockedSkills[skillName] = true;
                    saveBlockedSkills();
                    updateUI();
                }
                return;
            }
            
            if (skillValue > 5) {
                const freePoints = getFreePoints();
                setSkillValue(skillName, skillValue - 1);
                setFreePoints(freePoints + 1);
                updateUI();
                saveCharacterData();
            }
        }

        function rollSkill(skillName) {
            const skillValue = getSkillValue(skillName);
            const roll1 = Math.floor(Math.random() * 6) + 1;
            const roll2 = Math.floor(Math.random() * 6) + 1;
            const roll3 = Math.floor(Math.random() * 6) + 1;
            const totalRoll = roll1 + roll2 + roll3;

            let resultText, resultClass;
            if (totalRoll === 3 || totalRoll === 4) {
                resultText = "üí´ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –£–°–ü–ï–•!";
                resultClass = "success";
            } else if (totalRoll === 17 || totalRoll === 18) {
                resultText = "üí• –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –ü–†–û–í–ê–õ!";
                resultClass = "failure";
            } else if (totalRoll <= skillValue) {
                resultText = "‚úÖ –£–°–ü–ï–•!";
                resultClass = "success";
            } else {
                resultText = "‚ùå –ù–ï–£–î–ê–ß–ê!";
                resultClass = "failure";
            }

            showRollResult(skillName, skillValue, [roll1, roll2, roll3], totalRoll, resultText, resultClass);
        }

        function showRollResult(skillName, skillValue, dice, total, resultText, resultClass) {
            const popup = document.createElement('div');
            popup.className = 'popup';
            popup.innerHTML = `
                <div class="popup-content">
                    <h2 style="color: #d4af37;">–ë—Ä–æ—Å–æ–∫ –Ω–∞ "${skillName}" (${skillValue})</h2>
                    <div class="dice-rolls">
                        <div class="dice">${dice[0]}</div>
                        <div class="dice">${dice[1]}</div>
                        <div class="dice">${dice[2]}</div>
                    </div>
                    <div style="font-size: 1.5em; margin: 20px 0; color: #e0d0c0;">${dice.join(' + ')} = ${total}</div>
                    <div class="${resultClass}">${resultText}</div>
                    <button class="btn btn-roll" onclick="this.closest('.popup').remove()" style="margin-top: 20px;">–ó–∞–∫—Ä—ã—Ç—å</button>
                </div>
            `;
            document.body.appendChild(popup);
        }

        // === –°–ò–°–¢–ï–ú–ê –ó–ê–ö–õ–ò–ù–ê–ù–ò–ô ===
        function loadSpells() {
            const saved = localStorage.getItem('characterSpells');
            if (saved) {
                const data = JSON.parse(saved);
                Object.keys(spellsBySchool).forEach(school => {
                    if (data[school]) {
                        spellsBySchool[school] = data[school];
                    }
                });
            }
        }

        function saveSpells() {
            localStorage.setItem('characterSpells', JSON.stringify(spellsBySchool));
        }

        function showSpells(schoolName) {
            if (!availableMagicSchools[schoolName] && getSkillValue(schoolName) <= 5) {
                alert('‚ùå –≠—Ç–∞ —à–∫–æ–ª–∞ –º–∞–≥–∏–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –¥–ª—è –≤–∞—à–µ–π —Ä–∞—Å—ã!');
                return;
            }
            
            const spells = spellsBySchool[schoolName] || [];
            const popup = document.createElement('div');
            popup.className = 'popup';
            
            let spellsHTML = '';
            spells.forEach((spell, index) => {
                spellsHTML += `
                    <div class="spell-item">
                        <div class="spell-header">
                            <span class="spell-name">${spell.name}</span>
                            <span class="spell-order">–ü–æ—Ä—è–¥–æ–∫ ${spell.order}</span>
                        </div>
                        <div class="spell-details">
                            <p><strong>–≠—Ñ—Ñ–µ–∫—Ç:</strong> ${spell.effect}</p>
                            <p><strong>–¢–∏–ø:</strong> ${spell.type}</p>
                            <p><strong>–£—Å–ª–æ–≤–∏—è:</strong> ${spell.conditions}</p>
                            <p><strong>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:</strong> ${spell.duration}</p>
                            <p><strong>–ó–∞—Ç—Ä–∞—Ç—ã:</strong> ${spell.cost}</p>
                        </div>
                        <div class="spell-learned">
                            <input type="checkbox" id="spell-${schoolName}-${index}" 
                                   ${spell.learned ? 'checked' : ''} 
                                   onchange="toggleSpellLearned('${schoolName}', ${index})">
                            <label for="spell-${schoolName}-${index}" style="color: #e0d0c0;">–ò–∑—É—á–µ–Ω–æ</label>
                        </div>
                    </div>
                `;
            });
            
            popup.innerHTML = `
                <div class="popup-content spells-content">
                    <h2 style="color: #d4af37; text-align: center; margin-bottom: 20px;">üîÆ ${schoolName}</h2>
                    <div style="max-height: 60vh; overflow-y: auto;">
                        ${spellsHTML || '<p style="text-align: center; color: #8b7d6b;">–ó–∞–∫–ª–∏–Ω–∞–Ω–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>'}
                    </div>
                    <div style="text-align: center; margin-top: 20px;">
                        <button class="btn btn-roll" onclick="this.closest('.popup').remove()">–ó–∞–∫—Ä—ã—Ç—å</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(popup);
        }

        function toggleSpellLearned(schoolName, spellIndex) {
            if (spellsBySchool[schoolName] && spellsBySchool[schoolName][spellIndex]) {
                spellsBySchool[schoolName][spellIndex].learned = 
                    !spellsBySchool[schoolName][spellIndex].learned;
                saveSpells();
            }
        }

        // === –°–ò–°–¢–ï–ú–ê –ö–£–ë–ò–ö–û–í ===
        function rollDice(diceType) {
            const count = parseInt(document.getElementById('diceCount').value) || 1;
            let results = [];
            let total = 0;
            
            if (diceType === 'coin') {
                for (let i = 0; i < count; i++) {
                    const result = Math.random() > 0.5 ? '–û—Ä—ë–ª' : '–†–µ—à–∫–∞';
                    results.push(result);
                }
            } else {
                for (let i = 0; i < count; i++) {
                    const result = Math.floor(Math.random() * diceType) + 1;
                    results.push(result);
                    total += result;
                }
            }
            
            displayDiceResults(diceType, count, results, total);
            addToDiceHistory(diceType, count, results, total);
        }

        function rollCustomDice() {
            const sides = parseInt(document.getElementById('customDiceSides').value) || 6;
            if (sides < 2) {
                alert('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥—Ä–∞–Ω–µ–π –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –Ω–µ –º–µ–Ω—å—à–µ 2!');
                return;
            }
            rollDice(sides);
        }

        function displayDiceResults(diceType, count, results, total) {
            const container = document.getElementById('diceResults');
            let resultHTML = '';
            
            if (diceType === 'coin') {
                resultHTML = `<h3 style="color: #d4af37;">–ú–æ–Ω–µ—Ç–∫–∞ (${count} —Ä–∞–∑):</h3>`;
                resultHTML += `<div style="font-size: 1.2em; margin: 10px 0;">${results.join(', ')}</div>`;
            } else {
                const diceName = diceType === 0 ? '–ö–∞—Å—Ç–æ–º–Ω—ã–π' : `D${diceType}`;
                resultHTML = `<h3 style="color: #d4af37;">–ë—Ä–æ—Å–æ–∫ ${count}d${diceType}:</h3>`;
                resultHTML += `<div style="font-size: 1.2em; margin: 10px 0;">${results.join(' + ')}`;
                if (count > 1) {
                    resultHTML += ` = <strong>${total}</strong>`;
                }
                resultHTML += `</div>`;
            }
            
            container.innerHTML = resultHTML;
        }

        function addToDiceHistory(diceType, count, results, total) {
            const timestamp = new Date().toLocaleTimeString();
            let entry = {
                timestamp,
                diceType: diceType === 'coin' ? '–ú–æ–Ω–µ—Ç–∫–∞' : `D${diceType}`,
                count,
                results: [...results],
                total
            };
            
            diceHistory.unshift(entry);
            if (diceHistory.length > 10) diceHistory.pop();
            renderDiceHistory();
        }

        function renderDiceHistory() {
            const container = document.getElementById('diceHistory');
            if (diceHistory.length === 0) {
                container.innerHTML = '<p style="color: #8b7d6b; text-align: center;">–ò—Å—Ç–æ—Ä–∏—è –±—Ä–æ—Å–∫–æ–≤ –ø—É—Å—Ç–∞</p>';
                return;
            }
            
            let historyHTML = '<h4 style="color: #d4af37; margin-bottom: 10px;">–ò—Å—Ç–æ—Ä–∏—è –±—Ä–æ—Å–∫–æ–≤:</h4>';
            diceHistory.forEach(entry => {
                if (entry.diceType === '–ú–æ–Ω–µ—Ç–∫–∞') {
                    historyHTML += `<p style="margin: 5px 0;">${entry.timestamp} - ${entry.diceType}: ${entry.results.join(', ')}</p>`;
                } else {
                    historyHTML += `<p style="margin: 5px 0;">${entry.timestamp} - ${entry.count}${entry.diceType}: [${entry.results.join(', ')}]`;
                    if (entry.count > 1) {
                        historyHTML += ` = ${entry.total}`;
                    }
                    historyHTML += `</p>`;
                }
            });
            
            container.innerHTML = historyHTML;
        }

        // === –°–ò–°–¢–ï–ú–ê –ó–ê–ú–ï–¢–û–ö ===
        function loadNotes() {
            const saved = localStorage.getItem('characterNotes');
            if (saved) {
                notes = JSON.parse(saved);
            }
        }

        function saveNotes() {
            localStorage.setItem('characterNotes', JSON.stringify(notes));
        }

        function renderNotes() {
            const container = document.getElementById('notesContainer');
            const searchTerm = document.getElementById('notesSearch').value.toLowerCase();
            
            let filteredNotes = notes;
            if (searchTerm) {
                filteredNotes = notes.filter(note => 
                    note.title.toLowerCase().includes(searchTerm) || 
                    note.content.toLowerCase().includes(searchTerm)
                );
            }
            
            if (filteredNotes.length === 0) {
                container.innerHTML = '<p style="color: #8b7d6b; text-align: center;">–ó–∞–º–µ—Ç–æ–∫ –Ω–µ—Ç</p>';
                return;
            }
            
            let notesHTML = '';
            filteredNotes.forEach((note, index) => {
                const preview = note.content.length > 100 ? note.content.substring(0, 100) + '...' : note.content;
                notesHTML += `
                    <div class="note-item">
                        <div class="note-header">
                            <span class="note-title">${note.title}</span>
                            <div class="note-actions">
                                <button class="btn btn-small" onclick="editNote(${index})" style="background: #3498db;">‚úèÔ∏è</button>
                                <button class="btn btn-small" onclick="deleteNote(${index})" style="background: #c44536;">‚ùå</button>
                                <button class="btn btn-small" onclick="toggleNoteExpand(${index})" style="background: #8b4513;">
                                    ${note.expanded ? '‚ñº' : '‚ñ∂'}
                                </button>
                            </div>
                        </div>
                        <div class="note-preview">
                            ${note.expanded ? note.content : preview}
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = notesHTML;
        }

        function showAddNotePopup() {
            const popup = document.createElement('div');
            popup.className = 'popup';
            popup.innerHTML = `
                <div class="popup-content">
                    <h2 style="color: #d4af37;">–î–æ–±–∞–≤–∏—Ç—å –∑–∞–º–µ—Ç–∫—É</h2>
                    <input type="text" id="noteTitle" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∑–∞–º–µ—Ç–∫–∏" style="width: 100%; padding: 10px; margin: 10px 0; border: 2px solid #8b4513; border-radius: 4px; background: #1a0f0b; color: #e0d0c0;">
                    <textarea id="noteContent" placeholder="–¢–µ–∫—Å—Ç –∑–∞–º–µ—Ç–∫–∏" style="width: 100%; height: 200px; padding: 10px; margin: 10px 0; border: 2px solid #8b4513; border-radius: 4px; background: #1a0f0b; color: #e0d0c0; resize: vertical;"></textarea>
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button class="btn btn-plus" onclick="addNote()">–î–æ–±–∞–≤–∏—Ç—å</button>
                        <button class="btn btn-roll" onclick="this.closest('.popup').remove()">–û—Ç–º–µ–Ω–∞</button>
                    </div>
                </div>
            `;
            document.body.appendChild(popup);
        }

        function addNote() {
            const title = document.getElementById('noteTitle').value.trim();
            const content = document.getElementById('noteContent').value.trim();
            
            if (!title) {
                alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∑–∞–º–µ—Ç–∫–∏!');
                return;
            }
            
            notes.push({
                id: Date.now(),
                title,
                content,
                expanded: false
            });
            
            saveNotes();
            renderNotes();
            document.querySelector('.popup').remove();
        }

        function editNote(index) {
            const note = notes[index];
            const popup = document.createElement('div');
            popup.className = 'popup';
            popup.innerHTML = `
                <div class="popup-content">
                    <h2 style="color: #d4af37;">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–º–µ—Ç–∫—É</h2>
                    <input type="text" id="editNoteTitle" value="${note.title}" style="width: 100%; padding: 10px; margin: 10px 0; border: 2px solid #8b4513; border-radius: 4px; background: #1a0f0b; color: #e0d0c0;">
                    <textarea id="editNoteContent" style="width: 100%; height: 200px; padding: 10px; margin: 10px 0; border: 2px solid #8b4513; border-radius: 4px; background: #1a0f0b; color: #e0d0c0; resize: vertical;">${note.content}</textarea>
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button class="btn btn-plus" onclick="saveEditedNote(${index})">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                        <button class="btn btn-roll" onclick="this.closest('.popup').remove()">–û—Ç–º–µ–Ω–∞</button>
                    </div>
                </div>
            `;
            document.body.appendChild(popup);
        }

        function saveEditedNote(index) {
            const title = document.getElementById('editNoteTitle').value.trim();
            const content = document.getElementById('editNoteContent').value.trim();
            
            if (!title) {
                alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∑–∞–º–µ—Ç–∫–∏!');
                return;
            }
            
            notes[index].title = title;
            notes[index].content = content;
            
            saveNotes();
            renderNotes();
            document.querySelector('.popup').remove();
        }

        function deleteNote(index) {
            if (confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–º–µ—Ç–∫—É?')) {
                notes.splice(index, 1);
                saveNotes();
                renderNotes();
            }
        }

        function toggleNoteExpand(index) {
            notes[index].expanded = !notes[index].expanded;
            saveNotes();
            renderNotes();
        }

        // === –°–ò–°–¢–ï–ú–ê –ò–ù–í–ï–ù–¢–ê–†–Ø ===
        function loadInventory() {
            const saved = localStorage.getItem('inventoryData');
            if (saved) {
                inventory = JSON.parse(saved);
            }
        }

        function saveInventory() {
            localStorage.setItem('inventoryData', JSON.stringify(inventory));
        }

        function renderInventory() {
            const container = document.getElementById('inventoryContainer');
            const searchTerm = document.getElementById('inventorySearch').value.toLowerCase();
            
            let inventoryHTML = '';
            Object.entries(inventory).forEach(([category, items]) => {
                let filteredItems = items;
                if (searchTerm) {
                    filteredItems = items.filter(item => 
                        item.name.toLowerCase().includes(searchTerm) ||
                        (item.details && item.details.toLowerCase().includes(searchTerm)) ||
                        (item.quantity && item.quantity.toString().includes(searchTerm))
                    );
                }
                
                if (filteredItems.length === 0) return;
                
                inventoryHTML += `
                    <div class="skills-section">
                        <div class="section-title">${getCategoryName(category)}</div>
                        ${filteredItems.map((item, index) => `
                            <div class="skill-row">
                                <div class="skill-name">
                                    <span>${getCategoryIcon(category)}</span>
                                    <span>${item.name} ${item.quantity ? '√ó' + item.quantity : ''}</span>
                                </div>
                                <div class="skill-controls">
                                    <span style="color: #b8a28a;">${item.details || ''}</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            });
            
            container.innerHTML = inventoryHTML || '<p style="color: #8b7d6b; text-align: center;">–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å –ø—É—Å—Ç</p>';
        }

        function getCategoryName(category) {
            const names = {
                weapons: '‚öîÔ∏è –û—Ä—É–∂–∏–µ',
                armor: 'üõ°Ô∏è –ë—Ä–æ–Ω—è',
                potions: 'üß™ –ó–µ–ª—å—è',
                scrolls: 'üìú –°–≤–∏—Ç–∫–∏',
                resources: 'üíé –†–µ—Å—É—Ä—Å—ã',
                valuables: 'üí∞ –¶–µ–Ω–Ω–æ—Å—Ç–∏',
                tools: 'üîß –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã',
                other: 'üéí –ü—Ä–æ—á–µ–µ'
            };
            return names[category] || category;
        }

        function getCategoryIcon(category) {
            const icons = {
                weapons: '‚öîÔ∏è',
                armor: 'üõ°Ô∏è',
                potions: 'üß™',
                scrolls: 'üìú',
                resources: 'üíé',
                valuables: 'üí∞',
                tools: 'üîß',
                other: 'üéí'
            };
            return icons[category] || 'üìÅ';
        }

        // === –°–ò–°–¢–ï–ú–ê –£–†–û–í–ù–ï–ô ===
        function addExperience() {
            const expToAdd = prompt('–°–∫–æ–ª—å–∫–æ –æ–ø—ã—Ç–∞ –¥–æ–±–∞–≤–∏—Ç—å?');
            if (expToAdd && !isNaN(expToAdd)) {
                let currentExp = getCurrentExp();
                currentExp += parseInt(expToAdd);
                setCurrentExp(currentExp);
                checkLevelUp();
                updateLevelDisplay();
                saveCharacterData();
            }
        }

        function checkLevelUp() {
            let currentLevel = getCurrentLevel();
            let currentExp = getCurrentExp();
            
            if (currentLevel >= 9) return;
            
            while (currentLevel < 9 && currentExp >= levelTable[currentLevel].expRequired) {
                currentLevel++;
                
                const health = getHealth() + levelTable[currentLevel].hp;
                const mana = getMana() + levelTable[currentLevel].mana;
                const stamina = getStamina() + levelTable[currentLevel].stamina;
                const freePoints = getFreePoints() + levelTable[currentLevel].points;
                
                setHealth(health);
                setMana(mana);
                setStamina(stamina);
                setFreePoints(freePoints);
                
                currentExp = currentExp - levelTable[currentLevel-1].expRequired;
                setCurrentExp(currentExp);
                setCurrentLevel(currentLevel);
                
                alert(`üéâ –£—Ä–æ–≤–µ–Ω—å –ø–æ–≤—ã—à–µ–Ω –¥–æ ${currentLevel}!`);
            }
        }

        function editLevel() {
            const newLevel = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π —É—Ä–æ–≤–µ–Ω—å (0-9):', getCurrentLevel());
            if (newLevel && !isNaN(newLevel) && newLevel >= 0 && newLevel <= 9) {
                setCurrentLevel(parseInt(newLevel));
                updateStatsForLevel();
                updateLevelDisplay();
                saveCharacterData();
            }
        }

        function updateStatsForLevel() {
            const currentLevel = getCurrentLevel();
            let totalHP = 100, totalMana = 100, totalStamina = 100;
            
            for (let i = 0; i <= currentLevel; i++) {
                totalHP += levelTable[i].hp;
                totalMana += levelTable[i].mana;
                totalStamina += levelTable[i].stamina;
            }
            
            setHealth(totalHP);
            setMana(totalMana);
            setStamina(totalStamina);
        }

        function convertExpToPoints() {
            const currentExp = getCurrentExp();
            const availablePoints = Math.floor(currentExp / 1000);
            
            if (availablePoints > 0) {
                const expToConvert = availablePoints * 1000;
                setCurrentExp(currentExp - expToConvert);
                setFreePoints(getFreePoints() + availablePoints);
                
                alert(`üíé –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ ${availablePoints} –æ—á–∫–æ–≤ –Ω–∞–≤—ã–∫–æ–≤!`);
                updateLevelDisplay();
                updateUI();
                saveCharacterData();
            }
        }

        function updateLevelDisplay() {
            const currentLevel = getCurrentLevel();
            const currentExp = getCurrentExp();
            const convertBtn = document.getElementById('convertBtn');
            
            document.getElementById('currentLevel').textContent = currentLevel;
            document.getElementById('currentExp').value = currentExp;
            
            if (currentLevel < 9) {
                document.getElementById('requiredExp').textContent = levelTable[currentLevel].expRequired;
                convertBtn.style.display = 'none';
            } else {
                document.getElementById('requiredExp').textContent = 'MAX';
                convertBtn.style.display = 'block';
            }
        }

        function showLevelsTable() {
            const currentLevel = getCurrentLevel();
            const popup = document.createElement('div');
            popup.className = 'popup';
            popup.innerHTML = `
                <div class="popup-content">
                    <h2 style="color: #d4af37; margin-bottom: 20px;">üìä –¢–∞–±–ª–∏—Ü–∞ —É—Ä–æ–≤–Ω–µ–π</h2>
                    <table style="width: 100%; border-collapse: collapse; margin: 20px 0;">
                        <tr><th style="padding: 8px; border: 1px solid #5a3928; background: #3d2418; color: #d4af37;">–£—Ä.</th><th style="padding: 8px; border: 1px solid #5a3928; background: #3d2418; color: #d4af37;">–û–ø—ã—Ç</th><th style="padding: 8px; border: 1px solid #5a3928; background: #3d2418; color: #d4af37;">–•–ü</th><th style="padding: 8px; border: 1px solid #5a3928; background: #3d2418; color: #d4af37;">–ú–∞–Ω–∞</th><th style="padding: 8px; border: 1px solid #5a3928; background: #3d2418; color: #d4af37;">–°—Ç–∞–º–∏–Ω–∞</th><th style="padding: 8px; border: 1px solid #5a3928; background: #3d2418; color: #d4af37;">–û—á–∫–∏</th></tr>
                        ${Object.entries(levelTable).map(([level, data]) => `
                            <tr style="${level == currentLevel ? 'background: #8b4513; font-weight: bold;' : ''}">
                                <td style="padding: 8px; border: 1px solid #5a3928; text-align: center;">${level}</td>
                                <td style="padding: 8px; border: 1px solid #5a3928; text-align: center;">${data.expRequired || 'MAX'}</td>
                                <td style="padding: 8px; border: 1px solid #5a3928; text-align: center;">+${data.hp}</td>
                                <td style="padding: 8px; border: 1px solid #5a3928; text-align: center;">+${data.mana}</td>
                                <td style="padding: 8px; border: 1px solid #5a3928; text-align: center;">+${data.stamina}</td>
                                <td style="padding: 8px; border: 1px solid #5a3928; text-align: center;">+${data.points}</td>
                            </tr>
                        `).join('')}
                    </table>
                    <button class="btn btn-roll" onclick="this.closest('.popup').remove()">–ó–∞–∫—Ä—ã—Ç—å</button>
                </div>
            `;
            document.body.appendChild(popup);
        }

        // === –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ===
        function changeStat(stat, value) {
            const input = document.getElementById(stat);
            let currentValue = parseInt(input.value) || 0;
            let newValue = currentValue + value;
            if (newValue < 0) newValue = 0;
            input.value = newValue;
            saveCharacterData();
        }

        function editFreePoints() {
            const newPoints = prompt('–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–≤–æ–±–æ–¥–Ω—ã—Ö –æ—á–∫–æ–≤:', getFreePoints());
            if (newPoints && !isNaN(newPoints)) {
                setFreePoints(parseInt(newPoints));
                updateUI();
                saveCharacterData();
            }
        }

        function updateUI() {
            const freePoints = getFreePoints();
            
            document.querySelectorAll('.skill-row').forEach(row => {
                const skillName = row.querySelector('.skill-name span:nth-child(2)').textContent;
                const skillValue = getSkillValue(skillName);
                const minusBtn = row.querySelector('.btn-minus');
                const plusBtn = row.querySelector('.btn-plus');
                const skillValueElement = row.querySelector('.skill-value');
                
                skillValueElement.textContent = skillValue;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–æ–∫ –¥–ª—è –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –Ω–∞–≤—ã–∫–æ–≤
                const isBlocked = blockedSkills[skillName];
                const isMagicDisabled = skillsStructure["üîÆ –ú–ê–ì–ò–Ø"].includes(skillName) && 
                                      !availableMagicSchools[skillName] && 
                                      skillValue <= 5;
                
                if (isBlocked || isMagicDisabled) {
                    row.classList.add('skill-disabled');
                    minusBtn.disabled = true;
                    plusBtn.disabled = true;
                } else {
                    row.classList.remove('skill-disabled');
                    minusBtn.disabled = skillValue <= 5;
                    plusBtn.disabled = freePoints <= 0;
                }
            });
            
            updateMagicSkillsDisplay();
        }

        // –ì–µ—Ç—Ç–µ—Ä—ã/—Å–µ—Ç—Ç–µ—Ä—ã
        function getFreePoints() { 
            const element = document.getElementById('freePoints');
            return element ? parseInt(element.value) || 0 : 0; 
        }
        function setFreePoints(value) { 
            const element = document.getElementById('freePoints');
            if (element) element.value = value; 
        }
        function getCurrentLevel() { return parseInt(localStorage.getItem('currentLevel')) || 0; }
        function setCurrentLevel(value) { localStorage.setItem('currentLevel', value); }
        function getCurrentExp() { return parseInt(localStorage.getItem('currentExp')) || 0; }
        function setCurrentExp(value) { localStorage.setItem('currentExp', value); }
        function getHealth() { 
            const element = document.getElementById('health');
            return element ? parseInt(element.value) || 100 : 100; 
        }
        function setHealth(value) { 
            const element = document.getElementById('health');
            if (element) element.value = value; 
        }
        function getMana() { 
            const element = document.getElementById('mana');
            return element ? parseInt(element.value) || 100 : 100; 
        }
        function setMana(value) { 
            const element = document.getElementById('mana');
            if (element) element.value = value; 
        }
        function getStamina() { 
            const element = document.getElementById('stamina');
            return element ? parseInt(element.value) || 100 : 100; 
        }
        function setStamina(value) { 
            const element = document.getElementById('stamina');
            if (element) element.value = value; 
        }
        function getSkillValue(skillName) { return parseInt(localStorage.getItem(`skill_${skillName}`)) || 5; }
        function setSkillValue(skillName, value) { localStorage.setItem(`skill_${skillName}`, value); }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ/–∑–∞–≥—Ä—É–∑–∫–∞
        function saveCharacterData() {
            localStorage.setItem('characterName', document.getElementById('characterName').value);
            localStorage.setItem('characterSurname', document.getElementById('characterSurname').value);
            localStorage.setItem('characterTitle', document.getElementById('characterTitle').value);
            localStorage.setItem('characterRace', document.getElementById('characterRace').value);
            localStorage.setItem('characterHeritage', document.getElementById('characterHeritage').value);
            localStorage.setItem('characterHeight', document.getElementById('characterHeight').value);
            localStorage.setItem('characterWeight', document.getElementById('characterWeight').value);
            localStorage.setItem('characterAge', document.getElementById('characterAge').value);
            localStorage.setItem('availableMagicSchools', JSON.stringify(availableMagicSchools));
        }

        function loadCharacterData() {
            document.getElementById('characterName').value = localStorage.getItem('characterName') || '';
            document.getElementById('characterSurname').value = localStorage.getItem('characterSurname') || '';
            document.getElementById('characterTitle').value = localStorage.getItem('characterTitle') || '';
            document.getElementById('characterRace').value = localStorage.getItem('characterRace') || '';
            document.getElementById('characterHeritage').value = localStorage.getItem('characterHeritage') || '';
            document.getElementById('characterHeight').value = localStorage.getItem('characterHeight') || '';
            document.getElementById('characterWeight').value = localStorage.getItem('characterWeight') || '';
            document.getElementById('characterAge').value = localStorage.getItem('characterAge') || '';
            
            const savedMagicSchools = localStorage.getItem('availableMagicSchools');
            if (savedMagicSchools) {
                availableMagicSchools = JSON.parse(savedMagicSchools);
            }
            
            if (localStorage.getItem('characterRace')) {
                document.getElementById('generateHeightBtn').disabled = true;
            }
        }

        // –°–ª—É—à–∞—Ç–µ–ª–∏
        document.getElementById('characterName').addEventListener('input', saveCharacterData);
        document.getElementById('characterSurname').addEventListener('input', saveCharacterData);
        document.getElementById('characterTitle').addEventListener('input', saveCharacterData);
        document.getElementById('characterRace').addEventListener('change', saveCharacterData);
        document.getElementById('characterHeritage').addEventListener('input', saveCharacterData);
        document.getElementById('characterHeight').addEventListener('input', saveCharacterData);
        document.getElementById('characterWeight').addEventListener('input', saveCharacterData);
        document.getElementById('characterAge').addEventListener('input', saveCharacterData);
        document.getElementById('health').addEventListener('input', saveCharacterData);
        document.getElementById('mana').addEventListener('input', saveCharacterData);
        document.getElementById('stamina').addEventListener('input', saveCharacterData);
        document.getElementById('freePoints').addEventListener('input', function() {
            updateUI();
            saveCharacterData();
        });
        document.getElementById('currentExp').addEventListener('input', function() {
            setCurrentExp(parseInt(this.value) || 0);
            checkLevelUp();
            updateLevelDisplay();
            saveCharacterData();
        });
    </script>
</body>
</html>
