<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D&D –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –ë–æ–µ–≤–∞—è –°–∏—Å—Ç–µ–º–∞</title>
    <style>
        /* –ë–ê–ó–û–í–´–ï –°–¢–ò–õ–ò */
        * { 
            box-sizing: border-box; 
            margin: 0; 
            padding: 0; 
        }
        
        body { 
            font-family: 'Times New Roman', serif; 
            background: #1a0f0b; 
            color: #e0d0c0; 
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* –°–¢–ò–õ–ò –í–ö–õ–ê–î–û–ö */
        .tabs {
            display: flex;
            background: linear-gradient(to bottom, #5a3928, #3d2418);
            border-bottom: 2px solid #8b4513;
            flex-wrap: wrap;
        }

        .tab-btn {
            flex: 1;
            min-width: 120px;
            padding: 15px 10px;
            border: none;
            background: transparent;
            color: #e0d0c0;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            border-right: 1px solid #8b4513;
            font-family: 'Times New Roman', serif;
        }

        .tab-btn:last-child { border-right: none; }
        .tab-btn.active { 
            background: #8b4513; 
            text-shadow: 0 0 5px #ffd700;
        }

        .tab-content { 
            display: none; 
            padding: 20px; 
            background: #2c1810;
            border: 2px solid #8b4513;
            border-top: none;
        }

        .tab-content.active { display: block; }

        /* –û–ë–©–ò–ï –°–¢–ò–õ–ò –ö–ù–û–ü–û–ö */
        .btn {
            padding: 12px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s;
            min-height: 44px;
            font-family: 'Times New Roman', serif;
        }

        .btn-plus { background: #27ae60; color: white; }
        .btn-minus { background: #c44536; color: white; }
        .btn-roll { background: #8b4513; color: white; }
        .btn-dice { background: #3498db; color: white; margin: 5px; }

        /* –ó–ê–ì–û–õ–û–í–ö–ò –°–ï–ö–¶–ò–ô */
        .section-title {
            font-size: 1.5em;
            color: #d4af37;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid #8b4513;
        }

        /* –ê–î–ê–ü–¢–ò–í–ù–û–°–¢–¨ */
        @media (max-width: 768px) {
            .tabs { flex-direction: column; }
            .tab-btn { min-width: 100%; }
            .container { padding: 10px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- –í–ö–õ–ê–î–ö–ò -->
        <div class="tabs">
            <button class="tab-btn active" onclick="openTab('character')">üßô –ü–µ—Ä—Å–æ–Ω–∞–∂</button>
            <button class="tab-btn" onclick="openTab('combat')">‚öîÔ∏è –ë–æ–π</button>
            <button class="tab-btn" onclick="openTab('generator')">üé≤ –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä</button>
            <button class="tab-btn" onclick="openTab('inventory')">üéí –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</button>
            <button class="tab-btn" onclick="openTab('dice')">üé≤ –ö—É–±–∏–∫–∏</button>
            <button class="tab-btn" onclick="openTab('notes')">‚úçÔ∏è –ó–∞–º–µ—Ç–∫–∏</button>
            <button class="tab-btn" onclick="openTab('characters')">üë• –ü–µ—Ä—Å–æ–Ω–∞–∂–∏</button>
        </div>

        <!-- –°–û–î–ï–†–ñ–ò–ú–û–ï –í–ö–õ–ê–î–û–ö -->
        <div id="character-tab" class="tab-content active">
            <h2 class="section-title">üßô –õ–∏—Å—Ç –ø–µ—Ä—Å–æ–Ω–∞–∂–∞</h2>
            <!-- –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ –±—É–¥–µ—Ç –≤ —Å–ª–µ–¥—É—é—â–∏—Ö —á–∞—Å—Ç—è—Ö -->
        </div>

        <div id="combat-tab" class="tab-content">
            <h2 class="section-title">‚öîÔ∏è –ë–æ–µ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞</h2>
            <!-- –ë–æ–µ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ –±—É–¥–µ—Ç –≤ —Å–ª–µ–¥—É—é—â–∏—Ö —á–∞—Å—Ç—è—Ö -->
        </div>

        <div id="generator-tab" class="tab-content">
            <h2 class="section-title">üé≤ –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä—ã</h2>
            <!-- –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä—ã –±—É–¥—É—Ç –≤ —Å–ª–µ–¥—É—é—â–∏—Ö —á–∞—Å—Ç—è—Ö -->
        </div>

        <div id="inventory-tab" class="tab-content">
            <h2 class="section-title">üéí –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</h2>
            <!-- –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å –±—É–¥–µ—Ç –≤ —Å–ª–µ–¥—É—é—â–∏—Ö —á–∞—Å—Ç—è—Ö -->
        </div>

        <div id="dice-tab" class="tab-content">
            <h2 class="section-title">üé≤ –°–∏—Å—Ç–µ–º–∞ –∫—É–±–∏–∫–æ–≤</h2>
            <!-- –ö—É–±–∏–∫–∏ –±—É–¥—É—Ç –≤ —Å–ª–µ–¥—É—é—â–∏—Ö —á–∞—Å—Ç—è—Ö -->
        </div>

        <div id="notes-tab" class="tab-content">
            <h2 class="section-title">‚úçÔ∏è –ó–∞–º–µ—Ç–∫–∏</h2>
            <!-- –ó–∞–º–µ—Ç–∫–∏ –±—É–¥—É—Ç –≤ —Å–ª–µ–¥—É—é—â–∏—Ö —á–∞—Å—Ç—è—Ö -->
        </div>

        <div id="characters-tab" class="tab-content">
            <h2 class="section-title">üë• –ú–µ–Ω–µ–¥–∂–µ—Ä –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π</h2>
            <!-- –ú–µ–Ω–µ–¥–∂–µ—Ä –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π –±—É–¥–µ—Ç –≤ —Å–ª–µ–¥—É—é—â–∏—Ö —á–∞—Å—Ç—è—Ö -->
        </div>
    </div>

    <script>
        // –ë–ê–ó–û–í–´–ï –§–£–ù–ö–¶–ò–ò –î–õ–Ø –í–ö–õ–ê–î–û–ö
        function openTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(tabName + '-tab').classList.add('active');
            event.currentTarget.classList.add('active');
        }

        // –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø
        document.addEventListener('DOMContentLoaded', function() {
            console.log('‚úÖ D&D –ë–æ–µ–≤–∞—è –°–∏—Å—Ç–µ–º–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞!');
        });
    </script>
</body>
</html>
// ========== –ë–ê–ó–û–í–´–ï –°–ò–°–¢–ï–ú–´ –ò –ö–û–ù–°–¢–ê–ù–¢–´ ==========

// –°–∏—Å—Ç–µ–º–∞ —Ä–∞—Å
const races = {
    atski: { name: "üî• –ê—Ü–∫–∏", description: "50% –∑–∞—â–∏—Ç–∞ –æ—Ç –æ–≥–Ω—è", lifespan: "350 –ª–µ—Ç" },
    knofi: { name: "üó£Ô∏è –ö–Ω–æ—Ñ—ã", description: "+1 –∫ –∫—Ä–∞—Å–Ω–æ—Ä–µ—á–∏—é", lifespan: "400 –ª–µ—Ç" },
    vorki: { name: "‚ùÑÔ∏è –í–æ—Ä–∫–∏", description: "50% –∑–∞—â–∏—Ç–∞ –æ—Ç –ª—å–¥–∞", lifespan: "250 –ª–µ—Ç" },
    minci: { name: "üéØ –ú–∏–Ω—Ü—ã", description: "+1 –∫ –¥—Ä–µ–≤–∫–æ–≤–æ–º—É", lifespan: "350 –ª–µ—Ç" },
    kaei: { name: "‚öíÔ∏è –ö–∞—ç–π—Ü—ã", description: "–ú–∞–≥–∏—è –º–µ—Ç–∞–ª–ª–∞", lifespan: "300 –ª–µ—Ç" },
    forest_elf: { name: "üåø –õ–µ—Å–Ω—ã–µ —ç–ª—å—Ñ—ã", description: "–ú–∞–≥–∏—è –ø—Ä–∏—Ä–æ–¥—ã", lifespan: "700 –ª–µ—Ç" },
    high_elf: { name: "‚ú® –í—ã—Å—à–∏–µ —ç–ª—å—Ñ—ã", description: "–î–≤–µ —Å—Ç–∏—Ö–∏–∏", lifespan: "2000 –ª–µ—Ç" },
    dark_elf: { name: "üåë –¢–µ–º–Ω—ã–µ —ç–ª—å—Ñ—ã", description: "–ú–∞–≥–∏—è —Ç—å–º—ã", lifespan: "700 –ª–µ—Ç" },
    dwarf: { name: "‚õ∞Ô∏è –î–≤–∞—Ä—Ñ—ã", description: "–ö—É–∑–Ω–µ—á–Ω–æ–µ –¥–µ–ª–æ", lifespan: "600 –ª–µ—Ç" },
    gnome: { name: "üîÆ –ì–Ω–æ–º—ã", description: "–†–µ–º–µ—Å–ª–æ", lifespan: "800 –ª–µ—Ç" },
    orc: { name: "üíÄ –û—Ä–∫–∏", description: "–¢—è–∂–µ–ª–∞—è –±—Ä–æ–Ω—è", lifespan: "400 –ª–µ—Ç" },
    goblin: { name: "üëπ –ì–æ–±–ª–∏–Ω—ã", description: "–ë—ã—Å—Ç—Ä–æ–µ –æ–±—É—á–µ–Ω–∏–µ", lifespan: "25 –ª–µ—Ç" }
};

// –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –Ω–∞–≤—ã–∫–æ–≤
const skillsStructure = {
    "‚öîÔ∏è –ë–û–ï–í–´–ï –ù–ê–í–´–ö–ò": [
        "–¢—è–∂—ë–ª–∞—è –±—Ä–æ–Ω—è", "–õ—ë–≥–∫–∞—è –±—Ä–æ–Ω—è", "–î–≤—É—Ä—É—á–Ω–æ–µ –æ—Ä—É–∂–∏–µ", 
        "–û–¥–Ω–æ—Ä—É—á–Ω–æ–µ –æ—Ä—É–∂–∏–µ", "–°—Ç—Ä–µ–ª—å–±–∞", "–ë–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∏–µ", 
        "–î—Ä–µ–≤–∫–æ–≤–æ–µ", "–†—É–∫–æ–ø–∞—à–Ω—ã–π –±–æ–π", "–ú–µ—Ç–∞–Ω–∏–µ"
    ],
    "üé≠ –û–ë–©–ò–ï –ù–ê–í–´–ö–ò": [
        "–°–∫—Ä—ã—Ç–Ω–æ—Å—Ç—å", "–ö—Ä–∞—Å–Ω–æ—Ä–µ—á–∏–µ", "–õ–æ–≤–∫–æ—Å—Ç—å", "–í—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å",
        "–í–∑–ª–æ–º", "–í–æ—Å–ø—Ä–∏—è—Ç–∏–µ", "–£–¥–∞—á–∞", "–ö–∞—Ä–º–∞–Ω–Ω—ã–µ –∫—Ä–∞–∂–∏"
    ],
    "‚öóÔ∏è –†–ï–ú–ï–°–õ–ê": [
        "–ê–ª—Ö–∏–º–∏—è", "–ö—É–∑–Ω–µ—á–Ω–æ–µ –¥–µ–ª–æ", "–ó–∞—á–∞—Ä–æ–≤–∞–Ω–∏–µ", "–†–µ–º–µ—Å–ª–æ"
    ],
    "üîÆ –ú–ê–ì–ò–Ø": [
        "–ú–∞–≥–∏—è –≤–æ–¥—ã", "–ú–∞–≥–∏—è –∑–µ–º–ª–∏", "–ú–∞–≥–∏—è –≤–æ–∑–¥—É—Ö–∞", "–ú–∞–≥–∏—è –∫—Ä–æ–≤–∏",
        "–ú–∞–≥–∏—è –æ–≥–Ω—è", "–ú–∞–≥–∏—è –º–µ—Ç–∞–ª–ª–∞", "–ú–∞–≥–∏—è –ø—Ä–∏—Ä–æ–¥—ã", "–ú–∞–≥–∏—è —Å–≤–µ—Ç–∞",
        "–ú–∞–≥–∏—è —Ç—å–º—ã", "–ú–∞–≥–∏—è –∏–Ω—Ñ–µ—Ä–Ω–æ", "–ú–∞–≥–∏—è —Ö–∞–æ—Å–∞", "–ú–∞–≥–∏—è —Ä–∞–∑—É–º–∞",
        "–ú–∞–≥–∏—è –ñ–∏–∑–Ω–∏", "–ú–∞–≥–∏—è —Å–º–µ—Ä—Ç–∏", "–ú–∞–≥–∏—è –ø—É—Å—Ç–æ—Ç—ã", "–ú–∞–≥–∏—è –≠–Ω–µ—Ä–≥–∏–∏"
    ]
};

// –°–∏—Å—Ç–µ–º–∞ —É—Ä–æ–≤–Ω–µ–π
const levelTable = {
    0: { expRequired: 1000, hp: 100, mana: 100, stamina: 100, points: 20 },
    1: { expRequired: 3000, hp: 200, mana: 200, stamina: 200, points: 30 },
    2: { expRequired: 5000, hp: 300, mana: 300, stamina: 300, points: 40 },
    3: { expRequired: 8000, hp: 400, mana: 400, stamina: 400, points: 50 },
    4: { expRequired: 12000, hp: 500, mana: 500, stamina: 500, points: 60 },
    5: { expRequired: 16000, hp: 600, mana: 600, stamina: 600, points: 70 },
    6: { expRequired: 20000, hp: 700, mana: 700, stamina: 700, points: 80 },
    7: { expRequired: 25000, hp: 800, mana: 800, stamina: 800, points: 90 },
    8: { expRequired: 30000, hp: 900, mana: 900, stamina: 900, points: 100 },
    9: { expRequired: 100000, hp: 1000, mana: 1000, stamina: 1000, points: 200 }
};

// ========== –°–ò–°–¢–ï–ú–ê –ö–£–ë–ò–ö–û–í ==========

function rollDice(sides, count = 1) {
    let results = [];
    let total = 0;
    
    for (let i = 0; i < count; i++) {
        const result = Math.floor(Math.random() * sides) + 1;
        results.push(result);
        total += result;
    }
    
    return { results, total };
}

function roll3d6() {
    return rollDice(6, 3);
}

function rollSkillCheck(skillValue, modifiers = 0) {
    const roll = roll3d6();
    const totalRoll = roll.total + modifiers;
    const success = totalRoll <= skillValue;
    const successes = success ? Math.max(0, skillValue - totalRoll) : 0;
    
    return {
        roll: roll.results,
        total: totalRoll,
        success: success,
        successes: successes,
        critical: roll.total === 3 ? 'success' : (roll.total === 18 ? 'failure' : 'normal')
    };
}

// ========== –°–ò–°–¢–ï–ú–ê –•–†–ê–ù–ï–ù–ò–Ø –î–ê–ù–ù–´–• ==========

class StorageSystem {
    static set(key, value) {
        try {
            localStorage.setItem(key, JSON.stringify(value));
            return true;
        } catch (e) {
            console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', e);
            return false;
        }
    }

    static get(key, defaultValue = null) {
        try {
            const item = localStorage.getItem(key);
            return item ? JSON.parse(item) : defaultValue;
        } catch (e) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', e);
            return defaultValue;
        }
    }

    static remove(key) {
        try {
            localStorage.removeItem(key);
            return true;
        } catch (e) {
            console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è:', e);
            return false;
        }
    }
}

// ========== –ë–ê–ó–û–í–´–ô –ö–õ–ê–°–° –ü–ï–†–°–û–ù–ê–ñ–ê ==========

class Character {
    constructor(id = null) {
        this.id = id || 'char_' + Date.now();
        this.info = {
            name: '',
            surname: '',
            title: '',
            race: '',
            heritage: '',
            height: '',
            weight: '',
            age: ''
        };
        this.level = {
            current: 0,
            exp: 0
        };
        this.stats = {
            health: 100,
            maxHealth: 100,
            mana: 100,
            maxMana: 100,
            stamina: 100,
            maxStamina: 100,
            freePoints: 0
        };
        this.skills = {};
        this.lockedSkills = {};
        this.availableMagicSchools = {};
        this.inventory = {
            weapons: [], armor: [], potions: [], scrolls: [],
            resources: [], valuables: [], tools: [], other: []
        };
        this.customCategories = [];
        this.notes = [];
        this.createdAt = new Date().toISOString();
        this.updatedAt = new Date().toISOString();
        
        this.initializeSkills();
    }

    initializeSkills() {
        Object.values(skillsStructure).forEach(skillGroup => {
            skillGroup.forEach(skill => {
                this.skills[skill] = 5;
            });
        });
    }

    getSkillValue(skillName) {
        return this.skills[skillName] || 5;
    }

    setSkillValue(skillName, value) {
        this.skills[skillName] = value;
        this.updatedAt = new Date().toISOString();
    }

    addExperience(exp) {
        this.level.exp += exp;
        this.checkLevelUp();
        this.updatedAt = new Date().toISOString();
    }

    checkLevelUp() {
        if (this.level.current >= 9) return;

        const requiredExp = levelTable[this.level.current].expRequired;
        if (this.level.exp >= requiredExp) {
            this.level.current++;
            const levelData = levelTable[this.level.current];
            
            this.stats.maxHealth += levelData.hp;
            this.stats.maxMana += levelData.mana;
            this.stats.maxStamina += levelData.stamina;
            this.stats.freePoints += levelData.points;
            
            this.stats.health = this.stats.maxHealth;
            this.stats.mana = this.stats.maxMana;
            this.stats.stamina = this.stats.maxStamina;
            
            this.level.exp -= requiredExp;
            
            console.log(`üéâ –£—Ä–æ–≤–µ–Ω—å –ø–æ–≤—ã—à–µ–Ω –¥–æ ${this.level.current}!`);
        }
    }

    save() {
        return StorageSystem.set(`character_${this.id}`, this);
    }

    static load(characterId) {
        const data = StorageSystem.get(`character_${characterId}`);
        if (!data) return null;
        
        const character = new Character();
        Object.assign(character, data);
        return character;
    }
}

// ========== –°–ò–°–¢–ï–ú–ê –£–ü–†–ê–í–õ–ï–ù–ò–Ø –ü–ï–†–°–û–ù–ê–ñ–ê–ú–ò ==========

class CharacterManager {
    constructor() {
        this.characters = {};
        this.currentCharacterId = null;
        this.loadCharacters();
    }

    loadCharacters() {
        this.characters = StorageSystem.get('dnd_characters', {});
        this.currentCharacterId = StorageSystem.get('current_character_id');
    }

    saveCharacters() {
        StorageSystem.set('dnd_characters', this.characters);
        StorageSystem.set('current_character_id', this.currentCharacterId);
    }

    createCharacter(name, race) {
        const character = new Character();
        character.info.name = name;
        character.info.race = race;
        
        this.characters[character.id] = character;
        this.currentCharacterId = character.id;
        this.saveCharacters();
        
        return character;
    }

    getCurrentCharacter() {
        if (!this.currentCharacterId || !this.characters[this.currentCharacterId]) {
            return null;
        }
        return this.characters[this.currentCharacterId];
    }

    switchCharacter(characterId) {
        if (this.characters[characterId]) {
            this.currentCharacterId = characterId;
            this.saveCharacters();
            return true;
        }
        return false;
    }

    deleteCharacter(characterId) {
        if (this.characters[characterId]) {
            delete this.characters[characterId];
            
            if (this.currentCharacterId === characterId) {
                const remainingIds = Object.keys(this.characters);
                this.currentCharacterId = remainingIds.length > 0 ? remainingIds[0] : null;
            }
            
            this.saveCharacters();
            return true;
        }
        return false;
    }
}

// ========== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ==========

let characterManager = new CharacterManager();
let currentCharacter = characterManager.getCurrentCharacter();

// ========== –£–¢–ò–õ–ò–¢–´ ==========

function showPopup(title, content, buttons = []) {
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ –≤—Å–ø–ª—ã–≤–∞—é—â–∏—Ö –æ–∫–æ–Ω
    const popup = document.createElement('div');
    popup.className = 'popup';
    popup.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
        background: rgba(26, 15, 11, 0.95); display: flex; 
        justify-content: center; align-items: center; z-index: 1000;
    `;
    
    let buttonsHTML = '';
    if (buttons.length > 0) {
        buttonsHTML = `<div style="display: flex; gap: 10px; margin-top: 20px;">${buttons.join('')}</div>`;
    }
    
    popup.innerHTML = `
        <div class="popup-content" style="background: #2c1810; padding: 25px; border-radius: 8px; 
               max-width: 95%; width: 500px; border: 3px solid #8b4513;">
            <h2 style="color: #d4af37; margin-bottom: 15px;">${title}</h2>
            <div>${content}</div>
            ${buttonsHTML}
        </div>
    `;
    
    document.body.appendChild(popup);
    return popup;
}

function closePopup(popup) {
    if (popup && popup.parentNode) {
        popup.parentNode.removeChild(popup);
    }
}

// ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –°–ò–°–¢–ï–ú–´ ==========

function initializeSystem() {
    console.log('üéÆ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è D&D —Å–∏—Å—Ç–µ–º—ã...');
    
    // –ï—Å–ª–∏ –Ω–µ—Ç –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π, —Å–æ–∑–¥–∞–µ–º –¥–µ–º–æ-–ø–µ—Ä—Å–æ–Ω–∞–∂–∞
    if (!currentCharacter && Object.keys(characterManager.characters).length === 0) {
        const demoChar = characterManager.createCharacter('–ù–æ–≤—ã–π –ì–µ—Ä–æ–π', 'human');
        currentCharacter = demoChar;
        console.log('‚úÖ –°–æ–∑–¥–∞–Ω –¥–µ–º–æ-–ø–µ—Ä—Å–æ–Ω–∞–∂');
    }
    
    console.log(`‚úÖ –°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞! –ü–µ—Ä—Å–æ–Ω–∞–∂–µ–π: ${Object.keys(characterManager.characters).length}`);
}

// –ó–∞–ø—É—Å–∫ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
document.addEventListener('DOMContentLoaded', initializeSystem);
        // ========== –°–ò–°–¢–ï–ú–ê –û–¢–û–ë–†–ê–ñ–ï–ù–ò–Ø –ü–ï–†–°–û–ù–ê–ñ–ê ==========

function renderCharacterSheet() {
    const container = document.getElementById('character-tab');
    if (!container || !currentCharacter) return;

    container.innerHTML = `
        <div class="header" style="background: linear-gradient(to bottom, #3d2418, #2c1810); 
              color: #e0d0c0; padding: 25px; text-align: center; border-bottom: 3px solid #8b4513;">
            <h1 style="font-size: 2.2em; color: #d4af37; margin-bottom: 20px;">‚öîÔ∏è D&D Character Sheet</h1>
            
            <div class="character-info" style="display: flex; gap: 15px; margin-bottom: 15px; flex-wrap: wrap; justify-content: center;">
                <div class="input-group" style="flex: 1; min-width: 200px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: bold; color: #d4af37;">–ò–º—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞:</label>
                    <input type="text" id="characterName" value="${currentCharacter.info.name}" 
                           placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è" style="width: 100%; padding: 12px; border: 2px solid #8b4513; 
                           border-radius: 4px; font-size: 16px; background: #1a0f0b; color: #e0d0c0;">
                </div>
                <div class="input-group" style="flex: 1; min-width: 200px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: bold; color: #d4af37;">–§–∞–º–∏–ª–∏—è:</label>
                    <input type="text" id="characterSurname" value="${currentCharacter.info.surname}" 
                           placeholder="–í–≤–µ–¥–∏—Ç–µ —Ñ–∞–º–∏–ª–∏—é" style="width: 100%; padding: 12px; border: 2px solid #8b4513; 
                           border-radius: 4px; font-size: 16px; background: #1a0f0b; color: #e0d0c0;">
                </div>
                <div class="input-group" style="flex: 1; min-width: 200px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: bold; color: #d4af37;">–¢–∏—Ç—É–ª:</label>
                    <input type="text" id="characterTitle" value="${currentCharacter.info.title}" 
                           placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–∏—Ç—É–ª" style="width: 100%; padding: 12px; border: 2px solid #8b4513; 
                           border-radius: 4px; font-size: 16px; background: #1a0f0b; color: #e0d0c0;">
                </div>
            </div>

            <div class="character-info" style="display: flex; gap: 15px; margin-bottom: 15px; flex-wrap: wrap; justify-content: center;">
                <div class="input-group" style="flex: 1; min-width: 200px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: bold; color: #d4af37;">–†–∞—Å–∞:</label>
                    <select id="characterRace" style="width: 100%; padding: 12px; border: 2px solid #8b4513; 
                            border-radius: 4px; background: #1a0f0b; color: #e0d0c0;">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞—Å—É</option>
                        ${Object.entries(races).map(([id, race]) => 
                            `<option value="${id}" ${currentCharacter.info.race === id ? 'selected' : ''}>${race.name}</option>`
                        ).join('')}
                    </select>
                </div>
                <div class="input-group" style="flex: 1; min-width: 200px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: bold; color: #d4af37;">–ù–∞—Å–ª–µ–¥–∏–µ:</label>
                    <input type="text" id="characterHeritage" value="${currentCharacter.info.heritage}" 
                           placeholder="–û—Å–æ–±–æ–µ –Ω–∞—Å–ª–µ–¥–∏–µ" style="width: 100%; padding: 12px; border: 2px solid #8b4513; 
                           border-radius: 4px; font-size: 16px; background: #1a0f0b; color: #e0d0c0;">
                </div>
            </div>

            <div class="character-info" style="display: flex; gap: 15px; margin-bottom: 15px; flex-wrap: wrap; justify-content: center;">
                <div class="input-group" style="flex: 1; min-width: 200px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: bold; color: #d4af37;">–†–æ—Å—Ç (—Å–º):</label>
                    <input type="number" id="characterHeight" value="${currentCharacter.info.height}" 
                           style="width: 100%; padding: 12px; border: 2px solid #8b4513; border-radius: 4px; 
                           font-size: 16px; background: #1a0f0b; color: #e0d0c0;">
                </div>
                <div class="input-group" style="flex: 1; min-width: 200px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: bold; color: #d4af37;">–í–µ—Å (–∫–≥):</label>
                    <input type="number" id="characterWeight" value="${currentCharacter.info.weight}" 
                           placeholder="–í–µ—Å" style="width: 100%; padding: 12px; border: 2px solid #8b4513; 
                           border-radius: 4px; font-size: 16px; background: #1a0f0b; color: #e0d0c0;">
                </div>
                <div class="input-group" style="flex: 1; min-width: 200px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: bold; color: #d4af37;">–í–æ–∑—Ä–∞—Å—Ç (–ª–µ—Ç):</label>
                    <input type="number" id="characterAge" value="${currentCharacter.info.age}" 
                           placeholder="–í–æ–∑—Ä–∞—Å—Ç" style="width: 100%; padding: 12px; border: 2px solid #8b4513; 
                           border-radius: 4px; font-size: 16px; background: #1a0f0b; color: #e0d0c0;">
                </div>
            </div>
        </div>

        <div class="level-system" style="background: #3d2418; padding: 20px; border-bottom: 2px solid #8b4513;">
            <div class="level-display" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <div class="level-info" style="font-size: 1.3em; font-weight: bold; color: #d4af37; display: flex; align-items: center; gap: 10px;">
                    –£—Ä–æ–≤–µ–Ω—å: <span id="currentLevel">${currentCharacter.level.current}</span>
                    <button class="btn btn-roll" onclick="editLevel()">‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å</button>
                    <button class="btn btn-roll" onclick="showLevelsTable()">üìä –¢–∞–±–ª–∏—Ü–∞</button>
                </div>
                <div class="exp-display" style="display: flex; align-items: center; gap: 10px;">
                    <input type="number" id="currentExp" class="exp-input" value="${currentCharacter.level.exp}" 
                           style="width: 120px; padding: 10px; border: 2px solid #8b4513; border-radius: 4px; 
                           font-size: 16px; text-align: center; background: #1a0f0b; color: #e0d0c0;">
                    <span style="color: #d4af37; font-weight: bold;">/ 
                        <span id="requiredExp">${currentCharacter.level.current < 9 ? levelTable[currentCharacter.level.current].expRequired : 'MAX'}</span> XP
                    </span>
                    <button class="btn btn-plus" onclick="addExperience()">‚ûï –û–ø—ã—Ç</button>
                    <button class="btn btn-roll" id="convertBtn" onclick="convertExpToPoints()" 
                            style="${currentCharacter.level.current >= 9 ? '' : 'display: none;'}">üíé –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                </div>
            </div>
        </div>

        <div class="stats-panel" style="padding: 20px; background: #2c1810; border-bottom: 2px solid #5a3928;">
            <div class="stat-row" style="display: flex; align-items: center; padding: 12px 0; gap: 15px; border-bottom: 1px solid #3d2418;">
                <div class="stat-label" style="flex: 1; font-weight: bold; display: flex; align-items: center; gap: 10px; color: #d4af37;">
                    ‚ù§Ô∏è –ó–¥–æ—Ä–æ–≤—å–µ:
                </div>
                <input type="number" class="stat-input" id="health" value="${currentCharacter.stats.health}" 
                       style="width: 100px; padding: 10px; border: 2px solid #8b4513; border-radius: 4px; 
                       text-align: center; font-size: 16px; background: #1a0f0b; color: #e0d0c0;">
                <button class="btn btn-minus" onclick="changeStat('health', -5)">-5</button>
                <button class="btn btn-plus" onclick="changeStat('health', 5)">+5</button>
            </div>
            <div class="stat-row" style="display: flex; align-items: center; padding: 12px 0; gap: 15px; border-bottom: 1px solid #3d2418;">
                <div class="stat-label" style="flex: 1; font-weight: bold; display: flex; align-items: center; gap: 10px; color: #d4af37;">
                    üîÆ –ú–∞–Ω–∞:
                </div>
                <input type="number" class="stat-input" id="mana" value="${currentCharacter.stats.mana}" 
                       style="width: 100px; padding: 10px; border: 2px solid #8b4513; border-radius: 4px; 
                       text-align: center; font-size: 16px; background: #1a0f0b; color: #e0d0c0;">
                <button class="btn btn-minus" onclick="changeStat('mana', -5)">-5</button>
                <button class="btn btn-plus" onclick="changeStat('mana', 5)">+5</button>
            </div>
            <div class="stat-row" style="display: flex; align-items: center; padding: 12px 0; gap: 15px;">
                <div class="stat-label" style="flex: 1; font-weight: bold; display: flex; align-items: center; gap: 10px; color: #d4af37;">
                    ‚ö° –í—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å:
                </div>
                <input type="number" class="stat-input" id="stamina" value="${currentCharacter.stats.stamina}" 
                       style="width: 100px; padding: 10px; border: 2px solid #8b4513; border-radius: 4px; 
                       text-align: center; font-size: 16px; background: #1a0f0b; color: #e0d0c0;">
                <button class="btn btn-minus" onclick="changeStat('stamina', -5)">-5</button>
                <button class="btn btn-plus" onclick="changeStat('stamina', 5)">+5</button>
            </div>
        </div>

        <div class="points-panel" style="padding: 20px; background: #3d2418; border-bottom: 2px solid #8b4513;">
            <div class="points-display" style="display: flex; align-items: center; justify-content: center; gap: 15px;">
                <span style="font-size: 1.3em; font-weight: bold; color: #d4af37;">–°–≤–æ–±–æ–¥–Ω—ã–µ –æ—á–∫–∏ –Ω–∞–≤—ã–∫–æ–≤:</span>
                <input type="number" id="freePoints" class="stat-input" value="${currentCharacter.stats.freePoints}" 
                       style="width: 100px; padding: 10px; border: 2px solid #8b4513; border-radius: 4px; 
                       text-align: center; font-size: 16px; background: #1a0f0b; color: #e0d0c0;">
                <button class="btn btn-roll" onclick="editFreePoints()">‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å</button>
            </div>
        </div>

        <div id="skillsContainer"></div>

        <div class="export-import" style="display: flex; gap: 10px; justify-content: center; margin: 20px 0; flex-wrap: wrap;">
            <button class="btn btn-plus" onclick="exportCharacter()">üíæ –≠–∫—Å–ø–æ—Ä—Ç –ø–µ—Ä—Å–æ–Ω–∞–∂–∞</button>
            <button class="btn btn-roll" onclick="importCharacter()">üì• –ò–º–ø–æ—Ä—Ç –ø–µ—Ä—Å–æ–Ω–∞–∂–∞</button>
        </div>
    `;

    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
    setupCharacterEventListeners();
    renderSkills();
}

function setupCharacterEventListeners() {
    const inputs = ['characterName', 'characterSurname', 'characterTitle', 'characterRace', 
                   'characterHeritage', 'characterHeight', 'characterWeight', 'characterAge',
                   'health', 'mana', 'stamina', 'freePoints', 'currentExp'];
    
    inputs.forEach(inputId => {
        const element = document.getElementById(inputId);
        if (element) {
            element.addEventListener('change', saveCharacterData);
            element.addEventListener('input', saveCharacterData);
        }
    });
}

function saveCharacterData() {
    if (!currentCharacter) return;

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Å–Ω–æ–≤–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
    currentCharacter.info.name = document.getElementById('characterName').value;
    currentCharacter.info.surname = document.getElementById('characterSurname').value;
    currentCharacter.info.title = document.getElementById('characterTitle').value;
    currentCharacter.info.race = document.getElementById('characterRace').value;
    currentCharacter.info.heritage = document.getElementById('characterHeritage').value;
    currentCharacter.info.height = document.getElementById('characterHeight').value;
    currentCharacter.info.weight = document.getElementById('characterWeight').value;
    currentCharacter.info.age = document.getElementById('characterAge').value;

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏
    currentCharacter.stats.health = parseInt(document.getElementById('health').value) || 0;
    currentCharacter.stats.mana = parseInt(document.getElementById('mana').value) || 0;
    currentCharacter.stats.stamina = parseInt(document.getElementById('stamina').value) || 0;
    currentCharacter.stats.freePoints = parseInt(document.getElementById('freePoints').value) || 0;

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–ø—ã—Ç –∏ —É—Ä–æ–≤–µ–Ω—å
    currentCharacter.level.exp = parseInt(document.getElementById('currentExp').value) || 0;
    currentCharacter.checkLevelUp();

    // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
    updateLevelDisplay();
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
    currentCharacter.save();
    characterManager.saveCharacters();
}

// ========== –°–ò–°–¢–ï–ú–ê –ù–ê–í–´–ö–û–í ==========

function renderSkills() {
    const container = document.getElementById('skillsContainer');
    if (!container || !currentCharacter) return;

    let skillsHTML = '';

    for (const [groupName, skills] of Object.entries(skillsStructure)) {
        skillsHTML += `
            <div class="skills-section" style="padding: 25px; border-bottom: 2px solid #5a3928;">
                <div class="section-title">${groupName}</div>
        `;

        skills.forEach(skill => {
            const skillValue = currentCharacter.getSkillValue(skill);
            const isLocked = currentCharacter.lockedSkills[skill] || false;
            const lockBtnText = isLocked ? 'üîì' : 'üîí';
            const lockBtnClass = isLocked ? 'btn-lock locked' : 'btn-lock';

            skillsHTML += `
                <div class="skill-row" style="display: flex; align-items: center; padding: 15px 0; border-bottom: 1px solid #3d2418;
                      ${isLocked ? 'opacity: 0.6; color: #8b7d6b; background: #3d2418;' : ''}">
                    <div class="skill-name" style="flex: 2; font-weight: 500; display: flex; align-items: center; gap: 12px;">
                        <span>üéØ</span>
                        <span>${skill}</span>
                        ${groupName === "üîÆ –ú–ê–ì–ò–Ø" ? `<span class="spell-icon" onclick="showSpells('${skill}')" title="–ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∑–∞–∫–ª–∏–Ω–∞–Ω–∏—è" style="cursor: pointer; margin-left: 10px; font-size: 1.2em;">üîÆ</span>` : ''}
                    </div>
                    <div class="skill-controls" style="flex: 1; display: flex; align-items: center; justify-content: flex-end; gap: 12px;">
                        <button class="btn btn-minus" onclick="decreaseSkill('${skill}')" 
                                ${isLocked || skillValue <= 5 ? 'disabled' : ''}>-</button>
                        <span class="skill-value" style="font-size: 1.3em; font-weight: bold; color: #d4af37; min-width: 40px; text-align: center;">
                            ${skillValue}
                        </span>
                        <button class="btn btn-plus" onclick="increaseSkill('${skill}')" 
                                ${isLocked || currentCharacter.stats.freePoints <= 0 ? 'disabled' : ''}>+</button>
                        <button class="btn ${lockBtnClass}" onclick="toggleSkillLock('${skill}')" 
                                style="background: #95a5a6; color: white; padding: 10px 12px; ${isLocked ? 'background: #e74c3c;' : ''}">
                            ${lockBtnText}
                        </button>
                        <button class="btn btn-roll" onclick="rollSkill('${skill}')" ${isLocked ? 'disabled' : ''}>–ë—Ä–æ—Å–æ–∫</button>
                    </div>
                </div>
            `;
        });

        skillsHTML += `</div>`;
    }

    container.innerHTML = skillsHTML;
}

function increaseSkill(skillName) {
    if (!currentCharacter) return;

    const isLocked = currentCharacter.lockedSkills[skillName];
    if (isLocked) {
        alert('‚ùå –≠—Ç–æ—Ç –Ω–∞–≤—ã–∫ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω!');
        return;
    }

    if (currentCharacter.stats.freePoints > 0) {
        const currentValue = currentCharacter.getSkillValue(skillName);
        currentCharacter.setSkillValue(skillName, currentValue + 1);
        currentCharacter.stats.freePoints--;
        currentCharacter.save();
        renderSkills();
        updateUI();
    }
}

function decreaseSkill(skillName) {
    if (!currentCharacter) return;

    const isLocked = currentCharacter.lockedSkills[skillName];
    if (isLocked) {
        alert('‚ùå –≠—Ç–æ—Ç –Ω–∞–≤—ã–∫ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω!');
        return;
    }

    const currentValue = currentCharacter.getSkillValue(skillName);
    if (currentValue > 5) {
        currentCharacter.setSkillValue(skillName, currentValue - 1);
        currentCharacter.stats.freePoints++;
        currentCharacter.save();
        renderSkills();
        updateUI();
    }
}

function toggleSkillLock(skillName) {
    if (!currentCharacter) return;

    const currentlyLocked = currentCharacter.lockedSkills[skillName] || false;
    
    if (currentlyLocked) {
        const unlock = confirm(`üîì –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –Ω–∞–≤—ã–∫ "${skillName}"?`);
        if (unlock) {
            currentCharacter.lockedSkills[skillName] = false;
            currentCharacter.save();
            renderSkills();
            alert(`‚úÖ –ù–∞–≤—ã–∫ "${skillName}" —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω!`);
        }
    } else {
        const lock = confirm(`üîí –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –Ω–∞–≤—ã–∫ "${skillName}"?`);
        if (lock) {
            currentCharacter.lockedSkills[skillName] = true;
            currentCharacter.save();
            renderSkills();
            alert(`‚úÖ –ù–∞–≤—ã–∫ "${skillName}" –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω!`);
        }
    }
}

// ========== –§–£–ù–ö–¶–ò–ò –£–ü–†–ê–í–õ–ï–ù–ò–Ø –£–†–û–í–ù–ï–ú –ò –°–¢–ê–¢–ê–ú–ò ==========

function editLevel() {
    if (!currentCharacter) return;
    
    const newLevel = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π —É—Ä–æ–≤–µ–Ω—å (0-9):', currentCharacter.level.current);
    if (newLevel && !isNaN(newLevel) && newLevel >= 0 && newLevel <= 9) {
        currentCharacter.level.current = parseInt(newLevel);
        updateStatsForLevel();
        updateLevelDisplay();
        currentCharacter.save();
    }
}

function updateStatsForLevel() {
    if (!currentCharacter) return;
    
    let totalHP = 100, totalMana = 100, totalStamina = 100;
    
    for (let i = 0; i <= currentCharacter.level.current; i++) {
        totalHP += levelTable[i].hp;
        totalMana += levelTable[i].mana;
        totalStamina += levelTable[i].stamina;
    }
    
    currentCharacter.stats.maxHealth = totalHP;
    currentCharacter.stats.maxMana = totalMana;
    currentCharacter.stats.maxStamina = totalStamina;
    currentCharacter.stats.health = totalHP;
    currentCharacter.stats.mana = totalMana;
    currentCharacter.stats.stamina = totalStamina;
}

function addExperience() {
    if (!currentCharacter) return;
    
    const expToAdd = prompt('–°–∫–æ–ª—å–∫–æ –æ–ø—ã—Ç–∞ –¥–æ–±–∞–≤–∏—Ç—å?');
    if (expToAdd && !isNaN(expToAdd)) {
        currentCharacter.addExperience(parseInt(expToAdd));
        updateLevelDisplay();
        renderCharacterSheet();
    }
}

function convertExpToPoints() {
    if (!currentCharacter || currentCharacter.level.current < 9) return;
    
    const currentExp = currentCharacter.level.exp;
    const availablePoints = Math.floor(currentExp / 1000);
    
    if (availablePoints > 0) {
        currentCharacter.level.exp -= availablePoints * 1000;
        currentCharacter.stats.freePoints += availablePoints;
        currentCharacter.save();
        
        alert(`üíé –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ ${availablePoints} –æ—á–∫–æ–≤ –Ω–∞–≤—ã–∫–æ–≤!`);
        updateLevelDisplay();
        renderCharacterSheet();
    }
}

function updateLevelDisplay() {
    if (!currentCharacter) return;
    
    const levelElement = document.getElementById('currentLevel');
    const expElement = document.getElementById('currentExp');
    const requiredElement = document.getElementById('requiredExp');
    const convertBtn = document.getElementById('convertBtn');
    
    if (levelElement) levelElement.textContent = currentCharacter.level.current;
    if (expElement) expElement.value = currentCharacter.level.exp;
    
    if (currentCharacter.level.current < 9) {
        if (requiredElement) requiredElement.textContent = levelTable[currentCharacter.level.current].expRequired;
        if (convertBtn) convertBtn.style.display = 'none';
    } else {
        if (requiredElement) requiredElement.textContent = 'MAX';
        if (convertBtn) convertBtn.style.display = 'block';
    }
}

function changeStat(stat, value) {
    if (!currentCharacter) return;
    
    const input = document.getElementById(stat);
    let currentValue = parseInt(input.value) || 0;
    let newValue = currentValue + value;
    
    // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è
    if (newValue < 0) newValue = 0;
    if (newValue > currentCharacter.stats['max' + stat.charAt(0).toUpperCase() + stat.slice(1)]) {
        newValue = currentCharacter.stats['max' + stat.charAt(0).toUpperCase() + stat.slice(1)];
    }
    
    input.value = newValue;
    currentCharacter.stats[stat] = newValue;
    currentCharacter.save();
}

function editFreePoints() {
    if (!currentCharacter) return;
    
    const newPoints = prompt('–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–≤–æ–±–æ–¥–Ω—ã—Ö –æ—á–∫–æ–≤:', currentCharacter.stats.freePoints);
    if (newPoints && !isNaN(newPoints)) {
        currentCharacter.stats.freePoints = parseInt(newPoints);
        currentCharacter.save();
        renderCharacterSheet();
    }
}

function updateUI() {
    if (!currentCharacter) return;
    
    // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–≤–æ–±–æ–¥–Ω—ã—Ö –æ—á–∫–æ–≤
    const freePointsElement = document.getElementById('freePoints');
    if (freePointsElement) {
        freePointsElement.value = currentCharacter.stats.freePoints;
    }
}

// ========== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ==========

function showLevelsTable() {
    if (!currentCharacter) return;
    
    let tableHTML = `
        <h3 style="color: #d4af37; margin-bottom: 15px;">üìä –¢–∞–±–ª–∏—Ü–∞ —É—Ä–æ–≤–Ω–µ–π</h3>
        <table style="width: 100%; border-collapse: collapse; margin: 20px 0;">
            <tr>
                <th style="padding: 8px; border: 1px solid #5a3928; background: #3d2418; color: #d4af37;">–£—Ä.</th>
                <th style="padding: 8px; border: 1px solid #5a3928; background: #3d2418; color: #d4af37;">–û–ø—ã—Ç</th>
                <th style="padding: 8px; border: 1px solid #5a3928; background: #3d2418; color: #d4af37;">–•–ü</th>
                <th style="padding: 8px; border: 1px solid #5a3928; background: #3d2418; color: #d4af37;">–ú–∞–Ω–∞</th>
                <th style="padding: 8px; border: 1px solid #5a3928; background: #3d2418; color: #d4af37;">–°—Ç–∞–º–∏–Ω–∞</th>
                <th style="padding: 8px; border: 1px solid #5a3928; background: #3d2418; color: #d4af37;">–û—á–∫–∏</th>
            </tr>
    `;
    
    for (let level = 0; level <= 9; level++) {
        const data = levelTable[level];
        const isCurrent = level === currentCharacter.level.current;
        
        tableHTML += `
            <tr style="${isCurrent ? 'background: #8b4513; font-weight: bold;' : ''}">
                <td style="padding: 8px; border: 1px solid #5a3928; text-align: center;">${level}</td>
                <td style="padding: 8px; border: 1px solid #5a3928; text-align: center;">${data.expRequired || 'MAX'}</td>
                <td style="padding: 8px; border: 1px solid #5a3928; text-align: center;">+${data.hp}</td>
                <td style="padding: 8px; border: 1px solid #5a3928; text-align: center;">+${data.mana}</td>
                <td style="padding: 8px; border: 1px solid #5a3928; text-align: center;">+${data.stamina}</td>
                <td style="padding: 8px; border: 1px solid #5a3928; text-align: center;">+${data.points}</td>
            </tr>
        `;
    }
    
    tableHTML += `</table>`;
    
    showPopup('–¢–∞–±–ª–∏—Ü–∞ —É—Ä–æ–≤–Ω–µ–π', tableHTML, [
        '<button class="btn btn-roll" onclick="closePopup(this.closest(\'.popup\'))">–ó–∞–∫—Ä—ã—Ç—å</button>'
    ]);
}

function showSpells(schoolName) {
    // –ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è —Å–∏—Å—Ç–µ–º—ã –∑–∞–∫–ª–∏–Ω–∞–Ω–∏–π
    alert(`üîÆ –°–∏—Å—Ç–µ–º–∞ –∑–∞–∫–ª–∏–Ω–∞–Ω–∏–π –¥–ª—è "${schoolName}" –±—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –≤ —Å–ª–µ–¥—É—é—â–∏—Ö –≤–µ—Ä—Å–∏—è—Ö!`);
}

function exportCharacter() {
    if (!currentCharacter) return;
    
    const dataStr = JSON.stringify(currentCharacter, null, 2);
    const dataBlob = new Blob([dataStr], { type: 'application/json' });
    
    const link = document.createElement('a');
    link.href = URL.createObjectURL(dataBlob);
    link.download = `character_${currentCharacter.info.name || 'unknown'}.json`;
    link.click();
    
    alert(`‚úÖ –ü–µ—Ä—Å–æ–Ω–∞–∂ "${currentCharacter.info.name}" —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω!`);
}

function importCharacter() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';
    
    input.onchange = function(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const characterData = JSON.parse(e.target.result);
                
                // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–≥–æ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –∏–∑ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
                const newCharacter = new Character();
                Object.assign(newCharacter, characterData);
                newCharacter.id = 'char_import_' + Date.now();
                newCharacter.updatedAt = new Date().toISOString();
                
                characterManager.characters[newCharacter.id] = newCharacter;
                characterManager.currentCharacterId = newCharacter.id;
                characterManager.saveCharacters();
                
                currentCharacter = newCharacter;
                renderCharacterSheet();
                
                alert(`‚úÖ –ü–µ—Ä—Å–æ–Ω–∞–∂ "${newCharacter.info.name}" –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω!`);
            } catch (error) {
                alert('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞!');
                console.error(error);
            }
        };
        reader.readAsText(file);
    };
    
    input.click();
}

function rollSkill(skillName) {
    if (!currentCharacter) return;
    
    const skillValue = currentCharacter.getSkillValue(skillName);
    const check = rollSkillCheck(skillValue);
    
    let resultText, resultClass;
    if (check.critical === 'success') {
        resultText = "üí´ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –£–°–ü–ï–•!";
        resultClass = "success";
    } else if (check.critical === 'failure') {
        resultText = "üí• –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –ü–†–û–í–ê–õ!";
        resultClass = "failure";
    } else if (check.success) {
        resultText = "‚úÖ –£–°–ü–ï–•!";
        resultClass = "success";
    } else {
        resultText = "‚ùå –ù–ï–£–î–ê–ß–ê!";
        resultClass = "failure";
    }

    showRollResult(skillName, skillValue, check.roll, check.total, resultText, resultClass);
}

function showRollResult(skillName, skillValue, dice, total, resultText, resultClass) {
    const popup = showPopup(
        `–ë—Ä–æ—Å–æ–∫ –Ω–∞ "${skillName}" (${skillValue})`,
        `
            <div class="dice-rolls" style="display: flex; justify-content: center; gap: 15px; margin: 20px 0; flex-wrap: wrap;">
                <div class="dice" style="width: 50px; height: 50px; background: #8b4513; border-radius: 8px; 
                     display: flex; justify-content: center; align-items: center; font-size: 1.5em; 
                     font-weight: bold; color: #1a0f0b;">${dice[0]}</div>
                <div class="dice" style="width: 50px; height: 50px; background: #8b4513; border-radius: 8px; 
                     display: flex; justify-content: center; align-items: center; font-size: 1.5em; 
                     font-weight: bold; color: #1a0f0b;">${dice[1]}</div>
                <div class="dice" style="width: 50px; height: 50px; background: #8b4513; border-radius: 8px; 
                     display: flex; justify-content: center; align-items: center; font-size: 1.5em; 
                     font-weight: bold; color: #1a0f0b;">${dice[2]}</div>
            </div>
            <div style="font-size: 1.5em; margin: 20px 0; color: #e0d0c0;">${dice.join(' + ')} = ${total}</div>
            <div class="${resultClass}" style="${resultClass === 'success' ? 'color: #27ae60;' : 'color: #e74c3c;'} 
                  font-weight: bold; font-size: 1.3em;">${resultText}</div>
        `,
        [
            '<button class="btn btn-roll" onclick="rollSkill(\'' + skillName + '\'); closePopup(this.closest(\'.popup\'));">üé≤ –ö–∏–Ω—É—Ç—å –µ—â–µ</button>',
            '<button class="btn btn-roll" onclick="closePopup(this.closest(\'.popup\'))">–ó–∞–∫—Ä—ã—Ç—å</button>'
        ]
    );
}

// ========== –û–ë–ù–û–í–õ–ï–ù–ò–ï –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–ò ==========

function initializeSystem() {
    console.log('üéÆ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è D&D —Å–∏—Å—Ç–µ–º—ã...');
    
    // –ï—Å–ª–∏ –Ω–µ—Ç –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π, —Å–æ–∑–¥–∞–µ–º –¥–µ–º–æ-–ø–µ—Ä—Å–æ–Ω–∞–∂–∞
    if (!currentCharacter && Object.keys(characterManager.characters).length === 0) {
        const demoChar = characterManager.createCharacter('–ù–æ–≤—ã–π –ì–µ—Ä–æ–π', 'human');
        currentCharacter = demoChar;
        console.log('‚úÖ –°–æ–∑–¥–∞–Ω –¥–µ–º–æ-–ø–µ—Ä—Å–æ–Ω–∞–∂');
    }
    
    // –†–µ–Ω–¥–µ—Ä–∏–º –ª–∏—Å—Ç –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
    renderCharacterSheet();
    
    console.log(`‚úÖ –°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞! –ü–µ—Ä—Å–æ–Ω–∞–∂–µ–π: ${Object.keys(characterManager.characters).length}`);
}
        // ========== –°–ò–°–¢–ï–ú–ê –ì–ï–ö–°–ê–ì–û–ù–ê–õ–¨–ù–û–ì–û –ü–û–õ–Ø ==========

class HexagonalBattlefield {
    constructor(width = 15, height = 10) {
        this.width = width;
        this.height = height;
        this.cells = {};
        this.obstacles = {};
        this.characters = {};
        this.hexSize = 40; // –†–∞–∑–º–µ—Ä –≥–µ–∫—Å–∞ –≤ –ø–∏–∫—Å–µ–ª—è—Ö
        this.initializeGrid();
    }

    initializeGrid() {
        for (let q = 0; q < this.width; q++) {
            for (let r = 0; r < this.height; r++) {
                const cellId = this.getCellId(q, r);
                this.cells[cellId] = {
                    q: q,
                    r: r,
                    type: 'empty',
                    occupied: false,
                    visible: true,
                    explored: false
                };
            }
        }
    }

    getCellId(q, r) {
        return `hex_${q}_${r}`;
    }

    getCellCoordinates(cellId) {
        const [_, q, r] = cellId.split('_');
        return { q: parseInt(q), r: parseInt(r) };
    }

    hexToPixel(q, r) {
        const x = this.hexSize * Math.sqrt(3) * (q + r / 2);
        const y = this.hexSize * 3/2 * r;
        return { x, y };
    }

    pixelToHex(x, y) {
        const q = (x * Math.sqrt(3)/3 - y / 3) / this.hexSize;
        const r = y * 2/3 / this.hexSize;
        return this.roundHex(q, r);
    }

    roundHex(q, r) {
        const s = -q - r;
        let rq = Math.round(q);
        let rr = Math.round(r);
        let rs = Math.round(s);

        const q_diff = Math.abs(rq - q);
        const r_diff = Math.abs(rr - r);
        const s_diff = Math.abs(rs - s);

        if (q_diff > r_diff && q_diff > s_diff) {
            rq = -rr - rs;
        } else if (r_diff > s_diff) {
            rr = -rq - rs;
        }

        return { q: rq, r: rr };
    }

    getNeighbors(q, r) {
        const directions = [
            [1, 0], [1, -1], [0, -1],
            [-1, 0], [-1, 1], [0, 1]
        ];
        
        const neighbors = [];
        for (const [dq, dr] of directions) {
            const nq = q + dq;
            const nr = r + dr;
            if (this.isValidCell(nq, nr)) {
                neighbors.push(this.getCellId(nq, nr));
            }
        }
        return neighbors;
    }

    isValidCell(q, r) {
        return q >= 0 && q < this.width && r >= 0 && r < this.height;
    }

    calculateDistance(cellId1, cellId2) {
        const coords1 = this.getCellCoordinates(cellId1);
        const coords2 = this.getCellCoordinates(cellId2);
        
        return (Math.abs(coords1.q - coords2.q) + 
                Math.abs(coords1.q + coords1.r - coords2.q - coords2.r) + 
                Math.abs(coords1.r - coords2.r)) / 2;
    }

    addObstacle(cellId, type = 'tree') {
        if (this.cells[cellId]) {
            this.cells[cellId].type = type;
            this.cells[cellId].occupied = true;
            this.obstacles[cellId] = { type, cellId };
        }
    }

    removeObstacle(cellId) {
        if (this.cells[cellId]) {
            this.cells[cellId].type = 'empty';
            this.cells[cellId].occupied = false;
            delete this.obstacles[cellId];
        }
    }

    placeCharacter(characterId, cellId, direction = 0) {
        if (this.cells[cellId] && !this.cells[cellId].occupied) {
            // –û—Å–≤–æ–±–æ–∂–¥–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â—É—é –ø–æ–∑–∏—Ü–∏—é
            this.removeCharacter(characterId);
            
            this.cells[cellId].occupied = true;
            this.characters[characterId] = {
                cellId: cellId,
                direction: direction, // 0-5, –≥–¥–µ 0 - –≤–ø—Ä–∞–≤–æ, –ø–æ —á–∞—Å–æ–≤–æ–π —Å—Ç—Ä–µ–ª–∫–µ
                characterId: characterId
            };
            return true;
        }
        return false;
    }

    removeCharacter(characterId) {
        if (this.characters[characterId]) {
            const cellId = this.characters[characterId].cellId;
            if (this.cells[cellId]) {
                this.cells[cellId].occupied = false;
            }
            delete this.characters[characterId];
        }
    }

    moveCharacter(characterId, targetCellId) {
        if (!this.characters[characterId]) return false;
        
        const currentCellId = this.characters[characterId].cellId;
        const distance = this.calculateDistance(currentCellId, targetCellId);
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è (1 –≥–µ–∫—Å –∑–∞ —Ö–æ–¥)
        if (distance <= 1 && this.placeCharacter(characterId, targetCellId)) {
            return true;
        }
        return false;
    }

    getCharacterPosition(characterId) {
        return this.characters[characterId];
    }

    getCellAtDirection(cellId, direction, distance = 1) {
        const coords = this.getCellCoordinates(cellId);
        let targetQ = coords.q;
        let targetR = coords.r;

        // –í–µ–∫—Ç–æ—Ä—ã –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–ª—è –≥–µ–∫—Å–∞–≥–æ–Ω–∞–ª—å–Ω–æ–π —Å–µ—Ç–∫–∏
        const directionVectors = [
            [1, 0], [1, -1], [0, -1],
            [-1, 0], [-1, 1], [0, 1]
        ];

        if (direction >= 0 && direction < 6) {
            const [dq, dr] = directionVectors[direction];
            targetQ += dq * distance;
            targetR += dr * distance;
        }

        const targetCellId = this.getCellId(targetQ, targetR);
        return this.isValidCell(targetQ, targetR) ? targetCellId : null;
    }

    getFieldOfView(characterId, range = 10) {
        const character = this.characters[characterId];
        if (!character) return [];

        const visibleCells = new Set();
        const centerCoords = this.getCellCoordinates(character.cellId);
        
        // –ü—Ä–æ—Å—Ç–æ–π –∞–ª–≥–æ—Ä–∏—Ç–º –≤–∏–¥–∏–º–æ—Å—Ç–∏ (–º–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å)
        for (let q = -range; q <= range; q++) {
            for (let r = -range; r <= range; r++) {
                const targetQ = centerCoords.q + q;
                const targetR = centerCoords.r + r;
                
                if (this.isValidCell(targetQ, targetR)) {
                    const distance = this.calculateDistance(character.cellId, this.getCellId(targetQ, targetR));
                    if (distance <= range) {
                        visibleCells.add(this.getCellId(targetQ, targetR));
                    }
                }
            }
        }

        return Array.from(visibleCells);
    }

    getDirectionBetweenCells(fromCellId, toCellId) {
        const from = this.getCellCoordinates(fromCellId);
        const to = this.getCellCoordinates(toCellId);
        
        const dq = to.q - from.q;
        const dr = to.r - from.r;
        
        // –£–ø—Ä–æ—â–µ–Ω–Ω–æ–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è
        if (dq > 0 && dr === 0) return 0; // –í–ø—Ä–∞–≤–æ
        if (dq > 0 && dr < 0) return 1;   // –í–ø—Ä–∞–≤–æ-–≤–≤–µ—Ä—Ö
        if (dq === 0 && dr < 0) return 2; // –í–≤–µ—Ä—Ö
        if (dq < 0 && dr === 0) return 3; // –í–ª–µ–≤–æ
        if (dq < 0 && dr > 0) return 4;   // –í–ª–µ–≤–æ-–≤–Ω–∏–∑
        if (dq === 0 && dr > 0) return 5; // –í–Ω–∏–∑
        
        return 0;
    }
}

// ========== –°–ò–°–¢–ï–ú–ê –í–ò–ó–£–ê–õ–ò–ó–ê–¶–ò–ò –ü–û–õ–Ø –ë–û–Ø ==========

class BattlefieldRenderer {
    constructor(battlefield, containerId) {
        this.battlefield = battlefield;
        this.container = document.getElementById(containerId);
        this.selectedCell = null;
        this.selectedCharacter = null;
        this.setupEventListeners();
    }

    render() {
        if (!this.container) return;

        this.container.innerHTML = '';
        this.container.style.position = 'relative';
        this.container.style.width = `${this.battlefield.width * this.battlefield.hexSize * 1.8}px`;
        this.container.style.height = `${this.battlefield.height * this.battlefield.hexSize * 1.8}px`;
        this.container.style.background = '#1a0f0b';
        this.container.style.border = '2px solid #8b4513';
        this.container.style.borderRadius = '8px';
        this.container.style.overflow = 'hidden';

        // –†–µ–Ω–¥–µ—Ä–∏–º –≥–µ–∫—Å—ã
        for (const cellId in this.battlefield.cells) {
            this.renderHex(cellId);
        }

        // –†–µ–Ω–¥–µ—Ä–∏–º –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π
        for (const characterId in this.battlefield.characters) {
            this.renderCharacter(characterId);
        }
    }

    renderHex(cellId) {
        const cell = this.battlefield.cells[cellId];
        const { x, y } = this.battlefield.hexToPixel(cell.q, cell.r);
        
        const hexElement = document.createElement('div');
        hexElement.id = `hex_${cellId}`;
        hexElement.className = 'battlefield-hex';
        hexElement.style.cssText = `
            position: absolute;
            left: ${x}px;
            top: ${y}px;
            width: ${this.battlefield.hexSize * 2}px;
            height: ${this.battlefield.hexSize * 2}px;
            background: ${this.getHexColor(cell)};
            clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%);
            border: 1px solid #5a3928;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: #e0d0c0;
        `;

        hexElement.innerHTML = this.getHexContent(cell);
        hexElement.addEventListener('click', () => this.onHexClick(cellId));
        hexElement.addEventListener('mouseenter', () => this.onHexHover(cellId));
        hexElement.addEventListener('mouseleave', () => this.onHexLeave(cellId));

        this.container.appendChild(hexElement);
    }

    getHexColor(cell) {
        if (cell.occupied && cell.type !== 'empty') {
            switch (cell.type) {
                case 'tree': return '#2d5a27';
                case 'rock': return '#5a5a5a';
                case 'building': return '#8b4513';
                default: return '#3d2418';
            }
        }
        return cell.occupied ? '#5a3928' : '#2c1810';
    }

    getHexContent(cell) {
        if (cell.occupied && cell.type !== 'empty') {
            switch (cell.type) {
                case 'tree': return 'üå≤';
                case 'rock': return 'ü™®';
                case 'building': return 'üè†';
            }
        }
        return '';
    }

    renderCharacter(characterId) {
        const character = this.battlefield.characters[characterId];
        const cell = this.battlefield.cells[character.cellId];
        const { x, y } = this.battlefield.hexToPixel(cell.q, cell.r);
        
        const charElement = document.createElement('div');
        charElement.id = `char_${characterId}`;
        charElement.className = 'battlefield-character';
        charElement.style.cssText = `
            position: absolute;
            left: ${x + this.battlefield.hexSize * 0.5}px;
            top: ${y + this.battlefield.hexSize * 0.5}px;
            width: ${this.battlefield.hexSize}px;
            height: ${this.battlefield.hexSize}px;
            background: #d4af37;
            border: 2px solid #8b4513;
            border-radius: 50%;
            cursor: pointer;
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            color: #1a0f0b;
        `;

        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å–∏–º–≤–æ–ª –ø–æ —Ç–∏–ø—É –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
        const charSymbol = characterId.startsWith('player') ? 'üë§' : 
                          characterId.startsWith('farmer') ? 'üë®‚Äçüåæ' : 
                          characterId.startsWith('bandit') ? 'üíÄ' : '‚öîÔ∏è';
        
        charElement.innerHTML = charSymbol;
        charElement.title = `–ü–µ—Ä—Å–æ–Ω–∞–∂: ${characterId}`;
        
        charElement.addEventListener('click', (e) => {
            e.stopPropagation();
            this.onCharacterClick(characterId);
        });

        this.container.appendChild(charElement);
    }

    onHexClick(cellId) {
        console.log('–í—ã–±—Ä–∞–Ω–∞ —è—á–µ–π–∫–∞:', cellId);
        
        if (this.selectedCharacter) {
            // –ü—ã—Ç–∞–µ–º—Å—è –ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
            if (this.battlefield.moveCharacter(this.selectedCharacter, cellId)) {
                console.log(`–ü–µ—Ä—Å–æ–Ω–∞–∂ ${this.selectedCharacter} –ø–µ—Ä–µ–º–µ—â–µ–Ω –≤ ${cellId}`);
                this.render();
            } else {
                console.log('–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –≤ —ç—Ç—É —è—á–µ–π–∫—É');
            }
            this.selectedCharacter = null;
        } else {
            this.selectedCell = cellId;
            this.highlightCell(cellId);
        }
    }

    onHexHover(cellId) {
        this.highlightCell(cellId, true);
    }

    onHexLeave(cellId) {
        this.highlightCell(cellId, false);
    }

    onCharacterClick(characterId) {
        this.selectedCharacter = characterId;
        console.log('–í—ã–±—Ä–∞–Ω –ø–µ—Ä—Å–æ–Ω–∞–∂:', characterId);
        
        // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –≤–æ–∑–º–æ–∂–Ω—ã–µ —Ö–æ–¥—ã
        this.highlightPossibleMoves(characterId);
    }

    highlightCell(cellId, isHover = false) {
        const hexElement = document.getElementById(`hex_${cellId}`);
        if (hexElement) {
            if (isHover) {
                hexElement.style.filter = 'brightness(1.3)';
                hexElement.style.borderColor = '#d4af37';
            } else {
                hexElement.style.filter = 'brightness(1)';
                hexElement.style.borderColor = '#5a3928';
            }
        }
    }

    highlightPossibleMoves(characterId) {
        const character = this.battlefield.characters[characterId];
        if (!character) return;

        const currentCellId = character.cellId;
        const neighbors = this.battlefield.getNeighbors(
            this.battlefield.getCellCoordinates(currentCellId).q,
            this.battlefield.getCellCoordinates(currentCellId).r
        );

        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É –≤—Å–µ—Ö —è—á–µ–µ–∫
        this.resetHighlights();

        // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º –≤–æ–∑–º–æ–∂–Ω—ã–µ —Ö–æ–¥—ã
        neighbors.forEach(cellId => {
            const hexElement = document.getElementById(`hex_${cellId}`);
            if (hexElement && !this.battlefield.cells[cellId].occupied) {
                hexElement.style.background = '#27ae60';
                hexElement.style.borderColor = '#2ecc71';
            }
        });

        // –ü–æ–¥—Å–≤–µ—á–∏–≤–∞–µ–º —Ç–µ–∫—É—â—É—é –ø–æ–∑–∏—Ü–∏—é
        const currentHex = document.getElementById(`hex_${currentCellId}`);
        if (currentHex) {
            currentHex.style.background = '#3498db';
            currentHex.style.borderColor = '#2980b9';
        }
    }

    resetHighlights() {
        const allHexes = document.querySelectorAll('.battlefield-hex');
        allHexes.forEach(hex => {
            const cellId = hex.id.replace('hex_', '');
            const cell = this.battlefield.cells[cellId];
            hex.style.background = this.getHexColor(cell);
            hex.style.borderColor = '#5a3928';
        });
    }

    setupEventListeners() {
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–æ–≤ –≤–Ω–µ –ø–æ–ª—è –¥–ª—è —Å–±—Ä–æ—Å–∞ –≤—ã–¥–µ–ª–µ–Ω–∏—è
        document.addEventListener('click', (e) => {
            if (!this.container.contains(e.target)) {
                this.selectedCell = null;
                this.selectedCharacter = null;
                this.resetHighlights();
            }
        });
    }
}

// ========== –°–ò–°–¢–ï–ú–ê –õ–ê–ù–î–®–ê–§–¢–û–í ==========

const landscapes = {
    city: {
        name: "üèôÔ∏è –ì–æ—Ä–æ–¥",
        obstacles: [
            { type: 'building', density: 0.3 },
            { type: 'tree', density: 0.1 },
            { type: 'rock', density: 0.05 }
        ],
        description: "–£–∑–∫–∏–µ —É–ª–∏—Ü—ã, –º–Ω–æ–≥–æ —É–∫—Ä—ã—Ç–∏–π"
    },
    forest: {
        name: "üå≤ –õ–µ—Å", 
        obstacles: [
            { type: 'tree', density: 0.4 },
            { type: 'rock', density: 0.1 },
            { type: 'building', density: 0.02 }
        ],
        description: "–ü–ª–æ—Ç–Ω–∞—è —Ä–∞—Å—Ç–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å, –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–π –æ–±–∑–æ—Ä"
    },
    road: {
        name: "üõ£Ô∏è –î–æ—Ä–æ–≥–∞",
        obstacles: [
            { type: 'tree', density: 0.1 },
            { type: 'rock', density: 0.05 },
            { type: 'building', density: 0.01 }
        ],
        description: "–û—Ç–∫—Ä—ã—Ç–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ, —Ö–æ—Ä–æ—à–∏–π –æ–±–∑–æ—Ä"
    }
};

function generateLandscape(battlefield, landscapeType) {
    const landscape = landscapes[landscapeType];
    if (!landscape) return;

    // –û—á–∏—â–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è
    for (const cellId in battlefield.obstacles) {
        battlefield.removeObstacle(cellId);
    }

    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–æ–≤—ã–µ –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏—è
    for (let q = 0; q < battlefield.width; q++) {
        for (let r = 0; r < battlefield.height; r++) {
            const cellId = battlefield.getCellId(q, r);
            
            // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∫—Ä–∞—è –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π
            if (q < 2 || q >= battlefield.width - 2 || r < 2 || r >= battlefield.height - 2) {
                continue;
            }

            for (const obstacle of landscape.obstacles) {
                if (Math.random() < obstacle.density) {
                    battlefield.addObstacle(cellId, obstacle.type);
                    break; // –¢–æ–ª—å–∫–æ –æ–¥–Ω–æ –ø—Ä–µ–ø—è—Ç—Å—Ç–≤–∏–µ –Ω–∞ —è—á–µ–π–∫—É
                }
            }
        }
    }
}

// ========== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï –î–õ–Ø –°–ò–°–¢–ï–ú–´ –ë–û–Ø ==========

let battlefield = null;
let battlefieldRenderer = null;

// ========== –ò–ù–¢–ï–†–§–ï–ô–° –°–ò–°–¢–ï–ú–´ –ë–û–Ø ==========

function initializeCombatSystem() {
    const combatTab = document.getElementById('combat-tab');
    if (!combatTab) return;

    combatTab.innerHTML = `
        <div style="margin-bottom: 20px;">
            <h2 class="section-title">‚öîÔ∏è –ë–æ–µ–≤–∞—è –°–∏—Å—Ç–µ–º–∞</h2>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                <div>
                    <h3 style="color: #d4af37; margin-bottom: 10px;">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–æ—è</h3>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; color: #e0d0c0;">–õ–∞–Ω–¥—à–∞—Ñ—Ç:</label>
                        <select id="landscapeSelect" style="width: 100%; padding: 10px; border: 2px solid #8b4513; 
                              border-radius: 4px; background: #1a0f0b; color: #e0d0c0;">
                            <option value="city">üèôÔ∏è –ì–æ—Ä–æ–¥</option>
                            <option value="forest">üå≤ –õ–µ—Å</option>
                            <option value="road">üõ£Ô∏è –î–æ—Ä–æ–≥–∞</option>
                        </select>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; color: #e0d0c0;">–†–∞–∑–º–µ—Ä –ø–æ–ª—è:</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="number" id="battlefieldWidth" value="15" min="5" max="20" 
                                   style="flex: 1; padding: 10px; border: 2px solid #8b4513; border-radius: 4px; 
                                   background: #1a0f0b; color: #e0d0c0;">
                            <span style="color: #e0d0c0; line-height: 40px;">√ó</span>
                            <input type="number" id="battlefieldHeight" value="10" min="5" max="15" 
                                   style="flex: 1; padding: 10px; border: 2px solid #8b4513; border-radius: 4px; 
                                   background: #1a0f0b; color: #e0d0c0;">
                        </div>
                    </div>
                    
                    <button class="btn btn-plus" onclick="createBattlefield()" style="width: 100%;">
                        üé≤ –°–æ–∑–¥–∞—Ç—å –ø–æ–ª–µ –±–æ—è
                    </button>
                </div>
                
                <div>
                    <h3 style="color: #d4af37; margin-bottom: 10px;">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</h3>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                        <button class="btn btn-roll" onclick="addPlayerToBattlefield()">‚ûï –ò–≥—Ä–æ–∫</button>
                        <button class="btn btn-roll" onclick="addFarmerToBattlefield()">üë®‚Äçüåæ –§–µ—Ä–º–µ—Ä</button>
                        <button class="btn btn-roll" onclick="addBanditToBattlefield()">üíÄ –†–∞–∑–±–æ–π–Ω–∏–∫</button>
                        <button class="btn btn-minus" onclick="clearBattlefield()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å</button>
                    </div>
                    
                    <div style="background: #3d2418; padding: 15px; border-radius: 6px;">
                        <h4 style="color: #d4af37; margin-bottom: 10px;">–õ–µ–≥–µ–Ω–¥–∞:</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px; font-size: 0.9em;">
                            <div>üë§ - –ò–≥—Ä–æ–∫</div>
                            <div>üë®‚Äçüåæ - –§–µ—Ä–º–µ—Ä</div>
                            <div>üíÄ - –†–∞–∑–±–æ–π–Ω–∏–∫</div>
                            <div>üå≤ - –î–µ—Ä–µ–≤–æ</div>
                            <div>ü™® - –ö–∞–º–µ–Ω—å</div>
                            <div>üè† - –ó–¥–∞–Ω–∏–µ</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="battlefieldContainer" style="min-height: 400px; background: #1a0f0b; 
                 border: 2px solid #5a3928; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                <p style="text-align: center; color: #8b7d6b; padding: 50px;">
                    –°–æ–∑–¥–∞–π—Ç–µ –ø–æ–ª–µ –±–æ—è —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å
                </p>
            </div>
            
            <div id="battleInfo" style="background: #3d2418; padding: 15px; border-radius: 6px; display: none;">
                <h3 style="color: #d4af37; margin-bottom: 10px;">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±–æ–µ</h3>
                <div id="battleStatus">–°—Ç–∞—Ç—É—Å: –û–∂–∏–¥–∞–Ω–∏–µ –Ω–∞—á–∞–ª–∞</div>
            </div>
        </div>
    `;
}

function createBattlefield() {
    const width = parseInt(document.getElementById('battlefieldWidth').value) || 15;
    const height = parseInt(document.getElementById('battlefieldHeight').value) || 10;
    const landscapeType = document.getElementById('landscapeSelect').value;

    battlefield = new HexagonalBattlefield(width, height);
    battlefieldRenderer = new BattlefieldRenderer(battlefield, 'battlefieldContainer');
    
    generateLandscape(battlefield, landscapeType);
    battlefieldRenderer.render();
    
    document.getElementById('battleInfo').style.display = 'block';
    
    console.log(`‚úÖ –ü–æ–ª–µ –±–æ—è —Å–æ–∑–¥–∞–Ω–æ: ${width}x${height}, –ª–∞–Ω–¥—à–∞—Ñ—Ç: ${landscapeType}`);
}

function addPlayerToBattlefield() {
    if (!battlefield) {
        alert('–°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ –ø–æ–ª–µ –±–æ—è!');
        return;
    }

    // –†–∞–∑–º–µ—â–∞–µ–º –∏–≥—Ä–æ–∫–∞ –≤ –ª–µ–≤–æ–º –Ω–∏–∂–Ω–µ–º —É–≥–ª—É
    const startCell = battlefield.getCellId(1, battlefield.height - 2);
    if (battlefield.placeCharacter('player_1', startCell, 0)) {
        battlefieldRenderer.render();
        console.log('‚úÖ –ò–≥—Ä–æ–∫ –¥–æ–±–∞–≤–ª–µ–Ω –Ω–∞ –ø–æ–ª–µ –±–æ—è');
    }
}

function addFarmerToBattlefield() {
    if (!battlefield) {
        alert('–°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ –ø–æ–ª–µ –±–æ—è!');
        return;
    }

    const farmerId = 'farmer_' + Date.now();
    // –†–∞–∑–º–µ—â–∞–µ–º —Ñ–µ—Ä–º–µ—Ä–∞ –≤ –ø—Ä–∞–≤–æ–º –≤–µ—Ä—Ö–Ω–µ–º —É–≥–ª—É
    const startCell = battlefield.getCellId(battlefield.width - 2, 1);
    if (battlefield.placeCharacter(farmerId, startCell, 3)) {
        battlefieldRenderer.render();
        console.log('‚úÖ –§–µ—Ä–º–µ—Ä –¥–æ–±–∞–≤–ª–µ–Ω –Ω–∞ –ø–æ–ª–µ –±–æ—è');
    }
}

function addBanditToBattlefield() {
    if (!battlefield) {
        alert('–°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ –ø–æ–ª–µ –±–æ—è!');
        return;
    }

    const banditId = 'bandit_' + Date.now();
    // –†–∞–∑–º–µ—â–∞–µ–º —Ä–∞–∑–±–æ–π–Ω–∏–∫–∞ –≤ —Å–ª—É—á–∞–π–Ω–æ–π –ø–æ–∑–∏—Ü–∏–∏
    const randomQ = Math.floor(Math.random() * (battlefield.width - 4)) + 2;
    const randomR = Math.floor(Math.random() * (battlefield.height - 4)) + 2;
    const startCell = battlefield.getCellId(randomQ, randomR);
    
    if (battlefield.placeCharacter(banditId, startCell, Math.floor(Math.random() * 6))) {
        battlefieldRenderer.render();
        console.log('‚úÖ –†–∞–∑–±–æ–π–Ω–∏–∫ –¥–æ–±–∞–≤–ª–µ–Ω –Ω–∞ –ø–æ–ª–µ –±–æ—è');
    }
}

function clearBattlefield() {
    if (!battlefield) return;
    
    // –£–¥–∞–ª—è–µ–º –≤—Å–µ—Ö –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π
    for (const characterId in battlefield.characters) {
        battlefield.removeCharacter(characterId);
    }
    
    battlefieldRenderer.render();
    console.log('‚úÖ –ü–æ–ª–µ –±–æ—è –æ—á–∏—â–µ–Ω–æ');
}

// ========== –û–ë–ù–û–í–õ–ï–ù–ò–ï –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–ò ==========

function initializeSystem() {
    console.log('üéÆ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è D&D —Å–∏—Å—Ç–µ–º—ã...');
    
    // –ï—Å–ª–∏ –Ω–µ—Ç –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π, —Å–æ–∑–¥–∞–µ–º –¥–µ–º–æ-–ø–µ—Ä—Å–æ–Ω–∞–∂–∞
    if (!currentCharacter && Object.keys(characterManager.characters).length === 0) {
        const demoChar = characterManager.createCharacter('–ù–æ–≤—ã–π –ì–µ—Ä–æ–π', 'human');
        currentCharacter = demoChar;
        console.log('‚úÖ –°–æ–∑–¥–∞–Ω –¥–µ–º–æ-–ø–µ—Ä—Å–æ–Ω–∞–∂');
    }
    
    // –†–µ–Ω–¥–µ—Ä–∏–º –ª–∏—Å—Ç –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
    renderCharacterSheet();
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–∏—Å—Ç–µ–º—É –±–æ—è
    initializeCombatSystem();
    
    console.log(`‚úÖ –°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞! –ü–µ—Ä—Å–æ–Ω–∞–∂–µ–π: ${Object.keys(characterManager.characters).length}`);
}

// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –≤–∫–ª–∞–¥–∫–∏ –±–æ—è
let combatTabInitialized = false;
function openTab(tabName) {
    document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    document.getElementById(tabName + '-tab').classList.add('active');
    event.currentTarget.classList.add('active');
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º —Å–∏—Å—Ç–µ–º—É –±–æ—è –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –æ—Ç–∫—Ä—ã—Ç–∏–∏ –≤–∫–ª–∞–¥–∫–∏
    if (tabName === 'combat' && !combatTabInitialized) {
        initializeCombatSystem();
        combatTabInitialized = true;
    }
}
                    // ========== –°–ò–°–¢–ï–ú–ê –ë–û–ï–í–û–ô –ú–ï–•–ê–ù–ò–ö–ò ==========

class CombatSystem {
    constructor(battlefield) {
        this.battlefield = battlefield;
        this.combatants = {};
        this.currentTurn = 0;
        this.activeCombatant = null;
        this.combatHistory = [];
        this.weather = 'clear';
        this.fog = 'none';
        this.timeOfDay = 'day';
        this.isCombatActive = false;
    }

    addCombatant(characterId, type, stats = {}) {
        this.combatants[characterId] = {
            id: characterId,
            type: type, // 'player', 'farmer', 'bandit'
            stats: {
                health: stats.health || 100,
                maxHealth: stats.maxHealth || 100,
                skills: stats.skills || {},
                actions: 1,
                usedActions: 0,
                movement: 5, // –º–µ—Ç—Ä–æ–≤ –∑–∞ —Ö–æ–¥
                usedMovement: 0
            },
            conditions: [],
            position: this.battlefield.getCharacterPosition(characterId)
        };
    }

    startCombat() {
        this.isCombatActive = true;
        this.currentTurn = 1;
        this.determineInitiative();
        this.nextTurn();
        
        this.addToCombatHistory(`‚öîÔ∏è –ë–æ–π –Ω–∞—á–∞–ª—Å—è!`);
        this.updateBattleInfo();
    }

    determineInitiative() {
        // –ü—Ä–æ—Å—Ç–∞—è —Å–∏—Å—Ç–µ–º–∞ –∏–Ω–∏—Ü–∏–∞—Ç–∏–≤—ã - –∏–≥—Ä–æ–∫ –≤—Å–µ–≥–¥–∞ —Ö–æ–¥–∏—Ç –ø–µ—Ä–≤—ã–º
        const combatantIds = Object.keys(this.combatants);
        this.turnOrder = combatantIds.sort((a, b) => {
            if (a.startsWith('player')) return -1;
            if (b.startsWith('player')) return 1;
            return Math.random() - 0.5;
        });
    }

    nextTurn() {
        if (!this.isCombatActive) return;

        if (!this.activeCombatant || !this.turnOrder.includes(this.activeCombatant)) {
            this.activeCombatant = this.turnOrder[0];
        } else {
            const currentIndex = this.turnOrder.indexOf(this.activeCombatant);
            this.activeCombatant = this.turnOrder[(currentIndex + 1) % this.turnOrder.length];
        }

        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è –∏ –¥–≤–∏–∂–µ–Ω–∏–µ
        const combatant = this.combatants[this.activeCombatant];
        if (combatant) {
            combatant.stats.usedActions = 0;
            combatant.stats.usedMovement = 0;
        }

        this.addToCombatHistory(`üîÑ –•–æ–¥ ${this.currentTurn}: ${this.getCombatantName(this.activeCombatant)}`);
        this.updateBattleInfo();

        // –ï—Å–ª–∏ —Ö–æ–¥ –≤—Ä–∞–≥–∞ - –≤—ã–ø–æ–ª–Ω—è–µ–º AI
        if (this.activeCombatant.startsWith('farmer') || this.activeCombatant.startsWith('bandit')) {
            setTimeout(() => this.executeEnemyTurn(), 1000);
        }
    }

    executeEnemyTurn() {
        const enemy = this.combatants[this.activeCombatant];
        if (!enemy) return;

        const playerId = Object.keys(this.combatants).find(id => id.startsWith('player'));
        if (!playerId) return;

        // –ü—Ä–æ—Å—Ç–æ–π AI: –¥–≤–∏–≥–∞—Ç—å—Å—è –∫ –∏–≥—Ä–æ–∫—É –∏ –∞—Ç–∞–∫–æ–≤–∞—Ç—å
        const enemyPos = enemy.position;
        const playerPos = this.battlefield.getCharacterPosition(playerId);

        if (enemyPos && playerPos) {
            const distance = this.battlefield.calculateDistance(enemyPos.cellId, playerPos.cellId);
            
            if (distance <= 1) {
                // –ê—Ç–∞–∫–æ–≤–∞—Ç—å –µ—Å–ª–∏ —Ä—è–¥–æ–º
                this.performMeleeAttack(this.activeCombatant, playerId);
            } else if (enemy.stats.usedMovement < enemy.stats.movement) {
                // –î–≤–∏–≥–∞—Ç—å—Å—è –∫ –∏–≥—Ä–æ–∫—É
                this.moveTowardsTarget(this.activeCombatant, playerPos.cellId);
            }
        }

        // –ó–∞–≤–µ—Ä—à–∞–µ–º —Ö–æ–¥ –≤—Ä–∞–≥–∞
        setTimeout(() => this.nextTurn(), 500);
    }

    moveTowardsTarget(combatantId, targetCellId) {
        const combatant = this.combatants[combatantId];
        if (!combatant || !combatant.position) return false;

        const currentCellId = combatant.position.cellId;
        const neighbors = this.battlefield.getNeighbors(
            this.battlefield.getCellCoordinates(currentCellId).q,
            this.battlefield.getCellCoordinates(currentCellId).r
        );

        // –ù–∞—Ö–æ–¥–∏–º –±–ª–∏–∂–∞–π—à—É—é –∫ —Ü–µ–ª–∏ —è—á–µ–π–∫—É
        let bestCell = null;
        let bestDistance = Infinity;

        for (const neighborId of neighbors) {
            if (!this.battlefield.cells[neighborId].occupied) {
                const distance = this.battlefield.calculateDistance(neighborId, targetCellId);
                if (distance < bestDistance) {
                    bestDistance = distance;
                    bestCell = neighborId;
                }
            }
        }

        if (bestCell && this.battlefield.moveCharacter(combatantId, bestCell)) {
            combatant.position = this.battlefield.getCharacterPosition(combatantId);
            combatant.stats.usedMovement += 1;
            
            this.addToCombatHistory(`üö∂ ${this.getCombatantName(combatantId)} –ø–µ—Ä–µ–º–µ—Å—Ç–∏–ª—Å—è`);
            this.updateBattlefieldDisplay();
            return true;
        }

        return false;
    }

    performMeleeAttack(attackerId, targetId, aimZone = 'torso') {
        const attacker = this.combatants[attackerId];
        const target = this.combatants[targetId];
        
        if (!attacker || !target) return false;

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∏—Å—Ç–∞–Ω—Ü–∏–∏
        const attackerPos = attacker.position;
        const targetPos = this.battlefield.getCharacterPosition(targetId);
        
        if (!attackerPos || !targetPos) return false;

        const distance = this.battlefield.calculateDistance(attackerPos.cellId, targetPos.cellId);
        if (distance > 1) {
            this.addToCombatHistory(`‚ùå ${this.getCombatantName(attackerId)} –Ω–µ –º–æ–∂–µ—Ç –∞—Ç–∞–∫–æ–≤–∞—Ç—å - —Å–ª–∏—à–∫–æ–º –¥–∞–ª–µ–∫–æ`);
            return false;
        }

        // –ë—Ä–æ—Å–æ–∫ –Ω–∞ –ø–æ–ø–∞–¥–∞–Ω–∏–µ
        const attackSkill = attacker.stats.skills['–û–¥–Ω–æ—Ä—É—á–Ω–æ–µ –æ—Ä—É–∂–∏–µ'] || 10;
        const aimModifier = this.getAimModifier(aimZone);
        const attackCheck = rollSkillCheck(attackSkill, aimModifier);

        if (attackCheck.success) {
            // –†–∞—Å—á–µ—Ç —É—Ä–æ–Ω–∞
            const damage = this.calculateDamage(attacker, 'slashing');
            target.stats.health -= damage;

            this.addToCombatHistory(`üó°Ô∏è ${this.getCombatantName(attackerId)} –ø–æ–ø–∞–¥–∞–µ—Ç –ø–æ ${aimZone} –∏ –Ω–∞–Ω–æ—Å–∏—Ç ${damage} —É—Ä–æ–Ω–∞!`);

            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–º–µ—Ä—Ç–∏
            if (target.stats.health <= 0) {
                target.stats.health = 0;
                this.addToCombatHistory(`üíÄ ${this.getCombatantName(targetId)} —É–±–∏—Ç!`);
                this.removeCombatant(targetId);
            }
        } else {
            this.addToCombatHistory(`‚ùå ${this.getCombatantName(attackerId)} –ø—Ä–æ–º–∞—Ö–∏–≤–∞–µ—Ç—Å—è!`);
        }

        attacker.stats.usedActions += 1;
        this.updateBattleInfo();
        return attackCheck.success;
    }

    getAimModifier(aimZone) {
        const modifiers = {
            'torso': 0,
            'head': -5,
            'eye': -9,
            'neck': -7,
            'limb': -2,
            'hand': -4,
            'weapon': -4,
            'organs': -5
        };
        return modifiers[aimZone] || 0;
    }

    calculateDamage(attacker, damageType) {
        // –ë–∞–∑–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ —É—Ä–æ–Ω–∞ (—É–ø—Ä–æ—â–µ–Ω–Ω–∞—è)
        const baseDamage = rollDice(6, 2).total; // 2d6
        let modifier = 0;

        // –ú–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã –æ—Ç –Ω–∞–≤—ã–∫–æ–≤
        if (damageType === 'slashing') {
            modifier = Math.floor((attacker.stats.skills['–û–¥–Ω–æ—Ä—É—á–Ω–æ–µ –æ—Ä—É–∂–∏–µ'] || 10) / 5);
        }

        return Math.max(1, baseDamage + modifier);
    }

    removeCombatant(combatantId) {
        this.battlefield.removeCharacter(combatantId);
        delete this.combatants[combatantId];

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –±–æ—è
        this.checkCombatEnd();
    }

    checkCombatEnd() {
        const players = Object.keys(this.combatants).filter(id => id.startsWith('player'));
        const enemies = Object.keys(this.combatants).filter(id => !id.startsWith('player'));

        if (players.length === 0) {
            this.endCombat('defeat');
        } else if (enemies.length === 0) {
            this.endCombat('victory');
        }
    }

    endCombat(result) {
        this.isCombatActive = false;
        
        if (result === 'victory') {
            this.addToCombatHistory(`üéâ –ü–æ–±–µ–¥–∞! –í—Å–µ –≤—Ä–∞–≥–∏ –ø–æ–≤–µ—Ä–∂–µ–Ω—ã!`);
        } else {
            this.addToCombatHistory(`üíÄ –ü–æ—Ä–∞–∂–µ–Ω–∏–µ! –í—Å–µ –∏–≥—Ä–æ–∫–∏ –ø–∞–ª–∏...`);
        }

        this.updateBattleInfo();
    }

    getCombatantName(combatantId) {
        if (combatantId.startsWith('player')) return '–ò–≥—Ä–æ–∫';
        if (combatantId.startsWith('farmer')) return '–§–µ—Ä–º–µ—Ä';
        if (combatantId.startsWith('bandit')) return '–†–∞–∑–±–æ–π–Ω–∏–∫';
        return combatantId;
    }

    addToCombatHistory(message) {
        this.combatHistory.unshift({
            turn: this.currentTurn,
            message: message,
            timestamp: new Date().toLocaleTimeString()
        });

        // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é 50 —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
        if (this.combatHistory.length > 50) {
            this.combatHistory.pop();
        }

        this.updateCombatHistoryDisplay();
    }

    updateCombatHistoryDisplay() {
        const historyElement = document.getElementById('combatHistory');
        if (!historyElement) return;

        let historyHTML = '<h4 style="color: #d4af37; margin-bottom: 10px;">üìú –ò—Å—Ç–æ—Ä–∏—è –±–æ—è:</h4>';
        
        this.combatHistory.slice(0, 10).forEach(entry => {
            historyHTML += `
                <div style="padding: 5px 0; border-bottom: 1px solid #3d2418; font-size: 0.9em;">
                    <span style="color: #8b7d6b;">[${entry.timestamp}]</span> ${entry.message}
                </div>
            `;
        });

        historyElement.innerHTML = historyHTML;
    }

    updateBattleInfo() {
        const battleInfo = document.getElementById('battleInfo');
        const battleStatus = document.getElementById('battleStatus');
        
        if (!battleInfo || !battleStatus) return;

        let statusHTML = '';

        if (this.isCombatActive) {
            statusHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px;">
                    <div><strong>–¢–µ–∫—É—â–∏–π —Ö–æ–¥:</strong> ${this.currentTurn}</div>
                    <div><strong>–ê–∫—Ç–∏–≤–Ω—ã–π:</strong> ${this.getCombatantName(this.activeCombatant)}</div>
                </div>
                <div><strong>–°—Ç–∞—Ç—É—Å:</strong> –ë–æ–π –∞–∫—Ç–∏–≤–µ–Ω</div>
            `;
        } else {
            statusHTML = `<strong>–°—Ç–∞—Ç—É—Å:</strong> –ë–æ–π –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω`;
        }

        // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–æ–º–±–∞—Ç–∞–Ω—Ç–∞—Ö
        statusHTML += `<div style="margin-top: 15px;"><strong>–£—á–∞—Å—Ç–Ω–∏–∫–∏:</strong></div>`;
        
        for (const combatantId in this.combatants) {
            const combatant = this.combatants[combatantId];
            const healthPercent = (combatant.stats.health / combatant.stats.maxHealth) * 100;
            const healthColor = healthPercent > 60 ? '#27ae60' : healthPercent > 30 ? '#f39c12' : '#e74c3c';
            
            statusHTML += `
                <div style="display: flex; justify-content: space-between; align-items: center; 
                     padding: 5px 0; border-bottom: 1px solid #3d2418;">
                    <span>${this.getCombatantName(combatantId)}</span>
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div style="width: 60px; height: 8px; background: #2c1810; border-radius: 4px;">
                            <div style="width: ${healthPercent}%; height: 100%; background: ${healthColor}; border-radius: 4px;"></div>
                        </div>
                        <span style="font-size: 0.9em;">${combatant.stats.health}/${combatant.stats.maxHealth}</span>
                    </div>
                </div>
            `;
        }

        battleStatus.innerHTML = statusHTML;
    }
}

// ========== –ò–ù–¢–ï–†–§–ï–ô–° –£–ü–†–ê–í–õ–ï–ù–ò–Ø –ë–û–ï–ú ==========

let combatSystem = null;

function updateCombatInterface() {
    const combatControls = document.getElementById('combatControls');
    if (!combatControls) return;

    const isPlayerTurn = combatSystem && combatSystem.activeCombatant && 
                        combatSystem.activeCombatant.startsWith('player');

    combatControls.innerHTML = `
        <h3 style="color: #d4af37; margin-bottom: 15px;">–î–µ–π—Å—Ç–≤–∏—è –≤ –±–æ—é</h3>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
            <button class="btn btn-roll" onclick="playerMove()" ${!isPlayerTurn ? 'disabled' : ''}>
                üö∂ –ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ
            </button>
            <button class="btn btn-roll" onclick="playerAttack()" ${!isPlayerTurn ? 'disabled' : ''}>
                ‚öîÔ∏è –ê—Ç–∞–∫–∞
            </button>
            <button class="btn btn-roll" onclick="playerAim()" ${!isPlayerTurn ? 'disabled' : ''}>
                üéØ –ü—Ä–∏—Ü–µ–ª–∏–≤–∞–Ω–∏–µ
            </button>
            <button class="btn btn-roll" onclick="playerBlock()" ${!isPlayerTurn ? 'disabled' : ''}>
                üõ°Ô∏è –ë–ª–æ–∫
            </button>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            <button class="btn btn-plus" onclick="playerEndTurn()" ${!isPlayerTurn ? 'disabled' : ''}>
                ‚úÖ –ó–∞–≤–µ—Ä—à–∏—Ç—å —Ö–æ–¥
            </button>
            <button class="btn btn-minus" onclick="endCombat()">
                üè≥Ô∏è –ó–∞–≤–µ—Ä—à–∏—Ç—å –±–æ–π
            </button>
        </div>
        
        <div id="combatHistory" style="margin-top: 20px; max-height: 200px; overflow-y: auto; 
             background: #2c1810; padding: 10px; border-radius: 6px; border: 1px solid #5a3928;">
        </div>
    `;

    if (combatSystem) {
        combatSystem.updateCombatHistoryDisplay();
    }
}

function playerMove() {
    if (!combatSystem || !combatSystem.activeCombatant) return;

    const combatant = combatSystem.combatants[combatSystem.activeCombatant];
    if (!combatant || combatant.stats.usedActions >= combatant.stats.actions) {
        alert('–í—ã —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ –≤—Å–µ –¥–µ–π—Å—Ç–≤–∏—è –≤ —ç—Ç–æ–º —Ö–æ–¥—É!');
        return;
    }

    alert('–í—ã–±–µ—Ä–∏—Ç–µ —è—á–µ–π–∫—É –¥–ª—è –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è –Ω–∞ –ø–æ–ª–µ –±–æ—è');
    // –†–µ–∂–∏–º –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è —á–µ—Ä–µ–∑ –≤—ã–¥–µ–ª–µ–Ω–∏–µ —è—á–µ–π–∫–∏
}

function playerAttack() {
    if (!combatSystem || !combatSystem.activeCombatant) return;

    const combatant = combatSystem.combatants[combatSystem.activeCombatant];
    if (!combatant || combatant.stats.usedActions >= combatant.stats.actions) {
        alert('–í—ã —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ –≤—Å–µ –¥–µ–π—Å—Ç–≤–∏—è –≤ —ç—Ç–æ–º —Ö–æ–¥—É!');
        return;
    }

    // –ù–∞—Ö–æ–¥–∏–º –±–ª–∏–∂–∞–π—à–µ–≥–æ –≤—Ä–∞–≥–∞
    const enemies = Object.keys(combatSystem.combatants).filter(id => 
        !id.startsWith('player') && combatSystem.combatants[id].stats.health > 0
    );

    if (enemies.length === 0) {
        alert('–ù–µ—Ç –≤—Ä–∞–≥–æ–≤ –¥–ª—è –∞—Ç–∞–∫–∏!');
        return;
    }

    // –ê—Ç–∞–∫—É–µ–º –±–ª–∏–∂–∞–π—à–µ–≥–æ –≤—Ä–∞–≥–∞
    const attackerPos = combatant.position;
    let closestEnemy = null;
    let closestDistance = Infinity;

    for (const enemyId of enemies) {
        const enemyPos = combatSystem.battlefield.getCharacterPosition(enemyId);
        if (enemyPos) {
            const distance = combatSystem.battlefield.calculateDistance(
                attackerPos.cellId, enemyPos.cellId
            );
            if (distance < closestDistance) {
                closestDistance = distance;
                closestEnemy = enemyId;
            }
        }
    }

    if (closestEnemy && closestDistance <= 1) {
        combatSystem.performMeleeAttack(combatSystem.activeCombatant, closestEnemy, 'torso');
        updateCombatInterface();
    } else {
        alert('–ù–µ—Ç –≤—Ä–∞–≥–æ–≤ –≤ —Ä–∞–¥–∏—É—Å–µ –∞—Ç–∞–∫–∏!');
    }
}

function playerAim() {
    if (!combatSystem || !combatSystem.activeCombatant) return;

    const combatant = combatSystem.combatants[combatSystem.activeCombatant];
    if (combatant.stats.usedActions >= combatant.stats.actions) {
        alert('–í—ã —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ –≤—Å–µ –¥–µ–π—Å—Ç–≤–∏—è –≤ —ç—Ç–æ–º —Ö–æ–¥—É!');
        return;
    }

    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ–π—Å—Ç–≤–∏–µ –¥–ª—è –ø—Ä–∏—Ü–µ–ª–∏–≤–∞–Ω–∏—è (–¥–∞–µ—Ç –±–æ–Ω—É—Å –∫ —Å–ª–µ–¥—É—é—â–µ–π –∞—Ç–∞–∫–µ)
    combatant.stats.usedActions += 1;
    combatSystem.addToCombatHistory(`üéØ ${combatSystem.getCombatantName(combatSystem.activeCombatant)} –ø—Ä–∏—Ü–µ–ª–∏–≤–∞–µ—Ç—Å—è`);
    updateCombatInterface();
}

function playerBlock() {
    if (!combatSystem || !combatSystem.activeCombatant) return;

    const combatant = combatSystem.combatants[combatSystem.activeCombatant];
    if (combatant.stats.usedActions >= combatant.stats.actions) {
        alert('–í—ã —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ –≤—Å–µ –¥–µ–π—Å—Ç–≤–∏—è –≤ —ç—Ç–æ–º —Ö–æ–¥—É!');
        return;
    }

    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ–π—Å—Ç–≤–∏–µ –¥–ª—è –±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∏—è (–¥–∞–µ—Ç –∑–∞—â–∏—Ç—É –¥–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ —Ö–æ–¥–∞)
    combatant.stats.usedActions += 1;
    combatSystem.addToCombatHistory(`üõ°Ô∏è ${combatSystem.getCombatantName(combatSystem.activeCombatant)} –≥–æ—Ç–æ–≤–∏—Ç—Å—è –∫ –±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∏—é`);
    updateCombatInterface();
}

function playerEndTurn() {
    if (!combatSystem) return;
    combatSystem.nextTurn();
    updateCombatInterface();
}

function startCombat() {
    if (!battlefield) {
        alert('–°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ –ø–æ–ª–µ –±–æ—è –∏ —Ä–∞–∑–º–µ—Å—Ç–∏—Ç–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π!');
        return;
    }

    combatSystem = new CombatSystem(battlefield);

    // –î–æ–±–∞–≤–ª—è–µ–º –≤—Å–µ—Ö –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π –Ω–∞ –ø–æ–ª–µ –≤ —Å–∏—Å—Ç–µ–º—É –±–æ—è
    for (const characterId in battlefield.characters) {
        const character = battlefield.characters[characterId];
        let type = 'player';
        let stats = { health: 100, maxHealth: 100 };

        if (characterId.startsWith('farmer')) {
            type = 'farmer';
            stats = {
                health: 50 + Math.floor(Math.random() * 21), // 50-70 HP
                maxHealth: 70,
                skills: {
                    '–û–¥–Ω–æ—Ä—É—á–Ω–æ–µ –æ—Ä—É–∂–∏–µ': 6 + Math.floor(Math.random() * 5) // 6-10
                }
            };
        } else if (characterId.startsWith('bandit')) {
            type = 'bandit';
            stats = {
                health: 70 + Math.floor(Math.random() * 31), // 70-100 HP
                maxHealth: 100,
                skills: {
                    '–û–¥–Ω–æ—Ä—É—á–Ω–æ–µ –æ—Ä—É–∂–∏–µ': 8 + Math.floor(Math.random() * 5) // 8-12
                }
            };
        } else if (characterId.startsWith('player')) {
            // –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–∞–≤—ã–∫–∏ —Ç–µ–∫—É—â–µ–≥–æ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
            stats = {
                health: currentCharacter ? currentCharacter.stats.health : 100,
                maxHealth: currentCharacter ? currentCharacter.stats.maxHealth : 100,
                skills: currentCharacter ? currentCharacter.skills : {}
            };
        }

        combatSystem.addCombatant(characterId, type, stats);
    }

    combatSystem.startCombat();
    updateCombatInterface();

    // –î–æ–±–∞–≤–ª—è–µ–º –ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –±–æ–µ–º
    const combatTab = document.getElementById('combat-tab');
    const existingControls = document.getElementById('combatControls');
    if (!existingControls) {
        const controlsHTML = `
            <div id="combatControls" style="background: #3d2418; padding: 20px; border-radius: 8px; 
                 border: 2px solid #8b4513; margin-top: 20px;">
            </div>
        `;
        combatTab.insertAdjacentHTML('beforeend', controlsHTML);
    }

    updateCombatInterface();
}

function endCombat() {
    if (combatSystem) {
        combatSystem.endCombat('manual');
        combatSystem = null;
    }
    updateCombatInterface();
}

function updateBattlefieldDisplay() {
    if (battlefieldRenderer) {
        battlefieldRenderer.render();
    }
}

// ========== –û–ë–ù–û–í–õ–ï–ù–ò–ï –ò–ù–¢–ï–†–§–ï–ô–°–ê –ë–û–Ø ==========

function initializeCombatSystem() {
    const combatTab = document.getElementById('combat-tab');
    if (!combatTab) return;

    combatTab.innerHTML = `
        <div style="margin-bottom: 20px;">
            <h2 class="section-title">‚öîÔ∏è –ë–æ–µ–≤–∞—è –°–∏—Å—Ç–µ–º–∞</h2>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                <div>
                    <h3 style="color: #d4af37; margin-bottom: 10px;">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–æ—è</h3>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; color: #e0d0c0;">–õ–∞–Ω–¥—à–∞—Ñ—Ç:</label>
                        <select id="landscapeSelect" style="width: 100%; padding: 10px; border: 2px solid #8b4513; 
                              border-radius: 4px; background: #1a0f0b; color: #e0d0c0;">
                            <option value="city">üèôÔ∏è –ì–æ—Ä–æ–¥</option>
                            <option value="forest">üå≤ –õ–µ—Å</option>
                            <option value="road">üõ£Ô∏è –î–æ—Ä–æ–≥–∞</option>
                        </select>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; color: #e0d0c0;">–†–∞–∑–º–µ—Ä –ø–æ–ª—è:</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="number" id="battlefieldWidth" value="15" min="5" max="20" 
                                   style="flex: 1; padding: 10px; border: 2px solid #8b4513; border-radius: 4px; 
                                   background: #1a0f0b; color: #e0d0c0;">
                            <span style="color: #e0d0c0; line-height: 40px;">√ó</span>
                            <input type="number" id="battlefieldHeight" value="10" min="5" max="15" 
                                   style="flex: 1; padding: 10px; border: 2px solid #8b4513; border-radius: 4px; 
                                   background: #1a0f0b; color: #e0d0c0;">
                        </div>
                    </div>
                    
                    <button class="btn btn-plus" onclick="createBattlefield()" style="width: 100%; margin-bottom: 10px;">
                        üé≤ –°–æ–∑–¥–∞—Ç—å –ø–æ–ª–µ –±–æ—è
                    </button>
                    
                    <button class="btn btn-roll" onclick="startCombat()" style="width: 100%;">
                        ‚öîÔ∏è –ù–∞—á–∞—Ç—å –±–æ–π
                    </button>
                </div>
                
                <div>
                    <h3 style="color: #d4af37; margin-bottom: 10px;">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</h3>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                        <button class="btn btn-roll" onclick="addPlayerToBattlefield()">‚ûï –ò–≥—Ä–æ–∫</button>
                        <button class="btn btn-roll" onclick="addFarmerToBattlefield()">üë®‚Äçüåæ –§–µ—Ä–º–µ—Ä</button>
                        <button class="btn btn-roll" onclick="addBanditToBattlefield()">üíÄ –†–∞–∑–±–æ–π–Ω–∏–∫</button>
                        <button class="btn btn-minus" onclick="clearBattlefield()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å</button>
                    </div>
                    
                    <div style="background: #3d2418; padding: 15px; border-radius: 6px;">
                        <h4 style="color: #d4af37; margin-bottom: 10px;">–õ–µ–≥–µ–Ω–¥–∞:</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px; font-size: 0.9em;">
                            <div>üë§ - –ò–≥—Ä–æ–∫</div>
                            <div>üë®‚Äçüåæ - –§–µ—Ä–º–µ—Ä</div>
                            <div>üíÄ - –†–∞–∑–±–æ–π–Ω–∏–∫</div>
                            <div>üå≤ - –î–µ—Ä–µ–≤–æ</div>
                            <div>ü™® - –ö–∞–º–µ–Ω—å</div>
                            <div>üè† - –ó–¥–∞–Ω–∏–µ</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="battlefieldContainer" style="min-height: 400px; background: #1a0f0b; 
                 border: 2px solid #5a3928; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                <p style="text-align: center; color: #8b7d6b; padding: 50px;">
                    –°–æ–∑–¥–∞–π—Ç–µ –ø–æ–ª–µ –±–æ—è —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å
                </p>
            </div>
            
            <div id="battleInfo" style="background: #3d2418; padding: 15px; border-radius: 6px; display: none;">
                <h3 style="color: #d4af37; margin-bottom: 10px;">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±–æ–µ</h3>
                <div id="battleStatus">–°—Ç–∞—Ç—É—Å: –û–∂–∏–¥–∞–Ω–∏–µ –Ω–∞—á–∞–ª–∞</div>
            </div>
        </div>
    `;
}

// ========== –û–ë–ù–û–í–õ–ï–ù–ò–ï –°–ò–°–¢–ï–ú–´ –ü–ï–†–ï–ú–ï–©–ï–ù–ò–Ø ==========

// –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º –º–µ—Ç–æ–¥ onHexClick –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –±–æ–µ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã
const originalOnHexClick = BattlefieldRenderer.prototype.onHexClick;
BattlefieldRenderer.prototype.onHexClick = function(cellId) {
    if (combatSystem && combatSystem.isCombatActive && 
        combatSystem.activeCombatant && combatSystem.activeCombatant.startsWith('player')) {
        
        const combatant = combatSystem.combatants[combatSystem.activeCombatant];
        if (combatant && combatant.stats.usedMovement < combatant.stats.movement) {
            // –ü–æ–ø—ã—Ç–∫–∞ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è –≤ –±–æ—é
            if (combatSystem.moveTowardsTarget(combatSystem.activeCombatant, cellId)) {
                updateCombatInterface();
                return;
            }
        }
    }
    
    // –í—ã–∑—ã–≤–∞–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π –º–µ—Ç–æ–¥
    originalOnHexClick.call(this, cellId);
};
            // ========== –°–ò–°–¢–ï–ú–ê –ü–û–ì–û–î–´ –ò –í–†–ï–ú–ï–ù–ò ==========

class WeatherTimeSystem {
    constructor() {
        this.weather = 'clear';
        this.fog = 'none';
        this.timeOfDay = 'day';
        this.currentHour = 12; // 0-23
        this.weatherDuration = 0;
        this.fogDuration = 0;
    }

    // –ö—É–±–∏–∫ –ø–æ–≥–æ–¥—ã
    rollWeather() {
        const roll = rollDice(6, 1).total;
        const weatherTypes = {
            1: 'clear',
            2: 'cloudy', 
            3: 'light_rain',
            4: 'rain',
            5: 'heavy_rain',
            6: 'storm'
        };
        
        this.weather = weatherTypes[roll];
        this.weatherDuration = 2 + Math.floor(Math.random() * 4); // 2-5 —á–∞—Å–æ–≤
        return this.weather;
    }

    // –ö—É–±–∏–∫ —Ç—É–º–∞–Ω–∞
    rollFog() {
        const roll = rollDice(6, 1).total;
        const fogTypes = {
            1: 'none',
            2: 'none',
            3: 'light_fog',
            4: 'light_fog', 
            5: 'medium_fog',
            6: 'heavy_fog'
        };
        
        this.fog = fogTypes[roll];
        this.fogDuration = 1 + Math.floor(Math.random() * 3); // 1-3 —á–∞—Å–∞
        return this.fog;
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏
    advanceTime(hours = 1) {
        this.currentHour = (this.currentHour + hours) % 24;
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ —Å—É—Ç–æ–∫
        if (this.currentHour >= 6 && this.currentHour < 12) {
            this.timeOfDay = 'morning';
        } else if (this.currentHour >= 12 && this.currentHour < 18) {
            this.timeOfDay = 'day';
        } else if (this.currentHour >= 18 && this.currentHour < 24) {
            this.timeOfDay = 'evening';
        } else {
            this.timeOfDay = 'night';
        }

        // –£–º–µ–Ω—å—à–µ–Ω–∏–µ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –ø–æ–≥–æ–¥–Ω—ã—Ö —ç—Ñ—Ñ–µ–∫—Ç–æ–≤
        if (this.weatherDuration > 0) {
            this.weatherDuration -= hours;
            if (this.weatherDuration <= 0) {
                this.weather = 'clear';
            }
        }

        if (this.fogDuration > 0) {
            this.fogDuration -= hours;
            if (this.fogDuration <= 0) {
                this.fog = 'none';
            }
        }
    }

    // –ú–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã –≤–æ—Å–ø—Ä–∏—è—Ç–∏—è
    getPerceptionModifiers() {
        let modifiers = {
            perception: 0,
            stealth: 0,
            movement: 0,
            shooting: 0
        };

        // –ú–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã –≤—Ä–µ–º–µ–Ω–∏ —Å—É—Ç–æ–∫
        switch (this.timeOfDay) {
            case 'morning': modifiers.perception += 0; break;
            case 'day': modifiers.perception += 0; break;
            case 'evening': modifiers.perception -= 1; break;
            case 'night': modifiers.perception -= 3; break;
        }

        // –ú–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã –ø–æ–≥–æ–¥—ã
        switch (this.weather) {
            case 'cloudy': modifiers.perception -= 1; break;
            case 'light_rain': 
                modifiers.perception -= 2;
                modifiers.stealth += 1;
                break;
            case 'rain':
                modifiers.perception -= 3;
                modifiers.stealth += 2;
                modifiers.movement -= 1;
                break;
            case 'heavy_rain':
                modifiers.perception -= 5;
                modifiers.stealth += 3;
                modifiers.movement -= 2;
                modifiers.shooting -= 2;
                break;
            case 'storm':
                modifiers.perception -= 8;
                modifiers.stealth += 5;
                modifiers.movement -= 5;
                modifiers.shooting -= 5;
                break;
        }

        // –ú–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã —Ç—É–º–∞–Ω–∞
        switch (this.fog) {
            case 'light_fog':
                modifiers.perception -= 2;
                modifiers.stealth += 1;
                break;
            case 'medium_fog':
                modifiers.perception -= 3;
                modifiers.stealth += 2;
                modifiers.shooting -= 1;
                break;
            case 'heavy_fog':
                modifiers.perception -= 5;
                modifiers.stealth += 3;
                modifiers.shooting -= 3;
                break;
        }

        return modifiers;
    }

    getTimeDescription() {
        const times = {
            'morning': '–£—Ç—Ä–æ',
            'day': '–î–µ–Ω—å',
            'evening': '–í–µ—á–µ—Ä', 
            'night': '–ù–æ—á—å'
        };

        const weathers = {
            'clear': '–Ø—Å–Ω–æ',
            'cloudy': '–û–±–ª–∞—á–Ω–æ',
            'light_rain': '–°–ª–∞–±—ã–π –¥–æ–∂–¥—å',
            'rain': '–î–æ–∂–¥—å',
            'heavy_rain': '–°–∏–ª—å–Ω—ã–π –¥–æ–∂–¥—å',
            'storm': '–£—Ä–∞–≥–∞–Ω'
        };

        const fogs = {
            'none': '–ë–µ–∑ —Ç—É–º–∞–Ω–∞',
            'light_fog': '–°–ª–∞–±—ã–π —Ç—É–º–∞–Ω',
            'medium_fog': '–°—Ä–µ–¥–Ω–∏–π —Ç—É–º–∞–Ω',
            'heavy_fog': '–°–∏–ª—å–Ω—ã–π —Ç—É–º–∞–Ω'
        };

        return `${times[this.timeOfDay]}, ${weathers[this.weather]}, ${fogs[this.fog]}`;
    }
}

// ========== –†–ê–°–®–ò–†–ï–ù–ù–ê–Ø –°–ò–°–¢–ï–ú–ê –°–ö–†–´–¢–ù–û–°–¢–ò ==========

class StealthSystem {
    constructor(battlefield, weatherTimeSystem) {
        this.battlefield = battlefield;
        this.weatherTime = weatherTimeSystem;
        this.characterStates = {};
    }

    // –†–∞—Å—á–µ—Ç –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–≤ —Å–∫—Ä—ã—Ç–Ω–æ—Å—Ç–∏ –¥–ª—è –ø–æ–∑–∏—Ü–∏–∏
    calculateStealthModifiers(characterId, targetCellId = null) {
        const character = this.battlefield.characters[characterId];
        if (!character) return { stealth: 0, perception: 0 };

        let modifiers = {
            stealth: 0,
            perception: 0
        };

        // –ë–∞–∑–æ–≤—ã–µ –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã –æ—Ç –ø–æ–≥–æ–¥—ã –∏ –≤—Ä–µ–º–µ–Ω–∏
        const weatherMods = this.weatherTime.getPerceptionModifiers();
        modifiers.stealth += weatherMods.stealth;
        modifiers.perception += weatherMods.perception;

        // –ú–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã –ª–∞–Ω–¥—à–∞—Ñ—Ç–∞
        const cell = this.battlefield.cells[character.cellId];
        modifiers.stealth += this.getLandscapeModifier(cell);

        // –ú–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã –ø–æ–∑–∏—Ü–∏–∏ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª–µ–π
        if (targetCellId) {
            modifiers.stealth += this.getPositionModifier(characterId, targetCellId);
        }

        return modifiers;
    }

    getLandscapeModifier(cell) {
        if (cell.type === 'tree') return 8; // –ó–∞ –¥–µ—Ä–µ–≤–æ–º
        if (cell.type === 'building') return 10; // –ó–∞ –∑–¥–∞–Ω–∏–µ–º
        if (cell.type === 'rock') return 5; // –ó–∞ –∫–∞–º–Ω–µ–º
        
        // –î–ª—è –ø—É—Å—Ç—ã—Ö –∫–ª–µ—Ç–æ–∫ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –ª–∞–Ω–¥—à–∞—Ñ—Ç–∞ –≤–æ–∫—Ä—É–≥
        const neighbors = this.battlefield.getNeighbors(cell.q, cell.r);
        let coverCount = 0;
        
        for (const neighborId of neighbors) {
            const neighbor = this.battlefield.cells[neighborId];
            if (neighbor.type !== 'empty') coverCount++;
        }
        
        if (coverCount >= 3) return 3; // –í –≥—É—Å—Ç–æ–π –º–µ—Å—Ç–Ω–æ—Å—Ç–∏
        if (coverCount >= 1) return 1; // –í —Ä–µ–¥–∫–æ–π –º–µ—Å—Ç–Ω–æ—Å—Ç–∏
        return -5; // –ù–∞ –æ—Ç–∫—Ä—ã—Ç–æ–π –º–µ—Å—Ç–Ω–æ—Å—Ç–∏
    }

    getPositionModifier(characterId, observerCellId) {
        const character = this.battlefield.characters[characterId];
        if (!character) return 0;

        const observer = this.battlefield.characters[observerCellId];
        if (!observer) return 0;

        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª—è
        const direction = this.battlefield.getDirectionBetweenCells(observerCellId, character.cellId);
        const observerDirection = observer.direction;

        // –†–∞–∑–Ω–∏—Ü–∞ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–π (0-3, –≥–¥–µ 0 - –ø—Ä—è–º–æ, 3 - —Å–∑–∞–¥–∏)
        const directionDiff = Math.min(
            Math.abs(direction - observerDirection),
            6 - Math.abs(direction - observerDirection)
        );

        if (directionDiff === 0) return -10; // –ü—Ä—è–º–æ –ø–µ—Ä–µ–¥ –Ω–∞–±–ª—é–¥–∞—Ç–µ–ª–µ–º
        if (directionDiff === 1) return -5;  // –°–±–æ–∫—É
        if (directionDiff === 2) return 0;   // –°–±–æ–∫—É-—Å–∑–∞–¥–∏
        if (directionDiff === 3) return 5;   // –ü—Ä—è–º–æ —Å–∑–∞–¥–∏

        return 0;
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∫—Ä—ã—Ç–Ω–æ—Å—Ç–∏
    performStealthCheck(hiderId, seekerId) {
        const hider = this.battlefield.characters[hiderId];
        const seeker = this.battlefield.characters[seekerId];
        
        if (!hider || !seeker) return { detected: false, margin: 0 };

        // –ù–∞–≤—ã–∫–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π (—É–ø—Ä–æ—â–µ–Ω–Ω–æ)
        const hiderStealth = 10; // –ë–∞–∑–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ, –º–æ–∂–Ω–æ –±—Ä–∞—Ç—å –∏–∑ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫
        const seekerPerception = 10;

        // –ú–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã
        const stealthMods = this.calculateStealthModifiers(hiderId, seekerId);
        
        // –ë—Ä–æ—Å–æ–∫ —Å–∫—Ä—ã—Ç–Ω–æ—Å—Ç–∏
        const stealthCheck = rollSkillCheck(hiderStealth + stealthMods.stealth);
        const perceptionCheck = rollSkillCheck(seekerPerception + stealthMods.perception);

        // –†–∞—Å—á–µ—Ç —É—Å–ø–µ—Ö–æ–≤ (—Ä–∞–∑–Ω–∏—Ü–∞ –º–µ–∂–¥—É –±—Ä–æ—Å–∫–æ–º –∏ –Ω–∞–≤—ã–∫–æ–º)
        const stealthSuccesses = stealthCheck.success ? Math.max(0, (hiderStealth + stealthMods.stealth) - stealthCheck.total) : 0;
        const perceptionSuccesses = perceptionCheck.success ? Math.max(0, (seekerPerception + stealthMods.perception) - perceptionCheck.total) : 0;

        // –£—Å–ø–µ—Ö–∏ —Å–∫—Ä—ã—Ç–Ω–æ—Å—Ç–∏ —É–º–Ω–æ–∂–∞—é—Ç—Å—è –Ω–∞ 2
        const finalStealthSuccesses = stealthSuccesses * 2;
        
        // –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —É—Å–ø–µ—Ö–æ–≤
        const detected = finalStealthSuccesses <= perceptionSuccesses;

        return {
            detected: detected,
            margin: Math.abs(finalStealthSuccesses - perceptionSuccesses),
            stealthRoll: stealthCheck,
            perceptionRoll: perceptionCheck,
            stealthSuccesses: finalStealthSuccesses,
            perceptionSuccesses: perceptionSuccesses
        };
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è –ø—Ä–∏ –¥–≤–∏–∂–µ–Ω–∏–∏
    checkMovementDetection(moverId) {
        const detectors = Object.keys(this.battlefield.characters).filter(id => 
            id !== moverId && this.battlefield.characters[id]
        );

        const results = [];
        
        for (const detectorId of detectors) {
            const check = this.performStealthCheck(moverId, detectorId);
            if (check.detected) {
                results.push({
                    detectorId: detectorId,
                    margin: check.margin,
                    stealthSuccesses: check.stealthSuccesses,
                    perceptionSuccesses: check.perceptionSuccesses
                });
            }
        }

        return results;
    }
}

// ========== –†–ê–°–®–ò–†–ï–ù–ù–ê–Ø –°–ò–°–¢–ï–ú–ê –ü–ï–†–°–û–ù–ê–ñ–ï–ô ==========

class AdvancedCharacter {
    constructor(baseCharacter) {
        this.id = baseCharacter.id;
        this.baseCharacter = baseCharacter;
        this.combatStats = {
            currentHealth: baseCharacter.stats.health,
            conditions: [],
            equippedWeapon: null,
            equippedShield: false,
            lightSource: null
        };
        this.stealthState = 'visible'; // visible, hidden, undetected
    }

    getStealthSkill() {
        return this.baseCharacter.skills['–°–∫—Ä—ã—Ç–Ω–æ—Å—Ç—å'] || 10;
    }

    getPerceptionSkill() {
        return this.baseCharacter.skills['–í–æ—Å–ø—Ä–∏—è—Ç–∏–µ'] || 10;
    }

    getAgilitySkill() {
        return this.baseCharacter.skills['–õ–æ–≤–∫–æ—Å—Ç—å'] || 10;
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≤–∫–æ—Å—Ç–∏ –¥–ª—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è
    checkAgilityForExtraAction() {
        const agilityCheck = rollSkillCheck(this.getAgilitySkill());
        return agilityCheck.success;
    }

    // –ü–æ–ª—É—á–µ–Ω–∏–µ –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä–∞ –¥–≤–∏–∂–µ–Ω–∏—è
    getMovementModifier() {
        let modifier = 5; // –ë–∞–∑–æ–≤–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ 5 –º–µ—Ç—Ä–æ–≤
        
        if (this.checkAgilityForExtraAction()) {
            modifier += 5; // +5 –º–µ—Ç—Ä–æ–≤ —Å —É—Å–ø–µ—à–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–æ–π –ª–æ–≤–∫–æ—Å—Ç–∏
        }

        return modifier;
    }
}

// ========== –ò–ù–¢–ï–†–§–ï–ô–° –ü–û–ì–û–î–´ –ò –°–ö–†–´–¢–ù–û–°–¢–ò ==========

let weatherTimeSystem = new WeatherTimeSystem();
let stealthSystem = null;

function initializeWeatherStealthInterface() {
    const combatTab = document.getElementById('combat-tab');
    if (!combatTab) return;

    // –î–æ–±–∞–≤–ª—è–µ–º –ø–∞–Ω–µ–ª—å –ø–æ–≥–æ–¥—ã –∏ –≤—Ä–µ–º–µ–Ω–∏ –∫ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–º—É –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É
    const weatherHTML = `
        <div style="background: #3d2418; padding: 15px; border-radius: 8px; border: 2px solid #5a3928; margin-bottom: 20px;">
            <h3 style="color: #d4af37; margin-bottom: 15px;">üå§Ô∏è –ü–æ–≥–æ–¥–∞ –∏ –í—Ä–µ–º—è</h3>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                <div>
                    <label style="display: block; margin-bottom: 5px; color: #e0d0c0;">–í—Ä–µ–º—è —Å—É—Ç–æ–∫:</label>
                    <div id="currentTime" style="padding: 8px; background: #2c1810; border-radius: 4px; 
                         border: 1px solid #5a3928; text-align: center; font-weight: bold;">
                        –î–µ–Ω—å
                    </div>
                </div>
                
                <div>
                    <label style="display: block; margin-bottom: 5px; color: #e0d0c0;">–ü–æ–≥–æ–¥–∞:</label>
                    <div id="currentWeather" style="padding: 8px; background: #2c1810; border-radius: 4px; 
                         border: 1px solid #5a3928; text-align: center; font-weight: bold;">
                        –Ø—Å–Ω–æ
                    </div>
                </div>
                
                <div>
                    <label style="display: block; margin-bottom: 5px; color: #e0d0c0;">–¢—É–º–∞–Ω:</label>
                    <div id="currentFog" style="padding: 8px; background: #2c1810; border-radius: 4px; 
                         border: 1px solid #5a3928; text-align: center; font-weight: bold;">
                        –ù–µ—Ç
                    </div>
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <button class="btn btn-dice" onclick="rollWeatherDice()">
                    üå¶Ô∏è –ë—Ä–æ—Å–∏—Ç—å –ø–æ–≥–æ–¥—É
                </button>
                <button class="btn btn-dice" onclick="rollFogDice()">
                    üå´Ô∏è –ë—Ä–æ—Å–∏—Ç—å —Ç—É–º–∞–Ω
                </button>
                <button class="btn btn-roll" onclick="advanceTime(1)">
                    ‚è∞ +1 —á–∞—Å
                </button>
                <button class="btn btn-roll" onclick="advanceTime(6)">
                    ‚è∞ +6 —á–∞—Å–æ–≤
                </button>
            </div>
            
            <div id="weatherModifiers" style="margin-top: 15px; padding: 10px; background: #2c1810; 
                 border-radius: 4px; border: 1px solid #5a3928; font-size: 0.9em;">
                <strong>–ú–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã:</strong> –í–æ—Å–ø—Ä–∏—è—Ç–∏–µ: 0, –°–∫—Ä—ã—Ç–Ω–æ—Å—Ç—å: 0, –î–≤–∏–∂–µ–Ω–∏–µ: 0, –°—Ç—Ä–µ–ª—å–±–∞: 0
            </div>
        </div>
        
        <div style="background: #3d2418; padding: 15px; border-radius: 8px; border: 2px solid #5a3928; margin-bottom: 20px;">
            <h3 style="color: #d4af37; margin-bottom: 15px;">üëª –°–∏—Å—Ç–µ–º–∞ –°–∫—Ä—ã—Ç–Ω–æ—Å—Ç–∏</h3>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                <button class="btn btn-roll" onclick="performStealthTest()">
                    üé≠ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–∫—Ä—ã—Ç–Ω–æ—Å—Ç—å
                </button>
                <button class="btn btn-roll" onclick="toggleStealthMode()">
                    üïµÔ∏è‚Äç‚ôÇÔ∏è –†–µ–∂–∏–º —Å–∫—Ä—ã—Ç–Ω–æ—Å—Ç–∏
                </button>
            </div>
            
            <div id="stealthResults" style="min-height: 60px; padding: 10px; background: #2c1810; 
                 border-radius: 4px; border: 1px solid #5a3928; font-size: 0.9em;">
                –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø—Ä–æ–≤–µ—Ä–æ–∫ —Å–∫—Ä—ã—Ç–Ω–æ—Å—Ç–∏ –±—É–¥—É—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –∑–¥–µ—Å—å
            </div>
        </div>
    `;

    // –î–æ–±–∞–≤–ª—è–µ–º –ø–∞–Ω–µ–ª—å –∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É –±–æ—è
    const existingWeatherPanel = document.getElementById('weatherPanel');
    if (!existingWeatherPanel) {
        combatTab.insertAdjacentHTML('afterbegin', weatherHTML);
    }

    updateWeatherDisplay();
}

function updateWeatherDisplay() {
    const timeElement = document.getElementById('currentTime');
    const weatherElement = document.getElementById('currentWeather');
    const fogElement = document.getElementById('currentFog');
    const modifiersElement = document.getElementById('weatherModifiers');

    if (timeElement) timeElement.textContent = getTimeDescription(weatherTimeSystem.timeOfDay);
    if (weatherElement) weatherElement.textContent = getWeatherDescription(weatherTimeSystem.weather);
    if (fogElement) fogElement.textContent = getFogDescription(weatherTimeSystem.fog);
    
    if (modifiersElement) {
        const mods = weatherTimeSystem.getPerceptionModifiers();
        modifiersElement.innerHTML = `
            <strong>–ú–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã:</strong> 
            –í–æ—Å–ø—Ä–∏—è—Ç–∏–µ: ${mods.perception >= 0 ? '+' : ''}${mods.perception}, 
            –°–∫—Ä—ã—Ç–Ω–æ—Å—Ç—å: ${mods.stealth >= 0 ? '+' : ''}${mods.stealth}, 
            –î–≤–∏–∂–µ–Ω–∏–µ: ${mods.movement >= 0 ? '+' : ''}${mods.movement}, 
            –°—Ç—Ä–µ–ª—å–±–∞: ${mods.shooting >= 0 ? '+' : ''}${mods.shooting}
        `;
    }
}

function getTimeDescription(time) {
    const descriptions = {
        'morning': 'üåÖ –£—Ç—Ä–æ',
        'day': '‚òÄÔ∏è –î–µ–Ω—å', 
        'evening': 'üåá –í–µ—á–µ—Ä',
        'night': 'üåô –ù–æ—á—å'
    };
    return descriptions[time] || time;
}

function getWeatherDescription(weather) {
    const descriptions = {
        'clear': '‚òÄÔ∏è –Ø—Å–Ω–æ',
        'cloudy': '‚òÅÔ∏è –û–±–ª–∞—á–Ω–æ',
        'light_rain': 'üå¶Ô∏è –°–ª–∞–±—ã–π –¥–æ–∂–¥—å',
        'rain': 'üåßÔ∏è –î–æ–∂–¥—å',
        'heavy_rain': '‚õàÔ∏è –°–∏–ª—å–Ω—ã–π –¥–æ–∂–¥—å',
        'storm': 'üåÄ –£—Ä–∞–≥–∞–Ω'
    };
    return descriptions[weather] || weather;
}

function getFogDescription(fog) {
    const descriptions = {
        'none': 'üå´Ô∏è –ù–µ—Ç —Ç—É–º–∞–Ω–∞',
        'light_fog': 'üí® –°–ª–∞–±—ã–π —Ç—É–º–∞–Ω',
        'medium_fog': 'üå´Ô∏è –°—Ä–µ–¥–Ω–∏–π —Ç—É–º–∞–Ω', 
        'heavy_fog': 'üî¥ –°–∏–ª—å–Ω—ã–π —Ç—É–º–∞–Ω'
    };
    return descriptions[fog] || fog;
}

// ========== –§–£–ù–ö–¶–ò–ò –£–ü–†–ê–í–õ–ï–ù–ò–Ø –ü–û–ì–û–î–û–ô ==========

function rollWeatherDice() {
    const result = weatherTimeSystem.rollWeather();
    updateWeatherDisplay();
    
    showPopup(
        'üå¶Ô∏è –ë—Ä–æ—Å–æ–∫ –ø–æ–≥–æ–¥—ã',
        `–í—ã–ø–∞–ª–æ: <strong>${getWeatherDescription(result)}</strong><br>
         –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: ${weatherTimeSystem.weatherDuration} —á–∞—Å–æ–≤`,
        ['<button class="btn btn-roll" onclick="closePopup(this.closest(\'.popup\'))">OK</button>']
    );
}

function rollFogDice() {
    const result = weatherTimeSystem.rollFog();
    updateWeatherDisplay();
    
    showPopup(
        'üå´Ô∏è –ë—Ä–æ—Å–æ–∫ —Ç—É–º–∞–Ω–∞', 
        `–í—ã–ø–∞–ª–æ: <strong>${getFogDescription(result)}</strong><br>
         –î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å: ${weatherTimeSystem.fogDuration} —á–∞—Å–æ–≤`,
        ['<button class="btn btn-roll" onclick="closePopup(this.closest(\'.popup\'))">OK</button>']
    );
}

function advanceTime(hours) {
    weatherTimeSystem.advanceTime(hours);
    updateWeatherDisplay();
    
    showPopup(
        '‚è∞ –í—Ä–µ–º—è –ø—Ä–æ—à–ª–æ',
        `–ü—Ä–æ—à–ª–æ ${hours} ${hours === 1 ? '—á–∞—Å' : hours < 5 ? '—á–∞—Å–∞' : '—á–∞—Å–æ–≤'}<br>
         –°–µ–π—á–∞—Å: ${weatherTimeSystem.getTimeDescription()}`,
        ['<button class="btn btn-roll" onclick="closePopup(this.closest(\'.popup\'))">OK</button>']
    );
}

// ========== –§–£–ù–ö–¶–ò–ò –°–ö–†–´–¢–ù–û–°–¢–ò ==========

function performStealthTest() {
    if (!battlefield || !stealthSystem) {
        alert('–°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ –ø–æ–ª–µ –±–æ—è!');
        return;
    }

    const characters = Object.keys(battlefield.characters);
    if (characters.length < 2) {
        alert('–ù—É–∂–Ω–æ –∫–∞–∫ –º–∏–Ω–∏–º—É–º 2 –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –Ω–∞ –ø–æ–ª–µ!');
        return;
    }

    // –í—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω—ã—Ö –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π –¥–ª—è —Ç–µ—Å—Ç–∞
    const hiderId = characters[0];
    const seekerId = characters[1];
    
    const result = stealthSystem.performStealthCheck(hiderId, seekerId);
    
    const resultsElement = document.getElementById('stealthResults');
    if (resultsElement) {
        let resultHTML = `
            <strong>–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∫—Ä—ã—Ç–Ω–æ—Å—Ç–∏:</strong><br>
            –ü—Ä—è—á—É—â–∏–π—Å—è: ${hiderId}<br>
            –ò—â—É—â–∏–π: ${seekerId}<br>
            <br>
            <strong>–ë—Ä–æ—Å–∫–∏:</strong><br>
            –°–∫—Ä—ã—Ç–Ω–æ—Å—Ç—å: ${result.stealthRoll.roll.join('+')} = ${result.stealthRoll.total}<br>
            –í–æ—Å–ø—Ä–∏—è—Ç–∏–µ: ${result.perceptionRoll.roll.join('+')} = ${result.perceptionRoll.total}<br>
            <br>
            <strong>–£—Å–ø–µ—Ö–∏:</strong><br>
            –°–∫—Ä—ã—Ç–Ω–æ—Å—Ç—å: ${result.stealthSuccesses} (√ó2)<br>
            –í–æ—Å–ø—Ä–∏—è—Ç–∏–µ: ${result.perceptionSuccesses}<br>
            <br>
        `;

        if (result.detected) {
            resultHTML += `<span style="color: #e74c3c;">‚ùå –û–±–Ω–∞—Ä—É–∂–µ–Ω! (—Ä–∞–∑–Ω–∏—Ü–∞: ${result.margin})</span>`;
        } else {
            resultHTML += `<span style="color: #27ae60;">‚úÖ –û—Å—Ç–∞–ª—Å—è —Å–∫—Ä—ã—Ç—ã–º! (—Ä–∞–∑–Ω–∏—Ü–∞: ${result.margin})</span>`;
        }

        resultsElement.innerHTML = resultHTML;
    }
}

function toggleStealthMode() {
    if (!battlefield) {
        alert('–°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ –ø–æ–ª–µ –±–æ—è!');
        return;
    }

    const player = Object.keys(battlefield.characters).find(id => id.startsWith('player'));
    if (!player) {
        alert('–ù–∞ –ø–æ–ª–µ –Ω–µ—Ç –∏–≥—Ä–æ–∫–∞!');
        return;
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–≤–∏–∂–µ–Ω–∏—è –Ω–∞ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ
    const detectionResults = stealthSystem.checkMovementDetection(player);
    
    const resultsElement = document.getElementById('stealthResults');
    if (resultsElement) {
        if (detectionResults.length > 0) {
            let resultHTML = `<strong>–û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –ø—Ä–∏ –¥–≤–∏–∂–µ–Ω–∏–∏:</strong><br>`;
            
            detectionResults.forEach(result => {
                resultHTML += `
                    ${result.detectorId} –∑–∞–º–µ—Ç–∏–ª –≤–∞—Å!<br>
                    –£—Å–ø–µ—Ö–∏ —Å–∫—Ä—ã—Ç–Ω–æ—Å—Ç–∏: ${result.stealthSuccesses}<br>
                    –£—Å–ø–µ—Ö–∏ –≤–æ—Å–ø—Ä–∏—è—Ç–∏—è: ${result.perceptionSuccesses}<br>
                    –†–∞–∑–Ω–∏—Ü–∞: ${result.margin}<br>
                    <br>
                `;
            });
            
            resultsElement.innerHTML = resultHTML;
        } else {
            resultsElement.innerHTML = `<span style="color: #27ae60;">‚úÖ –í—ã –ø–µ—Ä–µ–º–µ—â–∞–µ—Ç–µ—Å—å –Ω–µ–∑–∞–º–µ—á–µ–Ω–Ω—ã–º!</span>`;
        }
    }
}

// ========== –û–ë–ù–û–í–õ–ï–ù–ò–ï –°–ò–°–¢–ï–ú–´ –ë–û–Ø –° –£–ß–ï–¢–û–ú –ü–û–ì–û–î–´ ==========

function updateCombatForWeather() {
    if (!combatSystem) return;

    const modifiers = weatherTimeSystem.getPerceptionModifiers();
    
    // –î–æ–±–∞–≤–ª—è–µ–º –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã –∫ –∏—Å—Ç–æ—Ä–∏–∏ –±–æ—è
    combatSystem.addToCombatHistory(
        `üå§Ô∏è –ü–æ–≥–æ–¥–Ω—ã–µ —É—Å–ª–æ–≤–∏—è: ${weatherTimeSystem.getTimeDescription()} ` +
        `(–í–æ—Å–ø—Ä–∏—è—Ç–∏–µ: ${modifiers.perception >= 0 ? '+' : ''}${modifiers.perception}, ` +
        `–°–∫—Ä—ã—Ç–Ω–æ—Å—Ç—å: ${modifiers.stealth >= 0 ? '+' : ''}${modifiers.stealth})`
    );
}

// ========== –û–ë–ù–û–í–õ–ï–ù–ò–ï –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–ò ==========

function createBattlefield() {
    const width = parseInt(document.getElementById('battlefieldWidth').value) || 15;
    const height = parseInt(document.getElementById('battlefieldHeight').value) || 10;
    const landscapeType = document.getElementById('landscapeSelect').value;

    battlefield = new HexagonalBattlefield(width, height);
    battlefieldRenderer = new BattlefieldRenderer(battlefield, 'battlefieldContainer');
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º –ø–æ–≥–æ–¥—ã –∏ —Å–∫—Ä—ã—Ç–Ω–æ—Å—Ç–∏
    stealthSystem = new StealthSystem(battlefield, weatherTimeSystem);
    
    generateLandscape(battlefield, landscapeType);
    battlefieldRenderer.render();
    
    document.getElementById('battleInfo').style.display = 'block';
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –ø–æ–≥–æ–¥—ã
    initializeWeatherStealthInterface();
    
    console.log(`‚úÖ –ü–æ–ª–µ –±–æ—è —Å–æ–∑–¥–∞–Ω–æ: ${width}x${height}, –ª–∞–Ω–¥—à–∞—Ñ—Ç: ${landscapeType}`);
}

function startCombat() {
    if (!battlefield) {
        alert('–°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ –ø–æ–ª–µ –±–æ—è –∏ —Ä–∞–∑–º–µ—Å—Ç–∏—Ç–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π!');
        return;
    }

    combatSystem = new CombatSystem(battlefield);

    // –î–æ–±–∞–≤–ª—è–µ–º –≤—Å–µ—Ö –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π –Ω–∞ –ø–æ–ª–µ –≤ —Å–∏—Å—Ç–µ–º—É –±–æ—è
    for (const characterId in battlefield.characters) {
        const character = battlefield.characters[characterId];
        let type = 'player';
        let stats = { health: 100, maxHealth: 100 };

        if (characterId.startsWith('farmer')) {
            type = 'farmer';
            stats = {
                health: 50 + Math.floor(Math.random() * 21),
                maxHealth: 70,
                skills: {
                    '–û–¥–Ω–æ—Ä—É—á–Ω–æ–µ –æ—Ä—É–∂–∏–µ': 6 + Math.floor(Math.random() * 5),
                    '–í–æ—Å–ø—Ä–∏—è—Ç–∏–µ': 8 + Math.floor(Math.random() * 3)
                }
            };
        } else if (characterId.startsWith('bandit')) {
            type = 'bandit';
            stats = {
                health: 70 + Math.floor(Math.random() * 31),
                maxHealth: 100,
                skills: {
                    '–û–¥–Ω–æ—Ä—É—á–Ω–æ–µ –æ—Ä—É–∂–∏–µ': 8 + Math.floor(Math.random() * 5),
                    '–°–∫—Ä—ã—Ç–Ω–æ—Å—Ç—å': 10 + Math.floor(Math.random() * 3),
                    '–í–æ—Å–ø—Ä–∏—è—Ç–∏–µ': 10 + Math.floor(Math.random() * 3)
                }
            };
        } else if (characterId.startsWith('player')) {
            stats = {
                health: currentCharacter ? currentCharacter.stats.health : 100,
                maxHealth: currentCharacter ? currentCharacter.stats.maxHealth : 100,
                skills: currentCharacter ? currentCharacter.skills : {}
            };
        }

        combatSystem.addCombatant(characterId, type, stats);
    }

    combatSystem.startCombat();
    updateCombatInterface();
    updateCombatForWeather();

    const combatTab = document.getElementById('combat-tab');
    const existingControls = document.getElementById('combatControls');
    if (!existingControls) {
        const controlsHTML = `<div id="combatControls"></div>`;
        combatTab.insertAdjacentHTML('beforeend', controlsHTML);
    }

    updateCombatInterface();
}
        // ========== –°–ò–°–¢–ï–ú–ê –ü–†–ï–î–ú–ï–¢–û–í –ò –û–†–£–ñ–ò–Ø ==========

const itemTemplates = {
    // –û—Ä—É–∂–∏–µ –±–ª–∏–∂–Ω–µ–≥–æ –±–æ—è
    weapons: {
        dagger: {
            id: 'dagger',
            name: '–ö–∏–Ω–∂–∞–ª',
            type: 'weapon',
            subtype: 'one_handed',
            damageType: 'piercing',
            damage: '1d4',
            hands: 1,
            weight: 0.5,
            value: 10,
            description: '–ù–µ–±–æ–ª—å—à–æ–π —Å–∫—Ä—ã—Ç—ã–π –∫–ª–∏–Ω–æ–∫'
        },
        shortsword: {
            id: 'shortsword',
            name: '–ö–æ—Ä–æ—Ç–∫–∏–π –º–µ—á',
            type: 'weapon', 
            subtype: 'one_handed',
            damageType: 'slashing',
            damage: '1d6',
            hands: 1,
            weight: 2,
            value: 25,
            description: '–°–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ–¥–Ω–æ—Ä—É—á–Ω—ã–π –º–µ—á'
        },
        axe: {
            id: 'axe',
            name: '–¢–æ–ø–æ—Ä',
            type: 'weapon',
            subtype: 'one_handed', 
            damageType: 'slashing',
            damage: '1d8',
            hands: 1,
            weight: 3,
            value: 30,
            description: '–¢—è–∂–µ–ª—ã–π –±–æ–µ–≤–æ–π —Ç–æ–ø–æ—Ä'
        },
        greatsword: {
            id: 'greatsword',
            name: '–î–≤—É—Ä—É—á–Ω—ã–π –º–µ—á',
            type: 'weapon',
            subtype: 'two_handed',
            damageType: 'slashing', 
            damage: '2d6',
            hands: 2,
            weight: 5,
            value: 50,
            description: '–ú–æ—â–Ω–æ–µ –¥–≤—É—Ä—É—á–Ω–æ–µ –æ—Ä—É–∂–∏–µ'
        },
        spear: {
            id: 'spear',
            name: '–ö–æ–ø—å–µ',
            type: 'weapon',
            subtype: 'polearm',
            damageType: 'piercing',
            damage: '1d8',
            hands: 2,
            weight: 3,
            value: 15,
            description: '–î—Ä–µ–≤–∫–æ–≤–æ–µ –æ—Ä—É–∂–∏–µ —Å –¥–ª–∏–Ω–Ω–æ–π –¥–∏—Å—Ç–∞–Ω—Ü–∏–µ–π'
        }
    },

    // –©–∏—Ç—ã
    shields: {
        buckler: {
            id: 'buckler',
            name: '–ë–∞–∫–ª–µ—Ä',
            type: 'shield',
            armorBonus: 1,
            weight: 2,
            value: 15,
            description: '–ù–µ–±–æ–ª—å—à–æ–π –∫—Ä—É–≥–ª—ã–π —â–∏—Ç'
        },
        round_shield: {
            id: 'round_shield',
            name: '–ö—Ä—É–≥–ª—ã–π —â–∏—Ç',
            type: 'shield', 
            armorBonus: 2,
            weight: 4,
            value: 30,
            description: '–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –¥–µ—Ä–µ–≤—è–Ω–Ω—ã–π —â–∏—Ç'
        },
        tower_shield: {
            id: 'tower_shield',
            name: '–ë–∞—à–µ–Ω–Ω—ã–π —â–∏—Ç',
            type: 'shield',
            armorBonus: 3,
            weight: 8,
            value: 50,
            description: '–ë–æ–ª—å—à–æ–π —â–∏—Ç, –æ–±–µ—Å–ø–µ—á–∏–≤–∞—é—â–∏–π –æ—Ç–ª–∏—á–Ω—É—é –∑–∞—â–∏—Ç—É'
        }
    },

    // –ë—Ä–æ–Ω—è
    armor: {
        leather_armor: {
            id: 'leather_armor',
            name: '–ö–æ–∂–∞–Ω–∞—è –±—Ä–æ–Ω—è',
            type: 'armor',
            armorClass: 2,
            weight: 5,
            value: 20,
            description: '–ü—Ä–æ—Å—Ç–∞—è –∫–æ–∂–∞–Ω–∞—è –∑–∞—â–∏—Ç–∞'
        },
        chainmail: {
            id: 'chainmail', 
            name: '–ö–æ–ª—å—á—É–≥–∞',
            type: 'armor',
            armorClass: 4,
            weight: 12,
            value: 75,
            description: '–ú–µ—Ç–∞–ª–ª–∏—á–µ—Å–∫–∞—è –∫–æ–ª—å—á—É–∂–Ω–∞—è —Ä—É–±–∞—Ö–∞'
        },
        plate_armor: {
            id: 'plate_armor',
            name: '–õ–∞—Ç–Ω–∞—è –±—Ä–æ–Ω—è',
            type: 'armor',
            armorClass: 6, 
            weight: 20,
            value: 200,
            description: '–ü–æ–ª–Ω—ã–π –∫–æ–º–ø–ª–µ–∫—Ç –º–µ—Ç–∞–ª–ª–∏—á–µ—Å–∫–∏—Ö –¥–æ—Å–ø–µ—Ö–æ–≤'
        }
    },

    // –ò—Å—Ç–æ—á–Ω–∏–∫–∏ —Å–≤–µ—Ç–∞
    light_sources: {
        torch: {
            id: 'torch',
            name: '–§–∞–∫–µ–ª',
            type: 'light_source',
            lightRadius: 10,
            duration: 60, // –º–∏–Ω—É—Ç—ã
            weight: 1,
            value: 1,
            description: '–ü—Ä–æ—Å—Ç–æ–π –∏—Å—Ç–æ—á–Ω–∏–∫ —Å–≤–µ—Ç–∞'
        },
        lantern: {
            id: 'lantern',
            name: '–§–æ–Ω–∞—Ä—å',
            type: 'light_source',
            lightRadius: 15,
            duration: 120,
            weight: 2,
            value: 10,
            description: '–ú–∞—Å–ª—è–Ω—ã–π —Ñ–æ–Ω–∞—Ä—å —Å —Ä–µ–≥—É–ª–∏—Ä—É–µ–º—ã–º —Å–≤–µ—Ç–æ–º'
        }
    },

    // –ë–æ–µ–ø—Ä–∏–ø–∞—Å—ã
    ammunition: {
        arrows: {
            id: 'arrows',
            name: '–°—Ç—Ä–µ–ª—ã',
            type: 'ammunition',
            subtype: 'arrows',
            quantity: 20,
            weight: 0.5,
            value: 5,
            description: '–ö–æ–ª—á–∞–Ω —Å–æ —Å—Ç—Ä–µ–ª–∞–º–∏'
        },
        bolts: {
            id: 'bolts',
            name: '–ë–æ–ª—Ç—ã',
            type: 'ammunition', 
            subtype: 'bolts',
            quantity: 20,
            weight: 0.5,
            value: 5,
            description: '–ù–∞–±–æ—Ä –±–æ–ª—Ç–æ–≤ –¥–ª—è –∞—Ä–±–∞–ª–µ—Ç–∞'
        }
    },

    // –ü—Ä–æ—á–µ–µ —Å–Ω–∞—Ä—è–∂–µ–Ω–∏–µ
    misc: {
        healing_potion: {
            id: 'healing_potion',
            name: '–ó–µ–ª—å–µ –ª–µ—á–µ–Ω–∏—è',
            type: 'potion',
            effect: 'heal',
            power: '2d4+2',
            weight: 0.5,
            value: 50,
            description: '–í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –∑–¥–æ—Ä–æ–≤—å–µ –ø—Ä–∏ —É–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–∏'
        },
        mana_potion: {
            id: 'mana_potion',
            name: '–ó–µ–ª—å–µ –º–∞–Ω—ã',
            type: 'potion',
            effect: 'restore_mana',
            power: '2d4+2',
            weight: 0.5,
            value: 75,
            description: '–í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –º–∞–Ω—É'
        },
        rope: {
            id: 'rope',
            name: '–í–µ—Ä–µ–≤–∫–∞',
            type: 'tool',
            length: 15, // –º–µ—Ç—Ä–æ–≤
            weight: 2,
            value: 1,
            description: '–ü—Ä–æ—á–Ω–∞—è –ø–µ–Ω—å–∫–æ–≤–∞—è –≤–µ—Ä–µ–≤–∫–∞'
        }
    }
};

// ========== –ö–õ–ê–°–° –ò–ù–í–ï–ù–¢–ê–†–Ø ==========

class InventorySystem {
    constructor(character) {
        this.character = character;
        this.items = [];
        this.equipped = {
            weapon: null,
            shield: null,
            armor: null,
            light_source: null
        };
        this.carryCapacity = this.calculateCarryCapacity();
        this.loadInventory();
    }

    calculateCarryCapacity() {
        // –ë–∞–∑–æ–≤–∞—è –≥—Ä—É–∑–æ–ø–æ–¥—ä–µ–º–Ω–æ—Å—Ç—å –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Å–∏–ª—ã/–≤—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç–∏
        const strength = this.character.getSkillValue('–í—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å') || 10;
        return Math.max(20, strength * 2); // –ú–∏–Ω–∏–º—É–º 20 –∫–≥
    }

    getCurrentWeight() {
        return this.items.reduce((total, item) => total + (item.weight * (item.quantity || 1)), 0);
    }

    getEncumbranceLevel() {
        const weight = this.getCurrentWeight();
        const capacity = this.carryCapacity;
        const ratio = weight / capacity;

        if (ratio < 0.3) return 'none';
        if (ratio < 0.6) return 'light';
        if (ratio < 0.9) return 'medium';
        return 'heavy';
    }

    getEncumbranceModifiers() {
        const level = this.getEncumbranceLevel();
        const modifiers = {
            none: { movement: 0, stealth: 0, agility: 0 },
            light: { movement: -1, stealth: -1, agility: -1 },
            medium: { movement: -2, stealth: -2, agility: -2 },
            heavy: { movement: -5, stealth: -5, agility: -5 }
        };
        return modifiers[level];
    }

    addItem(itemTemplate, quantity = 1) {
        const existingItem = this.items.find(item => item.id === itemTemplate.id);
        
        if (existingItem && itemTemplate.type !== 'weapon' && itemTemplate.type !== 'armor') {
            // –°–∫–ª–∞–¥—ã–≤–∞–µ–º—ã–µ –ø—Ä–µ–¥–º–µ—Ç—ã
            existingItem.quantity += quantity;
        } else {
            // –ù–æ–≤—ã–π –ø—Ä–µ–¥–º–µ—Ç
            const newItem = {
                ...itemTemplate,
                quantity: quantity,
                equipped: false
            };
            this.items.push(newItem);
        }

        this.saveInventory();
        return true;
    }

    removeItem(itemId, quantity = 1) {
        const itemIndex = this.items.findIndex(item => item.id === itemId);
        if (itemIndex === -1) return false;

        const item = this.items[itemIndex];
        
        if (item.quantity > quantity) {
            item.quantity -= quantity;
        } else {
            // –ï—Å–ª–∏ –ø—Ä–µ–¥–º–µ—Ç —ç–∫–∏–ø–∏—Ä–æ–≤–∞–Ω - —Å–Ω–∏–º–∞–µ–º –µ–≥–æ
            if (item.equipped) {
                this.unequipItem(itemId);
            }
            this.items.splice(itemIndex, 1);
        }

        this.saveInventory();
        return true;
    }

    equipItem(itemId) {
        const item = this.items.find(i => i.id === itemId);
        if (!item) return false;

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –¥–ª—è —ç–∫–∏–ø–∏—Ä–æ–≤–∫–∏
        if (!this.canEquipItem(item)) {
            return false;
        }

        // –°–Ω–∏–º–∞–µ–º —Ç–µ–∫—É—â–∏–π –ø—Ä–µ–¥–º–µ—Ç —ç—Ç–æ–≥–æ —Ç–∏–ø–∞ –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
        if (item.type === 'weapon') {
            if (this.equipped.weapon) {
                this.unequipItem(this.equipped.weapon.id);
            }
            this.equipped.weapon = item;
        } else if (item.type === 'shield') {
            if (this.equipped.shield) {
                this.unequipItem(this.equipped.shield.id);
            }
            this.equipped.shield = item;
        } else if (item.type === 'armor') {
            if (this.equipped.armor) {
                this.unequipItem(this.equipped.armor.id);
            }
            this.equipped.armor = item;
        } else if (item.type === 'light_source') {
            if (this.equipped.light_source) {
                this.unequipItem(this.equipped.light_source.id);
            }
            this.equipped.light_source = item;
        }

        item.equipped = true;
        this.saveInventory();
        return true;
    }

    unequipItem(itemId) {
        const item = this.items.find(i => i.id === itemId);
        if (!item || !item.equipped) return false;

        if (this.equipped.weapon === item) this.equipped.weapon = null;
        if (this.equipped.shield === item) this.equipped.shield = null;
        if (this.equipped.armor === item) this.equipped.armor = null;
        if (this.equipped.light_source === item) this.equipped.light_source = null;

        item.equipped = false;
        this.saveInventory();
        return true;
    }

    canEquipItem(item) {
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –¥–≤—É—Ä—É—á–Ω–æ–µ –æ—Ä—É–∂–∏–µ —Å–æ —â–∏—Ç–æ–º
        if (item.type === 'weapon' && item.hands === 2 && this.equipped.shield) {
            return false;
        }

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–≤—ã–∫–æ–≤ –¥–ª—è –æ—Ä—É–∂–∏—è
        if (item.type === 'weapon') {
            const requiredSkill = this.getWeaponSkill(item);
            const skillValue = this.character.getSkillValue(requiredSkill) || 5;
            if (skillValue < 5) {
                return false;
            }
        }

        return true;
    }

    getWeaponSkill(weapon) {
        const skillMap = {
            'one_handed': '–û–¥–Ω–æ—Ä—É—á–Ω–æ–µ –æ—Ä—É–∂–∏–µ',
            'two_handed': '–î–≤—É—Ä—É—á–Ω–æ–µ –æ—Ä—É–∂–∏–µ',
            'polearm': '–î—Ä–µ–≤–∫–æ–≤–æ–µ',
            'ranged': '–°—Ç—Ä–µ–ª—å–±–∞',
            'thrown': '–ú–µ—Ç–∞–Ω–∏–µ'
        };
        return skillMap[weapon.subtype] || '–û–¥–Ω–æ—Ä—É—á–Ω–æ–µ –æ—Ä—É–∂–∏–µ';
    }

    getCombatModifiers() {
        const modifiers = {
            attack: 0,
            damage: 0,
            armorClass: 0,
            movement: 0
        };

        // –ë–æ–Ω—É—Å—ã –æ—Ç –æ—Ä—É–∂–∏—è
        if (this.equipped.weapon) {
            // –ë–æ–Ω—É—Å –∞—Ç–∞–∫–∏ –æ—Ç –Ω–∞–≤—ã–∫–∞ –≤–ª–∞–¥–µ–Ω–∏—è –æ—Ä—É–∂–∏–µ–º
            const weaponSkill = this.getWeaponSkill(this.equipped.weapon);
            const skillValue = this.character.getSkillValue(weaponSkill) || 5;
            modifiers.attack += Math.floor((skillValue - 5) / 2);
        }

        // –ë–æ–Ω—É—Å—ã –æ—Ç —â–∏—Ç–∞
        if (this.equipped.shield) {
            modifiers.armorClass += this.equipped.shield.armorBonus;
        }

        // –ë–æ–Ω—É—Å—ã –æ—Ç –±—Ä–æ–Ω–∏
        if (this.equipped.armor) {
            modifiers.armorClass += this.equipped.armor.armorClass;
        }

        // –®—Ç—Ä–∞—Ñ—ã –æ—Ç –ø–µ—Ä–µ–≥—Ä—É–∑–∞
        const encumbranceMods = this.getEncumbranceModifiers();
        modifiers.movement += encumbranceMods.movement;

        return modifiers;
    }

    useItem(itemId) {
        const item = this.items.find(i => i.id === itemId);
        if (!item) return false;

        switch (item.type) {
            case 'potion':
                return this.usePotion(item);
            case 'ammunition':
                return this.useAmmunition(item);
            default:
                return false;
        }
    }

    usePotion(potion) {
        let effect = '';
        
        switch (potion.effect) {
            case 'heal':
                const healAmount = this.rollDiceExpression(potion.power);
                this.character.stats.health = Math.min(
                    this.character.stats.health + healAmount,
                    this.character.stats.maxHealth
                );
                effect = `–≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç ${healAmount} –∑–¥–æ—Ä–æ–≤—å—è`;
                break;
            case 'restore_mana':
                const manaAmount = this.rollDiceExpression(potion.power);
                this.character.stats.mana = Math.min(
                    this.character.stats.mana + manaAmount,
                    this.character.stats.maxMana
                );
                effect = `–≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç ${manaAmount} –º–∞–Ω—ã`;
                break;
        }

        // –£–±–∏—Ä–∞–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–Ω–æ–µ –∑–µ–ª—å–µ
        this.removeItem(potion.id, 1);
        
        this.saveInventory();
        return effect;
    }

    useAmmunition(ammo) {
        if (ammo.quantity <= 0) return false;
        ammo.quantity--;
        if (ammo.quantity <= 0) {
            this.removeItem(ammo.id);
        }
        this.saveInventory();
        return true;
    }

    rollDiceExpression(expression) {
        // –ü—Ä–æ—Å—Ç–æ–π –ø–∞—Ä—Å–µ—Ä –≤—ã—Ä–∞–∂–µ–Ω–∏–π —Ç–∏–ø–∞ "2d4+2"
        const match = expression.match(/(\d+)d(\d+)([+-]\d+)?/);
        if (!match) return 0;

        const count = parseInt(match[1]);
        const sides = parseInt(match[2]);
        const modifier = match[3] ? parseInt(match[3]) : 0;

        const roll = rollDice(sides, count);
        return roll.total + modifier;
    }

    saveInventory() {
        const inventoryData = {
            items: this.items,
            equipped: this.equipped
        };
        StorageSystem.set(`inventory_${this.character.id}`, inventoryData);
    }

    loadInventory() {
        const inventoryData = StorageSystem.get(`inventory_${this.character.id}`, {
            items: [],
            equipped: {
                weapon: null,
                shield: null,
                armor: null,
                light_source: null
            }
        });

        this.items = inventoryData.items;
        this.equipped = inventoryData.equipped;
    }
}

// ========== –ò–ù–¢–ï–†–§–ï–ô–° –ò–ù–í–ï–ù–¢–ê–†–Ø ==========

function initializeInventoryInterface() {
    const inventoryTab = document.getElementById('inventory-tab');
    if (!inventoryTab || !currentCharacter) return;

    const inventorySystem = new InventorySystem(currentCharacter);

    inventoryTab.innerHTML = `
        <div style="margin-bottom: 20px;">
            <h2 class="section-title">üéí –°–∏—Å—Ç–µ–º–∞ –ò–Ω–≤–µ–Ω—Ç–∞—Ä—è</h2>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                <div>
                    <h3 style="color: #d4af37; margin-bottom: 15px;">üìä –°—Ç–∞—Ç—É—Å —Å–Ω–∞—Ä—è–∂–µ–Ω–∏—è</h3>
                    
                    <div style="background: #3d2418; padding: 15px; border-radius: 6px; margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <span>–í–µ—Å:</span>
                            <span>${inventorySystem.getCurrentWeight().toFixed(1)} / ${inventorySystem.carryCapacity} –∫–≥</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <span>–ó–∞–≥—Ä—É–∂–µ–Ω–Ω–æ—Å—Ç—å:</span>
                            <span style="color: ${getEncumbranceColor(inventorySystem.getEncumbranceLevel())}">
                                ${getEncumbranceText(inventorySystem.getEncumbranceLevel())}
                            </span>
                        </div>
                        <div style="background: #2c1810; height: 10px; border-radius: 5px; overflow: hidden;">
                            <div style="height: 100%; background: #27ae60; width: ${(inventorySystem.getCurrentWeight() / inventorySystem.carryCapacity) * 100}%;"></div>
                        </div>
                    </div>

                    <div style="background: #3d2418; padding: 15px; border-radius: 6px;">
                        <h4 style="color: #d4af37; margin-bottom: 10px;">üéØ –≠–∫–∏–ø–∏—Ä–æ–≤–∞–Ω–æ</h4>
                        <div id="equippedItems">
                            ${renderEquippedItems(inventorySystem)}
                        </div>
                    </div>
                </div>
                
                <div>
                    <h3 style="color: #d4af37; margin-bottom: 15px;">üõí –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–µ–¥–º–µ—Ç—ã</h3>
                    
                    <div style="background: #3d2418; padding: 15px; border-radius: 6px; margin-bottom: 15px;">
                        <select id="itemCategory" style="width: 100%; padding: 10px; margin-bottom: 10px; 
                              border: 2px solid #8b4513; border-radius: 4px; background: #1a0f0b; color: #e0d0c0;">
                            <option value="weapons">‚öîÔ∏è –û—Ä—É–∂–∏–µ</option>
                            <option value="shields">üõ°Ô∏è –©–∏—Ç—ã</option>
                            <option value="armor">ü•ã –ë—Ä–æ–Ω—è</option>
                            <option value="light_sources">üí° –ò—Å—Ç–æ—á–Ω–∏–∫–∏ —Å–≤–µ—Ç–∞</option>
                            <option value="ammunition">üèπ –ë–æ–µ–ø—Ä–∏–ø–∞—Å—ã</option>
                            <option value="misc">üéí –ü—Ä–æ—á–µ–µ</option>
                        </select>
                        
                        <select id="itemSelect" style="width: 100%; padding: 10px; margin-bottom: 10px; 
                              border: 2px solid #8b4513; border-radius: 4px; background: #1a0f0b; color: #e0d0c0;">
                            ${renderItemOptions('weapons')}
                        </select>
                        
                        <div style="display: flex; gap: 10px;">
                            <input type="number" id="itemQuantity" value="1" min="1" 
                                   style="flex: 1; padding: 10px; border: 2px solid #8b4513; border-radius: 4px; 
                                   background: #1a0f0b; color: #e0d0c0;">
                            <button class="btn btn-plus" onclick="addItemToInventory()">–î–æ–±–∞–≤–∏—Ç—å</button>
                        </div>
                    </div>
                    
                    <button class="btn btn-roll" onclick="showQuickEquipment()" style="width: 100%;">
                        üéÅ –ë—ã—Å—Ç—Ä–∞—è —ç–∫–∏–ø–∏—Ä–æ–≤–∫–∞
                    </button>
                </div>
            </div>
            
            <div style="background: #3d2418; padding: 20px; border-radius: 8px; border: 2px solid #5a3928;">
                <h3 style="color: #d4af37; margin-bottom: 15px;">üéí –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è</h3>
                <input type="text" id="inventorySearch" placeholder="üîç –ü–æ–∏—Å–∫ –ø—Ä–µ–¥–º–µ—Ç–æ–≤..." 
                       style="width: 100%; padding: 10px; margin-bottom: 15px; border: 2px solid #8b4513; 
                       border-radius: 4px; background: #1a0f0b; color: #e0d0c0;">
                <div id="inventoryItems">
                    ${renderInventoryItems(inventorySystem)}
                </div>
            </div>
        </div>
    `;

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
    document.getElementById('itemCategory').addEventListener('change', function() {
        updateItemOptions(this.value);
    });
    
    document.getElementById('inventorySearch').addEventListener('input', function() {
        filterInventoryItems(this.value);
    });
}

function renderEquippedItems(inventorySystem) {
    let html = '';
    
    const slots = [
        { key: 'weapon', label: '–û—Ä—É–∂–∏–µ', icon: '‚öîÔ∏è' },
        { key: 'shield', label: '–©–∏—Ç', icon: 'üõ°Ô∏è' },
        { key: 'armor', label: '–ë—Ä–æ–Ω—è', icon: 'ü•ã' },
        { key: 'light_source', label: '–°–≤–µ—Ç', icon: 'üí°' }
    ];

    slots.forEach(slot => {
        const item = inventorySystem.equipped[slot.key];
        html += `
            <div style="display: flex; justify-content: space-between; align-items: center; 
                 padding: 8px 0; border-bottom: 1px solid #5a3928;">
                <div>
                    <span style="margin-right: 10px;">${slot.icon}</span>
                    <span>${slot.label}:</span>
                </div>
                <div>
                    ${item ? `
                        <span>${item.name}</span>
                        <button class="btn btn-small" onclick="unequipItem('${item.id}')" 
                                style="background: #c44536; margin-left: 10px;">–°–Ω—è—Ç—å</button>
                    ` : '<span style="color: #8b7d6b;">–ù–µ —ç–∫–∏–ø–∏—Ä–æ–≤–∞–Ω–æ</span>'}
                </div>
            </div>
        `;
    });

    // –ë–æ–µ–≤—ã–µ –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã
    const modifiers = inventorySystem.getCombatModifiers();
    html += `
        <div style="margin-top: 15px; padding-top: 10px; border-top: 2px solid #5a3928;">
            <h5 style="color: #d4af37; margin-bottom: 5px;">–ë–æ–µ–≤—ã–µ –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã:</h5>
            <div style="font-size: 0.9em;">
                –ê—Ç–∞–∫–∞: ${modifiers.attack >= 0 ? '+' : ''}${modifiers.attack} |
                –ó–∞—â–∏—Ç–∞: +${modifiers.armorClass} |
                –î–≤–∏–∂–µ–Ω–∏–µ: ${modifiers.movement >= 0 ? '+' : ''}${modifiers.movement}
            </div>
        </div>
    `;

    return html;
}

function renderItemOptions(category) {
    const items = itemTemplates[category];
    if (!items) return '<option value="">–ù–µ—Ç –ø—Ä–µ–¥–º–µ—Ç–æ–≤</option>';
    
    return Object.values(items).map(item => 
        `<option value="${item.id}">${item.name} (${item.value} –∑–æ–ª.)</option>`
    ).join('');
}

function renderInventoryItems(inventorySystem) {
    if (inventorySystem.items.length === 0) {
        return '<p style="text-align: center; color: #8b7d6b;">–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å –ø—É—Å—Ç</p>';
    }

    let html = '';
    inventorySystem.items.forEach(item => {
        const weight = (item.weight * (item.quantity || 1)).toFixed(1);
        html += `
            <div class="inventory-item" style="background: #2c1810; margin: 10px 0; padding: 15px; 
                 border-radius: 6px; border-left: 4px solid #d4af37;">
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                    <div>
                        <strong style="color: #d4af37;">${item.name}</strong>
                        ${item.quantity > 1 ? `<span style="background: #8b4513; color: #e0d0c0; padding: 2px 8px; 
                            border-radius: 4px; font-size: 0.9em; margin-left: 10px;">√ó${item.quantity}</span>` : ''}
                        <div style="color: #b8a28a; font-size: 0.9em; margin-top: 5px;">${item.description}</div>
                    </div>
                    <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                        ${!item.equipped ? `
                            <button class="btn btn-small" onclick="equipItem('${item.id}')" 
                                    style="background: #27ae60;">–≠–∫–∏–ø–∏—Ä–æ–≤–∞—Ç—å</button>
                        ` : `
                            <button class="btn btn-small" onclick="unequipItem('${item.id}')" 
                                    style="background: #c44536;">–°–Ω—è—Ç—å</button>
                        `}
                        <button class="btn btn-small" onclick="useItem('${item.id}')" 
                                style="background: #3498db;">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å</button>
                        <button class="btn btn-small" onclick="removeItem('${item.id}')" 
                                style="background: #e74c3c;">–í—ã–±—Ä–æ—Å–∏—Ç—å</button>
                    </div>
                </div>
                <div style="display: flex; justify-content: space-between; color: #8b7d6b; font-size: 0.8em;">
                    <span>–í–µ—Å: ${weight} –∫–≥</span>
                    <span>–°—Ç–æ–∏–º–æ—Å—Ç—å: ${item.value} –∑–æ–ª.</span>
                    <span>–¢–∏–ø: ${getItemTypeText(item.type)}</span>
                </div>
            </div>
        `;
    });

    return html;
}

// ========== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ==========

function getEncumbranceColor(level) {
    const colors = {
        'none': '#27ae60',
        'light': '#f39c12', 
        'medium': '#e67e22',
        'heavy': '#e74c3c'
    };
    return colors[level] || '#8b7d6b';
}

function getEncumbranceText(level) {
    const texts = {
        'none': '–ù–µ—Ç',
        'light': '–õ–µ–≥–∫–∞—è',
        'medium': '–°—Ä–µ–¥–Ω—è—è',
        'heavy': '–¢—è–∂–µ–ª–∞—è'
    };
    return texts[level] || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
}

function getItemTypeText(type) {
    const types = {
        'weapon': '–û—Ä—É–∂–∏–µ',
        'shield': '–©–∏—Ç',
        'armor': '–ë—Ä–æ–Ω—è',
        'light_source': '–ò—Å—Ç–æ—á–Ω–∏–∫ —Å–≤–µ—Ç–∞',
        'ammunition': '–ë–æ–µ–ø—Ä–∏–ø–∞—Å—ã',
        'potion': '–ó–µ–ª—å–µ',
        'tool': '–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç'
    };
    return types[type] || type;
}

// ========== –§–£–ù–ö–¶–ò–ò –£–ü–†–ê–í–õ–ï–ù–ò–Ø –ò–ù–í–ï–ù–¢–ê–†–ï–ú ==========

function updateItemOptions(category) {
    const itemSelect = document.getElementById('itemSelect');
    if (itemSelect) {
        itemSelect.innerHTML = renderItemOptions(category);
    }
}

function addItemToInventory() {
    if (!currentCharacter) return;

    const category = document.getElementById('itemCategory').value;
    const itemId = document.getElementById('itemSelect').value;
    const quantity = parseInt(document.getElementById('itemQuantity').value) || 1;

    const itemTemplate = itemTemplates[category]?.[itemId];
    if (!itemTemplate) {
        alert('–ü—Ä–µ–¥–º–µ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω!');
        return;
    }

    const inventorySystem = new InventorySystem(currentCharacter);
    inventorySystem.addItem(itemTemplate, quantity);
    
    alert(`‚úÖ "${itemTemplate.name}" –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å!`);
    initializeInventoryInterface();
}

function equipItem(itemId) {
    if (!currentCharacter) return;

    const inventorySystem = new InventorySystem(currentCharacter);
    if (inventorySystem.equipItem(itemId)) {
        alert('‚úÖ –ü—Ä–µ–¥–º–µ—Ç —ç–∫–∏–ø–∏—Ä–æ–≤–∞–Ω!');
        initializeInventoryInterface();
    } else {
        alert('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —ç–∫–∏–ø–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–µ–¥–º–µ—Ç!');
    }
}

function unequipItem(itemId) {
    if (!currentCharacter) return;

    const inventorySystem = new InventorySystem(currentCharacter);
    if (inventorySystem.unequipItem(itemId)) {
        alert('‚úÖ –ü—Ä–µ–¥–º–µ—Ç —Å–Ω—è—Ç!');
        initializeInventoryInterface();
    }
}

function useItem(itemId) {
    if (!currentCharacter) return;

    const inventorySystem = new InventorySystem(currentCharacter);
    const effect = inventorySystem.useItem(itemId);
    
    if (effect) {
        alert(`‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ: ${effect}`);
        initializeInventoryInterface();
    } else {
        alert('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–µ–¥–º–µ—Ç!');
    }
}

function removeItem(itemId) {
    if (!currentCharacter) return;

    if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–±—Ä–æ—Å–∏—Ç—å —ç—Ç–æ—Ç –ø—Ä–µ–¥–º–µ—Ç?')) {
        const inventorySystem = new InventorySystem(currentCharacter);
        if (inventorySystem.removeItem(itemId)) {
            alert('‚úÖ –ü—Ä–µ–¥–º–µ—Ç –≤—ã–±—Ä–æ—à–µ–Ω!');
            initializeInventoryInterface();
        }
    }
}

function filterInventoryItems(searchTerm) {
    const items = document.querySelectorAll('.inventory-item');
    const term = searchTerm.toLowerCase();
    
    items.forEach(item => {
        const text = item.textContent.toLowerCase();
        item.style.display = text.includes(term) ? 'block' : 'none';
    });
}

function showQuickEquipment() {
    if (!currentCharacter) return;

    const inventorySystem = new InventorySystem(currentCharacter);
    
    // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∞—Ä—Ç–æ–≤—ã–π –Ω–∞–±–æ—Ä
    const starterKit = [
        itemTemplates.weapons.shortsword,
        itemTemplates.armor.leather_armor,
        itemTemplates.shields.buckler,
        itemTemplates.light_sources.torch,
        itemTemplates.misc.healing_potion,
        itemTemplates.misc.rope
    ];

    starterKit.forEach(item => {
        inventorySystem.addItem(item);
    });

    alert('üéÅ –°—Ç–∞—Ä—Ç–æ–≤—ã–π –Ω–∞–±–æ—Ä –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å!');
    initializeInventoryInterface();
}

// ========== –û–ë–ù–û–í–õ–ï–ù–ò–ï –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–ò ==========

let inventoryTabInitialized = false;

function openTab(tabName) {
    document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    document.getElementById(tabName + '-tab').classList.add('active');
    event.currentTarget.classList.add('active');
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –æ—Ç–∫—Ä—ã—Ç–∏–∏ –≤–∫–ª–∞–¥–æ–∫
    if (tabName === 'combat' && !combatTabInitialized) {
        initializeCombatSystem();
        combatTabInitialized = true;
    }
    
    if (tabName === 'inventory' && !inventoryTabInitialized) {
        initializeInventoryInterface();
        inventoryTabInitialized = true;
    }
}
// ========== –°–ò–°–¢–ï–ú–ê –ö–£–ë–ò–ö–û–í –ò –ì–ï–ù–ï–†–ê–¢–û–†–û–í ==========

function initializeDiceSystem() {
    const diceTab = document.getElementById('dice-tab');
    if (!diceTab) return;

    diceTab.innerHTML = `
        <div style="margin-bottom: 20px;">
            <h2 class="section-title">üé≤ –°–∏—Å—Ç–µ–º–∞ –ö—É–±–∏–∫–æ–≤</h2>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                <div>
                    <h3 style="color: #d4af37; margin-bottom: 15px;">üéØ –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –∫—É–±–∏–∫–∏</h3>
                    
                    <div class="dice-controls" style="display: flex; gap: 10px; align-items: center; 
                         justify-content: center; margin: 20px 0; flex-wrap: wrap;">
                        <span style="color: #d4af37;">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:</span>
                        <input type="number" id="diceCount" class="dice-count" value="1" min="1" max="10"
                               style="width: 80px; padding: 12px; border: 2px solid #8b4513; border-radius: 4px; 
                               background: #1a0f0b; color: #e0d0c0; text-align: center; font-size: 16px;">
                    </div>

                    <div class="dice-container" style="display: flex; flex-wrap: wrap; gap: 10px; margin: 20px 0; 
                         justify-content: center; align-items: center;">
                        <button class="btn btn-dice" onclick="rollDiceUI('coin')">ü™ô –ú–æ–Ω–µ—Ç–∫–∞</button>
                        <button class="btn btn-dice" onclick="rollDiceUI(4)">D4</button>
                        <button class="btn btn-dice" onclick="rollDiceUI(6)">D6</button>
                        <button class="btn btn-dice" onclick="rollDiceUI(8)">D8</button>
                        <button class="btn btn-dice" onclick="rollDiceUI(10)">D10</button>
                        <button class="btn btn-dice" onclick="rollDiceUI(12)">D12</button>
                        <button class="btn btn-dice" onclick="rollDiceUI(20)">D20</button>
                        <button class="btn btn-dice" onclick="rollDiceUI(100)">D100</button>
                        <div style="display: flex; gap: 5px; align-items: center;">
                            <button class="btn btn-dice" onclick="rollCustomDiceUI()">‚ö´ –ö–∞—Å—Ç–æ–º–Ω—ã–π</button>
                            <input type="number" id="customDiceSides" class="custom-dice-input" value="6" 
                                   min="2" max="1000" placeholder="–ì—Ä–∞–Ω–∏"
                                   style="width: 80px; padding: 12px; border: 2px solid #8b4513; border-radius: 4px; 
                                   background: #1a0f0b; color: #e0d0c0; text-align: center; font-size: 16px;">
                        </div>
                    </div>
                </div>
                
                <div>
                    <h3 style="color: #d4af37; margin-bottom: 15px;">üå§Ô∏è –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –∫—É–±–∏–∫–∏</h3>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                        <button class="btn btn-dice" onclick="rollWeatherDiceUI()">üå¶Ô∏è –ü–æ–≥–æ–¥–∞</button>
                        <button class="btn btn-dice" onclick="rollFogDiceUI()">üå´Ô∏è –¢—É–º–∞–Ω</button>
                        <button class="btn btn-dice" onclick="rollEncounterDice()">üëπ –°–ª—É—á–∞–π–Ω–∞—è –≤—Å—Ç—Ä–µ—á–∞</button>
                        <button class="btn btn-dice" onclick="rollLootDice()">üíé –î–æ–±—ã—á–∞</button>
                    </div>
                    
                    <div style="background: #3d2418; padding: 15px; border-radius: 6px;">
                        <h4 style="color: #d4af37; margin-bottom: 10px;">üìä –ò—Å—Ç–æ—Ä–∏—è –±—Ä–æ—Å–∫–æ–≤</h4>
                        <div id="diceHistory" style="max-height: 150px; overflow-y: auto; font-size: 0.9em;">
                            <p style="color: #8b7d6b; text-align: center;">–ë—Ä–æ—Å–∫–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="diceResults" style="text-align: center; margin: 30px 0; min-height: 100px; 
                 background: #3d2418; padding: 20px; border-radius: 8px; border: 2px solid #5a3928;">
                <p style="color: #8b7d6b;">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –±—Ä–æ—Å–∫–æ–≤ –±—É–¥—É—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –∑–¥–µ—Å—å</p>
            </div>
        </div>
    `;
}

// –ì–ª–æ–±–∞–ª—å–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è –±—Ä–æ—Å–∫–æ–≤
let diceRollHistory = [];

function rollDiceUI(diceType) {
    const count = parseInt(document.getElementById('diceCount').value) || 1;
    let results = [];
    let total = 0;
    let diceName = '';
    
    if (diceType === 'coin') {
        for (let i = 0; i < count; i++) {
            const result = Math.random() > 0.5 ? '–û—Ä—ë–ª' : '–†–µ—à–∫–∞';
            results.push(result);
        }
        diceName = '–ú–æ–Ω–µ—Ç–∫–∞';
    } else {
        for (let i = 0; i < count; i++) {
            const result = Math.floor(Math.random() * diceType) + 1;
            results.push(result);
            total += result;
        }
        diceName = `D${diceType}`;
    }
    
    displayDiceResults(diceName, count, results, total);
    addToDiceHistory(diceName, count, results, total);
}

function rollCustomDiceUI() {
    const sides = parseInt(document.getElementById('customDiceSides').value) || 6;
    if (sides < 2) {
        alert('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥—Ä–∞–Ω–µ–π –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –Ω–µ –º–µ–Ω—å—à–µ 2!');
        return;
    }
    rollDiceUI(sides);
}

function rollWeatherDiceUI() {
    const result = weatherTimeSystem.rollWeather();
    const description = getWeatherDescription(result);
    
    displayDiceResults('–ü–æ–≥–æ–¥–∞', 1, [description], 0);
    addToDiceHistory('–ü–æ–≥–æ–¥–∞', 1, [description], 0);
    updateWeatherDisplay();
}

function rollFogDiceUI() {
    const result = weatherTimeSystem.rollFog();
    const description = getFogDescription(result);
    
    displayDiceResults('–¢—É–º–∞–Ω', 1, [description], 0);
    addToDiceHistory('–¢—É–º–∞–Ω', 1, [description], 0);
    updateWeatherDisplay();
}

function rollEncounterDice() {
    const encounters = [
        "üë®‚Äçüåæ –ì—Ä—É–ø–ø–∞ —Ñ–µ—Ä–º–µ—Ä–æ–≤",
        "üíÄ –ë–∞–Ω–¥–∞ —Ä–∞–∑–±–æ–π–Ω–∏–∫–æ–≤", 
        "üê∫ –°—Ç–∞—è –≤–æ–ª–∫–æ–≤",
        "üêª –ú–µ–¥–≤–µ–¥—å-—à–∞—Ç—É–Ω",
        "üßô‚Äç‚ôÇÔ∏è –°—Ç—Ä–∞–Ω—Å—Ç–≤—É—é—â–∏–π –º–∞–≥",
        "üè∞ –ö–æ—Ä–æ–ª–µ–≤—Å–∫–∏–π –ø–∞—Ç—Ä—É–ª—å",
        "üõí –¢–æ—Ä–≥–æ–≤—ã–π –∫–∞—Ä–∞–≤–∞–Ω",
        "üå≤ –õ–µ—Å–Ω—ã–µ –¥—É—Ö–∏",
        "üè¥‚Äç‚ò†Ô∏è –ü–∏—Ä–∞—Ç—ã",
        "üêâ –ú–æ–ª–æ–¥–æ–π –¥—Ä–∞–∫–æ–Ω"
    ];
    
    const roll = rollDice(10, 1).total - 1;
    const encounter = encounters[roll] || "–ù–∏—á–µ–≥–æ –Ω–µ–æ–±—ã—á–Ω–æ–≥–æ";
    
    displayDiceResults('–í—Å—Ç—Ä–µ—á–∞', 1, [encounter], 0);
    addToDiceHistory('–í—Å—Ç—Ä–µ—á–∞', 1, [encounter], 0);
}

function rollLootDice() {
    const lootTables = {
        common: ["10 –∑–æ–ª–æ—Ç—ã—Ö", "–ó–µ–ª—å–µ –ª–µ—á–µ–Ω–∏—è", "–ö–∏–Ω–∂–∞–ª", "–§–∞–∫–µ–ª", "–í–µ—Ä–µ–≤–∫–∞"],
        uncommon: ["50 –∑–æ–ª–æ—Ç—ã—Ö", "–ö–æ–ª—å—á—É–≥–∞", "–ö–æ—Ä–æ—Ç–∫–∏–π –º–µ—á", "–ú–∞–ª–æ–µ –∑–µ–ª—å–µ –º–∞–Ω—ã", "–°–≤–∏—Ç–æ–∫ –∑–∞–∫–ª–∏–Ω–∞–Ω–∏—è"],
        rare: ["100 –∑–æ–ª–æ—Ç—ã—Ö", "–õ–∞—Ç–Ω–∞—è –±—Ä–æ–Ω—è", "–í–æ–ª—à–µ–±–Ω—ã–π –º–µ—á", "–ê—Ä—Ç–µ—Ñ–∞–∫—Ç", "–î—Ä–∞–≥–æ—Ü–µ–Ω–Ω—ã–π –∫–∞–º–µ–Ω—å"]
    };
    
    const roll = rollDice(20, 1).total;
    let loot = [];
    
    if (roll <= 12) {
        loot = [lootTables.common[Math.floor(Math.random() * lootTables.common.length)]];
    } else if (roll <= 17) {
        loot = [lootTables.uncommon[Math.floor(Math.random() * lootTables.uncommon.length)]];
    } else {
        loot = [lootTables.rare[Math.floor(Math.random() * lootTables.rare.length)]];
    }
    
    displayDiceResults('–î–æ–±—ã—á–∞', 1, loot, 0);
    addToDiceHistory('–î–æ–±—ã—á–∞', 1, loot, 0);
}

function displayDiceResults(diceName, count, results, total) {
    const container = document.getElementById('diceResults');
    let resultHTML = '';
    
    if (diceName === '–ú–æ–Ω–µ—Ç–∫–∞') {
        resultHTML = `<h3 style="color: #d4af37;">${diceName} (${count} —Ä–∞–∑):</h3>`;
        resultHTML += `<div style="font-size: 1.5em; margin: 20px 0;">${results.join(', ')}</div>`;
    } else if (diceName === '–ü–æ–≥–æ–¥–∞' || diceName === '–¢—É–º–∞–Ω' || diceName === '–í—Å—Ç—Ä–µ—á–∞' || diceName === '–î–æ–±—ã—á–∞') {
        resultHTML = `<h3 style="color: #d4af37;">${diceName}:</h3>`;
        resultHTML += `<div style="font-size: 1.5em; margin: 20px 0; color: #27ae60;">${results[0]}</div>`;
    } else {
        resultHTML = `<h3 style="color: #d4af37;">–ë—Ä–æ—Å–æ–∫ ${count}${diceName}:</h3>`;
        resultHTML += `<div style="font-size: 1.5em; margin: 20px 0;">${results.join(' + ')}`;
        if (count > 1) {
            resultHTML += ` = <strong style="color: #d4af37;">${total}</strong>`;
        }
        resultHTML += `</div>`;
    }
    
    container.innerHTML = resultHTML;
}

function addToDiceHistory(diceName, count, results, total) {
    const timestamp = new Date().toLocaleTimeString();
    let entry = '';
    
    if (diceName === '–ú–æ–Ω–µ—Ç–∫–∞') {
        entry = `${timestamp} - ${diceName}: ${results.join(', ')}`;
    } else if (diceName === '–ü–æ–≥–æ–¥–∞' || diceName === '–¢—É–º–∞–Ω' || diceName === '–í—Å—Ç—Ä–µ—á–∞' || diceName === '–î–æ–±—ã—á–∞') {
        entry = `${timestamp} - ${diceName}: ${results[0]}`;
    } else {
        entry = `${timestamp} - ${count}${diceName}: [${results.join(', ')}]`;
        if (count > 1) {
            entry += ` = ${total}`;
        }
    }
    
    diceRollHistory.unshift(entry);
    if (diceRollHistory.length > 15) diceRollHistory.pop();
    renderDiceHistory();
}

function renderDiceHistory() {
    const container = document.getElementById('diceHistory');
    if (!container) return;

    if (diceRollHistory.length === 0) {
        container.innerHTML = '<p style="color: #8b7d6b; text-align: center;">–ë—Ä–æ—Å–∫–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</p>';
        return;
    }
    
    let historyHTML = '';
    diceRollHistory.forEach(entry => {
        historyHTML += `<div style="padding: 5px 0; border-bottom: 1px solid #3d2418;">${entry}</div>`;
    });
    
    container.innerHTML = historyHTML;
}

// ========== –°–ò–°–¢–ï–ú–ê –ó–ê–ú–ï–¢–û–ö ==========

function initializeNotesSystem() {
    const notesTab = document.getElementById('notes-tab');
    if (!notesTab) return;

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –∑–∞–º–µ—Ç–∫–∏ –∏–∑ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞
    const savedNotes = StorageSystem.get('character_notes', []);
    
    notesTab.innerHTML = `
        <div style="margin-bottom: 20px;">
            <h2 class="section-title">‚úçÔ∏è –°–∏—Å—Ç–µ–º–∞ –ó–∞–º–µ—Ç–æ–∫</h2>
            
            <div style="text-align: center; margin-bottom: 20px;">
                <button class="btn btn-plus" onclick="showAddNotePopup()">‚ûï –ù–æ–≤–∞—è –∑–∞–º–µ—Ç–∫–∞</button>
                <button class="btn btn-roll" onclick="exportNotes()">üíæ –≠–∫—Å–ø–æ—Ä—Ç –∑–∞–º–µ—Ç–æ–∫</button>
                <button class="btn btn-roll" onclick="importNotes()">üì• –ò–º–ø–æ—Ä—Ç –∑–∞–º–µ—Ç–æ–∫</button>
            </div>
            
            <input type="text" class="search-box" id="notesSearch" placeholder="üîç –ü–æ–∏—Å–∫ –≤ –∑–∞–º–µ—Ç–∫–∞—Ö..."
                   style="width: 100%; padding: 12px; margin: 10px 0; border: 2px solid #8b4513; 
                   border-radius: 4px; background: #1a0f0b; color: #e0d0c0; font-size: 16px;">
            
            <div class="notes-container" id="notesContainer">
                ${renderNotes(savedNotes)}
            </div>
        </div>
    `;

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–æ–∏—Å–∫–∞
    document.getElementById('notesSearch').addEventListener('input', function() {
        filterNotes(this.value, savedNotes);
    });
}

function renderNotes(notes) {
    if (notes.length === 0) {
        return '<p style="color: #8b7d6b; text-align: center;">–ó–∞–º–µ—Ç–æ–∫ –ø–æ–∫–∞ –Ω–µ—Ç</p>';
    }

    let notesHTML = '';
    notes.forEach((note, index) => {
        const preview = note.content.length > 100 ? note.content.substring(0, 100) + '...' : note.content;
        notesHTML += `
            <div class="note-item" style="background: #3d2418; margin: 10px 0; padding: 15px; 
                 border-radius: 6px; border-left: 4px solid #27ae60;">
                <div class="note-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <span class="note-title" style="font-weight: bold; color: #d4af37; font-size: 1.1em;">${note.title}</span>
                    <div class="note-actions" style="display: flex; gap: 10px;">
                        <button class="btn btn-small" onclick="editNote(${index})" style="background: #3498db;">‚úèÔ∏è</button>
                        <button class="btn btn-small" onclick="deleteNote(${index})" style="background: #c44536;">‚ùå</button>
                        <button class="btn btn-small" onclick="toggleNoteExpand(${index})" style="background: #8b4513;">
                            ${note.expanded ? '‚ñº' : '‚ñ∂'}
                        </button>
                    </div>
                </div>
                <div class="note-preview" style="color: #b8a28a; font-size: 0.95em; line-height: 1.4;">
                    ${note.expanded ? note.content : preview}
                </div>
                <div style="color: #8b7d6b; font-size: 0.8em; margin-top: 10px;">
                    –°–æ–∑–¥–∞–Ω–æ: ${new Date(note.created).toLocaleDateString()}
                </div>
            </div>
        `;
    });

    return notesHTML;
}

function showAddNotePopup() {
    showPopup(
        '‚úçÔ∏è –ù–æ–≤–∞—è –∑–∞–º–µ—Ç–∫–∞',
        `
            <input type="text" id="newNoteTitle" placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫ –∑–∞–º–µ—Ç–∫–∏" 
                   style="width: 100%; padding: 12px; margin: 10px 0; border: 2px solid #8b4513; 
                   border-radius: 4px; background: #1a0f0b; color: #e0d0c0;">
            <textarea id="newNoteContent" placeholder="–¢–µ–∫—Å—Ç –∑–∞–º–µ—Ç–∫–∏..." 
                      style="width: 100%; height: 200px; padding: 12px; margin: 10px 0; 
                      border: 2px solid #8b4513; border-radius: 4px; background: #1a0f0b; 
                      color: #e0d0c0; resize: vertical;"></textarea>
        `,
        [
            '<button class="btn btn-plus" onclick="addNewNote()">–î–æ–±–∞–≤–∏—Ç—å</button>',
            '<button class="btn btn-roll" onclick="closePopup(this.closest(\'.popup\'))">–û—Ç–º–µ–Ω–∞</button>'
        ]
    );
}

function addNewNote() {
    const title = document.getElementById('newNoteTitle').value.trim();
    const content = document.getElementById('newNoteContent').value.trim();
    
    if (!title) {
        alert('–í–≤–µ–¥–∏—Ç–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∑–∞–º–µ—Ç–∫–∏!');
        return;
    }
    
    const notes = StorageSystem.get('character_notes', []);
    notes.unshift({
        title,
        content,
        expanded: false,
        created: new Date().toISOString()
    });
    
    StorageSystem.set('character_notes', notes);
    initializeNotesSystem();
    closePopup(document.querySelector('.popup'));
}

function editNote(index) {
    const notes = StorageSystem.get('character_notes', []);
    const note = notes[index];
    
    showPopup(
        '‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–º–µ—Ç–∫—É',
        `
            <input type="text" id="editNoteTitle" value="${note.title}" 
                   style="width: 100%; padding: 12px; margin: 10px 0; border: 2px solid #8b4513; 
                   border-radius: 4px; background: #1a0f0b; color: #e0d0c0;">
            <textarea id="editNoteContent" 
                      style="width: 100%; height: 200px; padding: 12px; margin: 10px 0; 
                      border: 2px solid #8b4513; border-radius: 4px; background: #1a0f0b; 
                      color: #e0d0c0; resize: vertical;">${note.content}</textarea>
        `,
        [
            `<button class="btn btn-plus" onclick="saveEditedNote(${index})">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>`,
            '<button class="btn btn-roll" onclick="closePopup(this.closest(\'.popup\'))">–û—Ç–º–µ–Ω–∞</button>'
        ]
    );
}

function saveEditedNote(index) {
    const title = document.getElementById('editNoteTitle').value.trim();
    const content = document.getElementById('editNoteContent').value.trim();
    
    if (!title) {
        alert('–í–≤–µ–¥–∏—Ç–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∑–∞–º–µ—Ç–∫–∏!');
        return;
    }
    
    const notes = StorageSystem.get('character_notes', []);
    notes[index].title = title;
    notes[index].content = content;
    
    StorageSystem.set('character_notes', notes);
    initializeNotesSystem();
    closePopup(document.querySelector('.popup'));
}

function deleteNote(index) {
    if (confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–º–µ—Ç–∫—É?')) {
        const notes = StorageSystem.get('character_notes', []);
        notes.splice(index, 1);
        StorageSystem.set('character_notes', notes);
        initializeNotesSystem();
    }
}

function toggleNoteExpand(index) {
    const notes = StorageSystem.get('character_notes', []);
    notes[index].expanded = !notes[index].expanded;
    StorageSystem.set('character_notes', notes);
    initializeNotesSystem();
}

function filterNotes(searchTerm, notes) {
    const term = searchTerm.toLowerCase();
    const filteredNotes = notes.filter(note => 
        note.title.toLowerCase().includes(term) || 
        note.content.toLowerCase().includes(term)
    );
    
    document.getElementById('notesContainer').innerHTML = renderNotes(filteredNotes);
}

function exportNotes() {
    const notes = StorageSystem.get('character_notes', []);
    const dataStr = JSON.stringify(notes, null, 2);
    const dataBlob = new Blob([dataStr], { type: 'application/json' });
    
    const link = document.createElement('a');
    link.href = URL.createObjectURL(dataBlob);
    link.download = `dnd_notes_${new Date().toISOString().split('T')[0]}.json`;
    link.click();
    
    alert('‚úÖ –ó–∞–º–µ—Ç–∫–∏ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã!');
}

function importNotes() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';
    
    input.onchange = function(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const importedNotes = JSON.parse(e.target.result);
                StorageSystem.set('character_notes', importedNotes);
                initializeNotesSystem();
                alert('‚úÖ –ó–∞–º–µ—Ç–∫–∏ –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã!');
            } catch (error) {
                alert('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞!');
            }
        };
        reader.readAsText(file);
    };
    
    input.click();
}

// ========== –°–ò–°–¢–ï–ú–ê –£–ü–†–ê–í–õ–ï–ù–ò–Ø –ü–ï–†–°–û–ù–ê–ñ–ê–ú–ò ==========

function initializeCharactersManager() {
    const charactersTab = document.getElementById('characters-tab');
    if (!charactersTab) return;

    charactersTab.innerHTML = `
        <div style="margin-bottom: 20px;">
            <h2 class="section-title">üë• –ú–µ–Ω–µ–¥–∂–µ—Ä –ü–µ—Ä—Å–æ–Ω–∞–∂–µ–π</h2>
            
            <div style="text-align: center; margin-bottom: 20px;">
                <button class="btn btn-plus" onclick="showCreateCharacterPopup()">‚ûï –°–æ–∑–¥–∞—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞</button>
                <button class="btn btn-roll" onclick="showImportCharacterPopup()">üì• –ò–º–ø–æ—Ä—Ç –ø–µ—Ä—Å–æ–Ω–∞–∂–∞</button>
                <button class="btn btn-roll" onclick="exportAllCharacters()">üíæ –≠–∫—Å–ø–æ—Ä—Ç –≤—Å–µ—Ö</button>
                <button class="btn btn-minus" onclick="showClearAllPopup()">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å –≤—Å–µ—Ö</button>
            </div>

            <div class="skills-section" style="padding: 25px; border-bottom: 2px solid #5a3928;">
                <div class="section-title">üìÇ –í–∞—à–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–∏</div>
                <div id="charactersList" style="min-height: 200px;">
                    ${renderCharactersList()}
                </div>
            </div>

            <div class="skills-section" style="padding: 25px;">
                <div class="section-title">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</div>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; text-align: center;">
                    <div style="background: #3d2418; padding: 15px; border-radius: 6px;">
                        <div style="font-size: 2em; color: #d4af37;">${Object.keys(characterManager.characters).length}</div>
                        <div>–í—Å–µ–≥–æ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π</div>
                    </div>
                    <div style="background: #3d2418; padding: 15px; border-radius: 6px;">
                        <div style="font-size: 2em; color: #d4af37;">${getTotalPlayTime()}</div>
                        <div>–û–±—â–µ–µ –≤—Ä–µ–º—è –∏–≥—Ä—ã</div>
                    </div>
                    <div style="background: #3d2418; padding: 15px; border-radius: 6px;">
                        <div style="font-size: 2em; color: #d4af37;">${getHighestLevel()}</div>
                        <div>–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å</div>
                    </div>
                </div>
            </div>
        </div>
    `;
}

function renderCharactersList() {
    const characters = characterManager.characters;
    if (Object.keys(characters).length === 0) {
        return '<p style="color: #8b7d6b; text-align: center;">–ü–µ—Ä—Å–æ–Ω–∞–∂–µ–π –ø–æ–∫–∞ –Ω–µ—Ç</p>';
    }

    let html = '';
    Object.values(characters).forEach(character => {
        const isCurrent = characterManager.currentCharacterId === character.id;
        const raceInfo = races[character.info.race] || { name: '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ' };
        
        html += `
            <div class="character-item" style="background: #3d2418; padding: 15px; margin: 10px 0; 
                 border-radius: 6px; border-left: 4px solid ${isCurrent ? '#27ae60' : '#8b4513'}; 
                 ${isCurrent ? 'background: #2c4d2c;' : ''}">
                <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                    <div style="flex: 1;">
                        <div style="font-weight: bold; color: #d4af37; font-size: 1.1em;">${character.info.name}</div>
                        <div style="color: #b8a28a; font-size: 0.9em; margin-top: 5px;">
                            ${raceInfo.name} | –£—Ä. ${character.level.current} | –û–ø—ã—Ç: ${character.level.exp}
                        </div>
                        <div style="color: #8b7d6b; font-size: 0.8em; margin-top: 5px;">
                            –°–æ–∑–¥–∞–Ω: ${new Date(character.createdAt).toLocaleDateString()}
                        </div>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 5px; margin-left: 10px;">
                        ${!isCurrent ? 
                            `<button class="btn btn-small" onclick="switchCharacter('${character.id}')" 
                                     style="background: #27ae60;">üéØ –í—ã–±—Ä–∞—Ç—å</button>` : 
                            `<button class="btn btn-small" disabled 
                                     style="background: #5a3928;">‚úÖ –ê–∫—Ç–∏–≤–µ–Ω</button>`
                        }
                        <button class="btn btn-small" onclick="exportSingleCharacter('${character.id}')" 
                                style="background: #3498db;">üíæ –≠–∫—Å–ø–æ—Ä—Ç</button>
                        <button class="btn btn-small" onclick="showRenameCharacterPopup('${character.id}')" 
                                style="background: #f39c12;">‚úèÔ∏è –ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å</button>
                        <button class="btn btn-small" onclick="showDeleteCharacterPopup('${character.id}')" 
                                style="background: #c44536;">‚ùå –£–¥–∞–ª–∏—Ç—å</button>
                    </div>
                </div>
            </div>
        `;
    });
    
    return html;
}

function showCreateCharacterPopup() {
    showPopup(
        'üë§ –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞',
        `
            <input type="text" id="newCharacterName" placeholder="–ò–º—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞" 
                   style="width: 100%; padding: 12px; margin: 10px 0; border: 2px solid #8b4513; 
                   border-radius: 4px; background: #1a0f0b; color: #e0d0c0;">
            <select id="newCharacterRace" style="width: 100%; padding: 12px; margin: 10px 0; 
                    border: 2px solid #8b4513; border-radius: 4px; background: #1a0f0b; color: #e0d0c0;">
                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞—Å—É</option>
                ${Object.entries(races).map(([id, race]) => 
                    `<option value="${id}">${race.name}</option>`
                ).join('')}
            </select>
        `,
        [
            '<button class="btn btn-plus" onclick="createNewCharacter()">–°–æ–∑–¥–∞—Ç—å</button>',
            '<button class="btn btn-roll" onclick="closePopup(this.closest(\'.popup\'))">–û—Ç–º–µ–Ω–∞</button>'
        ]
    );
}

function createNewCharacter() {
    const name = document.getElementById('newCharacterName').value.trim();
    const race = document.getElementById('newCharacterRace').value;
    
    if (!name) {
        alert('–í–≤–µ–¥–∏—Ç–µ –∏–º—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞!');
        return;
    }
    if (!race) {
        alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞—Å—É –ø–µ—Ä—Å–æ–Ω–∞–∂–∞!');
        return;
    }

    characterManager.createCharacter(name, race);
    currentCharacter = characterManager.getCurrentCharacter();
    
    // –°–æ–∑–¥–∞–µ–º —Å—Ç–∞—Ä—Ç–æ–≤—ã–π –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å
    const inventorySystem = new InventorySystem(currentCharacter);
    const starterKit = [
        itemTemplates.weapons.dagger,
        itemTemplates.armor.leather_armor,
        itemTemplates.misc.healing_potion
    ];
    starterKit.forEach(item => inventorySystem.addItem(item));
    
    initializeCharactersManager();
    renderCharacterSheet();
    closePopup(document.querySelector('.popup'));
    
    alert(`‚úÖ –ü–µ—Ä—Å–æ–Ω–∞–∂ "${name}" —Å–æ–∑–¥–∞–Ω!`);
}

function switchCharacter(characterId) {
    characterManager.switchCharacter(characterId);
    currentCharacter = characterManager.getCurrentCharacter();
    initializeCharactersManager();
    renderCharacterSheet();
    alert(`‚úÖ –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω –Ω–∞ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞: ${currentCharacter.info.name}`);
}

function showRenameCharacterPopup(characterId) {
    const character = characterManager.characters[characterId];
    const newName = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –∏–º—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞:', character.info.name);
    
    if (newName && newName.trim()) {
        character.info.name = newName.trim();
        character.updatedAt = new Date().toISOString();
        characterManager.saveCharacters();
        initializeCharactersManager();
        if (characterId === characterManager.currentCharacterId) {
            renderCharacterSheet();
        }
        alert('‚úÖ –ò–º—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –∏–∑–º–µ–Ω–µ–Ω–æ!');
    }
}

function showDeleteCharacterPopup(characterId) {
    if (Object.keys(characterManager.characters).length <= 1) {
        alert('‚ùå –ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞!');
        return;
    }

    const character = characterManager.characters[characterId];
    if (confirm(`–£–¥–∞–ª–∏—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ "${character.info.name}"? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!`)) {
        characterManager.deleteCharacter(characterId);
        currentCharacter = characterManager.getCurrentCharacter();
        initializeCharactersManager();
        if (characterId === characterManager.currentCharacterId) {
            renderCharacterSheet();
        }
        alert('‚úÖ –ü–µ—Ä—Å–æ–Ω–∞–∂ —É–¥–∞–ª–µ–Ω!');
    }
}

function showClearAllPopup() {
    if (Object.keys(characterManager.characters).length === 0) {
        alert('–ù–µ—Ç –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è!');
        return;
    }

    if (confirm(`‚ùå –í–´ –£–í–ï–†–ï–ù–´?\n\n–≠—Ç–æ —É–¥–∞–ª–∏—Ç –í–°–ï–• –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π (${Object.keys(characterManager.characters).length} —à—Ç.)!\n–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!`)) {
        characterManager.characters = {};
        characterManager.currentCharacterId = null;
        characterManager.saveCharacters();
        location.reload();
    }
}

function exportSingleCharacter(characterId) {
    const character = characterManager.characters[characterId];
    const dataStr = JSON.stringify(character, null, 2);
    const dataBlob = new Blob([dataStr], { type: 'application/json' });
    
    const link = document.createElement('a');
    link.href = URL.createObjectURL(dataBlob);
    link.download = `character_${character.info.name || 'unknown'}.json`;
    link.click();
    
    alert(`‚úÖ –ü–µ—Ä—Å–æ–Ω–∞–∂ "${character.info.name}" —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω!`);
}

function exportAllCharacters() {
    if (Object.keys(characterManager.characters).length === 0) {
        alert('–ù–µ—Ç –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞!');
        return;
    }

    const dataStr = JSON.stringify(characterManager.characters, null, 2);
    const dataBlob = new Blob([dataStr], { type: 'application/json' });
    
    const link = document.createElement('a');
    link.href = URL.createObjectURL(dataBlob);
    link.download = `dnd_characters_backup_${new Date().toISOString().split('T')[0]}.json`;
    link.click();
    
    alert(`‚úÖ –í—Å–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∏ (${Object.keys(characterManager.characters).length} —à—Ç.) —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã!`);
}

function showImportCharacterPopup() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';
    
    input.onchange = function(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const characterData = JSON.parse(e.target.result);
                importCharacterData(characterData);
            } catch (error) {
                alert('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞!');
            }
        };
        reader.readAsText(file);
    };
    
    input.click();
}

function importCharacterData(characterData) {
    if (characterData.info && characterData.info.name) {
        // –û–¥–∏–Ω–æ—á–Ω—ã–π –ø–µ—Ä—Å–æ–Ω–∞–∂
        const newId = 'char_import_' + Date.now();
        characterManager.characters[newId] = characterData;
        characterManager.characters[newId].id = newId;
        characterManager.characters[newId].updatedAt = new Date().toISOString();
        
        characterManager.saveCharacters();
        initializeCharactersManager();
        alert(`‚úÖ –ü–µ—Ä—Å–æ–Ω–∞–∂ "${characterData.info.name}" –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω!`);
    } else {
        // –ù–µ—Å–∫–æ–ª—å–∫–æ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π
        let importedCount = 0;
        Object.values(characterData).forEach(char => {
            if (char.info && char.info.name) {
                const newId = 'char_import_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                characterManager.characters[newId] = char;
                characterManager.characters[newId].id = newId;
                characterManager.characters[newId].updatedAt = new Date().toISOString();
                importedCount++;
            }
        });
        
        characterManager.saveCharacters();
        initializeCharactersManager();
        alert(`‚úÖ –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ ${importedCount} –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π!`);
    }
}

function getTotalPlayTime() {
    const characters = Object.values(characterManager.characters);
    if (characters.length === 0) return '0—á';
    
    const totalMs = characters.reduce((total, char) => {
        const created = new Date(char.createdAt);
        const updated = new Date(char.updatedAt);
        return total + (updated - created);
    }, 0);
    
    const hours = Math.floor(totalMs / (1000 * 60 * 60));
    return hours > 0 ? `${hours}—á` : '<1—á';
}

function getHighestLevel() {
    const characters = Object.values(characterManager.characters);
    if (characters.length === 0) return '0';
    
    const maxLevel = Math.max(...characters.map(char => char.level.current));
    return maxLevel.toString();
}

// ========== –§–ò–ù–ê–õ–¨–ù–ê–Ø –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ==========

let diceTabInitialized = false;
let notesTabInitialized = false;
let charactersTabInitialized = false;

function openTab(tabName) {
    document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    document.getElementById(tabName + '-tab').classList.add('active');
    event.currentTarget.classList.add('active');
    
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –æ—Ç–∫—Ä—ã—Ç–∏–∏ –≤–∫–ª–∞–¥–æ–∫
    if (tabName === 'combat' && !combatTabInitialized) {
        initializeCombatSystem();
        combatTabInitialized = true;
    }
    
    if (tabName === 'inventory' && !inventoryTabInitialized) {
        initializeInventoryInterface();
        inventoryTabInitialized = true;
    }
    
    if (tabName === 'dice' && !diceTabInitialized) {
        initializeDiceSystem();
        diceTabInitialized = true;
    }
    
    if (tabName === 'notes' && !notesTabInitialized) {
        initializeNotesSystem();
        notesTabInitialized = true;
    }
    
    if (tabName === 'characters' && !charactersTabInitialized) {
        initializeCharactersManager();
        charactersTabInitialized = true;
    }
}

function initializeSystem() {
    console.log('üéÆ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è D&D —Å–∏—Å—Ç–µ–º—ã...');
    
    // –ï—Å–ª–∏ –Ω–µ—Ç –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π, —Å–æ–∑–¥–∞–µ–º –¥–µ–º–æ-–ø–µ—Ä—Å–æ–Ω–∞–∂–∞
    if (!currentCharacter && Object.keys(characterManager.characters).length === 0) {
        const demoChar = characterManager.createCharacter('–ù–æ–≤—ã–π –ì–µ—Ä–æ–π', 'human');
        currentCharacter = demoChar;
        
        // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∞—Ä—Ç–æ–≤—ã–π –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å
        const inventorySystem = new InventorySystem(currentCharacter);
        const starterKit = [
            itemTemplates.weapons.dagger,
            itemTemplates.armor.leather_armor,
            itemTemplates.misc.healing_potion,
            itemTemplates.misc.rope
        ];
        starterKit.forEach(item => inventorySystem.addItem(item));
        
        console.log('‚úÖ –°–æ–∑–¥–∞–Ω –¥–µ–º–æ-–ø–µ—Ä—Å–æ–Ω–∞–∂ —Å–æ —Å—Ç–∞—Ä—Ç–æ–≤—ã–º —Å–Ω–∞—Ä—è–∂–µ–Ω–∏–µ–º');
    }
    
    // –†–µ–Ω–¥–µ—Ä–∏–º –ª–∏—Å—Ç –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
    renderCharacterSheet();
    
    console.log(`‚úÖ –°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞! –ü–µ—Ä—Å–æ–Ω–∞–∂–µ–π: ${Object.keys(characterManager.characters).length}`);
}

// –ê–≤—Ç–æ–∑–∞–ø—É—Å–∫ —Å–∏—Å—Ç–µ–º—ã
document.addEventListener('DOMContentLoaded', initializeSystem);

// ========== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –£–¢–ò–õ–ò–¢–´ ==========

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏ - —Å–±—Ä–æ—Å –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö
function resetAllData() {
    if (confirm('‚ùå –í–´ –£–í–ï–†–ï–ù–´?\n\n–≠—Ç–æ —É–¥–∞–ª–∏—Ç –í–°–ï –¥–∞–Ω–Ω—ã–µ –≤—Å–µ—Ö –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π!\n–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å!')) {
        localStorage.clear();
        location.reload();
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫ —Ç–µ–∫—É—â–µ–º—É –ø–µ—Ä—Å–æ–Ω–∞–∂—É –≤ –∫–æ–Ω—Å–æ–ª–∏
window.getCurrentCharacter = function() {
    return currentCharacter;
};

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫ —Å–∏—Å—Ç–µ–º–µ –±–æ—è
window.getCombatSystem = function() {
    return combatSystem;
};

console.log(`üéâ D&D –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –ë–æ–µ–≤–∞—è –°–∏—Å—Ç–µ–º–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞!
–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:
- getCurrentCharacter() - –ø–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–µ–≥–æ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞
- getCombatSystem() - –ø–æ–ª—É—á–∏—Ç—å —Å–∏—Å—Ç–µ–º—É –±–æ—è
- resetAllData() - —Å–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ
`);            
