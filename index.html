<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D&D –†–∞—Å—à–∏—Ä–µ–Ω–Ω–∞—è –ë–æ–µ–≤–∞—è –°–∏—Å—Ç–µ–º–∞</title>
    <style>
        * { 
            box-sizing: border-box; 
            margin: 0; 
            padding: 0; 
        }
        
        body { 
            font-family: 'Times New Roman', serif; 
            background: #1a0f0b; 
            color: #e0d0c0; 
            min-height: 100vh;
            overflow-x: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .tabs {
            display: flex;
            background: linear-gradient(to bottom, #5a3928, #3d2418);
            border-bottom: 2px solid #8b4513;
            flex-wrap: wrap;
        }

        .tab-btn {
            flex: 1;
            min-width: 120px;
            padding: 15px 10px;
            border: none;
            background: transparent;
            color: #e0d0c0;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            border-right: 1px solid #8b4513;
            font-family: 'Times New Roman', serif;
        }

        .tab-btn:last-child { border-right: none; }
        .tab-btn.active { 
            background: #8b4513; 
            text-shadow: 0 0 5px #ffd700;
        }

        .tab-content { 
            display: none; 
            padding: 20px; 
            background: #2c1810;
            border: 2px solid #8b4513;
            border-top: none;
        }

        .tab-content.active { display: block; }

        .btn {
            padding: 12px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s;
            min-height: 44px;
            font-family: 'Times New Roman', serif;
        }

        .btn-plus { background: #27ae60; color: white; }
        .btn-minus { background: #c44536; color: white; }
        .btn-roll { background: #8b4513; color: white; }
        .btn-dice { background: #3498db; color: white; margin: 5px; }

        .section-title {
            font-size: 1.5em;
            color: #d4af37;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid #8b4513;
        }

        @media (max-width: 768px) {
            .tabs { flex-direction: column; }
            .tab-btn { min-width: 100%; }
            .container { padding: 10px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="tabs">
            <button class="tab-btn active" onclick="openTab('character')">üßô –ü–µ—Ä—Å–æ–Ω–∞–∂</button>
            <button class="tab-btn" onclick="openTab('combat')">‚öîÔ∏è –ë–æ–π</button>
            <button class="tab-btn" onclick="openTab('generator')">üé≤ –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä</button>
            <button class="tab-btn" onclick="openTab('inventory')">üéí –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</button>
            <button class="tab-btn" onclick="openTab('dice')">üé≤ –ö—É–±–∏–∫–∏</button>
            <button class="tab-btn" onclick="openTab('notes')">‚úçÔ∏è –ó–∞–º–µ—Ç–∫–∏</button>
            <button class="tab-btn" onclick="openTab('characters')">üë• –ü–µ—Ä—Å–æ–Ω–∞–∂–∏</button>
        </div>

        <div id="character-tab" class="tab-content active">
            <h2 class="section-title">üßô –õ–∏—Å—Ç –ø–µ—Ä—Å–æ–Ω–∞–∂–∞</h2>
        </div>

        <div id="combat-tab" class="tab-content">
            <h2 class="section-title">‚öîÔ∏è –ë–æ–µ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞</h2>
        </div>

        <div id="generator-tab" class="tab-content">
            <h2 class="section-title">üé≤ –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä—ã</h2>
        </div>

        <div id="inventory-tab" class="tab-content">
            <h2 class="section-title">üéí –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</h2>
        </div>

        <div id="dice-tab" class="tab-content">
            <h2 class="section-title">üé≤ –°–∏—Å—Ç–µ–º–∞ –∫—É–±–∏–∫–æ–≤</h2>
        </div>

        <div id="notes-tab" class="tab-content">
            <h2 class="section-title">‚úçÔ∏è –ó–∞–º–µ—Ç–∫–∏</h2>
        </div>

        <div id="characters-tab" class="tab-content">
            <h2 class="section-title">üë• –ú–µ–Ω–µ–¥–∂–µ—Ä –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π</h2>
        </div>
    </div>
    <script>
// ========== –ë–ê–ó–û–í–´–ï –§–£–ù–ö–¶–ò–ò –î–õ–Ø –í–ö–õ–ê–î–û–ö ==========
function openTab(tabName) {
    document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    document.getElementById(tabName + '-tab').classList.add('active');
    event.currentTarget.classList.add('active');
}

// ========== –ë–ê–ó–û–í–´–ï –°–ò–°–¢–ï–ú–´ –ò –ö–û–ù–°–¢–ê–ù–¢–´ ==========
const races = {
    atski: { name: "üî• –ê—Ü–∫–∏", description: "50% –∑–∞—â–∏—Ç–∞ –æ—Ç –æ–≥–Ω—è", lifespan: "350 –ª–µ—Ç" },
    knofi: { name: "üó£Ô∏è –ö–Ω–æ—Ñ—ã", description: "+1 –∫ –∫—Ä–∞—Å–Ω–æ—Ä–µ—á–∏—é", lifespan: "400 –ª–µ—Ç" },
    vorki: { name: "‚ùÑÔ∏è –í–æ—Ä–∫–∏", description: "50% –∑–∞—â–∏—Ç–∞ –æ—Ç –ª—å–¥–∞", lifespan: "250 –ª–µ—Ç" },
    minci: { name: "üéØ –ú–∏–Ω—Ü—ã", description: "+1 –∫ –¥—Ä–µ–≤–∫–æ–≤–æ–º—É", lifespan: "350 –ª–µ—Ç" },
    kaei: { name: "‚öíÔ∏è –ö–∞—ç–π—Ü—ã", description: "–ú–∞–≥–∏—è –º–µ—Ç–∞–ª–ª–∞", lifespan: "300 –ª–µ—Ç" },
    forest_elf: { name: "üåø –õ–µ—Å–Ω—ã–µ —ç–ª—å—Ñ—ã", description: "–ú–∞–≥–∏—è –ø—Ä–∏—Ä–æ–¥—ã", lifespan: "700 –ª–µ—Ç" },
    high_elf: { name: "‚ú® –í—ã—Å—à–∏–µ —ç–ª—å—Ñ—ã", description: "–î–≤–µ —Å—Ç–∏—Ö–∏–∏", lifespan: "2000 –ª–µ—Ç" },
    dark_elf: { name: "üåë –¢–µ–º–Ω—ã–µ —ç–ª—å—Ñ—ã", description: "–ú–∞–≥–∏—è —Ç—å–º—ã", lifespan: "700 –ª–µ—Ç" },
    dwarf: { name: "‚õ∞Ô∏è –î–≤–∞—Ä—Ñ—ã", description: "–ö—É–∑–Ω–µ—á–Ω–æ–µ –¥–µ–ª–æ", lifespan: "600 –ª–µ—Ç" },
    gnome: { name: "üîÆ –ì–Ω–æ–º—ã", description: "–†–µ–º–µ—Å–ª–æ", lifespan: "800 –ª–µ—Ç" },
    orc: { name: "üíÄ –û—Ä–∫–∏", description: "–¢—è–∂–µ–ª–∞—è –±—Ä–æ–Ω—è", lifespan: "400 –ª–µ—Ç" },
    goblin: { name: "üëπ –ì–æ–±–ª–∏–Ω—ã", description: "–ë—ã—Å—Ç—Ä–æ–µ –æ–±—É—á–µ–Ω–∏–µ", lifespan: "25 –ª–µ—Ç" }
};

const skillsStructure = {
    "‚öîÔ∏è –ë–û–ï–í–´–ï –ù–ê–í–´–ö–ò": [
        "–¢—è–∂—ë–ª–∞—è –±—Ä–æ–Ω—è", "–õ—ë–≥–∫–∞—è –±—Ä–æ–Ω—è", "–î–≤—É—Ä—É—á–Ω–æ–µ –æ—Ä—É–∂–∏–µ", 
        "–û–¥–Ω–æ—Ä—É—á–Ω–æ–µ –æ—Ä—É–∂–∏–µ", "–°—Ç—Ä–µ–ª—å–±–∞", "–ë–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∏–µ", 
        "–î—Ä–µ–≤–∫–æ–≤–æ–µ", "–†—É–∫–æ–ø–∞—à–Ω—ã–π –±–æ–π", "–ú–µ—Ç–∞–Ω–∏–µ"
    ],
    "üé≠ –û–ë–©–ò–ï –ù–ê–í–´–ö–ò": [
        "–°–∫—Ä—ã—Ç–Ω–æ—Å—Ç—å", "–ö—Ä–∞—Å–Ω–æ—Ä–µ—á–∏—é", "–õ–æ–≤–∫–æ—Å—Ç—å", "–í—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å",
        "–í–∑–ª–æ–º", "–í–æ—Å–ø—Ä–∏—è—Ç–∏–µ", "–£–¥–∞—á–∞", "–ö–∞—Ä–º–∞–Ω–Ω—ã–µ –∫—Ä–∞–∂–∏"
    ],
    "‚öóÔ∏è –†–ï–ú–ï–°–õ–ê": [
        "–ê–ª—Ö–∏–º–∏—è", "–ö—É–∑–Ω–µ—á–Ω–æ–µ –¥–µ–ª–æ", "–ó–∞—á–∞—Ä–æ–≤–∞–Ω–∏–µ", "–†–µ–º–µ—Å–ª–æ"
    ],
    "üîÆ –ú–ê–ì–ò–Ø": [
        "–ú–∞–≥–∏—è –≤–æ–¥—ã", "–ú–∞–≥–∏—è –∑–µ–º–ª–∏", "–ú–∞–≥–∏—è –≤–æ–∑–¥—É—Ö–∞", "–ú–∞–≥–∏—è –∫—Ä–æ–≤–∏",
        "–ú–∞–≥–∏—è –æ–≥–Ω—è", "–ú–∞–≥–∏—è –º–µ—Ç–∞–ª–ª–∞", "–ú–∞–≥–∏—è –ø—Ä–∏—Ä–æ–¥—ã", "–ú–∞–≥–∏—è —Å–≤–µ—Ç–∞",
        "–ú–∞–≥–∏—è —Ç—å–º—ã", "–ú–∞–≥–∏—è –∏–Ω—Ñ–µ—Ä–Ω–æ", "–ú–∞–≥–∏—è —Ö–∞–æ—Å–∞", "–ú–∞–≥–∏—è —Ä–∞–∑—É–º–∞",
        "–ú–∞–≥–∏—è –ñ–∏–∑–Ω–∏", "–ú–∞–≥–∏—è —Å–º–µ—Ä—Ç–∏", "–ú–∞–≥–∏—è –ø—É—Å—Ç–æ—Ç—ã", "–ú–∞–≥–∏—è –≠–Ω–µ—Ä–≥–∏–∏"
    ]
};

const levelTable = {
    0: { expRequired: 1000, hp: 100, mana: 100, stamina: 100, points: 20 },
    1: { expRequired: 3000, hp: 200, mana: 200, stamina: 200, points: 30 },
    2: { expRequired: 5000, hp: 300, mana: 300, stamina: 300, points: 40 },
    3: { expRequired: 8000, hp: 400, mana: 400, stamina: 400, points: 50 },
    4: { expRequired: 12000, hp: 500, mana: 500, stamina: 500, points: 60 },
    5: { expRequired: 16000, hp: 600, mana: 600, stamina: 600, points: 70 },
    6: { expRequired: 20000, hp: 700, mana: 700, stamina: 700, points: 80 },
    7: { expRequired: 25000, hp: 800, mana: 800, stamina: 800, points: 90 },
    8: { expRequired: 30000, hp: 900, mana: 900, stamina: 900, points: 100 },
    9: { expRequired: 100000, hp: 1000, mana: 1000, stamina: 1000, points: 200 }
};

// ========== –°–ò–°–¢–ï–ú–ê –ö–£–ë–ò–ö–û–í ==========
function rollDice(sides, count = 1) {
    let results = [];
    let total = 0;
    
    for (let i = 0; i < count; i++) {
        const result = Math.floor(Math.random() * sides) + 1;
        results.push(result);
        total += result;
    }
    
    return { results, total };
}

function roll3d6() {
    return rollDice(6, 3);
}

function rollSkillCheck(skillValue, modifiers = 0) {
    const roll = roll3d6();
    const totalRoll = roll.total + modifiers;
    const success = totalRoll <= skillValue;
    const successes = success ? Math.max(0, skillValue - totalRoll) : 0;
    
    return {
        roll: roll.results,
        total: totalRoll,
        success: success,
        successes: successes,
        critical: roll.total === 3 ? 'success' : (roll.total === 18 ? 'failure' : 'normal')
    };
}

// ========== –°–ò–°–¢–ï–ú–ê –•–†–ê–ù–ï–ù–ò–Ø –î–ê–ù–ù–´–• ==========
class StorageSystem {
    static set(key, value) {
        try {
            localStorage.setItem(key, JSON.stringify(value));
            return true;
        } catch (e) {
            console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', e);
            return false;
        }
    }

    static get(key, defaultValue = null) {
        try {
            const item = localStorage.getItem(key);
            return item ? JSON.parse(item) : defaultValue;
        } catch (e) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', e);
            return defaultValue;
        }
    }

    static remove(key) {
        try {
            localStorage.removeItem(key);
            return true;
        } catch (e) {
            console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è:', e);
            return false;
        }
    }
}

// ========== –ë–ê–ó–û–í–´–ô –ö–õ–ê–°–° –ü–ï–†–°–û–ù–ê–ñ–ê ==========
class Character {
    constructor(id = null) {
        this.id = id || 'char_' + Date.now();
        this.info = {
            name: '',
            surname: '',
            title: '',
            race: '',
            heritage: '',
            height: '',
            weight: '',
            age: ''
        };
        this.level = {
            current: 0,
            exp: 0
        };
        this.stats = {
            health: 100,
            maxHealth: 100,
            mana: 100,
            maxMana: 100,
            stamina: 100,
            maxStamina: 100,
            freePoints: 0
        };
        this.skills = {};
        this.lockedSkills = {};
        this.availableMagicSchools = {};
        this.inventory = {
            weapons: [], armor: [], potions: [], scrolls: [],
            resources: [], valuables: [], tools: [], other: []
        };
        this.customCategories = [];
        this.notes = [];
        this.createdAt = new Date().toISOString();
        this.updatedAt = new Date().toISOString();
        
        this.initializeSkills();
    }

    initializeSkills() {
        Object.values(skillsStructure).forEach(skillGroup => {
            skillGroup.forEach(skill => {
                this.skills[skill] = 5;
            });
        });
    }

    getSkillValue(skillName) {
        return this.skills[skillName] || 5;
    }

    setSkillValue(skillName, value) {
        this.skills[skillName] = value;
        this.updatedAt = new Date().toISOString();
    }

    addExperience(exp) {
        this.level.exp += exp;
        this.checkLevelUp();
        this.updatedAt = new Date().toISOString();
    }

    checkLevelUp() {
        if (this.level.current >= 9) return;

        const requiredExp = levelTable[this.level.current].expRequired;
        if (this.level.exp >= requiredExp) {
            this.level.current++;
            const levelData = levelTable[this.level.current];
            
            this.stats.maxHealth += levelData.hp;
            this.stats.maxMana += levelData.mana;
            this.stats.maxStamina += levelData.stamina;
            this.stats.freePoints += levelData.points;
            
            this.stats.health = this.stats.maxHealth;
            this.stats.mana = this.stats.maxMana;
            this.stats.stamina = this.stats.maxStamina;
            
            this.level.exp -= requiredExp;
            
            console.log(`üéâ –£—Ä–æ–≤–µ–Ω—å –ø–æ–≤—ã—à–µ–Ω –¥–æ ${this.level.current}!`);
        }
    }

    save() {
        return StorageSystem.set(`character_${this.id}`, this);
    }

    static load(characterId) {
        const data = StorageSystem.get(`character_${characterId}`);
        if (!data) return null;
        
        const character = new Character();
        Object.assign(character, data);
        return character;
    }
}

// ========== –°–ò–°–¢–ï–ú–ê –£–ü–†–ê–í–õ–ï–ù–ò–Ø –ü–ï–†–°–û–ù–ê–ñ–ê–ú–ò ==========
class CharacterManager {
    constructor() {
        this.characters = {};
        this.currentCharacterId = null;
        this.loadCharacters();
    }

    loadCharacters() {
        this.characters = StorageSystem.get('dnd_characters', {});
        this.currentCharacterId = StorageSystem.get('current_character_id');
    }

    saveCharacters() {
        StorageSystem.set('dnd_characters', this.characters);
        StorageSystem.set('current_character_id', this.currentCharacterId);
    }

    createCharacter(name, race) {
        const character = new Character();
        character.info.name = name;
        character.info.race = race;
        
        this.characters[character.id] = character;
        this.currentCharacterId = character.id;
        this.saveCharacters();
        
        return character;
    }

    getCurrentCharacter() {
        if (!this.currentCharacterId || !this.characters[this.currentCharacterId]) {
            return null;
        }
        return this.characters[this.currentCharacterId];
    }

    switchCharacter(characterId) {
        if (this.characters[characterId]) {
            this.currentCharacterId = characterId;
            this.saveCharacters();
            return true;
        }
        return false;
    }

    deleteCharacter(characterId) {
        if (this.characters[characterId]) {
            delete this.characters[characterId];
            
            if (this.currentCharacterId === characterId) {
                const remainingIds = Object.keys(this.characters);
                this.currentCharacterId = remainingIds.length > 0 ? remainingIds[0] : null;
            }
            
            this.saveCharacters();
            return true;
        }
        return false;
    }
}

// ========== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ==========
let characterManager = new CharacterManager();
let currentCharacter = characterManager.getCurrentCharacter();

// ========== –£–¢–ò–õ–ò–¢–´ ==========
function showPopup(title, content, buttons = []) {
    const popup = document.createElement('div');
    popup.className = 'popup';
    popup.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
        background: rgba(26, 15, 11, 0.95); display: flex; 
        justify-content: center; align-items: center; z-index: 1000;
    `;
    
    let buttonsHTML = '';
    if (buttons.length > 0) {
        buttonsHTML = `<div style="display: flex; gap: 10px; margin-top: 20px;">${buttons.join('')}</div>`;
    }
    
    popup.innerHTML = `
        <div class="popup-content" style="background: #2c1810; padding: 25px; border-radius: 8px; 
               max-width: 95%; width: 500px; border: 3px solid #8b4513;">
            <h2 style="color: #d4af37; margin-bottom: 15px;">${title}</h2>
            <div>${content}</div>
            ${buttonsHTML}
        </div>
    `;
    
    document.body.appendChild(popup);
    return popup;
}

function closePopup(popup) {
    if (popup && popup.parentNode) {
        popup.parentNode.removeChild(popup);
    }
}
</script>
<script>
// ========== –°–ò–°–¢–ï–ú–ê –û–¢–û–ë–†–ê–ñ–ï–ù–ò–Ø –ü–ï–†–°–û–ù–ê–ñ–ê ==========
function renderCharacterSheet() {
    const container = document.getElementById('character-tab');
    if (!container || !currentCharacter) return;

    container.innerHTML = `
        <div class="header" style="background: linear-gradient(to bottom, #3d2418, #2c1810); 
              color: #e0d0c0; padding: 25px; text-align: center; border-bottom: 3px solid #8b4513;">
            <h1 style="font-size: 2.2em; color: #d4af37; margin-bottom: 20px;">‚öîÔ∏è D&D Character Sheet</h1>
            
            <div class="character-info" style="display: flex; gap: 15px; margin-bottom: 15px; flex-wrap: wrap; justify-content: center;">
                <div class="input-group" style="flex: 1; min-width: 200px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: bold; color: #d4af37;">–ò–º—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞:</label>
                    <input type="text" id="characterName" value="${currentCharacter.info.name}" 
                           placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è" style="width: 100%; padding: 12px; border: 2px solid #8b4513; 
                           border-radius: 4px; font-size: 16px; background: #1a0f0b; color: #e0d0c0;">
                </div>
                <div class="input-group" style="flex: 1; min-width: 200px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: bold; color: #d4af37;">–§–∞–º–∏–ª–∏—è:</label>
                    <input type="text" id="characterSurname" value="${currentCharacter.info.surname}" 
                           placeholder="–í–≤–µ–¥–∏—Ç–µ —Ñ–∞–º–∏–ª–∏—é" style="width: 100%; padding: 12px; border: 2px solid #8b4513; 
                           border-radius: 4px; font-size: 16px; background: #1a0f0b; color: #e0d0c0;">
                </div>
                <div class="input-group" style="flex: 1; min-width: 200px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: bold; color: #d4af37;">–¢–∏—Ç—É–ª:</label>
                    <input type="text" id="characterTitle" value="${currentCharacter.info.title}" 
                           placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–∏—Ç—É–ª" style="width: 100%; padding: 12px; border: 2px solid #8b4513; 
                           border-radius: 4px; font-size: 16px; background: #1a0f0b; color: #e0d0c0;">
                </div>
            </div>

            <div class="character-info" style="display: flex; gap: 15px; margin-bottom: 15px; flex-wrap: wrap; justify-content: center;">
                <div class="input-group" style="flex: 1; min-width: 200px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: bold; color: #d4af37;">–†–∞—Å–∞:</label>
                    <select id="characterRace" style="width: 100%; padding: 12px; border: 2px solid #8b4513; 
                            border-radius: 4px; background: #1a0f0b; color: #e0d0c0;">
                        <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞—Å—É</option>
                        ${Object.entries(races).map(([id, race]) => 
                            `<option value="${id}" ${currentCharacter.info.race === id ? 'selected' : ''}>${race.name}</option>`
                        ).join('')}
                    </select>
                </div>
                <div class="input-group" style="flex: 1; min-width: 200px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: bold; color: #d4af37;">–ù–∞—Å–ª–µ–¥–∏–µ:</label>
                    <input type="text" id="characterHeritage" value="${currentCharacter.info.heritage}" 
                           placeholder="–û—Å–æ–±–æ–µ –Ω–∞—Å–ª–µ–¥–∏–µ" style="width: 100%; padding: 12px; border: 2px solid #8b4513; 
                           border-radius: 4px; font-size: 16px; background: #1a0f0b; color: #e0d0c0;">
                </div>
            </div>

            <div class="character-info" style="display: flex; gap: 15px; margin-bottom: 15px; flex-wrap: wrap; justify-content: center;">
                <div class="input-group" style="flex: 1; min-width: 200px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: bold; color: #d4af37;">–†–æ—Å—Ç (—Å–º):</label>
                    <input type="number" id="characterHeight" value="${currentCharacter.info.height}" 
                           style="width: 100%; padding: 12px; border: 2px solid #8b4513; border-radius: 4px; 
                           font-size: 16px; background: #1a0f0b; color: #e0d0c0;">
                </div>
                <div class="input-group" style="flex: 1; min-width: 200px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: bold; color: #d4af37;">–í–µ—Å (–∫–≥):</label>
                    <input type="number" id="characterWeight" value="${currentCharacter.info.weight}" 
                           placeholder="–í–µ—Å" style="width: 100%; padding: 12px; border: 2px solid #8b4513; 
                           border-radius: 4px; font-size: 16px; background: #1a0f0b; color: #e0d0c0;">
                </div>
                <div class="input-group" style="flex: 1; min-width: 200px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: bold; color: #d4af37;">–í–æ–∑—Ä–∞—Å—Ç (–ª–µ—Ç):</label>
                    <input type="number" id="characterAge" value="${currentCharacter.info.age}" 
                           placeholder="–í–æ–∑—Ä–∞—Å—Ç" style="width: 100%; padding: 12px; border: 2px solid #8b4513; 
                           border-radius: 4px; font-size: 16px; background: #1a0f0b; color: #e0d0c0;">
                </div>
            </div>
        </div>

        <div class="level-system" style="background: #3d2418; padding: 20px; border-bottom: 2px solid #8b4513;">
            <div class="level-display" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <div class="level-info" style="font-size: 1.3em; font-weight: bold; color: #d4af37; display: flex; align-items: center; gap: 10px;">
                    –£—Ä–æ–≤–µ–Ω—å: <span id="currentLevel">${currentCharacter.level.current}</span>
                    <button class="btn btn-roll" onclick="editLevel()">‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å</button>
                    <button class="btn btn-roll" onclick="showLevelsTable()">üìä –¢–∞–±–ª–∏—Ü–∞</button>
                </div>
                <div class="exp-display" style="display: flex; align-items: center; gap: 10px;">
                    <input type="number" id="currentExp" class="exp-input" value="${currentCharacter.level.exp}" 
                           style="width: 120px; padding: 10px; border: 2px solid #8b4513; border-radius: 4px; 
                           font-size: 16px; text-align: center; background: #1a0f0b; color: #e0d0c0;">
                    <span style="color: #d4af37; font-weight: bold;">/ 
                        <span id="requiredExp">${currentCharacter.level.current < 9 ? levelTable[currentCharacter.level.current].expRequired : 'MAX'}</span> XP
                    </span>
                    <button class="btn btn-plus" onclick="addExperience()">‚ûï –û–ø—ã—Ç</button>
                    <button class="btn btn-roll" id="convertBtn" onclick="convertExpToPoints()" 
                            style="${currentCharacter.level.current >= 9 ? '' : 'display: none;'}">üíé –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                </div>
            </div>
        </div>

        <div class="stats-panel" style="padding: 20px; background: #2c1810; border-bottom: 2px solid #5a3928;">
            <div class="stat-row" style="display: flex; align-items: center; padding: 12px 0; gap: 15px; border-bottom: 1px solid #3d2418;">
                <div class="stat-label" style="flex: 1; font-weight: bold; display: flex; align-items: center; gap: 10px; color: #d4af37;">
                    ‚ù§Ô∏è –ó–¥–æ—Ä–æ–≤—å–µ:
                </div>
                <input type="number" class="stat-input" id="health" value="${currentCharacter.stats.health}" 
                       style="width: 100px; padding: 10px; border: 2px solid #8b4513; border-radius: 4px; 
                       text-align: center; font-size: 16px; background: #1a0f0b; color: #e0d0c0;">
                <button class="btn btn-minus" onclick="changeStat('health', -5)">-5</button>
                <button class="btn btn-plus" onclick="changeStat('health', 5)">+5</button>
            </div>
            <div class="stat-row" style="display: flex; align-items: center; padding: 12px 0; gap: 15px; border-bottom: 1px solid #3d2418;">
                <div class="stat-label" style="flex: 1; font-weight: bold; display: flex; align-items: center; gap: 10px; color: #d4af37;">
                    üîÆ –ú–∞–Ω–∞:
                </div>
                <input type="number" class="stat-input" id="mana" value="${currentCharacter.stats.mana}" 
                       style="width: 100px; padding: 10px; border: 2px solid #8b4513; border-radius: 4px; 
                       text-align: center; font-size: 16px; background: #1a0f0b; color: #e0d0c0;">
                <button class="btn btn-minus" onclick="changeStat('mana', -5)">-5</button>
                <button class="btn btn-plus" onclick="changeStat('mana', 5)">+5</button>
            </div>
            <div class="stat-row" style="display: flex; align-items: center; padding: 12px 0; gap: 15px;">
                <div class="stat-label" style="flex: 1; font-weight: bold; display: flex; align-items: center; gap: 10px; color: #d4af37;">
                    ‚ö° –í—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å:
                </div>
                <input type="number" class="stat-input" id="stamina" value="${currentCharacter.stats.stamina}" 
                       style="width: 100px; padding: 10px; border: 2px solid #8b4513; border-radius: 4px; 
                       text-align: center; font-size: 16px; background: #1a0f0b; color: #e0d0c0;">
                <button class="btn btn-minus" onclick="changeStat('stamina', -5)">-5</button>
                <button class="btn btn-plus" onclick="changeStat('stamina', 5)">+5</button>
            </div>
        </div>

        <div class="points-panel" style="padding: 20px; background: #3d2418; border-bottom: 2px solid #8b4513;">
            <div class="points-display" style="display: flex; align-items: center; justify-content: center; gap: 15px;">
                <span style="font-size: 1.3em; font-weight: bold; color: #d4af37;">–°–≤–æ–±–æ–¥–Ω—ã–µ –æ—á–∫–∏ –Ω–∞–≤—ã–∫–æ–≤:</span>
                <input type="number" id="freePoints" class="stat-input" value="${currentCharacter.stats.freePoints}" 
                       style="width: 100px; padding: 10px; border: 2px solid #8b4513; border-radius: 4px; 
                       text-align: center; font-size: 16px; background: #1a0f0b; color: #e0d0c0;">
                <button class="btn btn-roll" onclick="editFreePoints()">‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å</button>
            </div>
        </div>

        <div id="skillsContainer"></div>

        <div class="export-import" style="display: flex; gap: 10px; justify-content: center; margin: 20px 0; flex-wrap: wrap;">
            <button class="btn btn-plus" onclick="exportCharacter()">üíæ –≠–∫—Å–ø–æ—Ä—Ç –ø–µ—Ä—Å–æ–Ω–∞–∂–∞</button>
            <button class="btn btn-roll" onclick="importCharacter()">üì• –ò–º–ø–æ—Ä—Ç –ø–µ—Ä—Å–æ–Ω–∞–∂–∞</button>
        </div>
    `;

    setupCharacterEventListeners();
    renderSkills();
}

function setupCharacterEventListeners() {
    const inputs = ['characterName', 'characterSurname', 'characterTitle', 'characterRace', 
                   'characterHeritage', 'characterHeight', 'characterWeight', 'characterAge',
                   'health', 'mana', 'stamina', 'freePoints', 'currentExp'];
    
    inputs.forEach(inputId => {
        const element = document.getElementById(inputId);
        if (element) {
            element.addEventListener('change', saveCharacterData);
            element.addEventListener('input', saveCharacterData);
        }
    });
}

function saveCharacterData() {
    if (!currentCharacter) return;

    currentCharacter.info.name = document.getElementById('characterName').value;
    currentCharacter.info.surname = document.getElementById('characterSurname').value;
    currentCharacter.info.title = document.getElementById('characterTitle').value;
    currentCharacter.info.race = document.getElementById('characterRace').value;
    currentCharacter.info.heritage = document.getElementById('characterHeritage').value;
    currentCharacter.info.height = document.getElementById('characterHeight').value;
    currentCharacter.info.weight = document.getElementById('characterWeight').value;
    currentCharacter.info.age = document.getElementById('characterAge').value;

    currentCharacter.stats.health = parseInt(document.getElementById('health').value) || 0;
    currentCharacter.stats.mana = parseInt(document.getElementById('mana').value) || 0;
    currentCharacter.stats.stamina = parseInt(document.getElementById('stamina').value) || 0;
    currentCharacter.stats.freePoints = parseInt(document.getElementById('freePoints').value) || 0;

    currentCharacter.level.exp = parseInt(document.getElementById('currentExp').value) || 0;
    currentCharacter.checkLevelUp();

    updateLevelDisplay();
    currentCharacter.save();
    characterManager.saveCharacters();
}

// ========== –°–ò–°–¢–ï–ú–ê –ù–ê–í–´–ö–û–í ==========
function renderSkills() {
    const container = document.getElementById('skillsContainer');
    if (!container || !currentCharacter) return;

    let skillsHTML = '';

    for (const [groupName, skills] of Object.entries(skillsStructure)) {
        skillsHTML += `
            <div class="skills-section" style="padding: 25px; border-bottom: 2px solid #5a3928;">
                <div class="section-title">${groupName}</div>
        `;

        skills.forEach(skill => {
            const skillValue = currentCharacter.getSkillValue(skill);
            const isLocked = currentCharacter.lockedSkills[skill] || false;
            const lockBtnText = isLocked ? 'üîì' : 'üîí';
            const lockBtnClass = isLocked ? 'btn-lock locked' : 'btn-lock';

            skillsHTML += `
                <div class="skill-row" style="display: flex; align-items: center; padding: 15px 0; border-bottom: 1px solid #3d2418;
                      ${isLocked ? 'opacity: 0.6; color: #8b7d6b; background: #3d2418;' : ''}">
                    <div class="skill-name" style="flex: 2; font-weight: 500; display: flex; align-items: center; gap: 12px;">
                        <span>üéØ</span>
                        <span>${skill}</span>
                        ${groupName === "üîÆ –ú–ê–ì–ò–Ø" ? `<span class="spell-icon" onclick="showSpells('${skill}')" title="–ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∑–∞–∫–ª–∏–Ω–∞–Ω–∏—è" style="cursor: pointer; margin-left: 10px; font-size: 1.2em;">üîÆ</span>` : ''}
                    </div>
                    <div class="skill-controls" style="flex: 1; display: flex; align-items: center; justify-content: flex-end; gap: 12px;">
                        <button class="btn btn-minus" onclick="decreaseSkill('${skill}')" 
                                ${isLocked || skillValue <= 5 ? 'disabled' : ''}>-</button>
                        <span class="skill-value" style="font-size: 1.3em; font-weight: bold; color: #d4af37; min-width: 40px; text-align: center;">
                            ${skillValue}
                        </span>
                        <button class="btn btn-plus" onclick="increaseSkill('${skill}')" 
                                ${isLocked || currentCharacter.stats.freePoints <= 0 ? 'disabled' : ''}>+</button>
                        <button class="btn ${lockBtnClass}" onclick="toggleSkillLock('${skill}')" 
                                style="background: #95a5a6; color: white; padding: 10px 12px; ${isLocked ? 'background: #e74c3c;' : ''}">
                            ${lockBtnText}
                        </button>
                        <button class="btn btn-roll" onclick="rollSkill('${skill}')" ${isLocked ? 'disabled' : ''}>–ë—Ä–æ—Å–æ–∫</button>
                    </div>
                </div>
            `;
        });

        skillsHTML += `</div>`;
    }

    container.innerHTML = skillsHTML;
}

function increaseSkill(skillName) {
    if (!currentCharacter) return;

    const isLocked = currentCharacter.lockedSkills[skillName];
    if (isLocked) {
        alert('‚ùå –≠—Ç–æ—Ç –Ω–∞–≤—ã–∫ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω!');
        return;
    }

    if (currentCharacter.stats.freePoints > 0) {
        const currentValue = currentCharacter.getSkillValue(skillName);
        currentCharacter.setSkillValue(skillName, currentValue + 1);
        currentCharacter.stats.freePoints--;
        currentCharacter.save();
        renderSkills();
        updateUI();
    }
}

function decreaseSkill(skillName) {
    if (!currentCharacter) return;

    const isLocked = currentCharacter.lockedSkills[skillName];
    if (isLocked) {
        alert('‚ùå –≠—Ç–æ—Ç –Ω–∞–≤—ã–∫ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω!');
        return;
    }

    const currentValue = currentCharacter.getSkillValue(skillName);
    if (currentValue > 5) {
        currentCharacter.setSkillValue(skillName, currentValue - 1);
        currentCharacter.stats.freePoints++;
        currentCharacter.save();
        renderSkills();
        updateUI();
    }
}

function toggleSkillLock(skillName) {
    if (!currentCharacter) return;

    const currentlyLocked = currentCharacter.lockedSkills[skillName] || false;
    
    if (currentlyLocked) {
        const unlock = confirm(`üîì –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –Ω–∞–≤—ã–∫ "${skillName}"?`);
        if (unlock) {
            currentCharacter.lockedSkills[skillName] = false;
            currentCharacter.save();
            renderSkills();
            alert(`‚úÖ –ù–∞–≤—ã–∫ "${skillName}" —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω!`);
        }
    } else {
        const lock = confirm(`üîí –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –Ω–∞–≤—ã–∫ "${skillName}"?`);
        if (lock) {
            currentCharacter.lockedSkills[skillName] = true;
            currentCharacter.save();
            renderSkills();
            alert(`‚úÖ –ù–∞–≤—ã–∫ "${skillName}" –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω!`);
        }
    }
}
</script>
<script>
// ========== –§–£–ù–ö–¶–ò–ò –£–ü–†–ê–í–õ–ï–ù–ò–Ø –£–†–û–í–ù–ï–ú –ò –°–¢–ê–¢–ê–ú–ò ==========
function editLevel() {
    if (!currentCharacter) return;
    
    const newLevel = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π —É—Ä–æ–≤–µ–Ω—å (0-9):', currentCharacter.level.current);
    if (newLevel && !isNaN(newLevel) && newLevel >= 0 && newLevel <= 9) {
        currentCharacter.level.current = parseInt(newLevel);
        updateStatsForLevel();
        updateLevelDisplay();
        currentCharacter.save();
    }
}

function updateStatsForLevel() {
    if (!currentCharacter) return;
    
    let totalHP = 100, totalMana = 100, totalStamina = 100;
    
    for (let i = 0; i <= currentCharacter.level.current; i++) {
        totalHP += levelTable[i].hp;
        totalMana += levelTable[i].mana;
        totalStamina += levelTable[i].stamina;
    }
    
    currentCharacter.stats.maxHealth = totalHP;
    currentCharacter.stats.maxMana = totalMana;
    currentCharacter.stats.maxStamina = totalStamina;
    currentCharacter.stats.health = totalHP;
    currentCharacter.stats.mana = totalMana;
    currentCharacter.stats.stamina = totalStamina;
}

function addExperience() {
    if (!currentCharacter) return;
    
    const expToAdd = prompt('–°–∫–æ–ª—å–∫–æ –æ–ø—ã—Ç–∞ –¥–æ–±–∞–≤–∏—Ç—å?');
    if (expToAdd && !isNaN(expToAdd)) {
        currentCharacter.addExperience(parseInt(expToAdd));
        updateLevelDisplay();
        renderCharacterSheet();
    }
}

function convertExpToPoints() {
    if (!currentCharacter || currentCharacter.level.current < 9) return;
    
    const currentExp = currentCharacter.level.exp;
    const availablePoints = Math.floor(currentExp / 1000);
    
    if (availablePoints > 0) {
        currentCharacter.level.exp -= availablePoints * 1000;
        currentCharacter.stats.freePoints += availablePoints;
        currentCharacter.save();
        
        alert(`üíé –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ ${availablePoints} –æ—á–∫–æ–≤ –Ω–∞–≤—ã–∫–æ–≤!`);
        updateLevelDisplay();
        renderCharacterSheet();
    }
}

function updateLevelDisplay() {
    if (!currentCharacter) return;
    
    const levelElement = document.getElementById('currentLevel');
    const expElement = document.getElementById('currentExp');
    const requiredElement = document.getElementById('requiredExp');
    const convertBtn = document.getElementById('convertBtn');
    
    if (levelElement) levelElement.textContent = currentCharacter.level.current;
    if (expElement) expElement.value = currentCharacter.level.exp;
    
    if (currentCharacter.level.current < 9) {
        if (requiredElement) requiredElement.textContent = levelTable[currentCharacter.level.current].expRequired;
        if (convertBtn) convertBtn.style.display = 'none';
    } else {
        if (requiredElement) requiredElement.textContent = 'MAX';
        if (convertBtn) convertBtn.style.display = 'block';
    }
}

function changeStat(stat, value) {
    if (!currentCharacter) return;
    
    const input = document.getElementById(stat);
    let currentValue = parseInt(input.value) || 0;
    let newValue = currentValue + value;
    
    if (newValue < 0) newValue = 0;
    if (newValue > currentCharacter.stats['max' + stat.charAt(0).toUpperCase() + stat.slice(1)]) {
        newValue = currentCharacter.stats['max' + stat.charAt(0).toUpperCase() + stat.slice(1)];
    }
    
    input.value = newValue;
    currentCharacter.stats[stat] = newValue;
    currentCharacter.save();
}

function editFreePoints() {
    if (!currentCharacter) return;
    
    const newPoints = prompt('–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–≤–æ–±–æ–¥–Ω—ã—Ö –æ—á–∫–æ–≤:', currentCharacter.stats.freePoints);
    if (newPoints && !isNaN(newPoints)) {
        currentCharacter.stats.freePoints = parseInt(newPoints);
        currentCharacter.save();
        renderCharacterSheet();
    }
}

function updateUI() {
    if (!currentCharacter) return;
    
    const freePointsElement = document.getElementById('freePoints');
    if (freePointsElement) {
        freePointsElement.value = currentCharacter.stats.freePoints;
    }
}

// ========== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ==========
function showLevelsTable() {
    if (!currentCharacter) return;
    
    let tableHTML = `
        <h3 style="color: #d4af37; margin-bottom: 15px;">üìä –¢–∞–±–ª–∏—Ü–∞ —É—Ä–æ–≤–Ω–µ–π</h3>
        <table style="width: 100%; border-collapse: collapse; margin: 20px 0;">
            <tr>
                <th style="padding: 8px; border: 1px solid #5a3928; background: #3d2418; color: #d4af37;">–£—Ä.</th>
                <th style="padding: 8px; border: 1px solid #5a3928; background: #3d2418; color: #d4af37;">–û–ø—ã—Ç</th>
                <th style="padding: 8px; border: 1px solid #5a3928; background: #3d2418; color: #d4af37;">–•–ü</th>
                <th style="padding: 8px; border: 1px solid #5a3928; background: #3d2418; color: #d4af37;">–ú–∞–Ω–∞</th>
                <th style="padding: 8px; border: 1px solid #5a3928; background: #3d2418; color: #d4af37;">–°—Ç–∞–º–∏–Ω–∞</th>
                <th style="padding: 8px; border: 1px solid #5a3928; background: #3d2418; color: #d4af37;">–û—á–∫–∏</th>
            </tr>
    `;
    
    for (let level = 0; level <= 9; level++) {
        const data = levelTable[level];
        const isCurrent = level === currentCharacter.level.current;
        
        tableHTML += `
            <tr style="${isCurrent ? 'background: #8b4513; font-weight: bold;' : ''}">
                <td style="padding: 8px; border: 1px solid #5a3928; text-align: center;">${level}</td>
                <td style="padding: 8px; border: 1px solid #5a3928; text-align: center;">${data.expRequired || 'MAX'}</td>
                <td style="padding: 8px; border: 1px solid #5a3928; text-align: center;">+${data.hp}</td>
                <td style="padding: 8px; border: 1px solid #5a3928; text-align: center;">+${data.mana}</td>
                <td style="padding: 8px; border: 1px solid #5a3928; text-align: center;">+${data.stamina}</td>
                <td style="padding: 8px; border: 1px solid #5a3928; text-align: center;">+${data.points}</td>
            </tr>
        `;
    }
    
    tableHTML += `</table>`;
    
    showPopup('–¢–∞–±–ª–∏—Ü–∞ —É—Ä–æ–≤–Ω–µ–π', tableHTML, [
        '<button class="btn btn-roll" onclick="closePopup(this.closest(\'.popup\'))">–ó–∞–∫—Ä—ã—Ç—å</button>'
    ]);
}

function showSpells(schoolName) {
    alert(`üîÆ –°–∏—Å—Ç–µ–º–∞ –∑–∞–∫–ª–∏–Ω–∞–Ω–∏–π –¥–ª—è "${schoolName}" –±—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –≤ —Å–ª–µ–¥—É—é—â–∏—Ö –≤–µ—Ä—Å–∏—è—Ö!`);
}

function exportCharacter() {
    if (!currentCharacter) return;
    
    const dataStr = JSON.stringify(currentCharacter, null, 2);
    const dataBlob = new Blob([dataStr], { type: 'application/json' });
    
    const link = document.createElement('a');
    link.href = URL.createObjectURL(dataBlob);
    link.download = `character_${currentCharacter.info.name || 'unknown'}.json`;
    link.click();
    
    alert(`‚úÖ –ü–µ—Ä—Å–æ–Ω–∞–∂ "${currentCharacter.info.name}" —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω!`);
}

function importCharacter() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';
    
    input.onchange = function(event) {
        const file = event.target.files[0];
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const characterData = JSON.parse(e.target.result);
                
                const newCharacter = new Character();
                Object.assign(newCharacter, characterData);
                newCharacter.id = 'char_import_' + Date.now();
                newCharacter.updatedAt = new Date().toISOString();
                
                characterManager.characters[newCharacter.id] = newCharacter;
                characterManager.currentCharacterId = newCharacter.id;
                characterManager.saveCharacters();
                
                currentCharacter = newCharacter;
                renderCharacterSheet();
                
                alert(`‚úÖ –ü–µ—Ä—Å–æ–Ω–∞–∂ "${newCharacter.info.name}" –∏–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω!`);
            } catch (error) {
                alert('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞!');
                console.error(error);
            }
        };
        reader.readAsText(file);
    };
    
    input.click();
}

function rollSkill(skillName) {
    if (!currentCharacter) return;
    
    const skillValue = currentCharacter.getSkillValue(skillName);
    const check = rollSkillCheck(skillValue);
    
    let resultText, resultClass;
    if (check.critical === 'success') {
        resultText = "üí´ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –£–°–ü–ï–•!";
        resultClass = "success";
    } else if (check.critical === 'failure') {
        resultText = "üí• –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –ü–†–û–í–ê–õ!";
        resultClass = "failure";
    } else if (check.success) {
        resultText = "‚úÖ –£–°–ü–ï–•!";
        resultClass = "success";
    } else {
        resultText = "‚ùå –ù–ï–£–î–ê–ß–ê!";
        resultClass = "failure";
    }

    showRollResult(skillName, skillValue, check.roll, check.total, resultText, resultClass);
}

function showRollResult(skillName, skillValue, dice, total, resultText, resultClass) {
    const popup = showPopup(
        `–ë—Ä–æ—Å–æ–∫ –Ω–∞ "${skillName}" (${skillValue})`,
        `
            <div class="dice-rolls" style="display: flex; justify-content: center; gap: 15px; margin: 20px 0; flex-wrap: wrap;">
                <div class="dice" style="width: 50px; height: 50px; background: #8b4513; border-radius: 8px; 
                     display: flex; justify-content: center; align-items: center; font-size: 1.5em; 
                     font-weight: bold; color: #1a0f0b;">${dice[0]}</div>
                <div class="dice" style="width: 50px; height: 50px; background: #8b4513; border-radius: 8px; 
                     display: flex; justify-content: center; align-items: center; font-size: 1.5em; 
                     font-weight: bold; color: #1a0f0b;">${dice[1]}</div>
                <div class="dice" style="width: 50px; height: 50px; background: #8b4513; border-radius: 8px; 
                     display: flex; justify-content: center; align-items: center; font-size: 1.5em; 
                     font-weight: bold; color: #1a0f0b;">${dice[2]}</div>
            </div>
            <div style="font-size: 1.5em; margin: 20px 0; color: #e0d0c0;">${dice.join(' + ')} = ${total}</div>
            <div class="${resultClass}" style="${resultClass === 'success' ? 'color: #27ae60;' : 'color: #e74c3c;'} 
                  font-weight: bold; font-size: 1.3em;">${resultText}</div>
        `,
        [
            '<button class="btn btn-roll" onclick="rollSkill(\'' + skillName + '\'); closePopup(this.closest(\'.popup\'));">üé≤ –ö–∏–Ω—É—Ç—å –µ—â–µ</button>',
            '<button class="btn btn-roll" onclick="closePopup(this.closest(\'.popup\'))">–ó–∞–∫—Ä—ã—Ç—å</button>'
        ]
    );
}

// ========== –û–ë–ù–û–í–õ–ï–ù–ò–ï –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–ò ==========
function initializeSystem() {
    console.log('üéÆ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è D&D —Å–∏—Å—Ç–µ–º—ã...');
    
    if (!currentCharacter && Object.keys(characterManager.characters).length === 0) {
        const demoChar = characterManager.createCharacter('–ù–æ–≤—ã–π –ì–µ—Ä–æ–π', 'human');
        currentCharacter = demoChar;
        console.log('‚úÖ –°–æ–∑–¥–∞–Ω –¥–µ–º–æ-–ø–µ—Ä—Å–æ–Ω–∞–∂');
    }
    
    renderCharacterSheet();
    
    console.log(`‚úÖ –°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞! –ü–µ—Ä—Å–æ–Ω–∞–∂–µ–π: ${Object.keys(characterManager.characters).length}`);
}

document.addEventListener('DOMContentLoaded', initializeSystem);
</script>
<script>
// ========== –°–ò–°–¢–ï–ú–ê –ì–ï–ö–°–ê–ì–û–ù–ê–õ–¨–ù–û–ì–û –ü–û–õ–Ø ==========
class HexagonalBattlefield {
    constructor(width = 15, height = 10) {
        this.width = width;
        this.height = height;
        this.cells = {};
        this.obstacles = {};
        this.characters = {};
        this.hexSize = 40;
        this.initializeGrid();
    }

    initializeGrid() {
        for (let q = 0; q < this.width; q++) {
            for (let r = 0; r < this.height; r++) {
                const cellId = this.getCellId(q, r);
                this.cells[cellId] = {
                    q: q,
                    r: r,
                    type: 'empty',
                    occupied: false,
                    visible: true,
                    explored: false
                };
            }
        }
    }

    getCellId(q, r) {
        return `hex_${q}_${r}`;
    }

    getCellCoordinates(cellId) {
        const [_, q, r] = cellId.split('_');
        return { q: parseInt(q), r: parseInt(r) };
    }

    hexToPixel(q, r) {
        const x = this.hexSize * Math.sqrt(3) * (q + r / 2);
        const y = this.hexSize * 3/2 * r;
        return { x, y };
    }

    pixelToHex(x, y) {
        const q = (x * Math.sqrt(3)/3 - y / 3) / this.hexSize;
        const r = y * 2/3 / this.hexSize;
        return this.roundHex(q, r);
    }

    roundHex(q, r) {
        const s = -q - r;
        let rq = Math.round(q);
        let rr = Math.round(r);
        let rs = Math.round(s);

        const q_diff = Math.abs(rq - q);
        const r_diff = Math.abs(rr - r);
        const s_diff = Math.abs(rs - s);

        if (q_diff > r_diff && q_diff > s_diff) {
            rq = -rr - rs;
        } else if (r_diff > s_diff) {
            rr = -rq - rs;
        }

        return { q: rq, r: rr };
    }

    getNeighbors(q, r) {
        const directions = [
            [1, 0], [1, -1], [0, -1],
            [-1, 0], [-1, 1], [0, 1]
        ];
        
        const neighbors = [];
        for (const [dq, dr] of directions) {
            const nq = q + dq;
            const nr = r + dr;
            if (this.isValidCell(nq, nr)) {
                neighbors.push(this.getCellId(nq, nr));
            }
        }
        return neighbors;
    }

    isValidCell(q, r) {
        return q >= 0 && q < this.width && r >= 0 && r < this.height;
    }

    calculateDistance(cellId1, cellId2) {
        const coords1 = this.getCellCoordinates(cellId1);
        const coords2 = this.getCellCoordinates(cellId2);
        
        return (Math.abs(coords1.q - coords2.q) + 
                Math.abs(coords1.q + coords1.r - coords2.q - coords2.r) + 
                Math.abs(coords1.r - coords2.r)) / 2;
    }

    addObstacle(cellId, type = 'tree') {
        if (this.cells[cellId]) {
            this.cells[cellId].type = type;
            this.cells[cellId].occupied = true;
            this.obstacles[cellId] = { type, cellId };
        }
    }

    removeObstacle(cellId) {
        if (this.cells[cellId]) {
            this.cells[cellId].type = 'empty';
            this.cells[cellId].occupied = false;
            delete this.obstacles[cellId];
        }
    }

    placeCharacter(characterId, cellId, direction = 0) {
        if (this.cells[cellId] && !this.cells[cellId].occupied) {
            this.removeCharacter(characterId);
            
            this.cells[cellId].occupied = true;
            this.characters[characterId] = {
                cellId: cellId,
                direction: direction,
                characterId: characterId
            };
            return true;
        }
        return false;
    }

    removeCharacter(characterId) {
        if (this.characters[characterId]) {
            const cellId = this.characters[characterId].cellId;
            if (this.cells[cellId]) {
                this.cells[cellId].occupied = false;
            }
            delete this.characters[characterId];
        }
    }

    moveCharacter(characterId, targetCellId) {
        if (!this.characters[characterId]) return false;
        
        const currentCellId = this.characters[characterId].cellId;
        const distance = this.calculateDistance(currentCellId, targetCellId);
        
        if (distance <= 1 && this.placeCharacter(characterId, targetCellId)) {
            return true;
        }
        return false;
    }

    getCharacterPosition(characterId) {
        return this.characters[characterId];
    }

    getCellAtDirection(cellId, direction, distance = 1) {
        const coords = this.getCellCoordinates(cellId);
        let targetQ = coords.q;
        let targetR = coords.r;

        const directionVectors = [
            [1, 0], [1, -1], [0, -1],
            [-1, 0], [-1, 1], [0, 1]
        ];

        if (direction >= 0 && direction < 6) {
            const [dq, dr] = directionVectors[direction];
            targetQ += dq * distance;
            targetR += dr * distance;
        }

        const targetCellId = this.getCellId(targetQ, targetR);
        return this.isValidCell(targetQ, targetR) ? targetCellId : null;
    }

    getFieldOfView(characterId, range = 10) {
        const character = this.characters[characterId];
        if (!character) return [];

        const visibleCells = new Set();
        const centerCoords = this.getCellCoordinates(character.cellId);
        
        for (let q = -range; q <= range; q++) {
            for (let r = -range; r <= range; r++) {
                const targetQ = centerCoords.q + q;
                const targetR = centerCoords.r + r;
                
                if (this.isValidCell(targetQ, targetR)) {
                    const distance = this.calculateDistance(character.cellId, this.getCellId(targetQ, targetR));
                    if (distance <= range) {
                        visibleCells.add(this.getCellId(targetQ, targetR));
                    }
                }
            }
        }

        return Array.from(visibleCells);
    }

    getDirectionBetweenCells(fromCellId, toCellId) {
        const from = this.getCellCoordinates(fromCellId);
        const to = this.getCellCoordinates(toCellId);
        
        const dq = to.q - from.q;
        const dr = to.r - from.r;
        
        if (dq > 0 && dr === 0) return 0;
        if (dq > 0 && dr < 0) return 1;
        if (dq === 0 && dr < 0) return 2;
        if (dq < 0 && dr === 0) return 3;
        if (dq < 0 && dr > 0) return 4;
        if (dq === 0 && dr > 0) return 5;
        
        return 0;
    }
}

// ========== –°–ò–°–¢–ï–ú–ê –í–ò–ó–£–ê–õ–ò–ó–ê–¶–ò–ò –ü–û–õ–Ø –ë–û–Ø ==========
class BattlefieldRenderer {
    constructor(battlefield, containerId) {
        this.battlefield = battlefield;
        this.container = document.getElementById(containerId);
        this.selectedCell = null;
        this.selectedCharacter = null;
        this.setupEventListeners();
    }

    render() {
        if (!this.container) return;

        this.container.innerHTML = '';
        this.container.style.position = 'relative';
        this.container.style.width = `${this.battlefield.width * this.battlefield.hexSize * 1.8}px`;
        this.container.style.height = `${this.battlefield.height * this.battlefield.hexSize * 1.8}px`;
        this.container.style.background = '#1a0f0b';
        this.container.style.border = '2px solid #8b4513';
        this.container.style.borderRadius = '8px';
        this.container.style.overflow = 'hidden';

        for (const cellId in this.battlefield.cells) {
            this.renderHex(cellId);
        }

        for (const characterId in this.battlefield.characters) {
            this.renderCharacter(characterId);
        }
    }

    renderHex(cellId) {
        const cell = this.battlefield.cells[cellId];
        const { x, y } = this.battlefield.hexToPixel(cell.q, cell.r);
        
        const hexElement = document.createElement('div');
        hexElement.id = `hex_${cellId}`;
        hexElement.className = 'battlefield-hex';
        hexElement.style.cssText = `
            position: absolute;
            left: ${x}px;
            top: ${y}px;
            width: ${this.battlefield.hexSize * 2}px;
            height: ${this.battlefield.hexSize * 2}px;
            background: ${this.getHexColor(cell)};
            clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%);
            border: 1px solid #5a3928;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            color: #e0d0c0;
        `;

        hexElement.innerHTML = this.getHexContent(cell);
        hexElement.addEventListener('click', () => this.onHexClick(cellId));
        hexElement.addEventListener('mouseenter', () => this.onHexHover(cellId));
        hexElement.addEventListener('mouseleave', () => this.onHexLeave(cellId));

        this.container.appendChild(hexElement);
    }

    getHexColor(cell) {
        if (cell.occupied && cell.type !== 'empty') {
            switch (cell.type) {
                case 'tree': return '#2d5a27';
                case 'rock': return '#5a5a5a';
                case 'building': return '#8b4513';
                default: return '#3d2418';
            }
        }
        return cell.occupied ? '#5a3928' : '#2c1810';
    }

    getHexContent(cell) {
        if (cell.occupied && cell.type !== 'empty') {
            switch (cell.type) {
                case 'tree': return 'üå≤';
                case 'rock': return 'ü™®';
                case 'building': return 'üè†';
            }
        }
        return '';
    }

    renderCharacter(characterId) {
        const character = this.battlefield.characters[characterId];
        const cell = this.battlefield.cells[character.cellId];
        const { x, y } = this.battlefield.hexToPixel(cell.q, cell.r);
        
        const charElement = document.createElement('div');
        charElement.id = `char_${characterId}`;
        charElement.className = 'battlefield-character';
        charElement.style.cssText = `
            position: absolute;
            left: ${x + this.battlefield.hexSize * 0.5}px;
            top: ${y + this.battlefield.hexSize * 0.5}px;
            width: ${this.battlefield.hexSize}px;
            height: ${this.battlefield.hexSize}px;
            background: #d4af37;
            border: 2px solid #8b4513;
            border-radius: 50%;
            cursor: pointer;
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            color: #1a0f0b;
        `;

        const charSymbol = characterId.startsWith('player') ? 'üë§' : 
                          characterId.startsWith('farmer') ? 'üë®‚Äçüåæ' : 
                          characterId.startsWith('bandit') ? 'üíÄ' : '‚öîÔ∏è';
        
        charElement.innerHTML = charSymbol;
        charElement.title = `–ü–µ—Ä—Å–æ–Ω–∞–∂: ${characterId}`;
        
        charElement.addEventListener('click', (e) => {
            e.stopPropagation();
            this.onCharacterClick(characterId);
        });

        this.container.appendChild(charElement);
    }

    onHexClick(cellId) {
        console.log('–í—ã–±—Ä–∞–Ω–∞ —è—á–µ–π–∫–∞:', cellId);
        
        if (this.selectedCharacter) {
            if (this.battlefield.moveCharacter(this.selectedCharacter, cellId)) {
                console.log(`–ü–µ—Ä—Å–æ–Ω–∞–∂ ${this.selectedCharacter} –ø–µ—Ä–µ–º–µ—â–µ–Ω –≤ ${cellId}`);
                this.render();
            } else {
                console.log('–ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–∞ –≤ —ç—Ç—É —è—á–µ–π–∫—É');
            }
            this.selectedCharacter = null;
        } else {
            this.selectedCell = cellId;
            this.highlightCell(cellId);
        }
    }

    onHexHover(cellId) {
        this.highlightCell(cellId, true);
    }

    onHexLeave(cellId) {
        this.highlightCell(cellId, false);
    }

    onCharacterClick(characterId) {
        this.selectedCharacter = characterId;
        console.log('–í—ã–±—Ä–∞–Ω –ø–µ—Ä—Å–æ–Ω–∞–∂:', characterId);
        this.highlightPossibleMoves(characterId);
    }

    highlightCell(cellId, isHover = false) {
        const hexElement = document.getElementById(`hex_${cellId}`);
        if (hexElement) {
            if (isHover) {
                hexElement.style.filter = 'brightness(1.3)';
                hexElement.style.borderColor = '#d4af37';
            } else {
                hexElement.style.filter = 'brightness(1)';
                hexElement.style.borderColor = '#5a3928';
            }
        }
    }

    highlightPossibleMoves(characterId) {
        const character = this.battlefield.characters[characterId];
        if (!character) return;

        const currentCellId = character.cellId;
        const neighbors = this.battlefield.getNeighbors(
            this.battlefield.getCellCoordinates(currentCellId).q,
            this.battlefield.getCellCoordinates(currentCellId).r
        );

        this.resetHighlights();

        neighbors.forEach(cellId => {
            const hexElement = document.getElementById(`hex_${cellId}`);
            if (hexElement && !this.battlefield.cells[cellId].occupied) {
                hexElement.style.background = '#27ae60';
                hexElement.style.borderColor = '#2ecc71';
            }
        });

        const currentHex = document.getElementById(`hex_${currentCellId}`);
        if (currentHex) {
            currentHex.style.background = '#3498db';
            currentHex.style.borderColor = '#2980b9';
        }
    }

    resetHighlights() {
        const allHexes = document.querySelectorAll('.battlefield-hex');
        allHexes.forEach(hex => {
            const cellId = hex.id.replace('hex_', '');
            const cell = this.battlefield.cells[cellId];
            hex.style.background = this.getHexColor(cell);
            hex.style.borderColor = '#5a3928';
        });
    }

    setupEventListeners() {
        document.addEventListener('click', (e) => {
            if (!this.container.contains(e.target)) {
                this.selectedCell = null;
                this.selectedCharacter = null;
                this.resetHighlights();
            }
        });
    }
}
</script>
<script>
// ========== –°–ò–°–¢–ï–ú–ê –õ–ê–ù–î–®–ê–§–¢–û–í ==========
const landscapes = {
    city: {
        name: "üèôÔ∏è –ì–æ—Ä–æ–¥",
        obstacles: [
            { type: 'building', density: 0.3 },
            { type: 'tree', density: 0.1 },
            { type: 'rock', density: 0.05 }
        ],
        description: "–£–∑–∫–∏–µ —É–ª–∏—Ü—ã, –º–Ω–æ–≥–æ —É–∫—Ä—ã—Ç–∏–π"
    },
    forest: {
        name: "üå≤ –õ–µ—Å", 
        obstacles: [
            { type: 'tree', density: 0.4 },
            { type: 'rock', density: 0.1 },
            { type: 'building', density: 0.02 }
        ],
        description: "–ü–ª–æ—Ç–Ω–∞—è —Ä–∞—Å—Ç–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å, –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω—ã–π –æ–±–∑–æ—Ä"
    },
    road: {
        name: "üõ£Ô∏è –î–æ—Ä–æ–≥–∞",
        obstacles: [
            { type: 'tree', density: 0.1 },
            { type: 'rock', density: 0.05 },
            { type: 'building', density: 0.01 }
        ],
        description: "–û—Ç–∫—Ä—ã—Ç–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ, —Ö–æ—Ä–æ—à–∏–π –æ–±–∑–æ—Ä"
    }
};

function generateLandscape(battlefield, landscapeType) {
    const landscape = landscapes[landscapeType];
    if (!landscape) return;

    for (const cellId in battlefield.obstacles) {
        battlefield.removeObstacle(cellId);
    }

    for (let q = 0; q < battlefield.width; q++) {
        for (let r = 0; r < battlefield.height; r++) {
            const cellId = battlefield.getCellId(q, r);
            
            if (q < 2 || q >= battlefield.width - 2 || r < 2 || r >= battlefield.height - 2) {
                continue;
            }

            for (const obstacle of landscape.obstacles) {
                if (Math.random() < obstacle.density) {
                    battlefield.addObstacle(cellId, obstacle.type);
                    break;
                }
            }
        }
    }
}

// ========== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï –î–õ–Ø –°–ò–°–¢–ï–ú–´ –ë–û–Ø ==========
let battlefield = null;
let battlefieldRenderer = null;

// ========== –ò–ù–¢–ï–†–§–ï–ô–° –°–ò–°–¢–ï–ú–´ –ë–û–Ø ==========
function initializeCombatSystem() {
    const combatTab = document.getElementById('combat-tab');
    if (!combatTab) return;

    combatTab.innerHTML = `
        <div style="margin-bottom: 20px;">
            <h2 class="section-title">‚öîÔ∏è –ë–æ–µ–≤–∞—è –°–∏—Å—Ç–µ–º–∞</h2>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                <div>
                    <h3 style="color: #d4af37; margin-bottom: 10px;">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–æ—è</h3>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; color: #e0d0c0;">–õ–∞–Ω–¥—à–∞—Ñ—Ç:</label>
                        <select id="landscapeSelect" style="width: 100%; padding: 10px; border: 2px solid #8b4513; 
                              border-radius: 4px; background: #1a0f0b; color: #e0d0c0;">
                            <option value="city">üèôÔ∏è –ì–æ—Ä–æ–¥</option>
                            <option value="forest">üå≤ –õ–µ—Å</option>
                            <option value="road">üõ£Ô∏è –î–æ—Ä–æ–≥–∞</option>
                        </select>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <label style="display: block; margin-bottom: 5px; color: #e0d0c0;">–†–∞–∑–º–µ—Ä –ø–æ–ª—è:</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="number" id="battlefieldWidth" value="15" min="5" max="20" 
                                   style="flex: 1; padding: 10px; border: 2px solid #8b4513; border-radius: 4px; 
                                   background: #1a0f0b; color: #e0d0c0;">
                            <span style="color: #e0d0c0; line-height: 40px;">√ó</span>
                            <input type="number" id="battlefieldHeight" value="10" min="5" max="15" 
                                   style="flex: 1; padding: 10px; border: 2px solid #8b4513; border-radius: 4px; 
                                   background: #1a0f0b; color: #e0d0c0;">
                        </div>
                    </div>
                    
                    <button class="btn btn-plus" onclick="createBattlefield()" style="width: 100%;">
                        üé≤ –°–æ–∑–¥–∞—Ç—å –ø–æ–ª–µ –±–æ—è
                    </button>
                </div>
                
                <div>
                    <h3 style="color: #d4af37; margin-bottom: 10px;">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</h3>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px;">
                        <button class="btn btn-roll" onclick="addPlayerToBattlefield()">‚ûï –ò–≥—Ä–æ–∫</button>
                        <button class="btn btn-roll" onclick="addFarmerToBattlefield()">üë®‚Äçüåæ –§–µ—Ä–º–µ—Ä</button>
                        <button class="btn btn-roll" onclick="addBanditToBattlefield()">üíÄ –†–∞–∑–±–æ–π–Ω–∏–∫</button>
                        <button class="btn btn-minus" onclick="clearBattlefield()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å</button>
                    </div>
                    
                    <div style="background: #3d2418; padding: 15px; border-radius: 6px;">
                        <h4 style="color: #d4af37; margin-bottom: 10px;">–õ–µ–≥–µ–Ω–¥–∞:</h4>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px; font-size: 0.9em;">
                            <div>üë§ - –ò–≥—Ä–æ–∫</div>
                            <div>üë®‚Äçüåæ - –§–µ—Ä–º–µ—Ä</div>
                            <div>üíÄ - –†–∞–∑–±–æ–π–Ω–∏–∫</div>
                            <div>üå≤ - –î–µ—Ä–µ–≤–æ</div>
                            <div>ü™® - –ö–∞–º–µ–Ω—å</div>
                            <div>üè† - –ó–¥–∞–Ω–∏–µ</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div id="battlefieldContainer" style="min-height: 400px; background: #1a0f0b; 
                 border: 2px solid #5a3928; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                <p style="text-align: center; color: #8b7d6b; padding: 50px;">
                    –°–æ–∑–¥–∞–π—Ç–µ –ø–æ–ª–µ –±–æ—è —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å
                </p>
            </div>
            
            <div id="battleInfo" style="background: #3d2418; padding: 15px; border-radius: 6px; display: none;">
                <h3 style="color: #d4af37; margin-bottom: 10px;">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –±–æ–µ</h3>
                <div id="battleStatus">–°—Ç–∞—Ç—É—Å: –û–∂–∏–¥–∞–Ω–∏–µ –Ω–∞—á–∞–ª–∞</div>
            </div>
        </div>
    `;
}

function createBattlefield() {
    const width = parseInt(document.getElementById('battlefieldWidth').value) || 15;
    const height = parseInt(document.getElementById('battlefieldHeight').value) || 10;
    const landscapeType = document.getElementById('landscapeSelect').value;

    battlefield = new HexagonalBattlefield(width, height);
    battlefieldRenderer = new BattlefieldRenderer(battlefield, 'battlefieldContainer');
    
    generateLandscape(battlefield, landscapeType);
    battlefieldRenderer.render();
    
    document.getElementById('battleInfo').style.display = 'block';
    
    console.log(`‚úÖ –ü–æ–ª–µ –±–æ—è —Å–æ–∑–¥–∞–Ω–æ: ${width}x${height}, –ª–∞–Ω–¥—à–∞—Ñ—Ç: ${landscapeType}`);
}

function addPlayerToBattlefield() {
    if (!battlefield) {
        alert('–°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ –ø–æ–ª–µ –±–æ—è!');
        return;
    }

    const startCell = battlefield.getCellId(1, battlefield.height - 2);
    if (battlefield.placeCharacter('player_1', startCell, 0)) {
        battlefieldRenderer.render();
        console.log('‚úÖ –ò–≥—Ä–æ–∫ –¥–æ–±–∞–≤–ª–µ–Ω –Ω–∞ –ø–æ–ª–µ –±–æ—è');
    }
}

function addFarmerToBattlefield() {
    if (!battlefield) {
        alert('–°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ –ø–æ–ª–µ –±–æ—è!');
        return;
    }

    const farmerId = 'farmer_' + Date.now();
    const startCell = battlefield.getCellId(battlefield.width - 2, 1);
    if (battlefield.placeCharacter(farmerId, startCell, 3)) {
        battlefieldRenderer.render();
        console.log('‚úÖ –§–µ—Ä–º–µ—Ä –¥–æ–±–∞–≤–ª–µ–Ω –Ω–∞ –ø–æ–ª–µ –±–æ—è');
    }
}

function addBanditToBattlefield() {
    if (!battlefield) {
        alert('–°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ –ø–æ–ª–µ –±–æ—è!');
        return;
    }

    const banditId = 'bandit_' + Date.now();
    const randomQ = Math.floor(Math.random() * (battlefield.width - 4)) + 2;
    const randomR = Math.floor(Math.random() * (battlefield.height - 4)) + 2;
    const startCell = battlefield.getCellId(randomQ, randomR);
    
    if (battlefield.placeCharacter(banditId, startCell, Math.floor(Math.random() * 6))) {
        battlefieldRenderer.render();
        console.log('‚úÖ –†–∞–∑–±–æ–π–Ω–∏–∫ –¥–æ–±–∞–≤–ª–µ–Ω –Ω–∞ –ø–æ–ª–µ –±–æ—è');
    }
}

function clearBattlefield() {
    if (!battlefield) return;
    
    for (const characterId in battlefield.characters) {
        battlefield.removeCharacter(characterId);
    }
    
    battlefieldRenderer.render();
    console.log('‚úÖ –ü–æ–ª–µ –±–æ—è –æ—á–∏—â–µ–Ω–æ');
}

// ========== –û–ë–ù–û–í–õ–ï–ù–ò–ï –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–ò ==========
let combatTabInitialized = false;

function openTab(tabName) {
    document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    document.getElementById(tabName + '-tab').classList.add('active');
    event.currentTarget.classList.add('active');
    
    if (tabName === 'combat' && !combatTabInitialized) {
        initializeCombatSystem();
        combatTabInitialized = true;
    }
}
</script>
<script>
// ========== –°–ò–°–¢–ï–ú–ê –ü–†–ï–î–ú–ï–¢–û–í –ò –û–†–£–ñ–ò–Ø ==========
const itemTemplates = {
    weapons: {
        dagger: {
            id: 'dagger',
            name: '–ö–∏–Ω–∂–∞–ª',
            type: 'weapon',
            subtype: 'one_handed',
            damageType: 'piercing',
            damage: '1d4',
            hands: 1,
            weight: 0.5,
            value: 10,
            description: '–ù–µ–±–æ–ª—å—à–æ–π —Å–∫—Ä—ã—Ç—ã–π –∫–ª–∏–Ω–æ–∫'
        },
        shortsword: {
            id: 'shortsword',
            name: '–ö–æ—Ä–æ—Ç–∫–∏–π –º–µ—á',
            type: 'weapon', 
            subtype: 'one_handed',
            damageType: 'slashing',
            damage: '1d6',
            hands: 1,
            weight: 2,
            value: 25,
            description: '–°–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ–¥–Ω–æ—Ä—É—á–Ω—ã–π –º–µ—á'
        },
        axe: {
            id: 'axe',
            name: '–¢–æ–ø–æ—Ä',
            type: 'weapon',
            subtype: 'one_handed', 
            damageType: 'slashing',
            damage: '1d8',
            hands: 1,
            weight: 3,
            value: 30,
            description: '–¢—è–∂–µ–ª—ã–π –±–æ–µ–≤–æ–π —Ç–æ–ø–æ—Ä'
        },
        greatsword: {
            id: 'greatsword',
            name: '–î–≤—É—Ä—É—á–Ω—ã–π –º–µ—á',
            type: 'weapon',
            subtype: 'two_handed',
            damageType: 'slashing', 
            damage: '2d6',
            hands: 2,
            weight: 5,
            value: 50,
            description: '–ú–æ—â–Ω–æ–µ –¥–≤—É—Ä—É—á–Ω–æ–µ –æ—Ä—É–∂–∏–µ'
        },
        spear: {
            id: 'spear',
            name: '–ö–æ–ø—å–µ',
            type: 'weapon',
            subtype: 'polearm',
            damageType: 'piercing',
            damage: '1d8',
            hands: 2,
            weight: 3,
            value: 15,
            description: '–î—Ä–µ–≤–∫–æ–≤–æ–µ –æ—Ä—É–∂–∏–µ —Å –¥–ª–∏–Ω–Ω–æ–π –¥–∏—Å—Ç–∞–Ω—Ü–∏–µ–π'
        }
    },

    shields: {
        buckler: {
            id: 'buckler',
            name: '–ë–∞–∫–ª–µ—Ä',
            type: 'shield',
            armorBonus: 1,
            weight: 2,
            value: 15,
            description: '–ù–µ–±–æ–ª—å—à–æ–π –∫—Ä—É–≥–ª—ã–π —â–∏—Ç'
        },
        round_shield: {
            id: 'round_shield',
            name: '–ö—Ä—É–≥–ª—ã–π —â–∏—Ç',
            type: 'shield', 
            armorBonus: 2,
            weight: 4,
            value: 30,
            description: '–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –¥–µ—Ä–µ–≤—è–Ω–Ω—ã–π —â–∏—Ç'
        },
        tower_shield: {
            id: 'tower_shield',
            name: '–ë–∞—à–µ–Ω–Ω—ã–π —â–∏—Ç',
            type: 'shield',
            armorBonus: 3,
            weight: 8,
            value: 50,
            description: '–ë–æ–ª—å—à–æ–π —â–∏—Ç, –æ–±–µ—Å–ø–µ—á–∏–≤–∞—é—â–∏–π –æ—Ç–ª–∏—á–Ω—É—é –∑–∞—â–∏—Ç—É'
        }
    },

    armor: {
        leather_armor: {
            id: 'leather_armor',
            name: '–ö–æ–∂–∞–Ω–∞—è –±—Ä–æ–Ω—è',
            type: 'armor',
            armorClass: 2,
            weight: 5,
            value: 20,
            description: '–ü—Ä–æ—Å—Ç–∞—è –∫–æ–∂–∞–Ω–∞—è –∑–∞—â–∏—Ç–∞'
        },
        chainmail: {
            id: 'chainmail', 
            name: '–ö–æ–ª—å—á—É–≥–∞',
            type: 'armor',
            armorClass: 4,
            weight: 12,
            value: 75,
            description: '–ú–µ—Ç–∞–ª–ª–∏—á–µ—Å–∫–∞—è –∫–æ–ª—å—á—É–∂–Ω–∞—è —Ä—É–±–∞—Ö–∞'
        },
        plate_armor: {
            id: 'plate_armor',
            name: '–õ–∞—Ç–Ω–∞—è –±—Ä–æ–Ω—è',
            type: 'armor',
            armorClass: 6, 
            weight: 20,
            value: 200,
            description: '–ü–æ–ª–Ω—ã–π –∫–æ–º–ø–ª–µ–∫—Ç –º–µ—Ç–∞–ª–ª–∏—á–µ—Å–∫–∏—Ö –¥–æ—Å–ø–µ—Ö–æ–≤'
        }
    },

    light_sources: {
        torch: {
            id: 'torch',
            name: '–§–∞–∫–µ–ª',
            type: 'light_source',
            lightRadius: 10,
            duration: 60,
            weight: 1,
            value: 1,
            description: '–ü—Ä–æ—Å—Ç–æ–π –∏—Å—Ç–æ—á–Ω–∏–∫ —Å–≤–µ—Ç–∞'
        },
        lantern: {
            id: 'lantern',
            name: '–§–æ–Ω–∞—Ä—å',
            type: 'light_source',
            lightRadius: 15,
            duration: 120,
            weight: 2,
            value: 10,
            description: '–ú–∞—Å–ª—è–Ω—ã–π —Ñ–æ–Ω–∞—Ä—å —Å —Ä–µ–≥—É–ª–∏—Ä—É–µ–º—ã–º —Å–≤–µ—Ç–æ–º'
        }
    },

    ammunition: {
        arrows: {
            id: 'arrows',
            name: '–°—Ç—Ä–µ–ª—ã',
            type: 'ammunition',
            subtype: 'arrows',
            quantity: 20,
            weight: 0.5,
            value: 5,
            description: '–ö–æ–ª—á–∞–Ω —Å–æ —Å—Ç—Ä–µ–ª–∞–º–∏'
        },
        bolts: {
            id: 'bolts',
            name: '–ë–æ–ª—Ç—ã',
            type: 'ammunition', 
            subtype: 'bolts',
            quantity: 20,
            weight: 0.5,
            value: 5,
            description: '–ù–∞–±–æ—Ä –±–æ–ª—Ç–æ–≤ –¥–ª—è –∞—Ä–±–∞–ª–µ—Ç–∞'
        }
    },

    misc: {
        healing_potion: {
            id: 'healing_potion',
            name: '–ó–µ–ª—å–µ –ª–µ—á–µ–Ω–∏—è',
            type: 'potion',
            effect: 'heal',
            power: '2d4+2',
            weight: 0.5,
            value: 50,
            description: '–í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –∑–¥–æ—Ä–æ–≤—å–µ –ø—Ä–∏ —É–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–∏'
        },
        mana_potion: {
            id: 'mana_potion',
            name: '–ó–µ–ª—å–µ –º–∞–Ω—ã',
            type: 'potion',
            effect: 'restore_mana',
            power: '2d4+2',
            weight: 0.5,
            value: 75,
            description: '–í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –º–∞–Ω—É'
        },
        rope: {
            id: 'rope',
            name: '–í–µ—Ä–µ–≤–∫–∞',
            type: 'tool',
            length: 15,
            weight: 2,
            value: 1,
            description: '–ü—Ä–æ—á–Ω–∞—è –ø–µ–Ω—å–∫–æ–≤–∞—è –≤–µ—Ä–µ–≤–∫–∞'
        }
    }
};

// ========== –ö–õ–ê–°–° –ò–ù–í–ï–ù–¢–ê–†–Ø ==========
class InventorySystem {
    constructor(character) {
        this.character = character;
        this.items = [];
        this.equipped = {
            weapon: null,
            shield: null,
            armor: null,
            light_source: null
        };
        this.carryCapacity = this.calculateCarryCapacity();
        this.loadInventory();
    }

    calculateCarryCapacity() {
        const strength = this.character.getSkillValue('–í—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å') || 10;
        return Math.max(20, strength * 2);
    }

    getCurrentWeight() {
        return this.items.reduce((total, item) => total + (item.weight * (item.quantity || 1)), 0);
    }

    getEncumbranceLevel() {
        const weight = this.getCurrentWeight();
        const capacity = this.carryCapacity;
        const ratio = weight / capacity;

        if (ratio < 0.3) return 'none';
        if (ratio < 0.6) return 'light';
        if (ratio < 0.9) return 'medium';
        return 'heavy';
    }

    getEncumbranceModifiers() {
        const level = this.getEncumbranceLevel();
        const modifiers = {
            none: { movement: 0, stealth: 0, agility: 0 },
            light: { movement: -1, stealth: -1, agility: -1 },
            medium: { movement: -2, stealth: -2, agility: -2 },
            heavy: { movement: -5, stealth: -5, agility: -5 }
        };
        return modifiers[level];
    }

    addItem(itemTemplate, quantity = 1) {
        const existingItem = this.items.find(item => item.id === itemTemplate.id);
        
        if (existingItem && itemTemplate.type !== 'weapon' && itemTemplate.type !== 'armor') {
            existingItem.quantity += quantity;
        } else {
            const newItem = {
                ...itemTemplate,
                quantity: quantity,
                equipped: false
            };
            this.items.push(newItem);
        }

        this.saveInventory();
        return true;
    }

    removeItem(itemId, quantity = 1) {
        const itemIndex = this.items.findIndex(item => item.id === itemId);
        if (itemIndex === -1) return false;

        const item = this.items[itemIndex];
        
        if (item.quantity > quantity) {
            item.quantity -= quantity;
        } else {
            if (item.equipped) {
                this.unequipItem(itemId);
            }
            this.items.splice(itemIndex, 1);
        }

        this.saveInventory();
        return true;
    }

    equipItem(itemId) {
        const item = this.items.find(i => i.id === itemId);
        if (!item) return false;

        if (!this.canEquipItem(item)) {
            return false;
        }

        if (item.type === 'weapon') {
            if (this.equipped.weapon) {
                this.unequipItem(this.equipped.weapon.id);
            }
            this.equipped.weapon = item;
        } else if (item.type === 'shield') {
            if (this.equipped.shield) {
                this.unequipItem(this.equipped.shield.id);
            }
            this.equipped.shield = item;
        } else if (item.type === 'armor') {
            if (this.equipped.armor) {
                this.unequipItem(this.equipped.armor.id);
            }
            this.equipped.armor = item;
        } else if (item.type === 'light_source') {
            if (this.equipped.light_source) {
                this.unequipItem(this.equipped.light_source.id);
            }
            this.equipped.light_source = item;
        }

        item.equipped = true;
        this.saveInventory();
        return true;
    }

    unequipItem(itemId) {
        const item = this.items.find(i => i.id === itemId);
        if (!item || !item.equipped) return false;

        if (this.equipped.weapon === item) this.equipped.weapon = null;
        if (this.equipped.shield === item) this.equipped.shield = null;
        if (this.equipped.armor === item) this.equipped.armor = null;
        if (this.equipped.light_source === item) this.equipped.light_source = null;

        item.equipped = false;
        this.saveInventory();
        return true;
    }

    canEquipItem(item) {
        if (item.type === 'weapon' && item.hands === 2 && this.equipped.shield) {
            return false;
        }

        if (item.type === 'weapon') {
            const requiredSkill = this.getWeaponSkill(item);
            const skillValue = this.character.getSkillValue(requiredSkill) || 5;
            if (skillValue < 5) {
                return false;
            }
        }

        return true;
    }

    getWeaponSkill(weapon) {
        const skillMap = {
            'one_handed': '–û–¥–Ω–æ—Ä—É—á–Ω–æ–µ –æ—Ä—É–∂–∏–µ',
            'two_handed': '–î–≤—É—Ä—É—á–Ω–æ–µ –æ—Ä—É–∂–∏–µ',
            'polearm': '–î—Ä–µ–≤–∫–æ–≤–æ–µ',
            'ranged': '–°—Ç—Ä–µ–ª—å–±–∞',
            'thrown': '–ú–µ—Ç–∞–Ω–∏–µ'
        };
        return skillMap[weapon.subtype] || '–û–¥–Ω–æ—Ä—É—á–Ω–æ–µ –æ—Ä—É–∂–∏–µ';
    }

    getCombatModifiers() {
        const modifiers = {
            attack: 0,
            damage: 0,
            armorClass: 0,
            movement: 0
        };

        if (this.equipped.weapon) {
            const weaponSkill = this.getWeaponSkill(this.equipped.weapon);
            const skillValue = this.character.getSkillValue(weaponSkill) || 5;
            modifiers.attack += Math.floor((skillValue - 5) / 2);
        }

        if (this.equipped.shield) {
            modifiers.armorClass += this.equipped.shield.armorBonus;
        }

        if (this.equipped.armor) {
            modifiers.armorClass += this.equipped.armor.armorClass;
        }

        const encumbranceMods = this.getEncumbranceModifiers();
        modifiers.movement += encumbranceMods.movement;

        return modifiers;
    }

    useItem(itemId) {
        const item = this.items.find(i => i.id === itemId);
        if (!item) return false;

        switch (item.type) {
            case 'potion':
                return this.usePotion(item);
            case 'ammunition':
                return this.useAmmunition(item);
            default:
                return false;
        }
    }

    usePotion(potion) {
        let effect = '';
        
        switch (potion.effect) {
            case 'heal':
                const healAmount = this.rollDiceExpression(potion.power);
                this.character.stats.health = Math.min(
                    this.character.stats.health + healAmount,
                    this.character.stats.maxHealth
                );
                effect = `–≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç ${healAmount} –∑–¥–æ—Ä–æ–≤—å—è`;
                break;
            case 'restore_mana':
                const manaAmount = this.rollDiceExpression(potion.power);
                this.character.stats.mana = Math.min(
                    this.character.stats.mana + manaAmount,
                    this.character.stats.maxMana
                );
                effect = `–≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç ${manaAmount} –º–∞–Ω—ã`;
                break;
        }

        this.removeItem(potion.id, 1);
        
        this.saveInventory();
        return effect;
    }

    useAmmunition(ammo) {
        if (ammo.quantity <= 0) return false;
        ammo.quantity--;
        if (ammo.quantity <= 0) {
            this.removeItem(ammo.id);
        }
        this.saveInventory();
        return true;
    }

    rollDiceExpression(expression) {
        const match = expression.match(/(\d+)d(\d+)([+-]\d+)?/);
        if (!match) return 0;

        const count = parseInt(match[1]);
        const sides = parseInt(match[2]);
        const modifier = match[3] ? parseInt(match[3]) : 0;

        const roll = rollDice(sides, count);
        return roll.total + modifier;
    }

    saveInventory() {
        const inventoryData = {
            items: this.items,
            equipped: this.equipped
        };
        StorageSystem.set(`inventory_${this.character.id}`, inventoryData);
    }

    loadInventory() {
        const inventoryData = StorageSystem.get(`inventory_${this.character.id}`, {
            items: [],
            equipped: {
                weapon: null,
                shield: null,
                armor: null,
                light_source: null
            }
        });

        this.items = inventoryData.items;
        this.equipped = inventoryData.equipped;
    }
}
</script>
<script>
// ========== –ò–ù–¢–ï–†–§–ï–ô–° –ò–ù–í–ï–ù–¢–ê–†–Ø ==========
let inventoryTabInitialized = false;

function initializeInventoryInterface() {
    const inventoryTab = document.getElementById('inventory-tab');
    if (!inventoryTab || !currentCharacter) return;

    const inventorySystem = new InventorySystem(currentCharacter);

    inventoryTab.innerHTML = `
        <div style="margin-bottom: 20px;">
            <h2 class="section-title">üéí –°–∏—Å—Ç–µ–º–∞ –ò–Ω–≤–µ–Ω—Ç–∞—Ä—è</h2>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                <div>
                    <h3 style="color: #d4af37; margin-bottom: 15px;">üìä –°—Ç–∞—Ç—É—Å —Å–Ω–∞—Ä—è–∂–µ–Ω–∏—è</h3>
                    
                    <div style="background: #3d2418; padding: 15px; border-radius: 6px; margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <span>–í–µ—Å:</span>
                            <span>${inventorySystem.getCurrentWeight().toFixed(1)} / ${inventorySystem.carryCapacity} –∫–≥</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                            <span>–ó–∞–≥—Ä—É–∂–µ–Ω–Ω–æ—Å—Ç—å:</span>
                            <span style="color: ${getEncumbranceColor(inventorySystem.getEncumbranceLevel())}">
                                ${getEncumbranceText(inventorySystem.getEncumbranceLevel())}
                            </span>
                        </div>
                        <div style="background: #2c1810; height: 10px; border-radius: 5px; overflow: hidden;">
                            <div style="height: 100%; background: #27ae60; width: ${(inventorySystem.getCurrentWeight() / inventorySystem.carryCapacity) * 100}%;"></div>
                        </div>
                    </div>

                    <div style="background: #3d2418; padding: 15px; border-radius: 6px;">
                        <h4 style="color: #d4af37; margin-bottom: 10px;">üéØ –≠–∫–∏–ø–∏—Ä–æ–≤–∞–Ω–æ</h4>
                        <div id="equippedItems">
                            ${renderEquippedItems(inventorySystem)}
                        </div>
                    </div>
                </div>
                
                <div>
                    <h3 style="color: #d4af37; margin-bottom: 15px;">üõí –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–µ–¥–º–µ—Ç—ã</h3>
                    
                    <div style="background: #3d2418; padding: 15px; border-radius: 6px; margin-bottom: 15px;">
                        <select id="itemCategory" style="width: 100%; padding: 10px; margin-bottom: 10px; 
                              border: 2px solid #8b4513; border-radius: 4px; background: #1a0f0b; color: #e0d0c0;">
                            <option value="weapons">‚öîÔ∏è –û—Ä—É–∂–∏–µ</option>
                            <option value="shields">üõ°Ô∏è –©–∏—Ç—ã</option>
                            <option value="armor">ü•ã –ë—Ä–æ–Ω—è</option>
                            <option value="light_sources">üí° –ò—Å—Ç–æ—á–Ω–∏–∫–∏ —Å–≤–µ—Ç–∞</option>
                            <option value="ammunition">üèπ –ë–æ–µ–ø—Ä–∏–ø–∞—Å—ã</option>
                            <option value="misc">üéí –ü—Ä–æ—á–µ–µ</option>
                        </select>
                        
                        <select id="itemSelect" style="width: 100%; padding: 10px; margin-bottom: 10px; 
                              border: 2px solid #8b4513; border-radius: 4px; background: #1a0f0b; color: #e0d0c0;">
                            ${renderItemOptions('weapons')}
                        </select>
                        
                        <div style="display: flex; gap: 10px;">
                            <input type="number" id="itemQuantity" value="1" min="1" 
                                   style="flex: 1; padding: 10px; border: 2px solid #8b4513; border-radius: 4px; 
                                   background: #1a0f0b; color: #e0d0c0;">
                            <button class="btn btn-plus" onclick="addItemToInventory()">–î–æ–±–∞–≤–∏—Ç—å</button>
                        </div>
                    </div>
                    
                    <button class="btn btn-roll" onclick="showQuickEquipment()" style="width: 100%;">
                        üéÅ –ë—ã—Å—Ç—Ä–∞—è —ç–∫–∏–ø–∏—Ä–æ–≤–∫–∞
                    </button>
                </div>
            </div>
            
            <div style="background: #3d2418; padding: 20px; border-radius: 8px; border: 2px solid #5a3928;">
                <h3 style="color: #d4af37; margin-bottom: 15px;">üéí –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è</h3>
                <input type="text" id="inventorySearch" placeholder="üîç –ü–æ–∏—Å–∫ –ø—Ä–µ–¥–º–µ—Ç–æ–≤..." 
                       style="width: 100%; padding: 10px; margin-bottom: 15px; border: 2px solid #8b4513; 
                       border-radius: 4px; background: #1a0f0b; color: #e0d0c0;">
                <div id="inventoryItems">
                    ${renderInventoryItems(inventorySystem)}
                </div>
            </div>
        </div>
    `;

    document.getElementById('itemCategory').addEventListener('change', function() {
        updateItemOptions(this.value);
    });
    
    document.getElementById('inventorySearch').addEventListener('input', function() {
        filterInventoryItems(this.value);
    });
}

function renderEquippedItems(inventorySystem) {
    let html = '';
    
    const slots = [
        { key: 'weapon', label: '–û—Ä—É–∂–∏–µ', icon: '‚öîÔ∏è' },
        { key: 'shield', label: '–©–∏—Ç', icon: 'üõ°Ô∏è' },
        { key: 'armor', label: '–ë—Ä–æ–Ω—è', icon: 'ü•ã' },
        { key: 'light_source', label: '–°–≤–µ—Ç', icon: 'üí°' }
    ];

    slots.forEach(slot => {
        const item = inventorySystem.equipped[slot.key];
        html += `
            <div style="display: flex; justify-content: space-between; align-items: center; 
                 padding: 8px 0; border-bottom: 1px solid #5a3928;">
                <div>
                    <span style="margin-right: 10px;">${slot.icon}</span>
                    <span>${slot.label}:</span>
                </div>
                <div>
                    ${item ? `
                        <span>${item.name}</span>
                        <button class="btn btn-small" onclick="unequipItem('${item.id}')" 
                                style="background: #c44536; margin-left: 10px;">–°–Ω—è—Ç—å</button>
                    ` : '<span style="color: #8b7d6b;">–ù–µ —ç–∫–∏–ø–∏—Ä–æ–≤–∞–Ω–æ</span>'}
                </div>
            </div>
        `;
    });

    const modifiers = inventorySystem.getCombatModifiers();
    html += `
        <div style="margin-top: 15px; padding-top: 10px; border-top: 2px solid #5a3928;">
            <h5 style="color: #d4af37; margin-bottom: 5px;">–ë–æ–µ–≤—ã–µ –º–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä—ã:</h5>
            <div style="font-size: 0.9em;">
                –ê—Ç–∞–∫–∞: ${modifiers.attack >= 0 ? '+' : ''}${modifiers.attack} |
                –ó–∞—â–∏—Ç–∞: +${modifiers.armorClass} |
                –î–≤–∏–∂–µ–Ω–∏–µ: ${modifiers.movement >= 0 ? '+' : ''}${modifiers.movement}
            </div>
        </div>
    `;

    return html;
}

function renderItemOptions(category) {
    const items = itemTemplates[category];
    if (!items) return '<option value="">–ù–µ—Ç –ø—Ä–µ–¥–º–µ—Ç–æ–≤</option>';
    
    return Object.values(items).map(item => 
        `<option value="${item.id}">${item.name} (${item.value} –∑–æ–ª.)</option>`
    ).join('');
}

function renderInventoryItems(inventorySystem) {
    if (inventorySystem.items.length === 0) {
        return '<p style="text-align: center; color: #8b7d6b;">–ò–Ω–≤–µ–Ω—Ç–∞—Ä—å –ø—É—Å—Ç</p>';
    }

    let html = '';
    inventorySystem.items.forEach(item => {
        const weight = (item.weight * (item.quantity || 1)).toFixed(1);
        html += `
            <div class="inventory-item" style="background: #2c1810; margin: 10px 0; padding: 15px; 
                 border-radius: 6px; border-left: 4px solid #d4af37;">
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                    <div>
                        <strong style="color: #d4af37;">${item.name}</strong>
                        ${item.quantity > 1 ? `<span style="background: #8b4513; color: #e0d0c0; padding: 2px 8px; 
                            border-radius: 4px; font-size: 0.9em; margin-left: 10px;">√ó${item.quantity}</span>` : ''}
                        <div style="color: #b8a28a; font-size: 0.9em; margin-top: 5px;">${item.description}</div>
                    </div>
                    <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                        ${!item.equipped ? `
                            <button class="btn btn-small" onclick="equipItem('${item.id}')" 
                                    style="background: #27ae60;">–≠–∫–∏–ø–∏—Ä–æ–≤–∞—Ç—å</button>
                        ` : `
                            <button class="btn btn-small" onclick="unequipItem('${item.id}')" 
                                    style="background: #c44536;">–°–Ω—è—Ç—å</button>
                        `}
                        <button class="btn btn-small" onclick="useItem('${item.id}')" 
                                style="background: #3498db;">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å</button>
                        <button class="btn btn-small" onclick="removeItem('${item.id}')" 
                                style="background: #e74c3c;">–í—ã–±—Ä–æ—Å–∏—Ç—å</button>
                    </div>
                </div>
                <div style="display: flex; justify-content: space-between; color: #8b7d6b; font-size: 0.8em;">
                    <span>–í–µ—Å: ${weight} –∫–≥</span>
                    <span>–°—Ç–æ–∏–º–æ—Å—Ç—å: ${item.value} –∑–æ–ª.</span>
                    <span>–¢–∏–ø: ${getItemTypeText(item.type)}</span>
                </div>
            </div>
        `;
    });

    return html;
}

// ========== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò –ò–ù–í–ï–ù–¢–ê–†–Ø ==========
function getEncumbranceColor(level) {
    const colors = {
        'none': '#27ae60',
        'light': '#f39c12', 
        'medium': '#e67e22',
        'heavy': '#e74c3c'
    };
    return colors[level] || '#8b7d6b';
}

function getEncumbranceText(level) {
    const texts = {
        'none': '–ù–µ—Ç',
        'light': '–õ–µ–≥–∫–∞—è',
        'medium': '–°—Ä–µ–¥–Ω—è—è',
        'heavy': '–¢—è–∂–µ–ª–∞—è'
    };
    return texts[level] || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
}

function getItemTypeText(type) {
    const types = {
        'weapon': '–û—Ä—É–∂–∏–µ',
        'shield': '–©–∏—Ç',
        'armor': '–ë—Ä–æ–Ω—è',
        'light_source': '–ò—Å—Ç–æ—á–Ω–∏–∫ —Å–≤–µ—Ç–∞',
        'ammunition': '–ë–æ–µ–ø—Ä–∏–ø–∞—Å—ã',
        'potion': '–ó–µ–ª—å–µ',
        'tool': '–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç'
    };
    return types[type] || type;
}

function updateItemOptions(category) {
    const itemSelect = document.getElementById('itemSelect');
    if (itemSelect) {
        itemSelect.innerHTML = renderItemOptions(category);
    }
}

function addItemToInventory() {
    if (!currentCharacter) return;

    const category = document.getElementById('itemCategory').value;
    const itemId = document.getElementById('itemSelect').value;
    const quantity = parseInt(document.getElementById('itemQuantity').value) || 1;

    const itemTemplate = itemTemplates[category]?.[itemId];
    if (!itemTemplate) {
        alert('–ü—Ä–µ–¥–º–µ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω!');
        return;
    }

    const inventorySystem = new InventorySystem(currentCharacter);
    inventorySystem.addItem(itemTemplate, quantity);
    
    alert(`‚úÖ "${itemTemplate.name}" –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å!`);
    initializeInventoryInterface();
}

function equipItem(itemId) {
    if (!currentCharacter) return;

    const inventorySystem = new InventorySystem(currentCharacter);
    if (inventorySystem.equipItem(itemId)) {
        alert('‚úÖ –ü—Ä–µ–¥–º–µ—Ç —ç–∫–∏–ø–∏—Ä–æ–≤–∞–Ω!');
        initializeInventoryInterface();
    } else {
        alert('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —ç–∫–∏–ø–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–µ–¥–º–µ—Ç!');
    }
}

function unequipItem(itemId) {
    if (!currentCharacter) return;

    const inventorySystem = new InventorySystem(currentCharacter);
    if (inventorySystem.unequipItem(itemId)) {
        alert('‚úÖ –ü—Ä–µ–¥–º–µ—Ç —Å–Ω—è—Ç!');
        initializeInventoryInterface();
    }
}

function useItem(itemId) {
    if (!currentCharacter) return;

    const inventorySystem = new InventorySystem(currentCharacter);
    const effect = inventorySystem.useItem(itemId);
    
    if (effect) {
        alert(`‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ: ${effect}`);
        initializeInventoryInterface();
    } else {
        alert('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–µ–¥–º–µ—Ç!');
    }
}

function removeItem(itemId) {
    if (!currentCharacter) return;

    if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–±—Ä–æ—Å–∏—Ç—å —ç—Ç–æ—Ç –ø—Ä–µ–¥–º–µ—Ç?')) {
        const inventorySystem = new InventorySystem(currentCharacter);
        if (inventorySystem.removeItem(itemId)) {
            alert('‚úÖ –ü—Ä–µ–¥–º–µ—Ç –≤—ã–±—Ä–æ—à–µ–Ω!');
            initializeInventoryInterface();
        }
    }
}

function filterInventoryItems(searchTerm) {
    const items = document.querySelectorAll('.inventory-item');
    const term = searchTerm.toLowerCase();
    
    items.forEach(item => {
        const text = item.textContent.toLowerCase();
        item.style.display = text.includes(term) ? 'block' : 'none';
    });
}

function showQuickEquipment() {
    if (!currentCharacter) return;

    const inventorySystem = new InventorySystem(currentCharacter);
    
    const starterKit = [
        itemTemplates.weapons.shortsword,
        itemTemplates.armor.leather_armor,
        itemTemplates.shields.buckler,
        itemTemplates.light_sources.torch,
        itemTemplates.misc.healing_potion,
        itemTemplates.misc.rope
    ];

    starterKit.forEach(item => {
        inventorySystem.addItem(item);
    });

    alert('üéÅ –°—Ç–∞—Ä—Ç–æ–≤—ã–π –Ω–∞–±–æ—Ä –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—å!');
    initializeInventoryInterface();
}

// ========== –û–ë–ù–û–í–õ–ï–ù–ò–ï –§–£–ù–ö–¶–ò–ò OPEN TAB ==========
function openTab(tabName) {
    document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    document.getElementById(tabName + '-tab').classList.add('active');
    event.currentTarget.classList.add('active');
    
    if (tabName === 'combat' && !combatTabInitialized) {
        initializeCombatSystem();
        combatTabInitialized = true;
    }
    
    if (tabName === 'inventory' && !inventoryTabInitialized) {
        initializeInventoryInterface();
        inventoryTabInitialized = true;
    }
}

// ========== –û–ë–ù–û–í–õ–ï–ù–ò–ï –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–ò –°–ò–°–¢–ï–ú–´ ==========
function initializeSystem() {
    console.log('üéÆ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è D&D —Å–∏—Å—Ç–µ–º—ã...');
    
    if (!currentCharacter && Object.keys(characterManager.characters).length === 0) {
        const demoChar = characterManager.createCharacter('–ù–æ–≤—ã–π –ì–µ—Ä–æ–π', 'human');
        currentCharacter = demoChar;
        
        const inventorySystem = new InventorySystem(currentCharacter);
        const starterKit = [
            itemTemplates.weapons.dagger,
            itemTemplates.armor.leather_armor,
            itemTemplates.misc.healing_potion,
            itemTemplates.misc.rope
        ];
        starterKit.forEach(item => inventorySystem.addItem(item));
        
        console.log('‚úÖ –°–æ–∑–¥–∞–Ω –¥–µ–º–æ-–ø–µ—Ä—Å–æ–Ω–∞–∂ —Å–æ —Å—Ç–∞—Ä—Ç–æ–≤—ã–º —Å–Ω–∞—Ä—è–∂–µ–Ω–∏–µ–º');
    }
    
    renderCharacterSheet();
    
    console.log(`‚úÖ –°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞! –ü–µ—Ä—Å–æ–Ω–∞–∂–µ–π: ${Object.keys(characterManager.characters).length}`);
}

document.addEventListener('DOMContentLoaded', initializeSystem);
</script>
</body>
</html>
