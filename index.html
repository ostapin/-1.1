<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D&D Character Sheet</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            font-family: 'Times New Roman', serif; 
            background: #1a0f0b url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" opacity="0.1"><rect fill="%234d2e1e" width="100" height="100"/><path fill="%235a3928" d="M0 0h50v50H0z"/></svg>'); 
            color: #e0d0c0; 
            padding: 20px; 
            min-height: 100vh; 
        }
        .container { 
            max-width: 900px; 
            margin: 0 auto; 
            background: #2c1810; 
            border: 3px solid #8b4513; 
            border-radius: 8px; 
            box-shadow: 0 0 30px rgba(139, 69, 19, 0.5); 
            overflow: hidden; 
            position: relative;
        }
        
        /* –ü–µ—Ä–≥–∞–º–µ–Ω—Ç–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç */
        .container::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100" opacity="0.05"><rect fill="%23e8d5b5" width="100" height="100"/></svg>');
            pointer-events: none;
            mix-blend-mode: overlay;
        }

        /* –í–∫–ª–∞–¥–∫–∏ */
        .tabs { 
            display: flex; 
            background: linear-gradient(to bottom, #5a3928, #3d2418); 
            border-bottom: 2px solid #8b4513; 
        }
        .tab-btn { 
            flex: 1; 
            padding: 15px; 
            border: none; 
            background: transparent; 
            color: #e0d0c0; 
            font-size: 16px; 
            cursor: pointer; 
            transition: all 0.3s; 
            border-right: 1px solid #8b4513;
            font-family: 'Times New Roman', serif;
            font-weight: bold;
        }
        .tab-btn:last-child { border-right: none; }
        .tab-btn.active { 
            background: #8b4513; 
            text-shadow: 0 0 5px #ffd700;
        }
        .tab-btn:hover:not(.active) {
            background: #6b3a1f;
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .header { 
            background: linear-gradient(to bottom, #3d2418, #2c1810); 
            color: #e0d0c0; 
            padding: 25px; 
            text-align: center; 
            border-bottom: 3px solid #8b4513;
            position: relative;
        }
        .header::after {
            content: '';
            position: absolute;
            bottom: -3px;
            left: 10%;
            right: 10%;
            height: 2px;
            background: linear-gradient(90deg, transparent, #ffd700, transparent);
        }
        .character-info { 
            display: flex; 
            gap: 15px; 
            margin-bottom: 15px; 
            flex-wrap: wrap; 
            justify-content: center; 
        }
        .input-group { 
            flex: 1; 
            min-width: 200px; 
        }
        .input-group label { 
            display: block; 
            margin-bottom: 8px; 
            font-weight: bold; 
            color: #d4af37; 
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .input-group input, .input-group select { 
            width: 100%; 
            padding: 12px; 
            border: 2px solid #8b4513; 
            border-radius: 4px; 
            font-size: 16px; 
            background: #1a0f0b; 
            color: #e0d0c0;
            font-family: 'Times New Roman', serif;
        }
        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: #d4af37;
            box-shadow: 0 0 10px rgba(212, 175, 55, 0.3);
        }
        .input-row { 
            display: flex; 
            gap: 10px; 
            align-items: center; 
        }
        .input-row input { 
            flex: 1; 
        }
        
        .level-system { 
            background: #3d2418; 
            padding: 20px; 
            border-bottom: 2px solid #8b4513; 
            position: relative;
        }
        .level-system::before {
            content: '‚öîÔ∏è';
            position: absolute;
            top: 10px;
            right: 20px;
            font-size: 24px;
            opacity: 0.3;
        }
        .level-display { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 15px; 
        }
        .level-info { 
            font-size: 1.3em; 
            font-weight: bold; 
            color: #d4af37; 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            text-shadow: 1px 1px 2px #000;
        }
        .exp-display { 
            display: flex; 
            align-items: center; 
            gap: 10px; 
        }
        .exp-input { 
            width: 120px; 
            padding: 10px; 
            border: 2px solid #8b4513; 
            border-radius: 4px; 
            font-size: 16px; 
            text-align: center; 
            background: #1a0f0b;
            color: #e0d0c0;
            font-family: 'Times New Roman', serif;
        }
        
        .stats-panel { 
            padding: 20px; 
            background: #2c1810; 
            border-bottom: 2px solid #5a3928; 
        }
        .stat-row { 
            display: flex; 
            align-items: center; 
            padding: 12px 0; 
            gap: 15px; 
            border-bottom: 1px solid #3d2418;
        }
        .stat-row:last-child { border-bottom: none; }
        .stat-label { 
            flex: 1; 
            font-weight: bold; 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            color: #d4af37;
            font-size: 1.1em;
        }
        .stat-input { 
            width: 100px; 
            padding: 10px; 
            border: 2px solid #8b4513; 
            border-radius: 4px; 
            text-align: center; 
            font-size: 16px; 
            background: #1a0f0b;
            color: #e0d0c0;
            font-family: 'Times New Roman', serif;
        }
        
        .points-panel { 
            padding: 20px; 
            background: #3d2418; 
            border-bottom: 2px solid #8b4513; 
        }
        .points-display { 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            gap: 15px; 
        }
        
        .skills-section { 
            padding: 25px; 
            border-bottom: 2px solid #5a3928; 
        }
        .section-title { 
            font-size: 1.5em; 
            color: #d4af37; 
            margin-bottom: 20px; 
            padding-bottom: 12px; 
            border-bottom: 2px solid #8b4513; 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            text-transform: uppercase;
            letter-spacing: 2px;
            text-shadow: 2px 2px 4px #000;
        }
        .skill-row { 
            display: flex; 
            align-items: center; 
            padding: 15px 0; 
            border-bottom: 1px solid #3d2418;
            transition: background 0.3s;
        }
        .skill-row:hover {
            background: rgba(139, 69, 19, 0.1);
        }
        .skill-row:last-child { border-bottom: none; }
        .skill-name { 
            flex: 2; 
            font-weight: 500; 
            display: flex; 
            align-items: center; 
            gap: 12px; 
            font-size: 1.1em;
        }
        .skill-controls { 
            flex: 1; 
            display: flex; 
            align-items: center; 
            justify-content: flex-end; 
            gap: 12px; 
        }
        .skill-value { 
            font-size: 1.3em; 
            font-weight: bold; 
            color: #d4af37; 
            min-width: 40px; 
            text-align: center; 
            text-shadow: 1px 1px 2px #000;
        }
        
        /* –°—Ç–∏–ª–∏ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è */
        .inventory-container { padding: 25px; }
        .category-section { 
            margin-bottom: 25px; 
            border: 2px solid #5a3928; 
            border-radius: 6px; 
            padding: 20px; 
            background: #2c1810;
        }
        .category-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 15px; 
            padding-bottom: 12px; 
            border-bottom: 1px solid #8b4513; 
        }
        .category-header h3 { 
            margin: 0; 
            color: #d4af37; 
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .category-items { min-height: 50px; }
        .item-row { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 12px; 
            margin: 8px 0; 
            background: #3d2418; 
            border-radius: 4px; 
            border-left: 4px solid #8b4513; 
            transition: transform 0.2s;
        }
        .item-row:hover {
            transform: translateX(5px);
            border-left-color: #d4af37;
        }
        .item-info { flex: 1; }
        .item-name { 
            font-weight: bold; 
            color: #e0d0c0; 
            font-size: 1.1em;
        }
        .item-details { 
            font-size: 0.9em; 
            color: #b8a28a; 
            font-style: italic;
        }
        .item-actions { display: flex; gap: 8px; }
        
        .btn { 
            padding: 10px 16px; 
            border: none; 
            border-radius: 4px; 
            cursor: pointer; 
            font-size: 14px; 
            font-weight: bold; 
            transition: all 0.3s; 
            font-family: 'Times New Roman', serif;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .btn-plus { background: #27ae60; color: white; }
        .btn-minus { background: #c44536; color: white; }
        .btn-roll { 
            background: linear-gradient(45deg, #8b4513, #d4af37); 
            color: #1a0f0b; 
            padding: 10px 20px; 
            font-weight: bold;
        }
        .btn-convert { 
            background: linear-gradient(45deg, #6c3483, #8e44ad); 
            color: white; 
        }
        .btn-levels { 
            background: linear-gradient(45deg, #d35400, #e67e22); 
            color: white; 
        }
        .btn-edit { 
            background: linear-gradient(45deg, #34495e, #5d6d7e); 
            color: white; 
        }
        .btn-undo { 
            background: linear-gradient(45deg, #e67e22, #f39c12); 
            color: white; 
        }
        .btn-redo { 
            background: linear-gradient(45deg, #d35400, #e74c3c); 
            color: white; 
        }
        .btn-small { padding: 6px 12px; font-size: 12px; }
        .btn:disabled { 
            background: #5a3928; 
            color: #8b7d6b; 
            cursor: not-allowed; 
        }
        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        .result-popup, .levels-popup, .inventory-popup { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(26, 15, 11, 0.95); 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            z-index: 1000; 
        }
        .result-content, .levels-content, .inventory-content { 
            background: #2c1810; 
            padding: 35px; 
            border-radius: 8px; 
            text-align: center; 
            max-width: 90%; 
            width: 500px; 
            max-height: 80vh; 
            overflow-y: auto; 
            border: 3px solid #8b4513;
            box-shadow: 0 0 50px rgba(212, 175, 55, 0.2);
        }
        .dice-rolls { 
            display: flex; 
            justify-content: center; 
            gap: 20px; 
            margin: 20px 0; 
        }
        .dice { 
            width: 60px; 
            height: 60px; 
            background: linear-gradient(45deg, #8b4513, #d4af37); 
            border-radius: 8px; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            font-size: 1.8em; 
            font-weight: bold; 
            color: #1a0f0b; 
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        
        .success { color: #27ae60; font-weight: bold; font-size: 1.3em; }
        .failure { color: #e74c3c; font-weight: bold; font-size: 1.3em; }
        .critical-success { color: #f39c12; font-weight: bold; font-size: 1.4em; text-shadow: 0 0 10px gold; }
        .critical-failure { color: #c0392b; font-weight: bold; font-size: 1.4em; text-shadow: 0 0 10px darkred; }
        
        .free-points-warning { 
            color: #e74c3c; 
            font-weight: bold; 
            text-align: center; 
            margin: 15px; 
            padding: 15px; 
            background: #3d2418; 
            border-radius: 6px; 
            border: 2px solid #c44536;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .levels-table { 
            width: 100%; 
            border-collapse: collapse; 
            margin: 20px 0; 
            background: #2c1810;
        }
        .levels-table th, .levels-table td { 
            padding: 12px; 
            text-align: center; 
            border: 1px solid #5a3928; 
        }
        .levels-table th { 
            background: linear-gradient(to bottom, #5a3928, #3d2418); 
            color: #d4af37; 
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .levels-table td {
            background: #2c1810;
            color: #e0d0c0;
        }
        .current-level { 
            background: linear-gradient(45deg, #8b4513, #d4af37) !important; 
            font-weight: bold; 
            color: #1a0f0b !important;
        }
        
        /* –°—Ç–∏–ª–∏ –¥–ª—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã—Ö –Ω–∞–≤—ã–∫–æ–≤ */
        .skill-disabled {
            opacity: 0.4;
            color: #8b7d6b !important;
        }
        .skill-disabled .skill-value {
            color: #8b7d6b !important;
        }
        .skill-disabled .btn-roll {
            background: #5a3928 !important;
            color: #8b7d6b !important;
        }

        @media (max-width: 768px) {
            .character-info, .stat-row, .skill-row { flex-direction: column; align-items: flex-start; gap: 12px; }
            .skill-controls { width: 100%; justify-content: space-between; }
            .exp-display, .level-display { flex-direction: column; gap: 15px; }
            .points-display { flex-direction: column; }
            .tabs { flex-direction: column; }
            .item-row { flex-direction: column; align-items: flex-start; gap: 12px; }
            .item-actions { width: 100%; justify-content: flex-end; }
            .input-row { flex-direction: column; }
            .btn { padding: 12px 18px; font-size: 16px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- –í–∫–ª–∞–¥–∫–∏ -->
        <div class="tabs">
            <button class="tab-btn active" onclick="openTab('character')">üßô –ü–µ—Ä—Å–æ–Ω–∞–∂</button>
            <button class="tab-btn" onclick="openTab('inventory')">üéí –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</button>
            <button class="tab-btn" onclick="openTab('spells')">üìú –ó–∞–∫–ª–∏–Ω–∞–Ω–∏—è</button>
            <button class="tab-btn" onclick="openTab('notes')">‚úçÔ∏è –ó–∞–º–µ—Ç–∫–∏</button>
        </div>

        <!-- –í–∫–ª–∞–¥–∫–∞ –ü–µ—Ä—Å–æ–Ω–∞–∂ -->
        <div id="character-tab" class="tab-content active">
            <div class="header">
                <h1 style="font-size: 2.5em; color: #d4af37; text-shadow: 2px 2px 4px #000; margin-bottom: 20px;">‚öîÔ∏è D&D Character Sheet</h1>
                <div class="character-info">
                    <div class="input-group">
                        <label for="characterName">–ò–º—è –ø–µ—Ä—Å–æ–Ω–∞–∂–∞:</label>
                        <input type="text" id="characterName" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è">
                    </div>
                    <div class="input-group">
                        <label for="characterSurname">–§–∞–º–∏–ª–∏—è:</label>
                        <input type="text" id="characterSurname" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ñ–∞–º–∏–ª–∏—é">
                    </div>
                    <div class="input-group">
                        <label for="characterTitle">–¢–∏—Ç—É–ª:</label>
                        <input type="text" id="characterTitle" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–∏—Ç—É–ª">
                    </div>
                </div>

                <div class="character-info">
                    <div class="input-group">
                        <label for="characterRace">–†–∞—Å–∞:</label>
                        <select id="characterRace" onchange="onRaceChange()">
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞—Å—É</option>
                            <option value="atski">üî• –ê—Ü–∫–∏ (–û–≥–Ω–µ–Ω–Ω—ã–µ)</option>
                            <option value="knofi">üó£Ô∏è –ö–Ω–æ—Ñ—ã (–û—Ä–∞—Ç–æ—Ä—ã)</option>
                            <option value="vorki">‚ùÑÔ∏è –í–æ—Ä–∫–∏ (–°–µ–≤–µ—Ä—è–Ω–µ)</option>
                            <option value="minci">üéØ –ú–∏–Ω—Ü—ã (–ú–∞—Å—Ç–µ—Ä–∞)</option>
                            <option value="kaei">‚öíÔ∏è –ö–∞—ç–π—Ü—ã (–ö—É–∑–Ω–µ—Ü—ã)</option>
                            <option value="forest_elf">üåø –õ–µ—Å–Ω—ã–µ —ç–ª—å—Ñ—ã</option>
                            <option value="high_elf">‚ú® –í—ã—Å—à–∏–µ —ç–ª—å—Ñ—ã</option>
                            <option value="dark_elf">üåë –¢–µ–º–Ω—ã–µ —ç–ª—å—Ñ—ã</option>
                            <option value="dwarf">‚õ∞Ô∏è –î–≤–∞—Ä—Ñ—ã</option>
                            <option value="gnome">üîÆ –ì–Ω–æ–º—ã</option>
                            <option value="orc">üíÄ –û—Ä–∫–∏</option>
                            <option value="goblin">üëπ –ì–æ–±–ª–∏–Ω—ã</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="characterHeritage">–ù–∞—Å–ª–µ–¥–∏–µ:</label>
                        <input type="text" id="characterHeritage" placeholder="–û—Å–æ–±–æ–µ –Ω–∞—Å–ª–µ–¥–∏–µ">
                    </div>
                </div>

                <div class="character-info">
                    <div class="input-group">
                        <label for="characterHeight">–†–æ—Å—Ç (—Å–º):</label>
                        <div class="input-row">
                            <input type="number" id="characterHeight" readonly>
                            <button class="btn" id="generateHeightBtn" onclick="generateHeightForSelectedRace()" style="background: linear-gradient(45deg, #8b4513, #d4af37); color: #1a0f0b;">üé≤ –ê–≤—Ç–æ</button>
                        </div>
                    </div>
                    <div class="input-group">
                        <label for="characterWeight">–í–µ—Å (–∫–≥):</label>
                        <input type="number" id="characterWeight" placeholder="–í–µ—Å">
                    </div>
                    <div class="input-group">
                        <label for="characterAge">–í–æ–∑—Ä–∞—Å—Ç (–ª–µ—Ç):</label>
                        <input type="number" id="characterAge" placeholder="–í–æ–∑—Ä–∞—Å—Ç">
                    </div>
                </div>
            </div>

            <div class="level-system">
                <div class="level-display">
                    <div class="level-info">
                        –£—Ä–æ–≤–µ–Ω—å: <span id="currentLevel">0</span>
                        <button class="btn btn-edit" onclick="editLevel()">‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å</button>
                        <button class="btn btn-levels" onclick="showLevelsTable()">üìä –¢–∞–±–ª–∏—Ü–∞</button>
                        <button class="btn btn-undo" onclick="undo()" id="undoBtn" disabled>‚Ü∂ –û—Ç–º–µ–Ω–∏—Ç—å</button>
                        <button class="btn btn-redo" onclick="redo()" id="redoBtn" disabled>‚Ü∑ –í–µ—Ä–Ω—É—Ç—å</button>
                    </div>
                    <div class="exp-display">
                        <input type="number" id="currentExp" class="exp-input" value="0" min="0">
                        <span style="color: #d4af37; font-weight: bold;">/ <span id="requiredExp">1000</span> XP</span>
                        <button class="btn btn-plus" onclick="addExperience()">‚ûï –û–ø—ã—Ç</button>
                        <button class="btn btn-convert" id="convertBtn" onclick="convertExpToPoints()" style="display: none;">üíé –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                    </div>
                </div>
                <div id="convertInfo" style="display: none; text-align: center; margin-top: 15px; font-size: 1em; color: #d4af37; font-style: italic;">
                    üíé 1000 –æ–ø—ã—Ç–∞ = 1 –æ—á–∫–æ –Ω–∞–≤—ã–∫–æ–≤
                </div>
            </div>

            <div class="stats-panel">
                <div class="stat-row">
                    <div class="stat-label">‚ù§Ô∏è –ó–¥–æ—Ä–æ–≤—å–µ:</div>
                    <input type="number" class="stat-input" id="health" value="100">
                    <button class="btn btn-minus" onclick="changeStat('health', -5)">-5</button>
                    <button class="btn btn-plus" onclick="changeStat('health', 5)">+5</button>
                </div>
                <div class="stat-row">
                    <div class="stat-label">üîÆ –ú–∞–Ω–∞:</div>
                    <input type="number" class="stat-input" id="mana" value="100">
                    <button class="btn btn-minus" onclick="changeStat('mana', -5)">-5</button>
                    <button class="btn btn-plus" onclick="changeStat('mana', 5)">+5</button>
                </div>
                <div class="stat-row">
                    <div class="stat-label">‚ö° –í—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å:</div>
                    <input type="number" class="stat-input" id="stamina" value="100">
                    <button class="btn btn-minus" onclick="changeStat('stamina', -5)">-5</button>
                    <button class="btn btn-plus" onclick="changeStat('stamina', 5)">+5</button>
                </div>
            </div>

            <div class="points-panel">
                <div class="points-display">
                    <span style="font-size: 1.3em; font-weight: bold; color: #d4af37; text-shadow: 1px 1px 2px #000;">–°–≤–æ–±–æ–¥–Ω—ã–µ –æ—á–∫–∏ –Ω–∞–≤—ã–∫–æ–≤:</span>
                    <input type="number" id="freePoints" class="stat-input" value="0">
                    <button class="btn btn-edit" onclick="editFreePoints()">‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å</button>
                </div>
            </div>

            <div id="skillsContainer"></div>
            
            <div class="free-points-warning" id="pointsWarning" style="display: none;">
                ‚ö†Ô∏è –°–≤–æ–±–æ–¥–Ω—ã–µ –æ—á–∫–∏ –Ω–∞–≤—ã–∫–æ–≤ –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å!
            </div>
        </div>

        <!-- –í–∫–ª–∞–¥–∫–∞ –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å -->
        <div id="inventory-tab" class="tab-content">
            <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è –±—É–¥–µ—Ç –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è —á–µ—Ä–µ–∑ JavaScript -->
        </div>

        <!-- –í–∫–ª–∞–¥–∫–∞ –ó–∞–∫–ª–∏–Ω–∞–Ω–∏—è -->
        <div id="spells-tab" class="tab-content">
            <div style="padding: 40px; text-align: center;">
                <h2 style="color: #d4af37; font-size: 2em; margin-bottom: 20px; text-shadow: 2px 2px 4px #000;">üìú –ö–Ω–∏–≥–∞ –ó–∞–∫–ª–∏–Ω–∞–Ω–∏–π</h2>
                <p style="color: #b8a28a; margin-top: 30px; font-size: 1.2em; font-style: italic;">–°–≤–∏—Ç–∫–∏ –∏ –≥—Ä–∏–º—É–∞—Ä—ã –∂–¥—É—Ç —Å–≤–æ–µ–≥–æ —á–∞—Å–∞...</p>
                <div style="margin-top: 40px; font-size: 4em; opacity: 0.3;">üîÆ</div>
            </div>
        </div>

        <!-- –í–∫–ª–∞–¥–∫–∞ –ó–∞–º–µ—Ç–∫–∏ -->
        <div id="notes-tab" class="tab-content">
            <div style="padding: 40px; text-align: center;">
                <h2 style="color: #d4af37; font-size: 2em; margin-bottom: 20px; text-shadow: 2px 2px 4px #000;">‚úçÔ∏è –°–≤–∏—Ç–æ–∫ –ó–∞–º–µ—Ç–æ–∫</h2>
                <p style="color: #b8a28a; margin-top: 30px; font-size: 1.2em; font-style: italic;">–ó–∞–ø–∏—Å–∏ –æ –ø—Ä–∏–∫–ª—é—á–µ–Ω–∏—è—Ö –∏ –ª–µ–≥–µ–Ω–¥–∞—Ö...</p>
                <div style="margin-top: 40px; font-size: 4em; opacity: 0.3;">üìñ</div>
            </div>
        </div>
    </div>

    <script>
        // –¢–∞–±–ª–∏—Ü–∞ —É—Ä–æ–≤–Ω–µ–π (–Ω–∞—á–∏–Ω–∞–µ–º —Å 0 —É—Ä–æ–≤–Ω—è)
        const levelTable = {
            0: { expRequired: 1000, hp: 100, mana: 100, stamina: 100, points: 20 },
            1: { expRequired: 3000, hp: 200, mana: 200, stamina: 200, points: 30 },
            2: { expRequired: 5000, hp: 300, mana: 300, stamina: 300, points: 40 },
            3: { expRequired: 8000, hp: 400, mana: 400, stamina: 400, points: 50 },
            4: { expRequired: 12000, hp: 500, mana: 500, stamina: 500, points: 60 },
            5: { expRequired: 16000, hp: 600, mana: 600, stamina: 600, points: 70 },
            6: { expRequired: 20000, hp: 700, mana: 700, stamina: 700, points: 80 },
            7: { expRequired: 25000, hp: 800, mana: 800, stamina: 800, points: 90 },
            8: { expRequired: 30000, hp: 900, mana: 900, stamina: 900, points: 100 },
            9: { expRequired: 100000, hp: 1000, mana: 1000, stamina: 1000, points: 200 }
        };

        // –°–∏—Å—Ç–µ–º–∞ —Ä–∞—Å (–±–µ–∑ –ª—é–¥–µ–π)
        const races = {
            atski: {
                name: "üî• –ê—Ü–∫–∏ (–û–≥–Ω–µ–Ω–Ω—ã–µ)",
                description: "50% –∑–∞—â–∏—Ç–∞ –æ—Ç –æ–≥–Ω—è, 100% –Ω–∞ –∞—Ç–∞–∫—É –æ–≥–Ω–µ–º, –ø—É—Å—Ç—ã–Ω—è —ç—Ç–æ –∏—Ö —Å—Ç–∏—Ö–∏—è",
                lifespan: "350 –ª–µ—Ç",
                bonuses: { "–ú–∞–≥–∏—è –æ–≥–Ω—è": 2 },
                limitations: {}
            },
            knofi: {
                name: "üó£Ô∏è –ö–Ω–æ—Ñ—ã (–û—Ä–∞—Ç–æ—Ä—ã)", 
                description: "+1 –∫ –∫—Ä–∞—Å–Ω–æ—Ä–µ—á–∏—é, –∑–Ω–∞–Ω–∏–µ 3 —è–∑—ã–∫–æ–≤",
                lifespan: "400 –ª–µ—Ç",
                bonuses: { "–ö—Ä–∞—Å–Ω–æ—Ä–µ—á–∏–µ": 1 },
                limitations: {}
            },
            vorki: {
                name: "‚ùÑÔ∏è –í–æ—Ä–∫–∏ (–°–µ–≤–µ—Ä—è–Ω–µ)",
                description: "50% –∑–∞—â–∏—Ç–∞ –æ—Ç –ª—å–¥—É, +100% –Ω–∞ –∞—Ç–∞–∫—É –ª—å–¥–æ–º",
                lifespan: "250 –ª–µ—Ç",
                bonuses: { "–ú–∞–≥–∏—è –≤–æ–¥—ã": 2 },
                limitations: {}
            },
            minci: {
                name: "üéØ –ú–∏–Ω—Ü—ã (–ú–∞—Å—Ç–µ—Ä–∞)",
                description: "+1 –∫ –¥—Ä–µ–≤–∫–æ–≤–æ–º—É, +1 –∫ –ª–æ–≤–∫–æ—Å—Ç–∏, +1 –≤—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç–∏",
                lifespan: "350 –ª–µ—Ç", 
                bonuses: { "–î—Ä–µ–≤–∫–æ–≤–æ–µ": 1, "–õ–æ–≤–∫–æ—Å—Ç—å": 1, "–í—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å": 1 },
                limitations: { "–î—Ä–µ–≤–∫–æ–≤–æ–µ": 19 }
            },
            kaei: {
                name: "‚öíÔ∏è –ö–∞—ç–π—Ü—ã (–ö—É–∑–Ω–µ—Ü—ã)",
                description: "–° —Ä–æ–∂–¥–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–Ω–∞ —Å—Ç–∏—Ö–∏—è –º–µ—Ç–∞–ª–ª–∞",
                lifespan: "300 –ª–µ—Ç",
                bonuses: { "–ú–∞–≥–∏—è –º–µ—Ç–∞–ª–ª–∞": 2 },
                limitations: {}
            },
            forest_elf: {
                name: "üåø –õ–µ—Å–Ω—ã–µ —ç–ª—å—Ñ—ã", 
                description: "–° —Ä–æ–∂–¥–µ–Ω–∏—è –æ–±–ª–∞–¥–∞—é—Ç –º–∞–≥–∏–µ–π –ø—Ä–∏—Ä–æ–¥—ã",
                lifespan: "700 –ª–µ—Ç",
                bonuses: { "–ú–∞–≥–∏—è –ø—Ä–∏—Ä–æ–¥—ã": 2 },
                limitations: {}
            },
            high_elf: {
                name: "‚ú® –í—ã—Å—à–∏–µ —ç–ª—å—Ñ—ã",
                description: "–° —Ä–æ–∂–¥–µ–Ω–∏—è –æ–±–ª–∞–¥–∞—é—Ç –¥–≤—É–º—è —Å—Ç–∏—Ö–∏—è–º–∏",
                lifespan: "2000 –ª–µ—Ç", 
                bonuses: { },
                limitations: { "–í—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å": 19 }
            },
            dark_elf: {
                name: "üåë –¢–µ–º–Ω—ã–µ —ç–ª—å—Ñ—ã",
                description: "–° —Ä–æ–∂–¥–µ–Ω–∏—è –≤–ª–∞–¥–µ—é—Ç –º–∞–≥–∏–µ–π —Ç—å–º—ã", 
                lifespan: "700 –ª–µ—Ç",
                bonuses: { "–ú–∞–≥–∏—è —Ç—å–º—ã": 2 },
                limitations: {}
            },
            dwarf: {
                name: "‚õ∞Ô∏è –î–≤–∞—Ä—Ñ—ã",
                description: "–ü—Ä–∏—Ä–æ–∂–¥–µ–Ω–Ω—ã–µ –∫—É–∑–Ω–µ—Ü—ã, –≤–æ–∏–Ω—Å—Ç–≤–µ–Ω–Ω–∞—è —Ä–∞—Å–∞",
                lifespan: "600 –ª–µ—Ç",
                bonuses: { "–ö—É–∑–Ω–µ—á–Ω–æ–µ –¥–µ–ª–æ": 1 },
                limitations: { "–ö—É–∑–Ω–µ—á–Ω–æ–µ –¥–µ–ª–æ": 19, "–õ–æ–≤–∫–æ—Å—Ç—å": 19 }
            },
            gnome: {
                name: "üîÆ –ì–Ω–æ–º—ã", 
                description: "–ò–∑–æ–±—Ä–µ—Ç–∞—Ç–µ–ª—å–Ω—ã–µ –∏ –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–µ",
                lifespan: "800 –ª–µ—Ç",
                bonuses: { "–†–µ–º–µ—Å–ª–æ": 1 },
                limitations: { "–õ–æ–≤–∫–æ—Å—Ç—å": 19, "–í—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å": 19, "–†–µ–º–µ—Å–ª–æ": 19 }
            },
            orc: {
                name: "üíÄ –û—Ä–∫–∏",
                description: "–õ—É—á—à–∏–µ –±–æ–π—Ü—ã, –ø—Ä–µ–∑–∏—Ä–∞—é—Ç –º–∞–≥–∏—é",
                lifespan: "400 –ª–µ—Ç", 
                bonuses: { "–¢—è–∂—ë–ª–∞—è –±—Ä–æ–Ω—è": 1, "–î–≤—É—Ä—É—á–Ω–æ–µ –æ—Ä—É–∂–∏–µ": 1 },
                limitations: { "–¢—è–∂—ë–ª–∞—è –±—Ä–æ–Ω—è": 20, "–î–≤—É—Ä—É—á–Ω–æ–µ –æ—Ä—É–∂–∏–µ": 20 }
            },
            goblin: {
                name: "üëπ –ì–æ–±–ª–∏–Ω—ã",
                description: "–•–∏—Ç—Ä—ã–µ –∏ –±—ã—Å—Ç—Ä–æ —É—á–∞—Ç—Å—è, –Ω–µ –º–æ–≥—É—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –º–∞–≥–∏—é",
                lifespan: "25 –ª–µ—Ç", 
                bonuses: {},
                limitations: { 
                    "–ú–∞–≥–∏—è –≤–æ–¥—ã": 0, "–ú–∞–≥–∏—è –∑–µ–º–ª–∏": 0, "–ú–∞–≥–∏—è –≤–æ–∑–¥—É—Ö–∞": 0, "–ú–∞–≥–∏—è –æ–≥–Ω—è": 0, 
                    "–ú–∞–≥–∏—è –∫—Ä–æ–≤–∏": 0, "–ú–∞–≥–∏—è –º–µ—Ç–∞–ª–ª–∞": 0, "–ú–∞–≥–∏—è –ø—Ä–∏—Ä–æ–¥—ã": 0, "–ú–∞–≥–∏—è —Å–≤–µ—Ç–∞": 0, 
                    "–ú–∞–≥–∏—è —Ç—å–º—ã": 0, "–ú–∞–≥–∏—è –∏–Ω—Ñ–µ—Ä–Ω–æ": 0, "–ú–∞–≥–∏—è —Ö–∞–æ—Å–∞": 0, "–ú–∞–≥–∏—è —Ä–∞–∑—É–º–∞": 0, 
                    "–ú–∞–≥–∏—è –ñ–∏–∑–Ω–∏": 0, "–ú–∞–≥–∏—è —Å–º–µ—Ä—Ç–∏": 0, "–ú–∞–≥–∏—è –ø—É—Å—Ç–æ—Ç—ã": 0, "–ú–∞–≥–∏—è –≠–Ω–µ—Ä–≥–∏–∏": 0, 
                    "–ê–ª—Ö–∏–º–∏—è": 0, "–ó–∞—á–∞—Ä–æ–≤–∞–Ω–∏–µ": 0 
                }
            }
        };

        // –î–∏–∞–ø–∞–∑–æ–Ω—ã —Ä–æ—Å—Ç–∞ –¥–ª—è —Ä–∞—Å
        const raceHeightRanges = {
            atski: { min: 140, max: 210 },
            knofi: { min: 135, max: 205 },
            vorki: { min: 150, max: 220 },
            minci: { min: 130, max: 200 },
            kaei: { min: 140, max: 225 },
            forest_elf: { min: 150, max: 210 },
            high_elf: { min: 170, max: 270 },
            dark_elf: { min: 160, max: 230 },
            dwarf: { min: 110, max: 160 },
            gnome: { min: 40, max: 80 },
            orc: { min: 200, max: 350 },
            goblin: { min: 90, max: 150 }
        };

        // –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –Ω–∞–≤—ã–∫–æ–≤
        const skillsStructure = {
            "‚öîÔ∏è –ë–û–ï–í–´–ï –ù–ê–í–´–ö–ò": [
                "–¢—è–∂—ë–ª–∞—è –±—Ä–æ–Ω—è", "–õ—ë–≥–∫–∞—è –±—Ä–æ–Ω—è", "–î–≤—É—Ä—É—á–Ω–æ–µ –æ—Ä—É–∂–∏–µ", 
                "–û–¥–Ω–æ—Ä—É—á–Ω–æ–µ –æ—Ä—É–∂–∏–µ", "–°—Ç—Ä–µ–ª—å–±–∞", "–ë–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∏–µ", 
                "–î—Ä–µ–≤–∫–æ–≤–æ–µ", "–†—É–∫–æ–ø–∞—à–Ω—ã–π –±–æ–π", "–ú–µ—Ç–∞–Ω–∏–µ"
            ],
            "üé≠ –û–ë–©–ò–ï –ù–ê–í–´–ö–ò": [
                "–°–∫—Ä—ã—Ç–Ω–æ—Å—Ç—å", "–ö—Ä–∞—Å–Ω–æ—Ä–µ—á–∏–µ", "–õ–æ–≤–∫–æ—Å—Ç—å", "–í—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å",
                "–í–∑–ª–æ–º", "–í–æ—Å–ø—Ä–∏—è—Ç–∏–µ", "–£–¥–∞—á–∞", "–ö–∞—Ä–º–∞–Ω–Ω—ã–µ –∫—Ä–∞–∂–∏"
            ],
            "‚öóÔ∏è –†–ï–ú–ï–°–õ–ê": [
                "–ê–ª—Ö–∏–º–∏—è", "–ö—É–∑–Ω–µ—á–Ω–æ–µ –¥–µ–ª–æ", "–ó–∞—á–∞—Ä–æ–≤–∞–Ω–∏–µ", "–†–µ–º–µ—Å–ª–æ"
            ],
            "üîÆ –ú–ê–ì–ò–Ø": [
                "–ú–∞–≥–∏—è –≤–æ–¥—ã", "–ú–∞–≥–∏—è –∑–µ–º–ª–∏", "–ú–∞–≥–∏—è –≤–æ–∑–¥—É—Ö–∞", "–ú–∞–≥–∏—è –∫—Ä–æ–≤–∏",
                "–ú–∞–≥–∏—è –æ–≥–Ω—è", "–ú–∞–≥–∏—è –º–µ—Ç–∞–ª–ª–∞", "–ú–∞–≥–∏—è –ø—Ä–∏—Ä–æ–¥—ã", "–ú–∞–≥–∏—è —Å–≤–µ—Ç–∞",
                "–ú–∞–≥–∏—è —Ç—å–º—ã", "–ú–∞–≥–∏—è –∏–Ω—Ñ–µ—Ä–Ω–æ", "–ú–∞–≥–∏—è —Ö–∞–æ—Å–∞", "–ú–∞–≥–∏—è —Ä–∞–∑—É–º–∞",
                "–ú–∞–≥–∏—è –ñ–∏–∑–Ω–∏", "–ú–∞–≥–∏—è —Å–º–µ—Ä—Ç–∏", "–ú–∞–≥–∏—è –ø—É—Å—Ç–æ—Ç—ã", "–ú–∞–≥–∏—è –≠–Ω–µ—Ä–≥–∏–∏"
            ]
        };

        // –°–∏—Å—Ç–µ–º–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –º–∞–≥–∏—á–µ—Å–∫–∏—Ö —à–∫–æ–ª –ø–æ —Ä–∞—Å–∞–º
        let availableMagicSchools = {};
        const baseMagicSchools = ["–ú–∞–≥–∏—è –≤–æ–¥—ã", "–ú–∞–≥–∏—è –∑–µ–º–ª–∏", "–ú–∞–≥–∏—è –≤–æ–∑–¥—É—Ö–∞", "–ú–∞–≥–∏—è –æ–≥–Ω—è"];

        // –°–∏—Å—Ç–µ–º–∞ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è
        let inventoryCategories = [
            { id: 'weapons', name: '‚öîÔ∏è –û—Ä—É–∂–∏–µ', icon: '‚öîÔ∏è', editable: true },
            { id: 'armor', name: 'üõ°Ô∏è –ë—Ä–æ–Ω—è', icon: 'üõ°Ô∏è', editable: true },
            { id: 'potions', name: 'üß™ –ó–µ–ª—å—è', icon: 'üß™', editable: true },
            { id: 'scrolls', name: 'üìú –°–≤–∏—Ç–∫–∏', icon: 'üìú', editable: true },
            { id: 'resources', name: 'üíé –†–µ—Å—É—Ä—Å—ã', icon: 'üíé', editable: true },
            { id: 'valuables', name: 'üí∞ –¶–µ–Ω–Ω–æ—Å—Ç–∏', icon: 'üí∞', editable: true },
            { id: 'tools', name: 'üîß –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã', icon: 'üîß', editable: true },
            { id: 'other', name: 'üéí –ü—Ä–æ—á–µ–µ', icon: 'üéí', editable: true }
        ];

        let inventory = {
            weapons: [],
            armor: [],
            potions: [],
            scrolls: [],
            resources: [],
            valuables: [],
            tools: [],
            other: []
        };

        // –ò—Å—Ç–æ—Ä–∏—è –±—Ä–æ—Å–∫–æ–≤
        const rollHistory = {};

        // –°–∏—Å—Ç–µ–º–∞ –∏—Å—Ç–æ—Ä–∏–∏ –¥–µ–π—Å—Ç–≤–∏–π
        let actionHistory = [];
        let currentHistoryIndex = -1;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', function() {
            loadCharacterData();
            loadInventory();
            loadRollHistory();
            renderSkills();
            renderInventory();
            updateUI();
            updateLevelDisplay();
            updateHistoryButtons();
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤ –∏—Å—Ç–æ—Ä–∏—é
            setTimeout(saveStateToHistory, 1000);
        });

        // === –°–ò–°–¢–ï–ú–ê –†–ê–° –ò –ú–ê–ì–ò–ò ===
        function generateRandomHeight(raceId) {
            const range = raceHeightRanges[raceId];
            if (!range) return 170;
            
            const randomHeight = Math.floor(Math.random() * (range.max - range.min + 1)) + range.min;
            return randomHeight;
        }

        function onRaceChange() {
            const raceSelect = document.getElementById('characterRace');
            const raceId = raceSelect.value;
            
            if (raceId) {
                showRaceInfo(raceId);
                // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –∞–≤—Ç–æ-—Ä–æ—Å—Ç–∞ –ø—Ä–∏ —Å–º–µ–Ω–µ —Ä–∞—Å—ã
                document.getElementById('generateHeightBtn').disabled = false;
                document.getElementById('generateHeightBtn').style.background = 'linear-gradient(45deg, #8b4513, #d4af37)';
            }
        }

        function showRaceInfo(raceId) {
            if (!raceId) return;
            
            const race = races[raceId];
            const heightRange = raceHeightRanges[raceId];
            const popup = document.createElement('div');
            popup.className = 'result-popup';
            popup.innerHTML = `
                <div class="result-content" style="text-align: left; max-width: 600px;">
                    <h2 style="color: #d4af37; border-bottom: 2px solid #8b4513; padding-bottom: 10px;">${race.name}</h2>
                    <p style="margin: 15px 0;"><strong style="color: #d4af37;">–û–ø–∏—Å–∞–Ω–∏–µ:</strong> ${race.description}</p>
                    <p style="margin: 10px 0;"><strong style="color: #d4af37;">–†–æ—Å—Ç:</strong> ${heightRange.min}-${heightRange.max} —Å–º</p>
                    <p style="margin: 10px 0;"><strong style="color: #d4af37;">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∂–∏–∑–Ω–∏:</strong> ${race.lifespan}</p>
                    
                    ${Object.keys(race.bonuses).length > 0 ? `
                        <p style="margin: 15px 0 10px 0;"><strong style="color: #d4af37;">–ë–æ–Ω—É—Å—ã:</strong></p>
                        <ul style="margin-left: 20px; color: #e0d0c0;">
                            ${Object.entries(race.bonuses).map(([skill, bonus]) => 
                                `<li>${skill}: +${bonus}</li>`
                            ).join('')}
                        </ul>
                    ` : ''}
                    
                    ${Object.keys(race.limitations).length > 0 ? `
                        <p style="margin: 15px 0 10px 0;"><strong style="color: #d4af37;">–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è:</strong></p>
                        <ul style="margin-left: 20px; color: #e0d0c0;">
                            ${Object.entries(race.limitations).map(([skill, limit]) => 
                                `<li>${skill}: –º–∞–∫—Å–∏–º—É–º ${limit === 0 ? '–Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ' : limit}</li>`
                            ).join('')}
                        </ul>
                    ` : ''}
                    
                    <div style="display: flex; gap: 10px; margin-top: 25px;">
                        <button class="btn" onclick="setRace('${raceId}')" style="background: linear-gradient(45deg, #27ae60, #2ecc71); flex: 1; color: white;">‚úÖ –í—ã–±—Ä–∞—Ç—å —Ä–∞—Å—É</button>
                        <button class="btn" onclick="this.closest('.result-popup').remove()" style="background: linear-gradient(45deg, #34495e, #5d6d7e); flex: 1;">–ó–∞–∫—Ä—ã—Ç—å</button>
                    </div>
                </div>
            `;
            document.body.appendChild(popup);
        }

        function setRace(raceId) {
            const race = races[raceId];
            if (!race) return;
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞—Å—É
            document.getElementById('characterRace').value = raceId;
            
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–æ—Å—Ç
            const randomHeight = generateRandomHeight(raceId);
            document.getElementById('characterHeight').value = randomHeight;
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –≤–æ–∑—Ä–∞—Å—Ç (10% –æ—Ç –ø—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∂–∏–∑–Ω–∏)
            const lifespan = parseInt(race.lifespan);
            document.getElementById('characterAge').value = Math.max(15, Math.floor(lifespan * 0.1));
            
            // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É —Ä–æ—Å—Ç–∞ (–º–æ–∂–Ω–æ –Ω–∞–∂–∞—Ç—å —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑)
            document.getElementById('generateHeightBtn').disabled = true;
            document.getElementById('generateHeightBtn').style.background = '#5a3928';
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ –º–∞–≥–∏—á–µ—Å–∫–∏–µ —à–∫–æ–ª—ã
            determineAvailableMagicSchools(raceId);
            
            // –ü—Ä–∏–º–µ–Ω—è–µ–º –±–æ–Ω—É—Å—ã —Ä–∞—Å—ã
            applyRaceBonuses(raceId);
            
            saveCharacterData();
            
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º –ø–æ–ø–∞–ø
            document.querySelector('.result-popup')?.remove();
            
            alert(`‚úÖ –†–∞—Å–∞ "${race.name}" –≤—ã–±—Ä–∞–Ω–∞!\nüìè –†–æ—Å—Ç: ${randomHeight} —Å–º`);
        }

        function determineAvailableMagicSchools(raceId) {
            availableMagicSchools = {};
            
            switch(raceId) {
                case 'forest_elf':
                    // –¢–æ–ª—å–∫–æ –º–∞–≥–∏—è –ø—Ä–∏—Ä–æ–¥—ã
                    availableMagicSchools["–ú–∞–≥–∏—è –ø—Ä–∏—Ä–æ–¥—ã"] = true;
                    break;
                    
                case 'dark_elf':
                    // –¢–æ–ª—å–∫–æ –º–∞–≥–∏—è —Ç—å–º—ã
                    availableMagicSchools["–ú–∞–≥–∏—è —Ç—å–º—ã"] = true;
                    break;
                    
                case 'high_elf':
                    // –î–≤–µ —Å–ª—É—á–∞–π–Ω—ã–µ –∏–∑ —á–µ—Ç—ã—Ä–µ—Ö –±–∞–∑–æ–≤—ã—Ö —Å—Ç–∏—Ö–∏–π
                    const shuffled = [...baseMagicSchools].sort(() => 0.5 - Math.random());
                    availableMagicSchools[shuffled[0]] = true;
                    availableMagicSchools[shuffled[1]] = true;
                    break;
                    
                case 'goblin':
                    // –ù–∏–∫–∞–∫–æ–π –º–∞–≥–∏–∏
                    break;
                    
                default:
                    // –í—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ä–∞—Å—ã - –æ–¥–Ω–∞ —Å–ª—É—á–∞–π–Ω–∞—è –±–∞–∑–æ–≤–∞—è —Å—Ç–∏—Ö–∏—è
                    const randomSchool = baseMagicSchools[Math.floor(Math.random() * baseMagicSchools.length)];
                    availableMagicSchools[randomSchool] = true;
            }
            
            // –ü—Ä–∏–º–µ–Ω—è–µ–º –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è —Ä–∞—Å—ã
            const race = races[raceId];
            if (race && race.limitations) {
                Object.keys(race.limitations).forEach(school => {
                    if (race.limitations[school] === 0) {
                        availableMagicSchools[school] = false;
                    }
                });
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–∞–≤—ã–∫–æ–≤
            updateMagicSkillsDisplay();
        }

        function updateMagicSkillsDisplay() {
            const magicSkills = skillsStructure["üîÆ –ú–ê–ì–ò–Ø"];
            magicSkills.forEach(skill => {
                const skillElement = document.getElementById(`skill-${skill}`);
                if (skillElement) {
                    const skillRow = skillElement.closest('.skill-row');
                    const isAvailable = availableMagicSchools[skill] || getSkillValue(skill) > 5;
                    
                    if (isAvailable) {
                        skillRow.classList.remove('skill-disabled');
                    } else {
                        skillRow.classList.add('skill-disabled');
                    }
                }
            });
        }

        function applyRaceBonuses(raceId) {
            const race = races[raceId];
            if (!race || !race.bonuses) return;
            
            // –ü—Ä–∏–º–µ–Ω—è–µ–º –±–æ–Ω—É—Å—ã –∫ –Ω–∞–≤—ã–∫–∞–º
            Object.entries(race.bonuses).forEach(([skill, bonus]) => {
                const currentValue = getSkillValue(skill);
                setSkillValue(skill, currentValue + bonus);
            });
            
            updateUI();
        }

        function generateHeightForSelectedRace() {
            const selectedRace = document.getElementById('characterRace').value;
            if (!selectedRace) {
                alert('‚ùå –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —Ä–∞—Å—É!');
                return;
            }
            
            const randomHeight = generateRandomHeight(selectedRace);
            document.getElementById('characterHeight').value = randomHeight;
            
            // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –ø–æ—Å–ª–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
            document.getElementById('generateHeightBtn').disabled = true;
            document.getElementById('generateHeightBtn').style.background = '#5a3928';
            
            saveCharacterData();
            
            alert(`üìè –ù–æ–≤—ã–π —Ä–æ—Å—Ç: ${randomHeight} —Å–º`);
        }

        function checkSkillLimit(skillName, newValue) {
            const selectedRaceId = document.getElementById('characterRace').value;
            if (!selectedRaceId) return true;
            
            const race = races[selectedRaceId];
            if (!race || !race.limitations) return true;
            
            const limitation = race.limitations[skillName];
            
            if (limitation === 0 && !availableMagicSchools[skillName] && newValue > 5) {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –º–∞—Å—Ç–µ—Ä–∞
                const masterPermission = confirm(
                    `üîÆ –í—ã –ø—ã—Ç–∞–µ—Ç–µ—Å—å –∏–∑—É—á–∏—Ç—å –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—É—é –º–∞–≥–∏—é!\n\n` +
                    `–ù–∞–≤—ã–∫ "${skillName}" –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è –≤–∞—à–µ–π —Ä–∞—Å—ã.\n` +
                    `–í—ã –ø–æ–ª—É—á–∏–ª–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –ú–∞—Å—Ç–µ—Ä–∞ –Ω–∞ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫—É —ç—Ç–æ–π –º–∞–≥–∏–∏?\n\n` +
                    `–ù–∞–∂–º–∏—Ç–µ "–û–ö" –¥–ª—è —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ (–Ω–∞–≤—ã–∫ —Å—Ç–∞–Ω–µ—Ç 5 —É—Ä–æ–≤–Ω—è) –∏–ª–∏ "–û—Ç–º–µ–Ω–∞" –¥–ª—è –æ—Ç–º–µ–Ω—ã.`
                );
                
                if (masterPermission) {
                    // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –º–∞–≥–∏—é –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–∞ 5 —É—Ä–æ–≤–µ–Ω—å
                    availableMagicSchools[skillName] = true;
                    setSkillValue(skillName, 5);
                    updateMagicSkillsDisplay();
                    updateUI();
                    saveCharacterData();
                    return false;
                }
                return false;
            }
            
            if (limitation && newValue > limitation) {
                const confirmUpgrade = confirm(
                    `‚ö†Ô∏è –í—ã –ø—Ä–µ–≤—ã—à–∞–µ—Ç–µ –ª–∏–º–∏—Ç —Ä–∞—Å—ã –¥–ª—è –Ω–∞–≤—ã–∫–∞ "${skillName}"!\n\n` +
                    `–ú–∞–∫—Å–∏–º—É–º –¥–ª—è ${race.name}: ${limitation}\n` +
                    `–í—ã –ø—ã—Ç–∞–µ—Ç–µ—Å—å –ø–æ–≤—ã—Å–∏—Ç—å –¥–æ: ${newValue}\n\n` +
                    `–í—Å—ë —Ä–∞–≤–Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å?`
                );
                
                return confirmUpgrade;
            }
            
            return true;
        }

        // –°–∏—Å—Ç–µ–º–∞ –≤–∫–ª–∞–¥–æ–∫
        function openTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            document.getElementById(tabName + '-tab').classList.add('active');
            event.currentTarget.classList.add('active');
        }

        // === –°–ò–°–¢–ï–ú–ê –ò–ù–í–ï–ù–¢–ê–†–Ø ===
        function loadInventory() {
            const saved = localStorage.getItem('inventoryData');
            if (saved) {
                const data = JSON.parse(saved);
                inventory = data.inventory || inventory;
                inventoryCategories = data.categories || inventoryCategories;
            }
        }

        function saveInventory() {
            const data = {
                inventory: inventory,
                categories: inventoryCategories
            };
            localStorage.setItem('inventoryData', JSON.stringify(data));
        }

        function renderInventory() {
            const container = document.getElementById('inventory-tab');
            if (!container) return;

            container.innerHTML = `
                <div class="inventory-container">
                    <h2 style="color: #d4af37; text-align: center; margin-bottom: 25px; text-shadow: 2px 2px 4px #000;">üéí –ò–ù–í–ï–ù–¢–ê–†–¨ –ü–ï–†–°–û–ù–ê–ñ–ê</h2>
                    <div style="margin-bottom: 25px; display: flex; gap: 12px; flex-wrap: wrap; justify-content: center;">
                        <button class="btn" onclick="showCategoryManager()" style="background: linear-gradient(45deg, #34495e, #5d6d7e);">‚öôÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏</button>
                        <button class="btn" onclick="addItem()" style="background: linear-gradient(45deg, #27ae60, #2ecc71);">‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–µ–¥–º–µ—Ç</button>
                    </div>
                    
                    <div id="inventory-categories">
                        ${inventoryCategories.map(category => `
                            <div class="category-section">
                                <div class="category-header">
                                    <h3>${category.name}</h3>
                                    <div class="item-actions">
                                        <button class="btn btn-small" onclick="addItemToCategory('${category.id}')" style="background: linear-gradient(45deg, #27ae60, #2ecc71);">‚ûï</button>
                                        ${category.editable ? `
                                            <button class="btn btn-small" onclick="editCategory('${category.id}')" style="background: linear-gradient(45deg, #34495e, #5d6d7e);">‚úèÔ∏è</button>
                                            <button class="btn btn-small" onclick="deleteCategory('${category.id}')" style="background: linear-gradient(45deg, #c44536, #e74c3c);">‚ùå</button>
                                        ` : ''}
                                    </div>
                                </div>
                                <div class="category-items" id="items-${category.id}">
                                    ${renderCategoryItems(category.id)}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function renderCategoryItems(categoryId) {
            const items = inventory[categoryId] || [];
            if (items.length === 0) {
                return '<p style="color: #8b7d6b; text-align: center; padding: 30px; font-style: italic;">–°–≤–∏—Ç–æ–∫ –ø—É—Å—Ç...</p>';
            }
            
            return items.map((item, index) => `
                <div class="item-row">
                    <div class="item-info">
                        <div class="item-name">${item.name}</div>
                        <div class="item-details">${item.details || ''} ${item.quantity ? '√ó' + item.quantity : ''}</div>
                    </div>
                    <div class="item-actions">
                        <button class="btn btn-small" onclick="editInventoryItem('${categoryId}', ${index})" style="background: linear-gradient(45deg, #34495e, #5d6d7e);">‚úèÔ∏è</button>
                        <button class="btn btn-small" onclick="deleteInventoryItem('${categoryId}', ${index})" style="background: linear-gradient(45deg, #c44536, #e74c3c);">‚ùå</button>
                    </div>
                </div>
            `).join('');
        }

        function showCategoryManager() {
            const popup = document.createElement('div');
            popup.className = 'inventory-popup';
            popup.innerHTML = `
                <div class="inventory-content">
                    <h2 style="color: #d4af37; margin-bottom: 20px;">‚öôÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏</h2>
                    <div style="text-align: left; margin: 25px 0;">
                        ${inventoryCategories.map(category => `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid #5a3928;">
                                <span style="color: #e0d0c0;">${category.name}</span>
                                ${category.editable ? `
                                    <div>
                                        <button class="btn btn-small" onclick="editCategory('${category.id}')" style="background: linear-gradient(45deg, #34495e, #5d6d7e);">‚úèÔ∏è</button>
                                        <button class="btn btn-small" onclick="deleteCategory('${category.id}')" style="background: linear-gradient(45deg, #c44536, #e74c3c);">‚ùå</button>
                                    </div>
                                ` : '<span style="color: #8b7d6b; font-style: italic;">–°–∏—Å—Ç–µ–º–Ω–∞—è</span>'}
                            </div>
                        `).join('')}
                    </div>
                    <button class="btn" onclick="addCategory()" style="background: linear-gradient(45deg, #27ae60, #2ecc71); margin-bottom: 15px;">‚ûï –î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é</button>
                    <button class="btn" onclick="this.closest('.inventory-popup').remove()" style="background: linear-gradient(45deg, #34495e, #5d6d7e);">–ó–∞–∫—Ä—ã—Ç—å</button>
                </div>
            `;
            document.body.appendChild(popup);
        }

        function addCategory() {
            const categoryName = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏:');
            if (categoryName) {
                const categoryId = 'category_' + Date.now();
                const categoryIcon = 'üìÅ';
                
                inventoryCategories.push({
                    id: categoryId,
                    name: categoryIcon + ' ' + categoryName,
                    icon: categoryIcon,
                    editable: true
                });
                
                inventory[categoryId] = [];
                saveInventory();
                renderInventory();
                document.querySelector('.inventory-popup')?.remove();
            }
        }

        function editCategory(categoryId) {
            const category = inventoryCategories.find(cat => cat.id === categoryId);
            if (category && category.editable) {
                const newName = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏:', category.name.replace(category.icon + ' ', ''));
                if (newName) {
                    category.name = category.icon + ' ' + newName;
                    saveInventory();
                    renderInventory();
                }
            }
        }

        function deleteCategory(categoryId) {
            const category = inventoryCategories.find(cat => cat.id === categoryId);
            if (category && category.editable) {
                if ((inventory[categoryId] || []).length === 0) {
                    if (confirm(`–£–¥–∞–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é "${category.name}"?`)) {
                        inventoryCategories = inventoryCategories.filter(cat => cat.id !== categoryId);
                        delete inventory[categoryId];
                        saveInventory();
                        renderInventory();
                        document.querySelector('.inventory-popup')?.remove();
                    }
                } else {
                    alert('–ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é —Å –ø—Ä–µ–¥–º–µ—Ç–∞–º–∏!');
                }
            }
        }

        function addItem() {
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –≤—ã–±–æ—Ä –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
            let categoryOptions = '';
            inventoryCategories.forEach(category => {
                categoryOptions += `<option value="${category.id}">${category.name}</option>`;
            });
            
            const categoryId = prompt(`–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é:\n\n${inventoryCategories.map((cat, index) => `${index + 1}. ${cat.name}`).join('\n')}\n\n–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –∫–∞—Ç–µ–≥–æ—Ä–∏–∏:`);
            
            if (categoryId) {
                const categoryIndex = parseInt(categoryId) - 1;
                if (categoryIndex >= 0 && categoryIndex < inventoryCategories.length) {
                    const selectedCategory = inventoryCategories[categoryIndex];
                    addItemToCategory(selectedCategory.id);
                } else {
                    alert('–ù–µ–≤–µ—Ä–Ω—ã–π –Ω–æ–º–µ—Ä –∫–∞—Ç–µ–≥–æ—Ä–∏–∏!');
                }
            }
        }

        function addItemToCategory(categoryId) {
            const category = inventoryCategories.find(cat => cat.id === categoryId);
            if (!category) return;
            
            const name = prompt(`–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–µ–¥–º–µ—Ç –≤ –∫–∞—Ç–µ–≥–æ—Ä–∏—é "${category.name}":\n\n–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–∞:`);
            if (name) {
                const details = prompt('–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–∞ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):') || '';
                const quantity = prompt('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):') || '1';
                
                if (!inventory[categoryId]) {
                    inventory[categoryId] = [];
                }
                
                inventory[categoryId].push({
                    name: name,
                    details: details,
                    quantity: quantity,
                    added: new Date().toLocaleDateString()
                });
                
                saveInventory();
                renderInventory();
            }
        }

        function editInventoryItem(categoryId, index) {
            const item = inventory[categoryId][index];
            const newName = prompt('–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–∞:', item.name);
            if (newName) {
                const newDetails = prompt('–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–∞:', item.details);
                const newQuantity = prompt('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:', item.quantity);
                
                inventory[categoryId][index] = {
                    ...item,
                    name: newName,
                    details: newDetails || '',
                    quantity: newQuantity || ''
                };
                
                saveInventory();
                renderInventory();
            }
        }

        function deleteInventoryItem(categoryId, index) {
            if (confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –ø—Ä–µ–¥–º–µ—Ç?')) {
                inventory[categoryId].splice(index, 1);
                saveInventory();
                renderInventory();
            }
        }

        // === –°–ò–°–¢–ï–ú–ê –ü–ï–†–°–û–ù–ê–ñ–ê ===
        function renderSkills() {
            const container = document.getElementById('skillsContainer');
            if (!container) return;
            
            container.innerHTML = '';

            for (const [groupName, skills] of Object.entries(skillsStructure)) {
                const section = document.createElement('div');
                section.className = 'skills-section';
                
                const title = document.createElement('div');
                title.className = 'section-title';
                title.innerHTML = groupName;
                section.appendChild(title);

                skills.forEach(skill => {
                    const skillRow = document.createElement('div');
                    skillRow.className = 'skill-row';
                    skillRow.innerHTML = `
                        <div class="skill-name"><span>üéØ</span><span>${skill}</span></div>
                        <div class="skill-controls">
                            <button class="btn btn-minus" onclick="decreaseSkill('${skill}')" disabled>-</button>
                            <span class="skill-value" id="skill-${skill}">5</span>
                            <button class="btn btn-plus" onclick="increaseSkill('${skill}')">+</button>
                            <button class="btn btn-roll" onclick="rollSkill('${skill}')">–ë—Ä–æ—Å–æ–∫</button>
                        </div>
                    `;
                    section.appendChild(skillRow);
                });
                container.appendChild(section);
            }
            updateUI();
        }

        // –°–∏—Å—Ç–µ–º–∞ –Ω–∞–≤—ã–∫–æ–≤
        function increaseSkill(skillName) {
            if (!checkSkillLimit(skillName, getSkillValue(skillName) + 1)) {
                return;
            }
            
            saveStateToHistory();
            const freePoints = getFreePoints();
            if (freePoints > 0) {
                const skillValue = getSkillValue(skillName);
                setSkillValue(skillName, skillValue + 1);
                setFreePoints(freePoints - 1);
                updateUI();
                saveCharacterData();
            }
        }

        function decreaseSkill(skillName) {
            saveStateToHistory();
            const skillValue = getSkillValue(skillName);
            if (skillValue > 5) {
                const freePoints = getFreePoints();
                setSkillValue(skillName, skillValue - 1);
                setFreePoints(freePoints + 1);
                updateUI();
                saveCharacterData();
            }
        }

        // –°–∏—Å—Ç–µ–º–∞ –±—Ä–æ—Å–∫–æ–≤
        function rollSkill(skillName) {
            const skillValue = getSkillValue(skillName);
            const roll1 = Math.floor(Math.random() * 6) + 1;
            const roll2 = Math.floor(Math.random() * 6) + 1;
            const roll3 = Math.floor(Math.random() * 6) + 1;
            const totalRoll = roll1 + roll2 + roll3;

            let resultType, resultText, resultClass;
            if (totalRoll === 3 || totalRoll === 4) {
                resultText = "üí´ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –£–°–ü–ï–•!";
                resultClass = "critical-success";
            } else if (totalRoll === 17 || totalRoll === 18) {
                resultText = "üí• –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –ü–†–û–í–ê–õ!";
                resultClass = "critical-failure";
            } else if (totalRoll <= skillValue) {
                resultText = "‚úÖ –£–°–ü–ï–•!";
                resultClass = "success";
            } else {
                resultText = "‚ùå –ù–ï–£–î–ê–ß–ê!";
                resultClass = "failure";
            }

            addToRollHistory(skillName, [roll1, roll2, roll3], totalRoll, totalRoll <= skillValue);
            showRollResult(skillName, skillValue, [roll1, roll2, roll3], totalRoll, resultText, resultClass);
        }

        function showRollResult(skillName, skillValue, dice, total, resultText, resultClass) {
            const popup = document.createElement('div');
            popup.className = 'result-popup';
            popup.innerHTML = `
                <div class="result-content">
                    <h2 style="color: #d4af37;">–ë—Ä–æ—Å–æ–∫ –Ω–∞ "${skillName}" (${skillValue})</h2>
                    <div class="dice-rolls">
                        <div class="dice">${dice[0]}</div>
                        <div class="dice">${dice[1]}</div>
                        <div class="dice">${dice[2]}</div>
                    </div>
                    <div style="font-size: 1.5em; margin: 20px 0; color: #e0d0c0;">${dice.join(' + ')} = ${total}</div>
                    <div class="${resultClass}">${resultText}</div>
                    <div style="margin-top: 25px; display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
                        <button class="btn" onclick="rollSkill('${skillName}'); this.closest('.result-popup').remove()" style="background: linear-gradient(45deg, #8b4513, #d4af37); color: #1a0f0b; font-weight: bold;">üé≤ –ë—Ä–æ—Å–∏—Ç—å –µ—â—ë</button>
                        <button class="btn" onclick="showRollHistory('${skillName}')" style="background: linear-gradient(45deg, #6c3483, #8e44ad); color: white;">üìú –ò—Å—Ç–æ—Ä–∏—è</button>
                        <button class="btn" onclick="this.closest('.result-popup').remove()" style="background: linear-gradient(45deg, #34495e, #5d6d7e); color: white;">–ó–∞–∫—Ä—ã—Ç—å</button>
                    </div>
                </div>
            `;
            document.body.appendChild(popup);
        }

        function loadRollHistory() {
            const saved = localStorage.getItem('rollHistory');
            if (saved) {
                Object.assign(rollHistory, JSON.parse(saved));
            }
        }

        function addToRollHistory(skillName, dice, total, success) {
            if (!rollHistory[skillName]) {
                rollHistory[skillName] = [];
            }
            
            rollHistory[skillName].unshift({
                dice: dice,
                total: total,
                success: success,
                timestamp: new Date().toLocaleTimeString()
            });
            
            if (rollHistory[skillName].length > 10) {
                rollHistory[skillName].pop();
            }
            
            localStorage.setItem('rollHistory', JSON.stringify(rollHistory));
        }

        function showRollHistory(skillName) {
            const history = rollHistory[skillName] || [];
            let historyHTML = '<h3 style="color: #d4af37; margin-bottom: 20px;">–ò—Å—Ç–æ—Ä–∏—è –±—Ä–æ—Å–∫–æ–≤ "' + skillName + '"</h3>';
            
            if (history.length === 0) {
                historyHTML += '<p style="color: #8b7d6b; font-style: italic;">–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π –æ –±—Ä–æ—Å–∫–∞—Ö</p>';
            } else {
                historyHTML += '<div style="text-align: left; max-height: 200px; overflow-y: auto; color: #e0d0c0;">';
                history.forEach((roll, index) => {
                    const resultIcon = roll.total === 3 || roll.total === 4 ? 'üí´' : 
                                     roll.total === 17 || roll.total === 18 ? 'üí•' :
                                     roll.success ? '‚úÖ' : '‚ùå';
                    historyHTML += `<p style="padding: 8px; border-bottom: 1px solid #3d2418;">${index + 1}. [${roll.dice.join(',')}] = ${roll.total} ${resultIcon} <span style="color: #8b7d6b; font-size: 0.9em;">(${roll.timestamp})</span></p>`;
                });
                historyHTML += '</div>';
            }
            
            const popup = document.createElement('div');
            popup.className = 'result-popup';
            popup.innerHTML = `
                <div class="result-content">
                    ${historyHTML}
                    <button class="btn close-btn" onclick="this.closest('.result-popup').remove()" style="background: linear-gradient(45deg, #34495e, #5d6d7e); color: white; padding: 12px 30px; margin-top: 20px;">–ó–∞–∫—Ä—ã—Ç—å</button>
                </div>
            `;
            document.body.appendChild(popup);
        }

        // –°–∏—Å—Ç–µ–º–∞ —É—Ä–æ–≤–Ω–µ–π
        function addExperience() {
            saveStateToHistory();
            const expToAdd = prompt('–°–∫–æ–ª—å–∫–æ –æ–ø—ã—Ç–∞ –¥–æ–±–∞–≤–∏—Ç—å?');
            if (expToAdd && !isNaN(expToAdd)) {
                let currentExp = getCurrentExp();
                const currentLevel = getCurrentLevel();
                
                currentExp += parseInt(expToAdd);
                setCurrentExp(currentExp);
                
                checkLevelUp();
                updateLevelDisplay();
                saveCharacterData();
            }
        }

        function checkLevelUp() {
            let currentLevel = getCurrentLevel();
            let currentExp = getCurrentExp();
            
            if (currentLevel >= 9) return;
            
            while (currentLevel < 9 && currentExp >= levelTable[currentLevel].expRequired) {
                currentLevel++;
                
                const health = getHealth() + levelTable[currentLevel].hp;
                const mana = getMana() + levelTable[currentLevel].mana;
                const stamina = getStamina() + levelTable[currentLevel].stamina;
                const freePoints = getFreePoints() + levelTable[currentLevel].points;
                
                setHealth(health);
                setMana(mana);
                setStamina(stamina);
                setFreePoints(freePoints);
                
                currentExp = currentExp - levelTable[currentLevel-1].expRequired;
                setCurrentExp(currentExp);
                
                setCurrentLevel(currentLevel);
                
                showMessage(`üéâ –£—Ä–æ–≤–µ–Ω—å –ø–æ–≤—ã—à–µ–Ω –¥–æ ${currentLevel}!`);
            }
        }

        function editLevel() {
            saveStateToHistory();
            const newLevel = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π —É—Ä–æ–≤–µ–Ω—å (0-9):', getCurrentLevel());
            if (newLevel && !isNaN(newLevel) && newLevel >= 0 && newLevel <= 9) {
                setCurrentLevel(parseInt(newLevel));
                updateStatsForLevel();
                updateLevelDisplay();
                saveCharacterData();
            }
        }

        function updateStatsForLevel() {
            const currentLevel = getCurrentLevel();
            let totalHP = 100, totalMana = 100, totalStamina = 100;
            
            for (let i = 0; i <= currentLevel; i++) {
                totalHP += levelTable[i].hp;
                totalMana += levelTable[i].mana;
                totalStamina += levelTable[i].stamina;
            }
            
            setHealth(totalHP);
            setMana(totalMana);
            setStamina(totalStamina);
        }

        function convertExpToPoints() {
            saveStateToHistory();
            const currentExp = getCurrentExp();
            const availablePoints = Math.floor(currentExp / 1000);
            
            if (availablePoints > 0) {
                const expToConvert = availablePoints * 1000;
                setCurrentExp(currentExp - expToConvert);
                setFreePoints(getFreePoints() + availablePoints);
                
                showMessage(`üíé –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ ${availablePoints} –æ—á–∫–æ–≤ –Ω–∞–≤—ã–∫–æ–≤!`);
                updateLevelDisplay();
                updateUI();
                saveCharacterData();
            }
        }

        function updateLevelDisplay() {
            const currentLevel = getCurrentLevel();
            const currentExp = getCurrentExp();
            const convertBtn = document.getElementById('convertBtn');
            const convertInfo = document.getElementById('convertInfo');
            
            document.getElementById('currentLevel').textContent = currentLevel;
            document.getElementById('currentExp').value = currentExp;
            
            if (currentLevel < 9) {
                document.getElementById('requiredExp').textContent = levelTable[currentLevel].expRequired;
                convertBtn.style.display = 'none';
                convertInfo.style.display = 'none';
            } else {
                document.getElementById('requiredExp').textContent = 'MAX';
                convertBtn.style.display = 'block';
                convertInfo.style.display = 'block';
            }
        }

        function showLevelsTable() {
            const currentLevel = getCurrentLevel();
            const popup = document.createElement('div');
            popup.className = 'levels-popup';
            popup.innerHTML = `
                <div class="levels-content">
                    <h2 style="color: #d4af37; margin-bottom: 20px;">üìä –¢–∞–±–ª–∏—Ü–∞ —É—Ä–æ–≤–Ω–µ–π</h2>
                    <table class="levels-table">
                        <tr><th>–£—Ä.</th><th>–û–ø—ã—Ç</th><th>–•–ü</th><th>–ú–∞–Ω–∞</th><th>–°—Ç–∞–º–∏–Ω–∞</th><th>–û—á–∫–∏</th></tr>
                        ${Object.entries(levelTable).map(([level, data]) => `
                            <tr class="${level == currentLevel ? 'current-level' : ''}">
                                <td>${level}</td>
                                <td>${data.expRequired || 'MAX'}</td>
                                <td>+${data.hp}</td>
                                <td>+${data.mana}</td>
                                <td>+${data.stamina}</td>
                                <td>+${data.points}</td>
                            </tr>
                        `).join('')}
                    </table>
                    <button class="btn close-btn" onclick="this.closest('.levels-popup').remove()" style="background: linear-gradient(45deg, #34495e, #5d6d7e); color: white; padding: 12px 30px; margin-top: 20px;">–ó–∞–∫—Ä—ã—Ç—å</button>
                </div>
            `;
            document.body.appendChild(popup);
        }

        // –°–∏—Å—Ç–µ–º–∞ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫
        function changeStat(stat, value) {
            saveStateToHistory();
            const input = document.getElementById(stat);
            let currentValue = parseInt(input.value) || 0;
            let newValue = currentValue + value;
            
            if (newValue < 0) newValue = 0;
            
            input.value = newValue;
            saveCharacterData();
        }

        function editFreePoints() {
            saveStateToHistory();
            const newPoints = prompt('–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–≤–æ–±–æ–¥–Ω—ã—Ö –æ—á–∫–æ–≤:', getFreePoints());
            if (newPoints && !isNaN(newPoints)) {
                setFreePoints(parseInt(newPoints));
                updateUI();
                saveCharacterData();
            }
        }

        // –ò—Å—Ç–æ—Ä–∏—è –¥–µ–π—Å—Ç–≤–∏–π
        function saveStateToHistory() {
            const state = {
                level: getCurrentLevel(),
                exp: getCurrentExp(),
                health: getHealth(),
                mana: getMana(),
                stamina: getStamina(),
                freePoints: getFreePoints(),
                skills: {}
            };

            for (const group of Object.values(skillsStructure)) {
                for (const skill of group) {
                    state.skills[skill] = getSkillValue(skill);
                }
            }

            actionHistory = actionHistory.slice(0, currentHistoryIndex + 1);
            actionHistory.push(state);
            currentHistoryIndex = actionHistory.length - 1;
            updateHistoryButtons();
        }

        function undo() {
            if (currentHistoryIndex > 0) {
                currentHistoryIndex--;
                loadStateFromHistory();
            }
        }

        function redo() {
            if (currentHistoryIndex < actionHistory.length - 1) {
                currentHistoryIndex++;
                loadStateFromHistory();
            }
        }

        function loadStateFromHistory() {
            const state = actionHistory[currentHistoryIndex];
            
            setCurrentLevel(state.level);
            setCurrentExp(state.exp);
            setHealth(state.health);
            setMana(state.mana);
            setStamina(state.stamina);
            setFreePoints(state.freePoints);
            
            for (const [skill, value] of Object.entries(state.skills)) {
                setSkillValue(skill, value);
            }
            
            updateLevelDisplay();
            updateUI();
            updateHistoryButtons();
        }

        function updateHistoryButtons() {
            const undoBtn = document.getElementById('undoBtn');
            const redoBtn = document.getElementById('redoBtn');
            if (undoBtn && redoBtn) {
                undoBtn.disabled = currentHistoryIndex <= 0;
                redoBtn.disabled = currentHistoryIndex >= actionHistory.length - 1;
            }
        }

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        function updateUI() {
            const freePoints = getFreePoints();
            const warning = document.getElementById('pointsWarning');
            if (warning) {
                warning.style.display = freePoints === 0 ? 'block' : 'none';
            }
            
            document.querySelectorAll('.skill-row').forEach(row => {
                const skillName = row.querySelector('.skill-name span:nth-child(2)').textContent;
                const skillValue = getSkillValue(skillName);
                const minusBtn = row.querySelector('.btn-minus');
                const plusBtn = row.querySelector('.btn-plus');
                
                row.querySelector('.skill-value').textContent = skillValue;
                minusBtn.disabled = skillValue <= 5;
                plusBtn.disabled = freePoints <= 0;
            });
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –º–∞–≥–∏—á–µ—Å–∫–∏—Ö –Ω–∞–≤—ã–∫–æ–≤
            updateMagicSkillsDisplay();
        }

        function showMessage(text) {
            alert(text);
        }

        // –ì–µ—Ç—Ç–µ—Ä—ã/—Å–µ—Ç—Ç–µ—Ä—ã
        function getFreePoints() { 
            const element = document.getElementById('freePoints');
            return element ? parseInt(element.value) || 0 : 0; 
        }

        function setFreePoints(value) { 
            const element = document.getElementById('freePoints');
            if (element) element.value = value; 
        }

        function getCurrentLevel() { return parseInt(localStorage.getItem('currentLevel')) || 0; }
        function setCurrentLevel(value) { localStorage.setItem('currentLevel', value); }

        function getCurrentExp() { return parseInt(localStorage.getItem('currentExp')) || 0; }
        function setCurrentExp(value) { localStorage.setItem('currentExp', value); }

        function getHealth() { 
            const element = document.getElementById('health');
            return element ? parseInt(element.value) || 100 : 100; 
        }

        function setHealth(value) { 
            const element = document.getElementById('health');
            if (element) element.value = value; 
        }

        function getMana() { 
            const element = document.getElementById('mana');
            return element ? parseInt(element.value) || 100 : 100; 
        }

        function setMana(value) { 
            const element = document.getElementById('mana');
            if (element) element.value = value; 
        }

        function getStamina() { 
            const element = document.getElementById('stamina');
            return element ? parseInt(element.value) || 100 : 100; 
        }

        function setStamina(value) { 
            const element = document.getElementById('stamina');
            if (element) element.value = value; 
        }

        function getSkillValue(skillName) { return parseInt(localStorage.getItem(`skill_${skillName}`)) || 5; }
        function setSkillValue(skillName, value) { localStorage.setItem(`skill_${skillName}`, value); }

        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ/–∑–∞–≥—Ä—É–∑–∫–∞
        function saveCharacterData() {
            localStorage.setItem('characterName', document.getElementById('characterName').value);
            localStorage.setItem('characterSurname', document.getElementById('characterSurname').value);
            localStorage.setItem('characterTitle', document.getElementById('characterTitle').value);
            localStorage.setItem('characterRace', document.getElementById('characterRace').value);
            localStorage.setItem('characterHeritage', document.getElementById('characterHeritage').value);
            localStorage.setItem('characterHeight', document.getElementById('characterHeight').value);
            localStorage.setItem('characterWeight', document.getElementById('characterWeight').value);
            localStorage.setItem('characterAge', document.getElementById('characterAge').value);
            localStorage.setItem('availableMagicSchools', JSON.stringify(availableMagicSchools));
        }

        function loadCharacterData() {
            document.getElementById('characterName').value = localStorage.getItem('characterName') || '';
            document.getElementById('characterSurname').value = localStorage.getItem('characterSurname') || '';
            document.getElementById('characterTitle').value = localStorage.getItem('characterTitle') || '';
            document.getElementById('characterRace').value = localStorage.getItem('characterRace') || '';
            document.getElementById('characterHeritage').value = localStorage.getItem('characterHeritage') || '';
            document.getElementById('characterHeight').value = localStorage.getItem('characterHeight') || '';
            document.getElementById('characterWeight').value = localStorage.getItem('characterWeight') || '';
            document.getElementById('characterAge').value = localStorage.getItem('characterAge') || '';
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ –º–∞–≥–∏—á–µ—Å–∫–∏–µ —à–∫–æ–ª—ã
            const savedMagicSchools = localStorage.getItem('availableMagicSchools');
            if (savedMagicSchools) {
                availableMagicSchools = JSON.parse(savedMagicSchools);
            }
            
            // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É —Ä–æ—Å—Ç–∞ –µ—Å–ª–∏ —Ä–∞—Å–∞ —É–∂–µ –≤—ã–±—Ä–∞–Ω–∞
            if (localStorage.getItem('characterRace')) {
                document.getElementById('generateHeightBtn').disabled = true;
                document.getElementById('generateHeightBtn').style.background = '#5a3928';
            }
        }

        // –°–ª—É—à–∞—Ç–µ–ª–∏
        document.getElementById('characterName').addEventListener('input', saveCharacterData);
        document.getElementById('characterSurname').addEventListener('input', saveCharacterData);
        document.getElementById('characterTitle').addEventListener('input', saveCharacterData);
        document.getElementById('characterRace').addEventListener('change', saveCharacterData);
        document.getElementById('characterHeritage').addEventListener('input', saveCharacterData);
        document.getElementById('characterHeight').addEventListener('input', saveCharacterData);
        document.getElementById('characterWeight').addEventListener('input', saveCharacterData);
        document.getElementById('characterAge').addEventListener('input', saveCharacterData);
        document.getElementById('health').addEventListener('input', saveCharacterData);
        document.getElementById('mana').addEventListener('input', saveCharacterData);
        document.getElementById('stamina').addEventListener('input', saveCharacterData);
        document.getElementById('freePoints').addEventListener('input', function() {
            updateUI();
            saveCharacterData();
        });
        document.getElementById('currentExp').addEventListener('input', function() {
            setCurrentExp(parseInt(this.value) || 0);
            checkLevelUp();
            updateLevelDisplay();
            saveCharacterData();
        });
    </script>
</body>
</html>
