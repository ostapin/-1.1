<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GURPS –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #333; padding: 20px; min-height: 100vh; }
        .container { max-width: 800px; margin: 0 auto; background: white; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); overflow: hidden; }
        
        /* –í–∫–ª–∞–¥–∫–∏ */
        .tabs { display: flex; background: #2c3e50; border-bottom: 2px solid #34495e; }
        .tab-btn { flex: 1; padding: 15px; border: none; background: transparent; color: white; font-size: 16px; cursor: pointer; transition: background 0.3s; }
        .tab-btn.active { background: #3498db; font-weight: bold; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .header { background: linear-gradient(135deg, #2c3e50, #34495e); color: white; padding: 20px; text-align: center; }
        .character-info { display: flex; gap: 15px; margin-bottom: 15px; flex-wrap: wrap; justify-content: center; }
        .input-group { flex: 1; min-width: 200px; }
        .input-group label { display: block; margin-bottom: 5px; font-weight: bold; color: #ecf0f1; }
        .input-group input { width: 100%; padding: 10px; border: none; border-radius: 8px; font-size: 16px; background: rgba(255,255,255,0.9); }
        
        .level-system { background: #f8f9fa; padding: 15px; border-bottom: 2px solid #dee2e6; }
        .level-display { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .level-info { font-size: 1.2em; font-weight: bold; color: #2c3e50; display: flex; align-items: center; gap: 10px; }
        .exp-display { display: flex; align-items: center; gap: 10px; }
        .exp-input { width: 120px; padding: 8px; border: 2px solid #3498db; border-radius: 6px; font-size: 16px; text-align: center; }
        
        .stats-panel { padding: 15px; background: #fff; border-bottom: 2px solid #ecf0f1; }
        .stat-row { display: flex; align-items: center; padding: 8px 0; gap: 10px; }
        .stat-label { flex: 1; font-weight: bold; display: flex; align-items: center; gap: 8px; }
        .stat-input { width: 100px; padding: 8px; border: 2px solid #3498db; border-radius: 6px; text-align: center; font-size: 16px; }
        
        .points-panel { padding: 15px; background: #e8f4f8; border-bottom: 2px solid #3498db; }
        .points-display { display: flex; align-items: center; justify-content: center; gap: 10px; }
        
        .skills-section { padding: 20px; border-bottom: 2px solid #ecf0f1; }
        .section-title { font-size: 1.4em; color: #2c3e50; margin-bottom: 15px; padding-bottom: 8px; border-bottom: 2px solid #3498db; display: flex; align-items: center; gap: 10px; }
        .skill-row { display: flex; align-items: center; padding: 12px 0; border-bottom: 1px solid #ecf0f1; }
        .skill-name { flex: 2; font-weight: 500; display: flex; align-items: center; gap: 8px; }
        .skill-controls { flex: 1; display: flex; align-items: center; justify-content: flex-end; gap: 10px; }
        .skill-value { font-size: 1.2em; font-weight: bold; color: #2c3e50; min-width: 30px; text-align: center; }
        
        /* –°—Ç–∏–ª–∏ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è */
        .inventory-container { padding: 20px; }
        .category-section { margin-bottom: 25px; border: 2px solid #ecf0f1; border-radius: 10px; padding: 15px; }
        .category-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #bdc3c7; }
        .category-header h3 { margin: 0; color: #2c3e50; }
        .category-items { min-height: 50px; }
        .item-row { display: flex; justify-content: space-between; align-items: center; padding: 8px; margin: 5px 0; background: #f8f9fa; border-radius: 5px; border-left: 4px solid #3498db; }
        .item-info { flex: 1; }
        .item-name { font-weight: bold; color: #2c3e50; }
        .item-details { font-size: 0.9em; color: #7f8c8d; }
        .item-actions { display: flex; gap: 5px; }
        
        .btn { padding: 8px 12px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: bold; transition: all 0.3s; }
        .btn-plus { background: #27ae60; color: white; }
        .btn-minus { background: #e74c3c; color: white; }
        .btn-roll { background: #3498db; color: white; padding: 8px 15px; }
        .btn-convert { background: #9b59b6; color: white; }
        .btn-levels { background: #f39c12; color: white; }
        .btn-edit { background: #95a5a6; color: white; }
        .btn-undo { background: #e67e22; color: white; }
        .btn-redo { background: #d35400; color: white; }
        .btn-small { padding: 4px 8px; font-size: 12px; }
        .btn:disabled { background: #bdc3c7; cursor: not-allowed; }
        
        .result-popup, .levels-popup, .inventory-popup { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .result-content, .levels-content, .inventory-content { background: white; padding: 30px; border-radius: 15px; text-align: center; max-width: 90%; width: 500px; max-height: 80vh; overflow-y: auto; }
        .dice-rolls { display: flex; justify-content: center; gap: 15px; margin: 15px 0; }
        .dice { width: 50px; height: 50px; background: #3498db; border-radius: 8px; display: flex; justify-content: center; align-items: center; font-size: 1.5em; font-weight: bold; color: white; }
        
        .success { color: #27ae60; font-weight: bold; }
        .failure { color: #e74c3c; font-weight: bold; }
        .critical-success { color: #f39c12; font-weight: bold; }
        .critical-failure { color: #c0392b; font-weight: bold; }
        
        .free-points-warning { color: #e74c3c; font-weight: bold; text-align: center; margin: 10px; padding: 10px; background: #ffeaa7; border-radius: 5px; }
        
        .levels-table { width: 100%; border-collapse: collapse; margin: 15px 0; }
        .levels-table th, .levels-table td { padding: 8px; text-align: center; border: 1px solid #ddd; }
        .levels-table th { background: #34495e; color: white; }
        .current-level { background: #ffeaa7 !important; font-weight: bold; }
        
        @media (max-width: 600px) {
            .character-info, .stat-row, .skill-row { flex-direction: column; align-items: flex-start; gap: 10px; }
            .skill-controls { width: 100%; justify-content: space-between; }
            .exp-display, .level-display { flex-direction: column; gap: 10px; }
            .points-display { flex-direction: column; }
            .tabs { flex-direction: column; }
            .item-row { flex-direction: column; align-items: flex-start; gap: 10px; }
            .item-actions { width: 100%; justify-content: flex-end; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- –í–∫–ª–∞–¥–∫–∏ -->
        <div class="tabs">
            <button class="tab-btn active" onclick="openTab('character')">üë§ –ü–µ—Ä—Å–æ–Ω–∞–∂</button>
            <button class="tab-btn" onclick="openTab('inventory')">üéí –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å</button>
            <button class="tab-btn" onclick="openTab('spells')">üìö –ó–∞–∫–ª–∏–Ω–∞–Ω–∏—è</button>
            <button class="tab-btn" onclick="openTab('notes')">üìù –ó–∞–º–µ—Ç–∫–∏</button>
        </div>

        <!-- –í–∫–ª–∞–¥–∫–∞ –ü–µ—Ä—Å–æ–Ω–∞–∂ -->
        <div id="character-tab" class="tab-content active">
            <div class="header">
                <h1>üé≤ GURPS –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ</h1>
                <div class="character-info">
                    <div class="input-group">
                        <label for="characterName">–ò–º—è:</label>
                        <input type="text" id="characterName" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è">
                    </div>
                    <div class="input-group">
                        <label for="characterSurname">–§–∞–º–∏–ª–∏—è:</label>
                        <input type="text" id="characterSurname" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ñ–∞–º–∏–ª–∏—é">
                    </div>
                    <div class="input-group">
                        <label for="characterTitle">–¢–∏—Ç—É–ª:</label>
                        <input type="text" id="characterTitle" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–∏—Ç—É–ª">
                    </div>
                </div>
            </div>

            <div class="level-system">
                <div class="level-display">
                    <div class="level-info">
                        –£—Ä–æ–≤–µ–Ω—å: <span id="currentLevel">0</span>
                        <button class="btn btn-edit" onclick="editLevel()">‚úèÔ∏è</button>
                        <button class="btn btn-levels" onclick="showLevelsTable()">üìä</button>
                        <button class="btn btn-undo" onclick="undo()" id="undoBtn" disabled>‚Ü∂</button>
                        <button class="btn btn-redo" onclick="redo()" id="redoBtn" disabled>‚Ü∑</button>
                    </div>
                    <div class="exp-display">
                        <input type="number" id="currentExp" class="exp-input" value="0" min="0">
                        <span>/ <span id="requiredExp">1000</span></span>
                        <button class="btn btn-plus" onclick="addExperience()">‚ûï –û–ø—ã—Ç</button>
                        <button class="btn btn-convert" id="convertBtn" onclick="convertExpToPoints()" style="display: none;">üíé –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                    </div>
                </div>
                <div id="convertInfo" style="display: none; text-align: center; margin-top: 10px; font-size: 0.9em; color: #9b59b6;">
                    üíé 1000 –æ–ø—ã—Ç–∞ = 1 –æ—á–∫–æ –Ω–∞–≤—ã–∫–æ–≤
                </div>
            </div>

            <div class="stats-panel">
                <div class="stat-row">
                    <div class="stat-label">‚ù§Ô∏è –ó–î–û–†–û–í–¨–ï:</div>
                    <input type="number" class="stat-input" id="health" value="100">
                    <button class="btn btn-minus" onclick="changeStat('health', -5)">-5</button>
                    <button class="btn btn-plus" onclick="changeStat('health', 5)">+5</button>
                </div>
                <div class="stat-row">
                    <div class="stat-label">üíß –ú–ê–ù–ê:</div>
                    <input type="number" class="stat-input" id="mana" value="100">
                    <button class="btn btn-minus" onclick="changeStat('mana', -5)">-5</button>
                    <button class="btn btn-plus" onclick="changeStat('mana', 5)">+5</button>
                </div>
                <div class="stat-row">
                    <div class="stat-label">‚ö° –°–¢–ê–ú–ò–ù–ê:</div>
                    <input type="number" class="stat-input" id="stamina" value="100">
                    <button class="btn btn-minus" onclick="changeStat('stamina', -5)">-5</button>
                    <button class="btn btn-plus" onclick="changeStat('stamina', 5)">+5</button>
                </div>
            </div>

            <div class="points-panel">
                <div class="points-display">
                    <span style="font-size: 1.2em; font-weight: bold; color: #2c3e50;">–°–≤–æ–±–æ–¥–Ω—ã–µ –æ—á–∫–∏:</span>
                    <input type="number" id="freePoints" class="stat-input" value="0">
                    <button class="btn btn-edit" onclick="editFreePoints()">‚úèÔ∏è</button>
                </div>
            </div>

            <div id="skillsContainer"></div>
            
            <div class="free-points-warning" id="pointsWarning" style="display: none;">
                ‚ö†Ô∏è –°–≤–æ–±–æ–¥–Ω—ã–µ –æ—á–∫–∏ –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å!
            </div>
        </div>

        <!-- –í–∫–ª–∞–¥–∫–∞ –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å -->
        <div id="inventory-tab" class="tab-content">
            <!-- –ö–æ–Ω—Ç–µ–Ω—Ç –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è –±—É–¥–µ—Ç –≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è —á–µ—Ä–µ–∑ JavaScript -->
        </div>

        <!-- –í–∫–ª–∞–¥–∫–∞ –ó–∞–∫–ª–∏–Ω–∞–Ω–∏—è -->
        <div id="spells-tab" class="tab-content">
            <div style="padding: 20px; text-align: center;">
                <h2>üìö –ó–∞–∫–ª–∏–Ω–∞–Ω–∏—è</h2>
                <p style="color: #7f8c8d; margin-top: 20px;">–†–∞–∑–¥–µ–ª –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ</p>
            </div>
        </div>

        <!-- –í–∫–ª–∞–¥–∫–∞ –ó–∞–º–µ—Ç–∫–∏ -->
        <div id="notes-tab" class="tab-content">
            <div style="padding: 20px; text-align: center;">
                <h2>üìù –ó–∞–º–µ—Ç–∫–∏</h2>
                <p style="color: #7f8c8d; margin-top: 20px;">–†–∞–∑–¥–µ–ª –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ</p>
            </div>
        </div>
    </div>

    <script>
        // –¢–∞–±–ª–∏—Ü–∞ —É—Ä–æ–≤–Ω–µ–π (–Ω–∞—á–∏–Ω–∞–µ–º —Å 0 —É—Ä–æ–≤–Ω—è)
        const levelTable = {
            0: { expRequired: 1000, hp: 100, mana: 100, stamina: 100, points: 20 },
            1: { expRequired: 3000, hp: 200, mana: 200, stamina: 200, points: 30 },
            2: { expRequired: 5000, hp: 300, mana: 300, stamina: 300, points: 40 },
            3: { expRequired: 8000, hp: 400, mana: 400, stamina: 400, points: 50 },
            4: { expRequired: 12000, hp: 500, mana: 500, stamina: 500, points: 60 },
            5: { expRequired: 16000, hp: 600, mana: 600, stamina: 600, points: 70 },
            6: { expRequired: 20000, hp: 700, mana: 700, stamina: 700, points: 80 },
            7: { expRequired: 25000, hp: 800, mana: 800, stamina: 800, points: 90 },
            8: { expRequired: 30000, hp: 900, mana: 900, stamina: 900, points: 100 },
            9: { expRequired: 100000, hp: 1000, mana: 1000, stamina: 1000, points: 200 }
        };

        // –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –Ω–∞–≤—ã–∫–æ–≤
        const skillsStructure = {
            "‚öîÔ∏è –ë–û–ï–í–´–ï –ù–ê–í–´–ö–ò": [
                "–¢—è–∂—ë–ª–∞—è –±—Ä–æ–Ω—è", "–õ—ë–≥–∫–∞—è –±—Ä–æ–Ω—è", "–î–≤—É—Ä—É—á–Ω–æ–µ –æ—Ä—É–∂–∏–µ", 
                "–û–¥–Ω–æ—Ä—É—á–Ω–æ–µ –æ—Ä—É–∂–∏–µ", "–°—Ç—Ä–µ–ª—å–±–∞", "–ë–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∏–µ", 
                "–î—Ä–µ–≤–∫–æ–≤–æ–µ", "–†—É–∫–æ–ø–∞—à–Ω—ã–π –±–æ–π", "–ú–µ—Ç–∞–Ω–∏–µ"
            ],
            "üé≠ –û–ë–©–ò–ï –ù–ê–í–´–ö–ò": [
                "–°–∫—Ä—ã—Ç–Ω–æ—Å—Ç—å", "–ö—Ä–∞—Å–Ω–æ—Ä–µ—á–∏–µ", "–õ–æ–≤–∫–æ—Å—Ç—å", "–í—ã–Ω–æ—Å–ª–∏–≤–æ—Å—Ç—å",
                "–í–∑–ª–æ–º", "–í–æ—Å–ø—Ä–∏—è—Ç–∏–µ", "–£–¥–∞—á–∞", "–ö–∞—Ä–º–∞–Ω–Ω—ã–µ –∫—Ä–∞–∂–∏"
            ],
            "‚öóÔ∏è –†–ï–ú–ï–°–õ–ê": [
                "–ê–ª—Ö–∏–º–∏—è", "–ö—É–∑–Ω–µ—á–Ω–æ–µ –¥–µ–ª–æ", "–ó–∞—á–∞—Ä–æ–≤–∞–Ω–∏–µ", "–†–µ–º–µ—Å–ª–æ"
            ],
            "üîÆ –ú–ê–ì–ò–Ø": [
                "–ú–∞–≥–∏—è –≤–æ–¥—ã", "–ú–∞–≥–∏—è –∑–µ–º–ª–∏", "–ú–∞–≥–∏—è –≤–æ–∑–¥—É—Ö–∞", "–ú–∞–≥–∏—è –∫—Ä–æ–≤–∏",
                "–ú–∞–≥–∏—è –æ–≥–Ω—è", "–ú–∞–≥–∏—è –º–µ—Ç–∞–ª–ª–∞", "–ú–∞–≥–∏—è –ø—Ä–∏—Ä–æ–¥—ã", "–ú–∞–≥–∏—è —Å–≤–µ—Ç–∞",
                "–ú–∞–≥–∏—è —Ç—å–º—ã", "–ú–∞–≥–∏—è –∏–Ω—Ñ–µ—Ä–Ω–æ", "–ú–∞–≥–∏—è —Ö–∞–æ—Å–∞", "–ú–∞–≥–∏—è —Ä–∞–∑—É–º–∞",
                "–ú–∞–≥–∏—è –ñ–∏–∑–Ω–∏", "–ú–∞–≥–∏—è —Å–º–µ—Ä—Ç–∏", "–ú–∞–≥–∏—è –ø—É—Å—Ç–æ—Ç—ã", "–ú–∞–≥–∏—è –≠–Ω–µ—Ä–≥–∏–∏"
            ]
        };

        // –°–∏—Å—Ç–µ–º–∞ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è
        let inventoryCategories = [
            { id: 'weapons', name: '‚öîÔ∏è –û—Ä—É–∂–∏–µ', icon: '‚öîÔ∏è', editable: true },
            { id: 'armor', name: 'üõ°Ô∏è –ë—Ä–æ–Ω—è', icon: 'üõ°Ô∏è', editable: true },
            { id: 'potions', name: 'üß™ –ó–µ–ª—å—è', icon: 'üß™', editable: true },
            { id: 'scrolls', name: 'üìú –°–≤–∏—Ç–∫–∏', icon: 'üìú', editable: true },
            { id: 'resources', name: 'üíé –†–µ—Å—É—Ä—Å—ã', icon: 'üíé', editable: true },
            { id: 'valuables', name: 'üí∞ –¶–µ–Ω–Ω–æ—Å—Ç–∏', icon: 'üí∞', editable: true },
            { id: 'tools', name: 'üîß –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã', icon: 'üîß', editable: true },
            { id: 'other', name: 'üéí –ü—Ä–æ—á–µ–µ', icon: 'üéí', editable: true }
        ];

        let inventory = {
            weapons: [],
            armor: [],
            potions: [],
            scrolls: [],
            resources: [],
            valuables: [],
            tools: [],
            other: []
        };

        // –ò—Å—Ç–æ—Ä–∏—è –±—Ä–æ—Å–∫–æ–≤
        const rollHistory = {};

        // –°–∏—Å—Ç–µ–º–∞ –∏—Å—Ç–æ—Ä–∏–∏ –¥–µ–π—Å—Ç–≤–∏–π
        let actionHistory = [];
        let currentHistoryIndex = -1;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        document.addEventListener('DOMContentLoaded', function() {
            loadCharacterData();
            loadInventory();
            loadRollHistory();
            renderSkills();
            renderInventory();
            updateUI();
            updateLevelDisplay();
            updateHistoryButtons();
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –Ω–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤ –∏—Å—Ç–æ—Ä–∏—é
            setTimeout(saveStateToHistory, 1000);
        });

        // –°–∏—Å—Ç–µ–º–∞ –≤–∫–ª–∞–¥–æ–∫
        function openTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            document.getElementById(tabName + '-tab').classList.add('active');
            event.currentTarget.classList.add('active');
        }

        // === –°–ò–°–¢–ï–ú–ê –ò–ù–í–ï–ù–¢–ê–†–Ø ===
        function loadInventory() {
            const saved = localStorage.getItem('inventoryData');
            if (saved) {
                const data = JSON.parse(saved);
                inventory = data.inventory || inventory;
                inventoryCategories = data.categories || inventoryCategories;
            }
        }

        function saveInventory() {
            const data = {
                inventory: inventory,
                categories: inventoryCategories
            };
            localStorage.setItem('inventoryData', JSON.stringify(data));
        }

        function renderInventory() {
            const container = document.getElementById('inventory-tab');
            if (!container) return;

            container.innerHTML = `
                <div class="inventory-container">
                    <h2>üéí –ò–ù–í–ï–ù–¢–ê–†–¨</h2>
                    <div style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="btn" onclick="showCategoryManager()" style="background: #95a5a6;">‚öôÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏</button>
                        <button class="btn" onclick="addItem()" style="background: #27ae60;">‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–µ–¥–º–µ—Ç</button>
                    </div>
                    
                    <div id="inventory-categories">
                        ${inventoryCategories.map(category => `
                            <div class="category-section">
                                <div class="category-header">
                                    <h3>${category.name}</h3>
                                    ${category.editable ? `
                                        <div class="item-actions">
                                            <button class="btn btn-small" onclick="editCategory('${category.id}')">‚úèÔ∏è</button>
                                            <button class="btn btn-small" onclick="deleteCategory('${category.id}')" style="background: #e74c3c;">‚ùå</button>
                                        </div>
                                    ` : ''}
                                </div>
                                <div class="category-items" id="items-${category.id}">
                                    ${renderCategoryItems(category.id)}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function renderCategoryItems(categoryId) {
            const items = inventory[categoryId] || [];
            if (items.length === 0) {
                return '<p style="color: #7f8c8d; text-align: center; padding: 20px;">–ü—É—Å—Ç–æ</p>';
            }
            
            return items.map((item, index) => `
                <div class="item-row">
                    <div class="item-info">
                        <div class="item-name">${item.name}</div>
                        <div class="item-details">${item.details || ''} ${item.quantity ? '√ó' + item.quantity : ''}</div>
                    </div>
                    <div class="item-actions">
                        <button class="btn btn-small" onclick="editInventoryItem('${categoryId}', ${index})">‚úèÔ∏è</button>
                        <button class="btn btn-small" onclick="deleteInventoryItem('${categoryId}', ${index})" style="background: #e74c3c;">‚ùå</button>
                    </div>
                </div>
            `).join('');
        }

        function showCategoryManager() {
            const popup = document.createElement('div');
            popup.className = 'inventory-popup';
            popup.innerHTML = `
                <div class="inventory-content">
                    <h2>‚öôÔ∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º–∏</h2>
                    <div style="text-align: left; margin: 20px 0;">
                        ${inventoryCategories.map(category => `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #ecf0f1;">
                                <span>${category.name}</span>
                                ${category.editable ? `
                                    <div>
                                        <button class="btn btn-small" onclick="editCategory('${category.id}')">‚úèÔ∏è</button>
                                        <button class="btn btn-small" onclick="deleteCategory('${category.id}')" style="background: #e74c3c;">‚ùå</button>
                                    </div>
                                ` : '<span style="color: #7f8c8d;">–°–∏—Å—Ç–µ–º–Ω–∞—è</span>'}
                            </div>
                        `).join('')}
                    </div>
                    <button class="btn" onclick="addCategory()" style="background: #27ae60; margin-bottom: 10px;">‚ûï –î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é</button>
                    <button class="btn" onclick="this.closest('.inventory-popup').remove()" style="background: #34495e;">–ó–∞–∫—Ä—ã—Ç—å</button>
                </div>
            `;
            document.body.appendChild(popup);
        }

        function addCategory() {
            const categoryName = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏:');
            if (categoryName) {
                const categoryId = 'category_' + Date.now();
                const categoryIcon = 'üìÅ';
                
                inventoryCategories.push({
                    id: categoryId,
                    name: categoryIcon + ' ' + categoryName,
                    icon: categoryIcon,
                    editable: true
                });
                
                inventory[categoryId] = [];
                saveInventory();
                renderInventory();
                document.querySelector('.inventory-popup')?.remove();
            }
        }

        function editCategory(categoryId) {
            const category = inventoryCategories.find(cat => cat.id === categoryId);
            if (category && category.editable) {
                const newName = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏:', category.name.replace(category.icon + ' ', ''));
                if (newName) {
                    category.name = category.icon + ' ' + newName;
                    saveInventory();
                    renderInventory();
                }
            }
        }

        function deleteCategory(categoryId) {
            const category = inventoryCategories.find(cat => cat.id === categoryId);
            if (category && category.editable) {
                if ((inventory[categoryId] || []).length === 0) {
                    if (confirm(`–£–¥–∞–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é "${category.name}"?`)) {
                        inventoryCategories = inventoryCategories.filter(cat => cat.id !== categoryId);
                        delete inventory[categoryId];
                        saveInventory();
                        renderInventory();
                        document.querySelector('.inventory-popup')?.remove();
                    }
                } else {
                    alert('–ù–µ–ª—å–∑—è —É–¥–∞–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é —Å –ø—Ä–µ–¥–º–µ—Ç–∞–º–∏!');
                }
            }
        }

        function addItem() {
            const categoryId = prompt('–í–≤–µ–¥–∏—Ç–µ ID –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –¥–ª—è –ø—Ä–µ–¥–º–µ—Ç–∞:\n' + 
                inventoryCategories.map(cat => `${cat.name} (${cat.id})`).join('\n'));
            
            if (categoryId && inventoryCategories.find(cat => cat.id === categoryId)) {
                const name = prompt('–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–∞:');
                if (name) {
                    const details = prompt('–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–∞ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):') || '';
                    const quantity = prompt('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):') || '';
                    
                    if (!inventory[categoryId]) {
                        inventory[categoryId] = [];
                    }
                    
                    inventory[categoryId].push({
                        name: name,
                        details: details,
                        quantity: quantity,
                        added: new Date().toLocaleDateString()
                    });
                    
                    saveInventory();
                    renderInventory();
                }
            } else {
                alert('–ö–∞—Ç–µ–≥–æ—Ä–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!');
            }
        }

        function editInventoryItem(categoryId, index) {
            const item = inventory[categoryId][index];
            const newName = prompt('–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–∞:', item.name);
            if (newName) {
                const newDetails = prompt('–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç–∞:', item.details);
                const newQuantity = prompt('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:', item.quantity);
                
                inventory[categoryId][index] = {
                    ...item,
                    name: newName,
                    details: newDetails || '',
                    quantity: newQuantity || ''
                };
                
                saveInventory();
                renderInventory();
            }
        }

        function deleteInventoryItem(categoryId, index) {
            if (confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –ø—Ä–µ–¥–º–µ—Ç?')) {
                inventory[categoryId].splice(index, 1);
                saveInventory();
                renderInventory();
            }
        }

        // === –û–°–¢–ê–õ–¨–ù–û–ô –ö–û–î (—Å–∏—Å—Ç–µ–º–∞ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞, –±—Ä–æ—Å–∫–æ–≤, —É—Ä–æ–≤–Ω–µ–π) ===
        // [–ó–¥–µ—Å—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤–µ—Å—å –ø—Ä–µ–¥—ã–¥—É—â–∏–π –∫–æ–¥ —Å–∏—Å—Ç–µ–º—ã –ø–µ—Ä—Å–æ–Ω–∞–∂–∞...]
        // –ò–∑-–∑–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –¥–ª–∏–Ω—ã –æ—Å—Ç–∞–≤–ª—é –æ—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏, –Ω–æ –≤ —Ä–µ–∞–ª—å–Ω–æ–º —Ñ–∞–π–ª–µ –±—É–¥–µ—Ç –ø–æ–ª–Ω—ã–π –∫–æ–¥

        function loadRollHistory() {
            const saved = localStorage.getItem('rollHistory');
            if (saved) {
                Object.assign(rollHistory, JSON.parse(saved));
            }
        }

        function addToRollHistory(skillName, dice, total, success) {
            if (!rollHistory[skillName]) {
                rollHistory[skillName] = [];
            }
            
            rollHistory[skillName].unshift({
                dice: dice,
                total: total,
                success: success,
                timestamp: new Date().toLocaleTimeString()
            });
            
            if (rollHistory[skillName].length > 10) {
                rollHistory[skillName].pop();
            }
            
            localStorage.setItem('rollHistory', JSON.stringify(rollHistory));
        }

        function showRollHistory(skillName) {
            const history = rollHistory[skillName] || [];
            let historyHTML = '<h3>–ò—Å—Ç–æ—Ä–∏—è –±—Ä–æ—Å–∫–æ–≤ "' + skillName + '"</h3>';
            
            if (history.length === 0) {
                historyHTML += '<p>–ü–æ–∫–∞ –Ω–µ—Ç –±—Ä–æ—Å–∫–æ–≤</p>';
            } else {
                historyHTML += '<div style="text-align: left; max-height: 200px; overflow-y: auto;">';
                history.forEach((roll, index) => {
                    const resultIcon = roll.total === 3 || roll.total === 4 ? 'üí´' : 
                                     roll.total === 17 || roll.total === 18 ? 'üí•' :
                                     roll.success ? '‚úÖ' : '‚ùå';
                    historyHTML += `<p>${index + 1}. [${roll.dice.join(',')}] = ${roll.total} ${resultIcon}</p>`;
                });
                historyHTML += '</div>';
            }
            
            const popup = document.createElement('div');
            popup.className = 'result-popup';
            popup.innerHTML = `
                <div class="result-content">
                    ${historyHTML}
                    <button class="btn close-btn" onclick="this.closest('.result-popup').remove()" style="background: #34495e; color: white; padding: 10px 25px; margin-top: 15px;">–ó–∞–∫—Ä—ã—Ç—å</button>
                </div>
            `;
            document.body.appendChild(popup);
        }

        // –û—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ —Å–∏—Å—Ç–µ–º—ã –ø–µ—Ä—Å–æ–Ω–∞–∂–∞...
        // [–ó–¥–µ—Å—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–æ–ª–Ω—ã–π –∫–æ–¥ –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –≤–µ—Ä—Å–∏–π]

    </script>
</body>
</html>
